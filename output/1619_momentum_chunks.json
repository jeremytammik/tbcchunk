[
  {
    "original_filename": "1619_momentum",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n<link rel=\"stylesheet\" type=\"text/css\" href=\"bc.css\">\n<!--\n<script src=\"run_prettify.js\" type=\"text/javascript\"></script>\n<script src=\"https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js\" type=\"text/javascript\"></script>\n-->\n<script src=\"https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js\" type=\"text/javascript\"></script>\n</head>\n\n<!---\n\n- https://github.com/tumcms/MomenTUM\n  pedestrian simulation framework and tools\n  the [Chair of Computational Modeling and Simulation](https://www.cms.bgu.tum.de/en/)\n  [Technische Universität München](https://www.tum.de)\n  The [layout-tools](https://github.com/tumcms/MomenTUM/tree/master/momentum-tools) projects provide mechanisms to generate simulation scenarios based on different input data (AutoCAD, Revit, OSM).\n  https://github.com/tumcms/MomenTUM/tree/master/momentum-tools/momentum-layout-tools/momentum-layout-tools-revit\n  This plugin is used to export geometrical information from a Revit project to a xml. The generated xml contains layouts (scenarios/levels) which can be used for Momentum simulations.\n\nMomenTUM Pedestrian Simulation with #RevitAPI in @AutodeskRevit #bim #dynamobim @AutodeskForge #ForgeDevCon http://bit.ly/momentumrvt\n\nChristian Thieme of the Chair of Computational Modeling and Simulation at TUM, the Technical University Munich, shares his tools connecting Revit to the MomenTUM agent-based pedestrian simulation framework\n&ndash; Giving something back to the community\n&ndash; Project overview\n&ndash; Export workflow\n&ndash; Import and display results workflow\n&ndash; Transformation from <code>XYZ</code> to <code>UV</code>...\n\n--->"
  },
  {
    "original_filename": "1619_momentum",
    "header_text": "Revit Tools for MomenTUM Pedestrian Simulation",
    "local_header_href": "#revit-tools-for-momentum-pedestrian-simulation",
    "chunk_text": "### Revit Tools for MomenTUM Pedestrian Simulation\n\nOccasionally, I have the delight of receiving messages entitled something like *Giving something back to the Community*.\n\nThis time, the pleasure was provided by Christian Thieme, master's degree student at\nthe [Chair of Computational Modeling and Simulation](https://www.cms.bgu.tum.de/en) at\n[TUM, the Technical University Munich](https://www.tum.de),\nworking on tools connecting Revit to\nthe [MomenTUM](https://www.cms.bgu.tum.de/en/31-forschung/projekte/456-momentum) agent-based\npedestrian simulation framework.\n\nMany thanks, Christian, for sharing this!\n\nIn his own words:\n\n- [Giving something back to the community](#2)\n- [Project overview](#3)\n- [Export workflow](#4)\n- [Import and display results workflow](#5)\n- [Transformation from `XYZ` to `UV`](#6)\n\n\n####<a name=\"2\"></a>Giving Something Back to the Community\n\nI am a Master's degree student at TUM in Germany.\n\nAs part of a project, I developed a Revit Plugin that uses\nthe [Revit Analysis Visualization Framework AVF](http://thebuildingcoder.typepad.com/blog/avf) to\ndisplay (arbitrary) analytical results.\n\nIn order to do so, your blog posts and the forum were a big help. And if it is of any help, I would like to share my solution to do so.\n\nMy general approach to compute and display was to extract geometrical information (e.g. the layout of a building).\nI exported this information in an xml format.\n\nThen I processed the xml-data using a Java Project of the University Chair I was working in.\n\nThe Java projects generates a 2D array out of the input xml file, and computes a metric &ndash; in my case, a type\nof [space syntax](https://en.wikipedia.org/wiki/Space_syntax) operation\n&ndash; [Visibility Graph Analysis](https://en.wikipedia.org/wiki/Visibility_graph_analysis)).\n\nThe result of the visibility graph analysis is a 2D array of values that is then fed in to my plugin.\n\nYou can find my Space Syntax Plugin within\nthe [Momentum GitHub repository](https://github.com/tumcms/MomenTUM).\n\nThe Revit Plugins are located in\nthe [momentum-tools subfolders](https://github.com/tumcms/MomenTUM/tree/master/momentum-tools).\n\n- Export: [MomenTumV2RevitLayouting add-in](https://github.com/tumcms/MomenTUM/tree/master/momentum-tools/momentum-layout-tools/momentum-layout-tools-revit) exports geometrical information from a Revit project to XML.\n- Import: [MomenTumV2SpaceSyntaxRevit](https://github.com/tumcms/MomenTUM/tree/master/momentum-tools/momentum-spaceSyntax-tools/momentum-spaceSyntax-tools-revit) reads the XML results and displays them using AVF.\n\n<center>\n<img src=\"img/momentum_gebaeude_7_rvt_export.png\" alt=\"Gebaeude 7\" width=\"442\"/>\n</center>\n\nI hope you find this interesting and worth sharing.\n\n\n####<a name=\"3\"></a>Project Overview\n\nThe project goal was to visualize an analytical result.\n\n- Step 1: use\nthe [MomenTumV2RevitLayouting Revit add-in](https://github.com/tumcms/MomenTUM/tree/master/momentum-tools/momentum-layout-tools/momentum-layout-tools-revit) to\nexport geometrical information from a Revit project to XML.\n- Step 2: run\nthe [MomentumV2 Kernel the main Java project](https://github.com/tumcms/MomenTUM) to produce another XML file with result data.\n- Step 3: use\nthe [MomentumV2SpaceSyntaxRevit Revit add-in](https://github.com/tumcms/MomenTUM/tree/master/momentum-tools/momentum-spaceSyntax-tools/momentum-spaceSyntax-tools-revit) and open the result data xml file and visualise the results.\n\nThe MomentumV2SpaceSyntaxPlugin uses AVF to display the result in the active view.\n\nThere are some limitations to the work, as mentioned in the project readme.\n\nThe space syntax plugin also contains the [transformation code from xyz to uv coordinates](#6).\n\n\n####<a name=\"4\"></a>Export Workflow\n\nExecuting the plugin prompts the user to select one level or all levels of a project. The selected level(s) will be exported as xml.\n\nNote: Walls and doors are exported as obstacles as type 'Wall'. Stairs can will either be shown as areas of either type 'Origin' or 'Destination'.\n\nDetailed information on the add-in installation and workflow is provided in\nthe [MomenTumV2RevitLayouting how-to documentation](zip/HowTo_MomenTumV2RevitLayouting.pdf).\n\n\n####<a name=\"5\"></a>Import and Display Results Workflow\n\nThe workflow assumes that you have successfully built the Revit layouting plugin and the Space Syntax plugin and integrated them into your Revit installation. Furthermore, you need to have built Momentum successfully and have a basic understanding of its usage (see momentum-documentation).\n\n1. Use the Layouting Plugin to export geometry data of a level of a Revit project into a xml file. Make sure that you have properly set rooms in your Revit project before exporting (see layouting documentation).\n\n2. Check if the resulting xml contains at least one area of type 'Origin' per scenario node.\n(If there is none, you have to create this area by hand yourself.)\n\n3. Create a xml configuration file and insert a lattice, Space Syntax and an outputwriter configuration.\n(Hint: You can copy the spaceSyntaxExamples.xml and make sure to adapt the file paths and ids accordingly.)\n\n4. Run your configuration with Momentum (see momentum-documentation) and check if the execution produced the xml output file defined in the Space Syntax output writer tag of the input configuration.\n\n5. In Revit, in the same project as you exported the geometry, go to 'Add-Ins' tab and run the MomentumV2SpaceSyntax external command and select the Space Syntax result xml you just created with Momentum.\n\n6. If you created the xml result using the Revit Layouting plugin, the Space Syntax plugin will automatically select the correct level to visualize the result from metadata in the result xml. Otherwise, a level picker will open.\n\n\n####<a name=\"6\"></a>Transformation from XYZ to UV\n\nIn my import and visualisation plugin, I managed to transform points from the global space (`XYZ`) to the local space of a face (`UV` representation of a bounding box).\n\nIn my understanding, this is quite unique, since I haven't found any other code snippet that does so.\n\nRevit itself only supports the `Face.Transform(UV)` method that translates a `UV` coordinate into `XYZ` coordinate space.\n\nI reversed that Method to translate `XYZ` coords to `UV` coords.\n\nAt first, I thought I could solve the reverse transformation by solving a linear equation with 2 unknown variables. But this wasn't a general solution. So, I finally found out that the transformation consists of a displacement vector and a rotation matrix.\n\n<pre class=\"code\">\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;Create&nbsp;transformation&nbsp;matrix&nbsp;to&nbsp;transform&nbsp;points&nbsp;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;from&nbsp;the&nbsp;global&nbsp;space&nbsp;(XYZ)&nbsp;to&nbsp;the&nbsp;local&nbsp;space&nbsp;of&nbsp;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;a&nbsp;face&nbsp;(UV&nbsp;representation&nbsp;of&nbsp;a&nbsp;bounding&nbsp;box).</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;Revit&nbsp;itself&nbsp;only&nbsp;supports&nbsp;Face.Transform(UV)&nbsp;that&nbsp;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;translates&nbsp;a&nbsp;UV&nbsp;coordinate&nbsp;into&nbsp;XYZ&nbsp;coordinate&nbsp;space.&nbsp;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;I&nbsp;reversed&nbsp;that&nbsp;Method&nbsp;to&nbsp;translate&nbsp;XYZ&nbsp;coords&nbsp;to&nbsp;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;UV&nbsp;coords.&nbsp;At&nbsp;first&nbsp;i&nbsp;thought&nbsp;i&nbsp;could&nbsp;solve&nbsp;the&nbsp;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;reverse&nbsp;transformation&nbsp;by&nbsp;solving&nbsp;a&nbsp;linear&nbsp;equation&nbsp;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;with&nbsp;2&nbsp;unknown&nbsp;variables.&nbsp;But&nbsp;this&nbsp;wasn&#39;t&nbsp;general.&nbsp;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;I&nbsp;finally&nbsp;found&nbsp;out&nbsp;that&nbsp;the&nbsp;transformation&nbsp;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;consists&nbsp;of&nbsp;a&nbsp;displacement&nbsp;vector&nbsp;and&nbsp;a&nbsp;rotation&nbsp;matrix.</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;/</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">double</span>[,]&nbsp;\n&nbsp;&nbsp;CalculateMatrixForGlobalToLocalCoordinateSystem(&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">Face</span>&nbsp;face&nbsp;)\n{\n&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;face.Evaluate&nbsp;uses&nbsp;a&nbsp;rotation&nbsp;matrix&nbsp;and</span>\n&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;a&nbsp;displacement&nbsp;vector&nbsp;to&nbsp;translate&nbsp;points</span>\n\n&nbsp;&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;originDisplacementVectorUV&nbsp;=&nbsp;face.Evaluate(&nbsp;<span style=\"color:#2b91af;\">UV</span>.Zero&nbsp;);\n&nbsp;&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;unitVectorUWithDisplacement&nbsp;=&nbsp;face.Evaluate(&nbsp;<span style=\"color:#2b91af;\">UV</span>.BasisU&nbsp;);\n&nbsp;&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;unitVectorVWithDisplacement&nbsp;=&nbsp;face.Evaluate(&nbsp;<span style=\"color:#2b91af;\">UV</span>.BasisV&nbsp;);\n\n&nbsp;&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;unitVectorU&nbsp;=&nbsp;unitVectorUWithDisplacement&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;originDisplacementVectorUV;\n\n&nbsp;&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;unitVectorV&nbsp;=&nbsp;unitVectorVWithDisplacement&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;originDisplacementVectorUV;\n\n&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;The&nbsp;rotation&nbsp;matrix&nbsp;A&nbsp;is&nbsp;composed&nbsp;of</span>\n&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;unitVectorU&nbsp;and&nbsp;unitVectorV&nbsp;transposed.</span>\n&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;To&nbsp;get&nbsp;the&nbsp;rotation&nbsp;matrix&nbsp;that&nbsp;translates&nbsp;from&nbsp;</span>\n&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;global&nbsp;space&nbsp;to&nbsp;local&nbsp;space,&nbsp;take&nbsp;the&nbsp;inverse&nbsp;of&nbsp;A.</span>\n\n&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;a11i&nbsp;=&nbsp;unitVectorU.X;\n&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;a12i&nbsp;=&nbsp;unitVectorU.Y;\n&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;a21i&nbsp;=&nbsp;unitVectorV.X;\n&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;a22i&nbsp;=&nbsp;unitVectorV.Y;\n\n&nbsp;&nbsp;<span style=\"color:blue;\">return</span>&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:blue;\">double</span>[2,&nbsp;2]&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;a11i,&nbsp;a12i&nbsp;},\n&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;a21i,&nbsp;a22i&nbsp;}};\n}\n</pre>"
  }
]