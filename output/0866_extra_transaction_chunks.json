[
  {
    "original_filename": "0866_extra_transaction",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0866_extra_transaction",
    "header_text": "Extra Transaction or Regeneration Required",
    "local_header_href": "#extra-transaction-or-regeneration-required",
    "chunk_text": "<h3>Extra Transaction or Regeneration Required</h3><p>Whenever your add-in modifies the model in any way and you wish to query the Revit database, you need to pay careful attention to ensure that you do not retrieve stale or invalid data.\n\n<p>If anything unexpected whatsoever happens, one of the first things to consider is the possible need for a document regeneration or additional separate transactions between steps.\n\n<p>These kinds of issues arise frequently.\n\n<p>I discussed adding an extra transaction to\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/01/extra-transaction-required.html\">\nmodify beam parameters and add openings</a> to\n\nit and to\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2012/07/creating-an-opening.html\">\ncreate an opening</a> in\n\na slab.\n\n<p>Sometimes a simple\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/06/to-regenerate-or-not-to-regenerate.html\">\ndocument regeneration</a> is\n\nalso sufficient, e.g. to\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/11/setting-text-width-requires-regen.html\">\nset the width of a newly created TextNote</a>.\n\n<p>Here are two more typical examples:</p>\n<ul>\n<li><a href=\"#2\">Extra transaction required after loading tag</a></li>\n<li><a href=\"#3\">Extra regeneration required to populate materials</a></li>\n</ul>\n<a name=\"2\"></a>\n<h4>Extra Transaction Required After Loading Tag</h4>\n<p>Here is an issue raised by Max, <a href=\"http://maciejszlek.pl\">Maciej Szlek</a>, who already contributed code to help\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2011/03/distinguishing-mep-element-shape.html\">\ndistinguish</a>\n<a href=\"http://thebuildingcoder.typepad.com/blog/2011/05/improved-mep-element-shape-and-mount-ararat.html\">\nMEP fitting shapes</a>:\n\n<p><strong>Question:</strong> I have a duct system and want to attach my tag to its elements, using the code to\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/06/set-tag-type.html\">\nset a tag type</a>.\n\nI tried something like this:\n\n<pre class=\"code\">\n  doc.LoadFamilySymbol(\n    [my_tag_family.rfa],\n    [type_name],\n    out tagType);\n\n  IndependentTag tag = doc.Create.NewTag(\n    doc.ActiveView,\n    element,\n    true,\n    TagMode.TM_ADDBY_CATEGORY,\n    TagOrientation.Horizontal,\n    XYZ.Zero);\n\n  tag.ChangeTypeId(tagType.Id);\n</pre>\n<!--\n<p>When I run this code in Revit MEP, the call to NewTag throws an InvalidOperationException saying that there is no tag available.\n\n<p>However, it works fine on Revit Architecture.\n\n<p>Experimenting more with the NewTag function, I noticed the following weird behaviour:\n\n<ul>\n<li>In Revit Architecture:\n<ul>\n<li>for doors/walls: works fine.\n<li>for mechanical equipment/duct: works fine.\n</ul>\n\n<li>In Revit MEP:\n<ul>\n<li>for doors/walls: works fine.\n<li>for mechanical equipment/duct: throws InvalidOperationException saying there is no tag available.\n</ul>\n</ul>\n-->\n<p>This code works fine in some projects, whereas in others Revit throws an InvalidOperationException saying that there is no tag available in the call to the NewTag method.\nThe behaviour seems to vary between different projects and on different elements.\n\n<p>How can that be?\n\n<p><strong>Answer:</strong> Have you tried either regenerating the document or placing the tag symbol loading and the tag creation calls in separate transaction, committed individually?\n\n<p><strong>Response:</strong> Problem solved.\nAs it turns out, the Revit project needs to have some suitable tag type loaded before calling NewTag.\nYour transaction hint was very helpful.\nMy earlier code was not enough as it stands.\nIt actually requires separate transactions to load the tag type and add a new tag if there was no other tag loaded before.\nI did not previously know what Revit meant by 'there is no tag available'.\n\n<p>Furthermore, I was initially using automatic transaction mode for this command, thinking that would free me from worrying about any transaction handling myself at all.\nI now learned that the automatic transaction mode does not enclose each action in a separate transaction, but wraps all executed functions in the whole external command into one single one.\nIn this case, such an approach is not usable at all.\n\n<p>Thank you for a very useful API lesson :))\n\n<!--\n<p><strong>Response:</strong> Actually, in some cases, Revit was still throwing that exception.\nAfter further experimenting it seems that the LoadFamilySymbol method sometimes is not enough.\nSometimes LoadFamily seems to work better, and separate transactions or regeneration is not needed after all.</p>\n-->\n<p><strong>Answer:</strong> Yes, I already mentioned that automatic transaction mode is unofficially deprecated, and manual mode is recommended for all cases nowadays.\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2012/05/read-only-and-automatic-transaction-modes.html\">\nAutomatic transaction mode is considered obsolete</a>.\n\n<p>Arnošt Löbel's AU class on\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2012/11/au-classes-on-python-ui-server-and-framework-apis.html#4\">\nCore Frameworks in the Revit API</a> provides\n\nmore details on this topic.\n\n<p>Many thanks to Max for raising this issue and verifying that the solution works!\n\n\n\n<a name=\"3\"></a>\n<h4>Extra Regeneration Required to Populate Materials</h4>\n<p>One of the issues we took a look at during the DevLab at AU last Tuesday was the list of materials attached to a newly duplicated symbol.</p>\n<p>At first glance, it appeared that a duplicated family symbol had zero entries in its list of materials, whereas the original symbols material list was correctly populated.\n\n<p>On further exploration, we discovered that this is another case of retrieving stale data after a model modification.\n\n<p>The behaviour is easily rectified by a call to regenerate the model after the symbol duplication.\n\n<p>Here is the final implementation of the external command implementing to test the issue.\nIt expects a structural steel column to be pre-selected, which is a family instance whose associated symbol has exactly one entry in its materials list.\nWe duplicate the symbol.\nThis requires defining a new name.\nTo simplify repeated testing, we generate a new name by simply appending the clock tick counter to the original one.\nDirectly after the call to Duplicate, the new symbol's material list has zero entries, which makes no sense for this kind of symbol.\nA call to Regenerate fixes that:</p>\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Command</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">UIApplication</span> uiapp = commandData.Application;\n    <span class=\"teal\">UIDocument</span> uidoc = uiapp.ActiveUIDocument;\n    <span class=\"teal\">Application</span> app = uiapp.Application;\n    <span class=\"teal\">Document</span> doc = uidoc.Document;\n    <span class=\"teal\">Selection</span> sel = uidoc.Selection;\n    <span class=\"teal\">FamilyInstance</span> inst = <span class=\"blue\">null</span>;\n \n    <span class=\"blue\">if</span>( 1 == sel.Elements.Size )\n    {\n      <span class=\"blue\">foreach</span>( <span class=\"teal\">Element</span> e <span class=\"blue\">in</span> sel.Elements )\n      {\n        inst = e <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n \n        <span class=\"blue\">break</span>;\n      }\n    }\n \n    <span class=\"blue\">if</span>( <span class=\"blue\">null</span> == inst )\n    {\n      message = <span class=\"maroon\">\"Please select one \"</span>\n        + <span class=\"maroon\">\"single structural column\"</span>;\n \n      <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Failed;\n    }\n \n    <span class=\"blue\">using</span>( <span class=\"teal\">Transaction</span> tx\n      = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc ) )\n    {\n      tx.Start( <span class=\"maroon\">\"Duplicate Symbol\"</span> );\n \n      <span class=\"teal\">FamilySymbol</span> symbol = inst.Symbol;\n \n      <span class=\"blue\">string</span> name = symbol.Name\n        + <span class=\"teal\">DateTime</span>.Now.Ticks.ToString();\n \n      <span class=\"blue\">int</span> nMaterialsBefore\n        = symbol.Materials.Size;\n \n      symbol = inst.Symbol.Duplicate( name )\n        <span class=\"blue\">as</span> <span class=\"teal\">FamilySymbol</span>;\n \n      <span class=\"green\">// The model is in a temporary state that does </span>\n      <span class=\"green\">// not make sense. Regenerate to clean this up.</span>\n \n      <span class=\"blue\">int</span> nMaterialsAfter\n        = symbol.Materials.Size;\n \n      doc.Regenerate();\n \n      nMaterialsAfter = symbol.Materials.Size;\n \n      <span class=\"teal\">Debug</span>.Assert(\n        nMaterialsAfter.Equals( nMaterialsBefore ),\n        <span class=\"maroon\">\"why does the material get lost, please?\"</span> );\n \n      tx.Commit();\n    }\n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>For completeness' sake, here is\n\n<a href=\"zip/DuplicatedSymbolLosesMaterial.zip\">\nDuplicatedSymbolLosesMaterial.zip</a> containing\n\nthe complete source code, Visual Studio solution and add-in manifest of this little test command.</p>\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0866_extra_transaction",
    "header_text": "Extra Transaction Required After Loading Tag",
    "local_header_href": "#extra-transaction-required-after-loading-tag",
    "chunk_text": "<h4>Extra Transaction Required After Loading Tag</h4><p>Here is an issue raised by Max, <a href=\"http://maciejszlek.pl\">Maciej Szlek</a>, who already contributed code to help\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2011/03/distinguishing-mep-element-shape.html\">\ndistinguish</a>\n<a href=\"http://thebuildingcoder.typepad.com/blog/2011/05/improved-mep-element-shape-and-mount-ararat.html\">\nMEP fitting shapes</a>:\n\n<p><strong>Question:</strong> I have a duct system and want to attach my tag to its elements, using the code to\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/06/set-tag-type.html\">\nset a tag type</a>.\n\nI tried something like this:\n\n<pre class=\"code\">\n  doc.LoadFamilySymbol(\n    [my_tag_family.rfa],\n    [type_name],\n    out tagType);\n\n  IndependentTag tag = doc.Create.NewTag(\n    doc.ActiveView,\n    element,\n    true,\n    TagMode.TM_ADDBY_CATEGORY,\n    TagOrientation.Horizontal,\n    XYZ.Zero);\n\n  tag.ChangeTypeId(tagType.Id);\n</pre>\n<!--\n<p>When I run this code in Revit MEP, the call to NewTag throws an InvalidOperationException saying that there is no tag available.\n\n<p>However, it works fine on Revit Architecture.\n\n<p>Experimenting more with the NewTag function, I noticed the following weird behaviour:\n\n<ul>\n<li>In Revit Architecture:\n<ul>\n<li>for doors/walls: works fine.\n<li>for mechanical equipment/duct: works fine.\n</ul>\n\n<li>In Revit MEP:\n<ul>\n<li>for doors/walls: works fine.\n<li>for mechanical equipment/duct: throws InvalidOperationException saying there is no tag available.\n</ul>\n</ul>\n-->\n<p>This code works fine in some projects, whereas in others Revit throws an InvalidOperationException saying that there is no tag available in the call to the NewTag method.\nThe behaviour seems to vary between different projects and on different elements.\n\n<p>How can that be?\n\n<p><strong>Answer:</strong> Have you tried either regenerating the document or placing the tag symbol loading and the tag creation calls in separate transaction, committed individually?\n\n<p><strong>Response:</strong> Problem solved.\nAs it turns out, the Revit project needs to have some suitable tag type loaded before calling NewTag.\nYour transaction hint was very helpful.\nMy earlier code was not enough as it stands.\nIt actually requires separate transactions to load the tag type and add a new tag if there was no other tag loaded before.\nI did not previously know what Revit meant by 'there is no tag available'.\n\n<p>Furthermore, I was initially using automatic transaction mode for this command, thinking that would free me from worrying about any transaction handling myself at all.\nI now learned that the automatic transaction mode does not enclose each action in a separate transaction, but wraps all executed functions in the whole external command into one single one.\nIn this case, such an approach is not usable at all.\n\n<p>Thank you for a very useful API lesson :))\n\n<!--\n<p><strong>Response:</strong> Actually, in some cases, Revit was still throwing that exception.\nAfter further experimenting it seems that the LoadFamilySymbol method sometimes is not enough.\nSometimes LoadFamily seems to work better, and separate transactions or regeneration is not needed after all.</p>\n-->\n<p><strong>Answer:</strong> Yes, I already mentioned that automatic transaction mode is unofficially deprecated, and manual mode is recommended for all cases nowadays.\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2012/05/read-only-and-automatic-transaction-modes.html\">\nAutomatic transaction mode is considered obsolete</a>.\n\n<p>Arnošt Löbel's AU class on\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2012/11/au-classes-on-python-ui-server-and-framework-apis.html#4\">\nCore Frameworks in the Revit API</a> provides\n\nmore details on this topic.\n\n<p>Many thanks to Max for raising this issue and verifying that the solution works!\n\n\n\n<a name=\"3\"></a>\n<h4>Extra Regeneration Required to Populate Materials</h4>\n<p>One of the issues we took a look at during the DevLab at AU last Tuesday was the list of materials attached to a newly duplicated symbol.</p>\n<p>At first glance, it appeared that a duplicated family symbol had zero entries in its list of materials, whereas the original symbols material list was correctly populated.\n\n<p>On further exploration, we discovered that this is another case of retrieving stale data after a model modification.\n\n<p>The behaviour is easily rectified by a call to regenerate the model after the symbol duplication.\n\n<p>Here is the final implementation of the external command implementing to test the issue.\nIt expects a structural steel column to be pre-selected, which is a family instance whose associated symbol has exactly one entry in its materials list.\nWe duplicate the symbol.\nThis requires defining a new name.\nTo simplify repeated testing, we generate a new name by simply appending the clock tick counter to the original one.\nDirectly after the call to Duplicate, the new symbol's material list has zero entries, which makes no sense for this kind of symbol.\nA call to Regenerate fixes that:</p>\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Command</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">UIApplication</span> uiapp = commandData.Application;\n    <span class=\"teal\">UIDocument</span> uidoc = uiapp.ActiveUIDocument;\n    <span class=\"teal\">Application</span> app = uiapp.Application;\n    <span class=\"teal\">Document</span> doc = uidoc.Document;\n    <span class=\"teal\">Selection</span> sel = uidoc.Selection;\n    <span class=\"teal\">FamilyInstance</span> inst = <span class=\"blue\">null</span>;\n \n    <span class=\"blue\">if</span>( 1 == sel.Elements.Size )\n    {\n      <span class=\"blue\">foreach</span>( <span class=\"teal\">Element</span> e <span class=\"blue\">in</span> sel.Elements )\n      {\n        inst = e <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n \n        <span class=\"blue\">break</span>;\n      }\n    }\n \n    <span class=\"blue\">if</span>( <span class=\"blue\">null</span> == inst )\n    {\n      message = <span class=\"maroon\">\"Please select one \"</span>\n        + <span class=\"maroon\">\"single structural column\"</span>;\n \n      <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Failed;\n    }\n \n    <span class=\"blue\">using</span>( <span class=\"teal\">Transaction</span> tx\n      = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc ) )\n    {\n      tx.Start( <span class=\"maroon\">\"Duplicate Symbol\"</span> );\n \n      <span class=\"teal\">FamilySymbol</span> symbol = inst.Symbol;\n \n      <span class=\"blue\">string</span> name = symbol.Name\n        + <span class=\"teal\">DateTime</span>.Now.Ticks.ToString();\n \n      <span class=\"blue\">int</span> nMaterialsBefore\n        = symbol.Materials.Size;\n \n      symbol = inst.Symbol.Duplicate( name )\n        <span class=\"blue\">as</span> <span class=\"teal\">FamilySymbol</span>;\n \n      <span class=\"green\">// The model is in a temporary state that does </span>\n      <span class=\"green\">// not make sense. Regenerate to clean this up.</span>\n \n      <span class=\"blue\">int</span> nMaterialsAfter\n        = symbol.Materials.Size;\n \n      doc.Regenerate();\n \n      nMaterialsAfter = symbol.Materials.Size;\n \n      <span class=\"teal\">Debug</span>.Assert(\n        nMaterialsAfter.Equals( nMaterialsBefore ),\n        <span class=\"maroon\">\"why does the material get lost, please?\"</span> );\n \n      tx.Commit();\n    }\n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>For completeness' sake, here is\n\n<a href=\"zip/DuplicatedSymbolLosesMaterial.zip\">\nDuplicatedSymbolLosesMaterial.zip</a> containing\n\nthe complete source code, Visual Studio solution and add-in manifest of this little test command.</p>\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0866_extra_transaction",
    "header_text": "Extra Regeneration Required to Populate Materials",
    "local_header_href": "#extra-regeneration-required-to-populate-materials",
    "chunk_text": "<h4>Extra Regeneration Required to Populate Materials</h4><p>One of the issues we took a look at during the DevLab at AU last Tuesday was the list of materials attached to a newly duplicated symbol.</p><p>At first glance, it appeared that a duplicated family symbol had zero entries in its list of materials, whereas the original symbols material list was correctly populated.\n\n<p>On further exploration, we discovered that this is another case of retrieving stale data after a model modification.\n\n<p>The behaviour is easily rectified by a call to regenerate the model after the symbol duplication.\n\n<p>Here is the final implementation of the external command implementing to test the issue.\nIt expects a structural steel column to be pre-selected, which is a family instance whose associated symbol has exactly one entry in its materials list.\nWe duplicate the symbol.\nThis requires defining a new name.\nTo simplify repeated testing, we generate a new name by simply appending the clock tick counter to the original one.\nDirectly after the call to Duplicate, the new symbol's material list has zero entries, which makes no sense for this kind of symbol.\nA call to Regenerate fixes that:</p>\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Command</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">UIApplication</span> uiapp = commandData.Application;\n    <span class=\"teal\">UIDocument</span> uidoc = uiapp.ActiveUIDocument;\n    <span class=\"teal\">Application</span> app = uiapp.Application;\n    <span class=\"teal\">Document</span> doc = uidoc.Document;\n    <span class=\"teal\">Selection</span> sel = uidoc.Selection;\n    <span class=\"teal\">FamilyInstance</span> inst = <span class=\"blue\">null</span>;\n \n    <span class=\"blue\">if</span>( 1 == sel.Elements.Size )\n    {\n      <span class=\"blue\">foreach</span>( <span class=\"teal\">Element</span> e <span class=\"blue\">in</span> sel.Elements )\n      {\n        inst = e <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n \n        <span class=\"blue\">break</span>;\n      }\n    }\n \n    <span class=\"blue\">if</span>( <span class=\"blue\">null</span> == inst )\n    {\n      message = <span class=\"maroon\">\"Please select one \"</span>\n        + <span class=\"maroon\">\"single structural column\"</span>;\n \n      <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Failed;\n    }\n \n    <span class=\"blue\">using</span>( <span class=\"teal\">Transaction</span> tx\n      = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc ) )\n    {\n      tx.Start( <span class=\"maroon\">\"Duplicate Symbol\"</span> );\n \n      <span class=\"teal\">FamilySymbol</span> symbol = inst.Symbol;\n \n      <span class=\"blue\">string</span> name = symbol.Name\n        + <span class=\"teal\">DateTime</span>.Now.Ticks.ToString();\n \n      <span class=\"blue\">int</span> nMaterialsBefore\n        = symbol.Materials.Size;\n \n      symbol = inst.Symbol.Duplicate( name )\n        <span class=\"blue\">as</span> <span class=\"teal\">FamilySymbol</span>;\n \n      <span class=\"green\">// The model is in a temporary state that does </span>\n      <span class=\"green\">// not make sense. Regenerate to clean this up.</span>\n \n      <span class=\"blue\">int</span> nMaterialsAfter\n        = symbol.Materials.Size;\n \n      doc.Regenerate();\n \n      nMaterialsAfter = symbol.Materials.Size;\n \n      <span class=\"teal\">Debug</span>.Assert(\n        nMaterialsAfter.Equals( nMaterialsBefore ),\n        <span class=\"maroon\">\"why does the material get lost, please?\"</span> );\n \n      tx.Commit();\n    }\n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>For completeness' sake, here is\n\n<a href=\"zip/DuplicatedSymbolLosesMaterial.zip\">\nDuplicatedSymbolLosesMaterial.zip</a> containing\n\nthe complete source code, Visual Studio solution and add-in manifest of this little test command.</p>\n</p></p></p>"
  }
]