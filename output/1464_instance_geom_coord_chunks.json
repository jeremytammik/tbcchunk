[
  {
    "original_filename": "1464_instance_geom_coord",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<title>The Building Coder</title>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"/>\n<link rel=\"stylesheet\" type=\"text/css\" href=\"3dwc.css\"/>\n<script src=\"https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?autoload=true\" defer=\"defer\"></script>\n</head>\n\n<!---\n\nhttp://jeremytammik.github.io/tbc/a/1464_instance_geom_coord.html\n\nVoodoo Magic Retrieves Global Instance Edges #revitapi #3dwebcoder @AutodeskRevit @AutodeskForge #aec #bim\n\nI recently shared Scott Wilson's reference stable representation magic voodoo, and you may have asked yourself what use it is. Well, here is one example making effective use of it, raised and solved by Ola Gunnar Skippervik of Multiconsult\n&ndash; Goal: retrieve family instance edge to create direct shape\n&ndash; Snooping the family instance geometry\n&ndash; Partial answer and suggestion\n&ndash; Confirmation\n&ndash; Summary\n&ndash; Structural concrete setout point add-in...\n\n-->"
  },
  {
    "original_filename": "1464_instance_geom_coord",
    "header_text": "Voodoo Magic Retrieves Global Instance Edges",
    "local_header_href": "#voodoo-magic-retrieves-global-instance-edges",
    "chunk_text": "### Voodoo Magic Retrieves Global Instance Edges\n\nI recently shared\nScott Wilson's [reference stable representation magic voodoo](http://thebuildingcoder.typepad.com/blog/2016/04/stable-reference-string-magic-voodoo.html),\nand you may have asked yourself what use it is.\n\nWell, here is one example making effective use of it, raised and solved by Ola Gunnar Skippervik\nof [Multiconsult](http://www.multiconsult.no),\none of the leading firms of consulting engineers and designers in Norway.\n\n- [Goal: retrieve family instance edge to create direct shape](#2)\n- [Snooping the family instance geometry](#3)\n- [Answer](#4)\n- [Confirmation](#5)\n- [Summary](#6)\n- [Structural concrete setout point add-in](#7)"
  },
  {
    "original_filename": "1464_instance_geom_coord",
    "header_text": "<a name=\"2\"></a>Goal: Retrieve Family Instance Edge to Create Direct Shape",
    "local_header_href": "#a-name2agoal-retrieve-family-instance-edge-to-create-direct-shape",
    "chunk_text": "#### <a name=\"2\"></a>Goal: Retrieve Family Instance Edge to Create Direct Shape\n\nI have been programing on an add-on for Revit for my company over some time now. One function that I am trying to implement is to create setout lines (separate objects that can during export to DWG be placed on separate layers).\n \nThe workflow that I have tried to implement is as follows:\n\n1. Select edges\n2. Extract the Curve from the Edge\n3. Use `WireframeBuilder` to create a `DirectShape` from the curves\n\nWhat I just experienced was that for some structural foundations (it is the same family type the is used for all of my instances) this code is for some of my instances producing a direct shape with the global geometry of the foundation, and sometimes it is reading the local geometry in my structural foundation, causing the Direct shape to be inserted near the project basepoint.\n\nHere are two structural foundations of the same type:\n\n<center>\n<img src=\"img/instance_edges_1.jpeg\" alt=\"Structural foundations\" width=\"796\">\n</center>\n\nRetrieving some of their bottom edges produces the desired direct shape:\n\n<center>\n<img src=\"img/instance_edges_2.jpeg\" alt=\"DirectShape\" width=\"696\">\n</center>\n\nOn other instances, retrieving their bottom edges produces a direct shape at the project base point instead:\n\n<center>\n<img src=\"img/instance_edges_3.png\" alt=\"DirectShape at base point\" width=\"895\">\n</center>\n\nObviously, the family instance geometry is sometimes retrieved in global project coordinates, and sometimes in local family definition coordinates.\n\nQ1: How can I be sure to always get the global geometry to put into the DirectShape?\n\nQ2: Can you please point me in the right direction when I wish to select the Edge of a curved surface that is joined tangentially with the next surface (also to be used in the same manner as described above)?"
  },
  {
    "original_filename": "1464_instance_geom_coord",
    "header_text": "<a name=\"3\"></a>Snooping the Family Instance Geometry",
    "local_header_href": "#a-name3asnooping-the-family-instance-geometry",
    "chunk_text": "#### <a name=\"3\"></a>Snooping the Family Instance Geometry\n\nIâ€™ve been snooping two objects that produce different behaviour. This is what I found so far:\n \nThe family instances on which I can retrieve the global geometry have direct geometry objects:\n\n<center>\n<img src=\"img/instance_edges_4.png\" alt=\"Snooping the family instance geometry\" width=\"1753\">\n</center>\n \nThe other ones have geometry instances, from which the geometry objects have to be retrieved in a second step:\n\n<center>\n<img src=\"img/instance_edges_5.png\" alt=\"Snooping the family instance geometry\" width=\"1907\">\n</center>\n\nThe problematic geometry seems to be nested deeper in the latter element. Why so? If I copy the element that behaves as I expected, the new element also works fine. If I add a new instance (place structural foundation or create similar) the new instance the element gets the nested properties.\n \nQ3: Why are the elements built up differently?\n \nQ4: How can I implement a solution that produces geometry at the globally same place as I picked the edge?"
  },
  {
    "original_filename": "1464_instance_geom_coord",
    "header_text": "<a name=\"4\"></a>Answer",
    "local_header_href": "#a-name4aanswer",
    "chunk_text": "#### <a name=\"4\"></a>Answer\n\nSome family instances can make use of the unmodified symbol geometry generated by the family definition.\n\nIn that case, they can obtain their geometry from the `GeometryInstance` object, and share it with other instances.\n\nIn other cases, the geometry may need some modification for a specific instance, so it cannot be shared.\n\nIn that case, the instance generates its own geometry.\n\nThe discussion on\n[GetInstanceGeometry Overhead and Invalid References](http://thebuildingcoder.typepad.com/blog/2012/12/getinstancegeometry-overhead-references-and-exceptions.html) points out some differences between the `GetSymbolGeometry` and `GetInstanceGeometry` methods that can be used to access these different geometry collections.\n\nOther developers have encountered similar problems in the past distinguishing between local and global coordinated retrieved from family instances, as you can see from\nthe [Revit API discussion forum](http://forums.autodesk.com/t5/revit-api/bd-p/160) thread\non [converting local family instance coordinate of selected edge to project coordinates](http://forums.autodesk.com/t5/revit-api/convert-local-family-instance-coordinate-of-selected-edge-to/m-p/6282821).\n\nIn it, Scott Wilson provides a solution making use of\nsome [reference stable representation magic voodoo](http://thebuildingcoder.typepad.com/blog/2016/04/stable-reference-string-magic-voodoo.html).\n\nMight that come in useful for you too?\n\nLater, I noticed that I encountered and solved this exact same problem myself in a more direct and offical manner without the use of any voodoo magic for \nmy [structural concrete setout point add-in](#7) discussed below."
  },
  {
    "original_filename": "1464_instance_geom_coord",
    "header_text": "<a name=\"5\"></a>Confirmation",
    "local_header_href": "#a-name5aconfirmation",
    "chunk_text": "#### <a name=\"5\"></a>Confirmation\n\nThank you!\n \nI implemented the `GetInstanceEdgeFromSymbolRef` method suggested by the Voodoo Magic, and everything works like a charm!\n\nThis was something that I would not be able to come up with myself.\n \nOnce again, thank you! You saved the day!"
  },
  {
    "original_filename": "1464_instance_geom_coord",
    "header_text": "<a name=\"6\"></a>Summary",
    "local_header_href": "#a-name6asummary",
    "chunk_text": "#### <a name=\"6\"></a>Summary\n\nWhat I wanted the add-in to do was the following:\n\n1. Let the user select some edges in the model (typical some characteristic edges on the structure, to be used for generating set-out data/lines for the contractor when exported to dwg or dxf).\n2. Create a new geometry object that can represent the set-out data (lines)\n \nThis is done by:\n\n1. Extract edges\n2. Get the Curves form the edges\n3. Add curves to `WireframeBuilder`\n4. Add the geometry from the wireframe builder to a direct shape\n \nWhat I experienced was that for some instances I got the global geometry, and for other I got the local geometry. This caused some serious headache, because after some time I understood that I had to use `GetGeometryInstance` to collect the whole bunch of geometry from the element, but then I had no clue how to find the right curve corresponding to the selected edge. This was fixed by the method `GetInstanceEdgeFromSymbolRef`.\n \nHowever, when I selected an edge on an element where the geometry was stored directly in the element, the method cast an error due to the fact that the `tokenList` count was only 3, not 6 as for the others.\n\n<center>\n<img src=\"img/instance_edges_6.png\" alt=\"TokenList count\" width=\"1036\">\n</center>\n\nMy solution to this was to add an `if` test for the count of the `tokenList` to the method:\n\n<center>\n<img src=\"img/instance_edges_7.png\" alt=\"TokenList count\" width=\"722\">\n</center>\n\nI hope this proves useful for others as well!\n\nMany thanks to Ola Gunnar for his useful sample and confirmation!"
  },
  {
    "original_filename": "1464_instance_geom_coord",
    "header_text": "<a name=\"7\"></a>Structural Concrete Setout Point Add-In",
    "local_header_href": "#a-name7astructural-concrete-setout-point-add-in",
    "chunk_text": "#### <a name=\"7\"></a>Structural Concrete Setout Point Add-In\n\nBy the way, talking about set-out geometry, I once implemented a full-fledged \n[structural concrete setout point add-in](http://thebuildingcoder.typepad.com/blog/2012/08/structural-concrete-setout-point-add-in.html),\nlater [migrated to Revit 2015](http://thebuildingcoder.typepad.com/blog/2014/11/concrete-setout-points-for-revit-structure-2015.html)\nand hosted in the [GitHub SetoutPoints repository](https://github.com/jeremytammik/SetoutPoints).\n\nIt is a Revit add-in for automatic placement and management of structural concrete setout points.\n\nHere is some more on its history:\n\n- [Melbourne DevLab](http://thebuildingcoder.typepad.com/blog/2012/03/melbourne-devlab.html)\n- [Commercial use of the SetoutPoints application](http://thebuildingcoder.typepad.com/blog/2013/01/basic-file-info-and-rvt-file-version.html)\n- [Revit API forum discussion thread on Jeremy's SetoutPoints](http://forums.autodesk.com/t5/revit-api/jeremy-s-setoutpoint/m-p/5372337)\n\nIn the forum discussion, the exact same issue as above is raised and solved to ensure that all points are placed correctly in the global coordinate system using \na [more direct and officially supported approach](http://thebuildingcoder.typepad.com/blog/2014/11/concrete-setout-points-for-revit-structure-2015.html) without \nany voodoo magic  :-)\n\nNow it just remains to compare the two approaches and determine which is better, simpler and more reliable."
  }
]