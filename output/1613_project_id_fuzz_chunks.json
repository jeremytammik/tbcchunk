[
  {
    "original_filename": "1613_project_id_fuzz",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n<link rel=\"stylesheet\" type=\"text/css\" href=\"bc.css\">\n<!--\n<script src=\"run_prettify.js\" type=\"text/javascript\"></script>\n<script src=\"https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js\" type=\"text/javascript\"></script>\n-->\n<script src=\"https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js\" type=\"text/javascript\"></script>\n</head>\n\n<!---\n\n- 13713081 [the Unique Id in ProjectInformation is same in different project files]\n\n- exact comparison is impossible\n  13710363 [Problem with the function Curve.Intersect(Curve)]\n  https://forums.autodesk.com/t5/revit-api-forum/problem-with-the-function-curve-intersect-curve/m-p/7632649\n\nProject identifier and fuzzy comparison in #RevitAPI @AutodeskRevit #bim #dynamobim @AutodeskForge #ForgeDevCon http://bit.ly/projectidfuzz\n\nI bring up two recurring topics, fresh every time around\n&ndash; Project identifier\n&ndash; Fuzzy comparison versus exact arithmetic for curve intersection...\n\n--->"
  },
  {
    "original_filename": "1613_project_id_fuzz",
    "header_text": "Project Identifier and Fuzzy Comparison",
    "local_header_href": "#project-identifier-and-fuzzy-comparison",
    "chunk_text": "### Project Identifier and Fuzzy Comparison\n\nI bring up two recurring topics...\n\nFresh every time around:\n\n- [Project identifier](#2)\n- [Fuzzy comparison versus exact arithmetic for curve intersection](#3)\n\n\n####<a name=\"2\"></a>Project Identifier\n\n**Question:** I have a problem with the unique id for `Document.ProjectInformation`.\n\nIf I create two Revit project files from the same Revit template file, the project information unique ids are identical.\n\nHow can I get the different unique ids for different project files, even when they are created from the same template?\n\n**Answer:** As far as I know you cannot.\n\nI am not aware of any way to change an existing unique id.\n\nFurthermore, even if you could change it, how are you going to guarantee that an end user does not copy an existing project file later on to reuse in another different project, thus again duplicating the existing unique id?\n\nTherefore, I would suggest that you create your own personal project identifier that you can control as you yourself see fit, in a way that perfectly matches your own requirements.\n\nI implemented such a system for The Building Coder\nusing [named `GUID` storage for project identification](http://thebuildingcoder.typepad.com/blog/2016/04/named-guid-storage-for-project-identification.html).\n\nI am not saying that my solution is perfect.\n\nFurthermore, it is completely untested, as far as I know.\n\nIf anyone has made using of this or enhanced it in any way, please let us know.\n\nThank you!\n\n\n####<a name=\"3\"></a>Fuzzy Comparison versus Exact Arithmetic for Curve Intersection\n\nAn interesting discussion ensued in \nthe [Revit API discussion forum](http://forums.autodesk.com/t5/revit-api-forum/bd-p/160) thread on\na [problem with the function `Curve.Intersect(Curve)`](https://forums.autodesk.com/t5/revit-api-forum/problem-with-the-function-curve-intersect-curve/m-p/7632649):\n\n**Question:**\n\nI have a problem when I use this function with 2 lines intersecting each other in the case where they are parallel:\n\n<pre class=\"code\">\n&nbsp;&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;pt1&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">XYZ</span>();\n&nbsp;&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;pt2&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">XYZ</span>(&nbsp;1,&nbsp;0,&nbsp;0&nbsp;);\n&nbsp;&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;pt3&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">XYZ</span>(&nbsp;-1,&nbsp;0,&nbsp;0&nbsp;);\n \n&nbsp;&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>&nbsp;scr&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Line</span>.CreateBound(&nbsp;pt1,&nbsp;pt2&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;.Intersect(&nbsp;<span style=\"color:#2b91af;\">Line</span>.CreateBound(&nbsp;pt1,&nbsp;pt3&nbsp;),&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">out</span>&nbsp;IntersectionResultArray&nbsp;ira&nbsp;);\n \n&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;scr&nbsp;==&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Overlap&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;monMessage&nbsp;+=&nbsp;<span style=\"color:#a31515;\">&quot;\\n&nbsp;Case&nbsp;1&nbsp;overlap&quot;</span>&nbsp;+&nbsp;DonneXYZ(&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ira.get_Item(&nbsp;0&nbsp;).XYZPoint&nbsp;);\n \n&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;scr&nbsp;==&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Disjoint&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;monMessage&nbsp;+=&nbsp;<span style=\"color:#a31515;\">&quot;\\n&nbsp;Case&nbsp;1&nbsp;disjoint&quot;</span>;\n \n&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;scr&nbsp;!=&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Overlap&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;scr&nbsp;!=&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Disjoint&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;monMessage&nbsp;+=&nbsp;<span style=\"color:#a31515;\">&quot;\\n&nbsp;Case&nbsp;1&nbsp;problem&quot;</span>;\n</pre>\n\nThis returns the Case 1, which is a problem (not overlap, not disjoint).\n\nIf the 2 lines are not parallel to each other, the result is overlap (correct):\n\n<pre class=\"code\">\n&nbsp;&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;pt4&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">XYZ</span>(&nbsp;0,&nbsp;1,&nbsp;0&nbsp;);\n\n&nbsp;&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>&nbsp;scr2&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Line</span>.CreateBound(&nbsp;pt1,&nbsp;pt2&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;.Intersect(&nbsp;<span style=\"color:#2b91af;\">Line</span>.CreateBound(&nbsp;pt1,&nbsp;pt4&nbsp;),&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">out</span>&nbsp;IntersectionResultArray&nbsp;ira2&nbsp;);\n \n&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;scr2&nbsp;==&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Overlap&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;monMessage&nbsp;+=&nbsp;<span style=\"color:#a31515;\">&quot;\\n&nbsp;Case&nbsp;2&nbsp;overlap&quot;</span>&nbsp;+&nbsp;DonneXYZ(&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ira2.get_Item(&nbsp;0&nbsp;).XYZPoint&nbsp;);\n \n&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;scr2&nbsp;==&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Disjoint&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;monMessage&nbsp;+=&nbsp;<span style=\"color:#a31515;\">&quot;\\n&nbsp;Case&nbsp;2&nbsp;disjoint&quot;</span>;\n \n&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;scr2&nbsp;!=&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Overlap&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;scr&nbsp;!=&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Disjoint&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;monMessage&nbsp;+=&nbsp;<span style=\"color:#a31515;\">&quot;\\n&nbsp;Case&nbsp;2&nbsp;problem&quot;</span>;\n</pre>\n\nI also tried to get a curve with tangent parallel with the other curve:\n\n<pre class=\"code\">\n&nbsp;&nbsp;<span style=\"color:#2b91af;\">Arc</span>&nbsp;myArc&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Arc</span>.Create(&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">XYZ</span>(&nbsp;0,&nbsp;1,&nbsp;0&nbsp;),&nbsp;1.0,&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;-0.5&nbsp;*&nbsp;<span style=\"color:#2b91af;\">Math</span>.PI,&nbsp;0.0,&nbsp;<span style=\"color:#2b91af;\">XYZ</span>.BasisX,&nbsp;<span style=\"color:#2b91af;\">XYZ</span>.BasisY&nbsp;);\n \n&nbsp;&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>&nbsp;scr3&nbsp;=&nbsp;myArc.Intersect(&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">Line</span>.CreateBound(&nbsp;pt1,&nbsp;pt3&nbsp;),\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">out</span>&nbsp;IntersectionResultArray&nbsp;ira3&nbsp;);\n \n&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;scr3&nbsp;==&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Overlap&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;monMessage&nbsp;+=&nbsp;<span style=\"color:#a31515;\">&quot;\\n&nbsp;Case&nbsp;2&nbsp;overlap&nbsp;&quot;</span>&nbsp;+&nbsp;DonneXYZ(&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ira3.get_Item(&nbsp;0&nbsp;).XYZPoint&nbsp;);\n \n&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;scr3&nbsp;==&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Disjoint&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;monMessage&nbsp;+=&nbsp;<span style=\"color:#a31515;\">&quot;\\n&nbsp;Case&nbsp;2&nbsp;disjoint&quot;</span>;\n \n&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;scr3&nbsp;!=&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Overlap&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;scr&nbsp;!=&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Disjoint&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;monMessage&nbsp;+=&nbsp;<span style=\"color:#a31515;\">&quot;\\n&nbsp;Case&nbsp;2&nbsp;problem&quot;</span>;\n</pre>\n\nThis result is also correct (overlap).\n\nSo, it appears that the only incorrect result is when you have 2 parallel lines.\n\nThis causes problems in my code (unexpected errors that I have to deal with) so if this could be fixed if would be great!\n\n**Answer:** You say that you have a problem with the intersection of two parallel lines?\n\n<pre>\n  Point P = (-1,0,0)\n  Point O = (0,0,0)\n  Point Q = (0,0,+1)\n  Line A from P to O\n  Line B from O to Q\n</pre>\n\nThese two lines have one single common point in (0,0,0).\n\nWhether that is to be considered an intersection depends completely on your point of view.\n\nIf the lines are considered as closed sets of points in space, they intersect in one point.\n\nIf they are considered as open sets in space, they do not intersect.\n\nBoth of these way of looking at geometrical elements are completely valid.\n\nMathematically speaking, you can consider this equivalent question:\n\nDo the two intervals [-1,0] and [0,1] intersect?\n\n- The two closed intervals [-1,0] and [0,1] do intersect, in one single point 0.\nThe intersection is infinitesimally small and has a volume of zero.\n- The two open intervals (-1,0) and (0,1) do not intersect.\n- There is also no intersection between the two intervals if one of them is open and the second closed.\n\nThese cases can only be distinguished precisely\nusing [exact arithmetic](https://stackoverflow.com/questions/24352127/exact-arithmetic-in-c),\naka [arbitrary precision arithmetic](https://en.wikipedia.org/wiki/Arbitrary-precision_arithmetic).\n\n<center>\n<img src=\"img/exact_arithmetic.jpg\" alt=\"Exact arithmetic\" width=\"650\"/>\n</center>\n\nThe Revit API, just like most other current geometrical programming environments, does not specify which paradigm is considered valid.\n\nIn fact, it cannot, because it does not work with exact arithmetic.\n\nAs long as we are working with imprecise double precision floating point numbers, these two cases cannot be distinguished.\n\nThe line A is considered totally equivalent to the line\n\n<pre>\n  Line A' from P to (-0.000000000000000000001,0,0)\n</pre>\n\nWhat result would you consider correct for that case?\n\nRemember, lines A and A' must be considered completely identical in all respects!\n\nThe only way I see for you to handle your problem properly using inexact floating point arithmetic is to perform\na [fuzzy comparison](http://thebuildingcoder.typepad.com/blog/2017/06/sensors-bim-ai-revitlookup-and-fuzzy-comparison.html#4) of\nthe edge cases such as these.\n\nI would say that this is not a bug, and there is no way to decide whether parallel lines that meet in one single point intersect or not.\n\nAny such attempt would be completely pointless  :-)\n\nYour software needs to be implemented in a way that takes this possibility into account.\n\nExact comparison would be required to answer this precisely.\n\nThis is definitely not possible using floating point arithmetic.\n\n**Response:** Your explanation is interesting.\n\nStill, the bottom of the problem remains:\n\nThe way this is coded in Revit makes the results of very similar intersection problems inconsistent. \n\n- Case 1 : intersection between [(0,0) ; (1,0)] and [(0,0) ; (-1,0)] returns neither overlap nor disjoint.\n- Case 2 : intersection between [(0,0) ; (1,0)] and [(0,0) ; (0,1)] returns overlap.\n- Case 3 : intersection between [(0,0) ; (1,0)] and the arc of centre (0,10E9) and of radius 10E9 ending in (0,0) (which is locally a Line) returns overlap.\n\nThis problem arises only for Line which are parallel, not for the other types of Curves.\n\nAs I explained, this causes unexpected errors which should be avoided and can be difficult to find.\n\nSo, I believe the `Curve.Intersect` method should be updated on this particular point.\n\nExcept if there is a better argument not to do so...\n\n**Answer:** As you can tell, I find the topic interesting and really want to help find a satisfactory solution.\n\nIf this only applies to parallel lines, I would suggest solving it for that case, because it is not hard to do.\n\nI added `IsParallel` and `IsCollinear` predicates to The Building Coder samples for this:\n\n<pre class=\"code\">\n  <span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">bool</span>&nbsp;IsParallel(&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;p,&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;q&nbsp;)\n  {\n  &nbsp;&nbsp;<span style=\"color:blue;\">return</span>&nbsp;p.CrossProduct(&nbsp;q&nbsp;).IsZeroLength();\n  }\n   \n  <span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">bool</span>&nbsp;IsCollinear(&nbsp;<span style=\"color:#2b91af;\">Line</span>&nbsp;a,&nbsp;<span style=\"color:#2b91af;\">Line</span>&nbsp;b&nbsp;)\n  {\n  &nbsp;&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;v&nbsp;=&nbsp;a.Direction;\n  &nbsp;&nbsp;<span style=\"color:#2b91af;\">XYZ</span>&nbsp;w&nbsp;=&nbsp;b.Origin&nbsp;-&nbsp;a.Origin;\n  &nbsp;&nbsp;<span style=\"color:blue;\">return</span>&nbsp;IsParallel(&nbsp;v,&nbsp;b.Direction&nbsp;)\n  &nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;IsParallel(&nbsp;v,&nbsp;w&nbsp;);\n  }\n</pre>\n\nThe next step would be to check for the overlap including the required fuzziness in case lines are collinear.\n\nI also discussed this with the development team, and they say:\n\nI believe the documentation covers this case and the return is [`SetComparisonResult.Subset`](http://www.revitapidocs.com/2018.1/3310a68d-b67a-79cb-ea54-deb00d9f60d9.htm):\n\n> The inputs are parallel lines with only one common intersection point, or the curve used to invoke the intersection check is a line entirely within the unbound line passed as argument curve. If the former, the output argument has the details of the intersection point.\n\nThe customer didn't indicate what the return value was for them; if it is subset, that matches what we have told them it would be.\n\n**Response:** Indeed, using `SetcomparisonResult.Subset` works for my problem and is much more elegant than my previous workaround solution (which was, in essence: check if `SetComparisonResult` is either `Overlap` or `Disjoint`; if not, check if the 2 elements are line, collinear, and have same end; if so, treat the case as `Overlap`).\n\nThe improved test is now:\n\n<pre class=\"code\">\n&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;scr&nbsp;!=&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Overlap\n&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;scr&nbsp;!=&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Disjoint\n&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;!(&nbsp;scr&nbsp;==&nbsp;<span style=\"color:#2b91af;\">SetComparisonResult</span>.Subset&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;ira.Size&nbsp;==&nbsp;1&nbsp;)&nbsp;)\n</pre>"
  }
]