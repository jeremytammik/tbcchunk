[
  {
    "original_filename": "0728_remove_dwf_link",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0728_remove_dwf_link",
    "header_text": "Remove DWF Links",
    "local_header_href": "#remove-dwf-links",
    "chunk_text": "<h3>Remove DWF Links</h3><p>I spent this weekend in Chamonix with my brother Nick.\nWe did one day of rock climbing in the valley at Les Gaillants and Servoz doing \n\n<a href=\"http://www.highmountainguides.com/index.php/eng/Gallery/Chamonix-Rock-Climbing/Chamonix-Rock-Climbing-Gallery/Surbac-a-Bras-6a-Servoz\">\nSurbac a' Bras</a>, 6a+, and one day of skiing with Chris down the \n\n<a href=\"http://fr.wikipedia.org/wiki/Vall%C3%A9e_Blanche\">\nVallee Blanche</a>,\n\n<a href=\"http://fr.wikipedia.org/wiki/Mer_de_Glace\">\nMer de Glace</a> and\n\n<a href=\"http://fr.wikipedia.org/wiki/Montenvers\">\nMontenvers</a> from the \n\n<a href=\"http://fr.wikipedia.org/wiki/T%C3%A9l%C3%A9ph%C3%A9rique_de_l%27aiguille_du_Midi\">\nTelepherique</a> de \n\n<a href=\"http://fr.wikipedia.org/wiki/Aiguille_du_Midi\">\nl'Aiguille du Midi</a>.\n\n<p>Our route from the telepherique actually joins the Vallee Blanche via the steep looking descent at the extreme right of this picture, with a sharp ridge crossing it diagonally, the upper half in sunshine, and the lower in shadow:</p>\n<center>\n<img alt=\"Nick and Jeremy in the Vallee Blanche at Chamonix\" src=\"file:////j/photo/jeremy/2012/2012-03-04_vallee_blanche/WP_000578_nick_jeremy.jpg\" width=\"400\"/>\n</center>\n<p>I had a fall and a hundred meter slide coming down that steep incline, which was interesting and a bit painful.\n\n<p>Returning to the Revit API, I recently explored how to \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2012/02/remove-imported-jpg-and-bmp-images.html\">\nremove imported JPG and BMP images</a>.\n\nSoon afterwards, another query on removing file references in the model showed up.\nIn my naivety, I assumed that the solution would be similar.\nFar failed, as we shall shortly see:\n\n<p><strong>Question:</strong> I want to remove all DWF links from a RVT file. \nI can remove RVT and DWG links but cannot figure out how to do the same for DWF and did not find any way on the web, help file or API examples.\n\n<p><strong>Answer:</strong> I looked at your sample model which includes a couple of DWF mark-up objects:</p>\n<center>\n<img alt=\"DWF mark-up elements\" src=\"img/remove_dwf_link.png\"/>\n</center>\n<p>I used the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/05/pre-post-and-pick-select.html\">\nelement lister</a> on\n\nit to create an overview of all its elements in a text file. \nThe result shows an obvious way to identify at least some of the DWF import instances by using their category name, which includes the substring \".dwfx\" (copy to an editor to see the truncated lines in full):\n\n<pre>\nId=161300; Class=ImportInstance; Category=Project1.dwfx[Sheet: A101 - Unnamed]; Name=Markup Object 3 1;\nId=161301; Class=ImportInstance; Category=Project1.dwfx[Sheet: A101 - Unnamed]; Name=Markup Object 2 1;\nId=161302; Class=ImportInstance; Category=Project1.dwfx[Sheet: A101 - Unnamed]; Name=Markup Object 1 1;\n</pre>\n<p>Searching for other objects with a dwf substring in their category name, I discovered the following element types:\n\n<pre>\nId=161219; Class=ElementType; Category=Project1.dwfx[Sheet: A101 - Unnamed]; Name=Project1.dwfx[Sheet: A101 - Unnamed]; \nId=161278; Class=ElementType; Category=Project1.dwfx[Sheet: A101 - Unnamed]; Name=Markup Object 3 1; \nId=161279; Class=ElementType; Category=Project1.dwfx[Sheet: A101 - Unnamed]; Name=Markup Object 2 1; \nId=161280; Class=ElementType; Category=Project1.dwfx[Sheet: A101 - Unnamed]; Name=Markup Object 1 1; \n</pre>\n<p>Apparently, there is one main element type for the file reference itself, then one element type and one import instance for each of its occurrences in the model.\n\n<p>I tried to use this information and an approach similar to the one described for the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2012/02/remove-imported-jpg-and-bmp-images.html\">\nremoval of image files</a> to\n\ndelete them from the model.\n\n<p>Analogously to the ElementNameEndsWithJpg predicate checking the element name, I implemented ElementCategoryContainsDwf which retrieves and checks the category name for the DWF substring.\nIt returns true if the given element category name contains the substring \".dwf\":\n\n<pre class=\"code\">\n<span class=\"blue\">bool</span> ElementCategoryContainsDwf( <span class=\"teal\">Element</span> e )\n{\n  <span class=\"blue\">return</span> ( <span class=\"blue\">null</span> != e.Category )\n    &amp;&amp; e.Category.Name.ToLower()\n      .Contains( <span class=\"maroon\">\".dwf\"</span> );\n}\n</pre>\n<p>I then implemented the algorithm which first retrieves and deletes the non-ElementType objects fulfilling this criterion, followed by the element type ones, but the call to doc.Delete with their ids simply returns null and does nothing.\n\n<p>I noted that the DWF mark-up elements are pinned, so I added code to unpin them prior to the deletion attempt:\n\n<pre class=\"code\">\n<span class=\"blue\">int</span> Unpin( <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt; ids, <span class=\"teal\">Document</span> doc )\n{\n  <span class=\"blue\">int</span> count = 0;\n \n  <span class=\"blue\">foreach</span>( <span class=\"teal\">ElementId</span> id <span class=\"blue\">in</span> ids )\n  {\n    <span class=\"teal\">Element</span> e = doc.get_Element( id );\n    <span class=\"blue\">if</span>( e.Pinned )\n    {\n      e.Pinned = <span class=\"blue\">false</span>;\n      ++count;\n    }\n  }\n  <span class=\"blue\">return</span> count;\n}\n</pre>\n<p>Unfortunately, that still did not help.\n\n<p>The new command CmdRemoveDwfLinks in The Building Coder samples that I implemented to demonstrate the working solution provided below includes the code for this failed attempt, in case you are interested, but I will omit it here for the sake of brevity.\nIt may be of use if you ever run into the need to unpin a set of elements, for example.\n\n<p>Just as I was about to give up and ask for help, I discovered a previous case that provides a hint:\n\n<p>\"Trying to delete the markup element will not work using the Document.Delete method, because you cannot delete that kind of element directly through the user interface either, like you would a wall or door.  \nInstead, you have to launch the Manage &gt; Manage Links dialogue and remove the markup there.  \nIn the API, this can be achieved using the ExternalFileUtils class.\"\n\n<p>I implemented a new method RemoveDwfLinkUsingExternalFileUtils and a call to execute it to the external command CmdRemoveDwfLinks to test this.\nIt removes all DWF links from the model and returns the total number of deleted elements:\n\n<pre class=\"code\">\n<span class=\"blue\">int</span> RemoveDwfLinkUsingExternalFileUtils(\n  <span class=\"teal\">Document</span> doc )\n{\n  <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt; idsToDelete\n    = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt;();\n \n  <span class=\"teal\">ICollection</span>&lt;<span class=\"teal\">ElementId</span>&gt; ids = <span class=\"teal\">ExternalFileUtils</span>\n    .GetAllExternalFileReferences( doc );\n \n  <span class=\"blue\">foreach</span>( <span class=\"teal\">ElementId</span> id <span class=\"blue\">in</span> ids )\n  {\n    <span class=\"teal\">Element</span> e = doc.get_Element( id );\n \n    <span class=\"teal\">Debug</span>.Print( <span class=\"teal\">Util</span>.ElementDescription( e ) );\n \n    <span class=\"teal\">ExternalFileReference</span> xr = <span class=\"teal\">ExternalFileUtils</span>\n      .GetExternalFileReference( doc, id );\n \n    <span class=\"teal\">ExternalFileReferenceType</span> xrType\n      = xr.ExternalFileReferenceType;\n \n    <span class=\"blue\">if</span>( xrType == <span class=\"teal\">ExternalFileReferenceType</span>.DWFMarkup )\n    {\n      <span class=\"teal\">ModelPath</span> xrPath = xr.GetPath();\n \n      <span class=\"blue\">string</span> path = <span class=\"teal\">ModelPathUtils</span>\n        .ConvertModelPathToUserVisiblePath( xrPath );\n \n      <span class=\"blue\">if</span>( path.EndsWith( <span class=\"maroon\">\".dwf\"</span> )\n        || path.EndsWith( <span class=\"maroon\">\".dwfx\"</span> ) )\n      {\n        idsToDelete.Add( id );\n      }\n    }\n  }\n \n  <span class=\"blue\">int</span> n = idsToDelete.Count;\n \n  <span class=\"teal\">ICollection</span>&lt;<span class=\"teal\">ElementId</span>&gt; idsDeleted = <span class=\"blue\">null</span>;\n \n  <span class=\"blue\">if</span>( 0 &lt; n )\n  {\n    <span class=\"blue\">using</span>( <span class=\"teal\">Transaction</span> t = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc ) )\n    {\n      t.Start( <span class=\"maroon\">\"Delete DWFx Links\"</span> );\n \n      idsDeleted = doc.Delete( idsToDelete );\n \n      t.Commit();\n    }\n  }\n \n  <span class=\"blue\">int</span> m = ( <span class=\"blue\">null</span> == idsDeleted )\n    ? 0\n    : idsDeleted.Count;\n \n  <span class=\"teal\">Debug</span>.Print( <span class=\"blue\">string</span>.Format(\n    <span class=\"maroon\">\"Selected {0} DWF external file reference{1}, \"</span>\n    + <span class=\"maroon\">\"{2} element{3} successfully deleted.\"</span>,\n    n, <span class=\"teal\">Util</span>.PluralSuffix( n ), m, <span class=\"teal\">Util</span>.PluralSuffix( m ) ) );\n \n  <span class=\"blue\">return</span> m;\n}\n</pre>\n<p>Here is the complete code of the external command mainline Execute method calling both the initial non-functional RemoveDwfLinkUsingDelete and the new working RemoveDwfLinkUsingExternalFileUtils methods:\n\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n  <span class=\"teal\">ExternalCommandData</span> commandData,\n  <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n  <span class=\"teal\">ElementSet</span> elements )\n{\n  <span class=\"teal\">UIApplication</span> uiapp = commandData.Application;\n  <span class=\"teal\">UIDocument</span> uidoc = uiapp.ActiveUIDocument;\n  <span class=\"teal\">Document</span> doc = uidoc.Document;\n \n  <span class=\"blue\">if</span>( doc.IsFamilyDocument )\n  {\n    <span class=\"teal\">Util</span>.ErrorMsg(\n      <span class=\"maroon\">\"This command requires an active document.\"</span> );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Failed;\n  }\n \n  <span class=\"blue\">int</span> nDeleted = RemoveDwfLinkUsingDelete( doc );\n \n  <span class=\"blue\">int</span> nDeleted2 = RemoveDwfLinkUsingExternalFileUtils( doc );\n \n  <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n}\n</pre>\n<p>This seems to do the trick for me all right.\n\n<p>The new code in RemoveDwfLinkUsingExternalFileUtils is significantly shorter and simpler than the failed initial attempt using the Delete method directly, besides having the advantage of functioning  :-)\n\n<p>It also turns out that far more elements than just the seven listed above that I found by searching the element and category names for the DWF substring are deleted by the removal of the DWF file reference.\nIn fact, a total of 25 elements are affected.\n\n<p>Running the CmdRemoveDwfLinks external command on it produces the following messages in the Visual Studio debug output window:\n\n<pre>\nElement &lt;117704 Standard&gt;\nProject1.dwfx[Sheet: A101 - Unnamed] &lt;161219 Project1.dwfx[Sheet: A101 - Unnamed]&gt;\nSelected 1 DWF external file reference, 25 elements successfully deleted.\n</pre>\n<p>Here is \n\n<a href=\"zip/bc_12_98.zip\">\nversion 2012.0.98.0</a> of\n\nThe Building Coder samples including the new command.\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  }
]