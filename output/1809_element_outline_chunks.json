[
  {
    "original_filename": "1809_element_outline",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n<link rel=\"stylesheet\" type=\"text/css\" href=\"bc.css\">\n<script src=\"https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js\" type=\"text/javascript\"></script>\n<script async src=\"https://platform.twitter.com/widgets.js\" charset=\"utf-8\"></script>\n</head>\n\n<!---\n\n\ntwitter:\n\nHappy New Year to the Revit add-in developer community! \n\nDetermine 2D plan view outer boundary of a room in XY including all bounding element geometry, ExtrusionAnalyzer versus Clipper 2D Booleans for birds-eye element view polygons in the #RevitAPI #DynamoBim @AutodeskForge @AutodeskRevit #bim #ForgeDevCon http://bit.ly/elementoutline\n\nHappy New Year to the Revit add-in developer community!\nMy main holiday project was the implementation of an external command to determine the 2D plan view outer boundary of a room in the XY plane, including all its bounding elements' geometry\n&ndash; How to generate a 2D polygon representing the birds-eye view of an element\n&ndash; <code>CmdExtrusionAnalyzer</code> element outline using <code>ExtrusionAnalyzer</code>\n&ndash; <code>Cmd2dBoolean</code> element outline using 2D Booleans\n&ndash; <code>CmdRoomOuterOutline</code> outer room outline using 2D Booleans...\n\nlinkedin:\n\nHappy New Year to the Revit add-in developer community! \n\nDetermine 2D plan view outer boundary of a room in XY  including all bounding element geometry.\n\nExtrusionAnalyzer versus Clipper 2D Booleans for birds-eye element view polygons in the #RevitAPI\n\nhttp://bit.ly/elementoutline\n\nMy main holiday project was the implementation of an external command to determine the 2D plan view outer boundary of a room in the XY plane, including all its bounding elements' geometry\n\n- How to generate a 2D polygon representing the birds-eye view of an element\n- CmdExtrusionAnalyzer element outline using ExtrusionAnalyzer\n- Cmd2dBoolean element outline using 2D Booleans\n- CmdRoomOuterOutline outer room outline using 2D Booleans...\n\n#bim #DynamoBim #ForgeDevCon #Revit #API #IFC #SDK #AI #VisualStudio #Autodesk #AEC #adsk\n\nthe [Revit API discussion forum](http://forums.autodesk.com/t5/revit-api-forum/bd-p/160) thread\n\n<p style=\"font-size: 80%; font-style:italic\"></p>\n\n-->"
  },
  {
    "original_filename": "1809_element_outline",
    "header_text": "Extrusion Analyser and 2D Boolean Element Outline",
    "local_header_href": "#extrusion-analyser-and-2d-boolean-element-outline",
    "chunk_text": "### Extrusion Analyser and 2D Boolean Element Outline\n\nHappy New Year to the Revit add-in developer community!\n\nMy main holiday project was the addition of a new external command `CmdRoomOuterOutline` to\nthe [ElementOutline add-in](https://github.com/jeremytammik/ElementOutline).\n\n`CmdRoomOuterOutline` determines the 2D plan view outer boundary of a room in the XY plane, including all its bounding elements' geometry.\n\nThe idea for this was prompted by\nthe [Revit API discussion forum](http://forums.autodesk.com/t5/revit-api-forum/bd-p/160) threads\non [room boundary polygons](https://forums.autodesk.com/t5/revit-api-forum/room-boundary-polygons/m-p/9157379),\n[CreateViaOffset to offset room boundary inwards or outwards](https://forums.autodesk.com/t5/revit-api-forum/createviaoffset/m-p/9159500) and\n[CreateViaOffset taking a list of offset distances](https://forums.autodesk.com/t5/revit-api-forum/createviaoffset-curveloop-original-ilist-lt-double-gt/m-p/9196659).\n\nBefore we get to the new command, though, let's discuss some other more basic aspects and functionality of this add-in:\n\n- [Task &ndash; 2D polygon representing birds-eye view of an element](#2)\n- [CmdExtrusionAnalyzer](#3)\n- [Alternative approaches to determine 2D element outline](#4)\n- [Cmd2dBoolean](#5)\n- [CmdRoomOuterOutline](#6)\n\nThe add-in implements three external commands:\n\n- [CmdExtrusionAnalyzer](#3) &ndash; generate element outline using `ExtrusionAnalyzer`\n- [Cmd2dBoolean](#5) &ndash; generate element outline using 2D Booleans\n- [CmdRoomOuterOutline](#6) &ndash; outer room outline using 2D Booleans\n\nAll three generate element outlines of various types in various ways.\n\nThe first uses the Revit API and \nthe [`ExtrusionAnalyzer` class](https://www.revitapidocs.com/2020/ba9e3283-6868-8834-e8bf-2ea9e7358930.htm).\n\nThe other two make use of\nthe [Clipper integer coordinate based 2D Boolean operations library](http://angusj.com/delphi/clipper.php).\n\nThe add-in also implements a bunch of utilities for converting Revit coordinates to 2D data in millimetre units and displaying the resulting element outlines in a Windows form."
  },
  {
    "original_filename": "1809_element_outline",
    "header_text": "<a name=\"2\"></a>Task &ndash; 2D Polygon Representing Birds-Eye View of an Element",
    "local_header_href": "#a-name2atask-ndash-2d-polygon-representing-birds-eye-view-of-an-element",
    "chunk_text": "#### <a name=\"2\"></a>Task &ndash; 2D Polygon Representing Birds-Eye View of an Element\n\nThe goal is to export the 2D outlines of Revit `Element` instances, i.e., for each element, associate its element id or unique id with the list of X,Y coordinates describing a polygon representing the visual birds-eye view look of its outline.\n\nAdditional requirements:\n\n- Address family instances as well as elements that might be built as part of the construction, including wall, floor, railing, ceiling, mechanical duct, panel, plumbing pipe.\n- Generate a separate outline in place for each element, directly in its appropriate location and orientation.\n- Output the result in a simple text file.\n\nThere is no need for a rendered view, just coordinates defining a 2D polygon around the element.\n\nThe goal is: given an element id, retrieve a list of X,Y coordinates describing the birds-eye view look of an element.\n\n<!--\nFor instance, here are three sample images highlighting the bathtubs, doors and toilets, respectively, in a given floor of a building:\n\nBathtubs:\n\n<center>\n<img src=\"img/birdseye_view_bathtubs.png\" alt=\"Bathtubs\" title=\"Bathtubs\" width=\"300\"/>\n</center>\n\nDoors:\n\n<center>\n<img src=\"img/birdseye_view_internal_doors.png\" alt=\"Doors\" title=\"Doors\" width=\"300\"/>\n</center>\n\nToilets:\n\n<center>\n<img src=\"img/birdseye_view_toilets.png\" alt=\"Toilets\" title=\"Toilets\" width=\"300\"/>\n</center>\n-->\n\nFor instance, here is an apartment layout showing a birdseye view of bathtubs, doors, toilets and other accessories:\n\n<center>\n<img src=\"img/apartment_layout.png\" alt=\"Apartment layout showing birdseye view of accessories\" title=\"Apartment layout showing birdseye view of accessories\" width=\"400\"/> <!-- 1100 -->\n</center>\n\nIn end effect, we generate a dictionary mapping an element id or unique id to a list of space delimited pairs of X Y vertex coordinates in millimetres."
  },
  {
    "original_filename": "1809_element_outline",
    "header_text": "<a name=\"3\"></a>CmdExtrusionAnalyzer",
    "local_header_href": "#a-name3acmdextrusionanalyzer",
    "chunk_text": "#### <a name=\"3\"></a>CmdExtrusionAnalyzer\n\nThis code was originally implemented as part of (and later extracted from)\nthe [RoomEditorApp project](https://github.com/jeremytammik/RoomEditorApp).\n\nThe approach implemented for the room editor is not based on the 2D view, but on the element geometry solids in the 3D view and the result of applying\nthe [`ExtrusionAnalyzer` class](https://www.revitapidocs.com/2020/ba9e3283-6868-8834-e8bf-2ea9e7358930.htm) to them,\ncreating a vertical projection of the 3D element shape onto the 2D XY plane.\nThis approach is described in detail in the discussion on\nthe [extrusion analyser and plan view boundaries](https://thebuildingcoder.typepad.com/blog/2013/04/extrusion-analyser-and-plan-view-boundaries.html).\n\nThe [GeoSnoop .NET boundary curve loop visualisation](https://thebuildingcoder.typepad.com/blog/2013/04/geosnoop-net-boundary-curve-loop-visualisation.html) provides\nsome example images of the resulting outlines.\n\nAs you can see there, the outline generated is more precise and detailed than the standard 2D Revit representation.\n\nThe standard plan view of the default desk and chair components look like this in Revit:\n\n<center>\n<img src=\"img/desk_and_chair_plan.png\" alt=\"Plan view of desk and chair in Revit\" title=\"Plan view of desk and chair in Revit\" width=\"318\"/>\n</center>\n\nThe loops exported by the RoomEditorApp add-in for the same desk and chair look like this instead:\n\n<center>\n<img src=\"img/desk_and_chair_loops.png\" alt=\"Desk and chair loops in GeoSnoop\" title=\"Desk and chair loops in GeoSnoop\" width=\"318\"/>\n</center>\n\nE.g., for the desk, you notice the little bulges for the desk drawer handles sticking out a little bit beyond the desktop surface.\n\nFor the chair, the arm rests are missing, because the solids used to model them do not make it through the extrusion analyser, or maybe because the code ignores multiple disjunct loops.\n\nHere is a sample model with four elements highlighted in blue:\n\n<center>\n<img src=\"img/element_outline_four_selected_extrusion_analyser_svg_path.png\" alt=\"Four elements selected for extrusion analyser\" title=\"Four elements selected for extrusion analyser\" width=\"300\"/>\n</center>\n\nFor them, the CmdExtrusionAnalyzer command generates the following JSON file defining their outline polygon in SVG format:\n\n<pre>\n{\"name\":\"pt2+20+7\", \"id\":\"576786\", \"uid\":\"bc43ed2e-7e23-4f0e-9588-ab3c43f3d388-0008cd12\", \"svg_path\":\"M-56862 -9150 L-56572 -9150 -56572 -14186 -56862 -14186Z\"}\n{\"name\":\"pt70/210\", \"id\":\"576925\", \"uid\":\"bc43ed2e-7e23-4f0e-9588-ab3c43f3d388-0008cd9d\", \"svg_path\":\"M-55672 -11390 L-55672 -11290 -55656 -11290 -55656 -11278 -55087 -11278 -55087 -11270 -55076 -11270 -55076 -11242 -55182 -11242 -55182 -11214 -55048 -11214 -55048 -11270 -55037 -11270 -55037 -11278 -54988 -11278 -54988 -11290 -54972 -11290 -54972 -11390Z\"}\n{\"name\":\"pt80/115\", \"id\":\"576949\", \"uid\":\"bc43ed2e-7e23-4f0e-9588-ab3c43f3d388-0008cdb5\", \"svg_path\":\"M-56572 -10580 L-56572 -9430 -55772 -9430 -55772 -10580Z\"}\n{\"name\":\"מנוע מזגן מפוצל\", \"id\":\"576972\", \"uid\":\"bc43ed2e-7e23-4f0e-9588-ab3c43f3d388-0008cdcc\", \"svg_path\":\"M-56753 -8031 L-56713 -8031 -56713 -8018 -56276 -8018 -56276 -8031 -56265 -8031 -56265 -8109 -56276 -8109 -56276 -8911 -56252 -8911 -56252 -8989 -56276 -8989 -56276 -9020 -56277 -9020 -56278 -9020 -56711 -9020 -56713 -9020 -56713 -8989 -56753 -8989 -56753 -8911 -56713 -8911 -56713 -8109 -56753 -8109Z\"}\n</pre>\n\n`M`, `L` and `Z` stand for `moveto`, `lineto` and `close`, respectively. Repetitions of `L` can be omitted. Nice and succinct.\n\nHowever, the extrusion analyser approach obviously fails for all elements that do not define any solids, e.g., 2D elements represented only by curves and meshes.\n\nHence the continued research to find an alternative approach and the implementation of `Cmd2dBoolean` described below making use of the Clipper library and 2D Booleans instead.\n\nIn July 2019, I checked with the development team and asked whether they could suggest a better way to retrieve the 2D outline of an element.\n\nThey responded that my `ExtrusionAnalyzer` approach seems like the best (and maybe only) way to achieve this right now.\n\nConsidering Cmd2dBoolean, I might add the caveat 'using the Revit API' to the last statement."
  },
  {
    "original_filename": "1809_element_outline",
    "header_text": "<a name=\"4\"></a>Alternative Approaches to Determine 2D Element Outline",
    "local_header_href": "#a-name4aalternative-approaches-to-determine-2d-element-outline",
    "chunk_text": "#### <a name=\"4\"></a>Alternative Approaches to Determine 2D Element Outline\n\nThe `ExtrusionAnalyzer` approach based on element solids does not successfully address the task of generating the 2D birds-eye view outline for all Revit elements.\n\nI therefore explored other avenues.\n\nConcave hull: \n\n- http://ubicomp.algoritmi.uminho.pt/local/concavehull.html\n- https://towardsdatascience.com/the-concave-hull-c649795c0f0f\n- https://github.com/kubkon/powercrust\n- https://adared.ch/concaveman-cpp-a-very-fast-2d-concave-hull-maybe-even-faster-with-c-and-python/\n- https://www.codeproject.com/Articles/1201438/The-Concave-Hull-of-a-Set-of-Points\n- http://www.cs.ubc.ca/research/flann/\n  \n2D outline:\n\n- https://github.com/eppz/Unity.Library.eppz.Geometry\n- https://github.com/eppz/Clipper\n- https://github.com/eppz/Triangle.NET\n- https://en.wikipedia.org/wiki/Sweep_line_algorithm\n- https://stackoverflow.com/questions/4213117/the-generalization-of-bentley-ottmann-algorithm\n- https://ggolikov.github.io/bentley-ottman/\n- Joining unordered line segments &ndash; https://stackoverflow.com/questions/1436091/joining-unordered-line-segments\n- http://www3.cs.stonybrook.edu/~algorith/implement/sweep/implement.shtml\n- https://github.com/mikhaildubov/Computational-geometry/blob/master/2)%20Any%20segments%20intersection/src/ru/dubov/anysegmentsintersect/SegmentsIntersect.java\n- https://github.com/jeremytammik/wykobi/blob/master/wykobi_naive_group_intersections.inl\n\nAlpha shape:\n\n- https://en.wikipedia.org/wiki/Alpha_shape\n- https://pypi.org/project/alphashape/\n- https://alphashape.readthedocs.io/\n\nI determined that some elements have no solids, just meshes, hence the extrusion analyser approach cannot be used.\n\nLooked at the [alpha shape implementation here](https://pypi.org/project/alphashape).\n\nI worked on a 2D contour outline following algorithm, but it turned out quite complex.\n\nI had another idea for a much simpler approach using 2D Boolean operations, uniting all the solid faces and mesh faces into one single 2D polygon set.\n\n- Join all line segments into closed polygons\n- Union all the polygons using Clipper\n\nThat seems to return robust results."
  },
  {
    "original_filename": "1809_element_outline",
    "header_text": "<a name=\"5\"></a>Cmd2dBoolean",
    "local_header_href": "#a-name5acmd2dboolean",
    "chunk_text": "#### <a name=\"5\"></a>Cmd2dBoolean\n\nI completed a new poly2d implementation using 2D Booleans instead of the solids and extrusion analyser.\nI expect it is significantly faster.\n\nThe ElementOutline release 2020.0.0.10 exports outlines from both solids and 2D Booleans and generates identical results for both, so that is a good sign.\n\nMaybe meshes and solids cover all requirements.\nI am still experimenting and testing.\nWhat is missing besides meshes and solids?\n\nI tested successfully on an intercom element.\nIt is not a mesh, just a circle, represented by a full closed arc.\nI implemented support to include circles as well as solids and meshes in the Boolean operation.\n\nI also implemented a utility `GeoSnoop` to display the loops generated in a temporary Windows form.\n\nHere is an image showing part of a sample Revit model in the middle including a wall, bathtub and intercom element and two GeoSnoop windows:\n\n<center>\n<img src=\"img/geosnoop_solids_versus_booleans.png\" alt=\"GeoSnoop outlines generated from solids versus 2D Booleans\" title=\"GeoSnoop outlines generated from solids versus 2D Booleans\" width=\"800\"/>\n</center>\n\nThe left GeoSnoop window shows the outline loops retrieved from the solids using the extrusion analyser.\nThe right one shows the loops retrieved from the 2D Booleans, including closed arcs.\nNote the differences in the intercom and the bathtub drain.\n\nMy target is to continue enhancing the 2D Booleans until they include all the solid loop information, so that we can then get rid of the solid and extrusion analyser code.\n\nMaybe all I need to do is to use LevelOfDetail = Fine?\n\n<pre class=\"code\">\n  Options opt = new Options\n  {\n    IncludeNonVisibleObjects = true,\n    DetailLevel = ViewDetailLevel.Fine\n  };\n  GeometryElement geomElem = element.get_Geometry(opt);\n</pre>\n\nI might try again with fine detail level.\nHowever, the circle already looks pretty good to me.\nIn fact, right now, I think all I need is there, in the combination of the two approaches. \n\nThe first image was generated by capturing data from a 2D view.\nCapturing the 2D Booleans from a 3D view gives us all we need, I think.\n\nTested a few use-cases and it seems to be working fine.\n\nCurrently, the production pipeline uses an implementation in Python based on\nthe [Shapely library](https://github.com/Toblerity/Shapely) for\nmanipulation and analysis of geometric objects to `union()` the triangles. \n\nSince it is slower, it would be better to switch to Clipper."
  },
  {
    "original_filename": "1809_element_outline",
    "header_text": "<a name=\"6\"></a>CmdRoomOuterOutline",
    "local_header_href": "#a-name6acmdroomouteroutline",
    "chunk_text": "#### <a name=\"6\"></a>CmdRoomOuterOutline\n\nI implemented the third command `CmdRoomOuterOutline` after an unsuccessful attempt at generating the outer outline of a room including its bounding elements\nby [specifying a list of offsets to `CreateViaOffset`](https://thebuildingcoder.typepad.com/blog/2019/12/dashboards-createviaoffset-and-room-outline-algorithms.html#3).\n\nAfter that failure, I suggested a number of alternative approaches \nto [determine the room outline including surrounding walls](https://thebuildingcoder.typepad.com/blog/2019/12/dashboards-createviaoffset-and-room-outline-algorithms.html#4).\n\n**Question:** I started to look at the possibility of tracing the outside of the walls several weeks ago, when I was at a loss utilising `CreateViaOffset`.\n\nI was finding it difficult to create the closed loop necessary, and particularly how I would achieve this were the wall thickness changes across its length.\n\nCould you point me in the right direction, possibly some sample code that I could examine and see if I could get it to work to my requirements.\n\n**Answer:** I see several possible alternative approaches avoiding the use of `CreateViaOffset`, based on:\n\n- Room boundary curves and wall thicknesses\n- Room boundary curves and wall bottom face edges\n- Projection of 3D union of room and wall solids\n- 2D union of room and wall footprints\n\nThe most immediate and pure Revit API approach would be to get the curves representing the room boundaries, determine the wall thicknesses, offset the wall boundary curves outwards by wall thickness plus minimum offset, and ensure that everything is well connected by adding small connecting segments in the gaps where the offset jumps.\n\nSeveral slightly more complex pure Revit API approaches could be designed by using the wall solids instead of just offsetting the room boundary curves based on the wall thickness. For instance, we could query the wall bottom face for its edges, determine and patch together all the bits of edge segments required to go around the outside of the wall instead of the inside.\n\nSlightly more complex still, and still pure Revit API: determine the room closed shell solid, unite it with all the wall solids, and make use of the extrusion analyser to project this union vertically onto the XY plane and grab its outside edge.\n\nFinally, making use of a minimalistic yet powerful 2D Boolean operation library, perform the projection onto the XY plane first, and unite the room footprint with all its surrounding wall footprints in 2D instead. Note that the 2D Booleans are integer based. To make use of those, I convert the geometry from imperial feet units using real numbers to integer-based millimetres.\n\nThe two latter approaches are both implemented in\nmy [ElementOutline add-in](https://github.com/jeremytammik/ElementOutline).\n\nI mentioned it here in two previous threads:\n\n- [Question regarding SVG data](https://forums.autodesk.com/t5/revit-api-forum/question-regarding-svg-data-from-revit/m-p/9106146)\n- [How do I get the outline and stakeout path of a built-in loft family](https://forums.autodesk.com/t5/revit-api-forum/how-do-i-get-the-outline-and-stakeout-path-of-a-built-in-loft/m-p/9148138)\n\nProbably all the pure Revit API approaches will run into various problematic exceptional cases, whereas the 2D Booleans seem fast, reliable and robust and may well be able to handle all the exceptional cases that can possibly occur, so I would recommend trying that out first.\n\nI ended up implementing my suggestion in the new external command `CmdRoomOuterOutline`.\n\nIt makes use of the 2D Boolean outline generation functionality implemented for Cmd2dBoolean, adding code to generate a polygon for the room boundary and unite it with all the bounding elements.\n\nIt successfully handles the wall width sample model:\n\n<center>\n<img src=\"img/wall_width_loop_using_2d_booleans.png\" alt=\"Wall width sample loop\" title=\"Wall width sample loop\" width=\"500\"/>\n</center>\n\nIt also gracefully handles the room separator situation:\n\n<center>\n<img src=\"img/room_separator_using_2d_booleans.png\" alt=\"Room separator sample loop\" title=\"Room separator sample loop\" width=\"500\"/>\n</center>"
  },
  {
    "original_filename": "1809_element_outline",
    "header_text": "<a name=\"7\"></a>Conclusion",
    "local_header_href": "#a-name7aconclusion",
    "chunk_text": "#### <a name=\"7\"></a>Conclusion\n\nAs you can see, the 2D Boolean approach provides a highly robust and flexible method to solve almost any kind of element outlining task.\n\nI look forward to hearing your feedback and suggestions for improvements.\n\nPlease submit them as pull requests to \nthe [ElementOutline GitHub repository](https://github.com/jeremytammik/ElementOutline).\n\nThank you!\n\nHappy continuation of 2020 to all!"
  }
]