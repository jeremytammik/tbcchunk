[
  {
    "original_filename": "1422_named_guid_storage",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n<link rel=\"stylesheet\" type=\"text/css\" href=\"bc.css\">\n<script src=\"run_prettify.js\" type=\"text/javascript\"></script>\n<!--\n<script src=\"https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js\" type=\"text/javascript\"></script>\n-->\n</head>\n\n<!---\n\nNamed Guid Storage for Project Identification #revitAPI #3dwebcoder @AutodeskRevit #adsk #aec #bim\n\nI want to continue working on the TrackChangesCloud project asap.\nSo far, it only consists of the Revit add-in to determine and list the changes made to the BIM.\nThe interesting part will be to store the results in a cloud database for analysis and reporting.\nA prerequisite for that is a reliable way to identify Revit project documents.\nI already explored that topic when starting to implement the FireRatingCloud sample...\n\n-->"
  },
  {
    "original_filename": "1422_named_guid_storage",
    "header_text": "Named Guid Storage for Project Identification",
    "local_header_href": "#named-guid-storage-for-project-identification",
    "chunk_text": "### Named Guid Storage for Project Identification\n\nI want to continue working on\nthe [TrackChangesCloud](https://github.com/jeremytammik/TrackChangesCloud) project asap.\n\nSo far, it only consists of the Revit add-in to determine and list the changes made to the BIM.\n\nThe interesting part will be to store the results in a cloud database for analysis and reporting.\n\nA prerequisite for that is a reliable way to identify Revit project documents.\n\nI already explored that topic\nwhen [starting to implement](http://thebuildingcoder.typepad.com/blog/2015/07/firerating-and-the-revit-python-shell-in-the-cloud-as-web-servers.html#4)\nthe [FireRatingCloud](https://github.com/jeremytammik/FireRatingCloud) sample, writing\nabout [implementing Mongo database relationships](http://the3dwebcoder.typepad.com/blog/2015/07/implementing-mongo-database-relationships.html)\nand [identifying a RVT project](http://the3dwebcoder.typepad.com/blog/2015/07/implementing-mongo-database-relationships.html#2).\n\nI was not completely happy with that solution, and have not heard of any really perfect way to achieve what I want, so I decided to try a different tack this time:\n\nSimply create my own Guid for the current Revit project and use that to identify it globally forever after.\n\nActually, I decided for a slightly more generic approach, supporting 'named Guid storage'.\n\nI define an extensible storage schema named `JtNamedGuidStorageSchema` that just stores one single Guid object.\n\nTo create a new project identifier, I create a GUID and store it in an extensible storage entity with that schema on a Revit `DataStorage` element with a specific element name, e.g., `TrackChanges_project_identifier`.\n\nTo search for an existing project identifier, I can filter for all data storage elements with extensible storage entities containing data matching our specific schema and with the given element name.\n\nOne danger in this approach is that an existing project that already defines its own identifier might be copied to one or more follow-up projects so that its identifier is retained and reused.\n\nAh well, I guess I will live with that."
  },
  {
    "original_filename": "1422_named_guid_storage",
    "header_text": "<a name=\"2\"></a>JtNamedGuidStorage Implementation Class",
    "local_header_href": "#a-name2ajtnamedguidstorage-implementation-class",
    "chunk_text": "#### <a name=\"2\"></a>JtNamedGuidStorage Implementation Class\n\nHere is the new `JtNamedGuidStorage` class that I just implemented and added\nto [The Building Coder samples](https://github.com/jeremytammik/the_building_coder_samples):\n\n\n<pre class=\"code\">\n<span class=\"blue\">class</span> <span class=\"teal\">JtNamedGuidStorage</span>\n{\n&nbsp; <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n&nbsp; <span class=\"gray\">///</span><span class=\"green\"> The extensible storage schema, </span>\n&nbsp; <span class=\"gray\">///</span><span class=\"green\"> containing one single Guid field.</span>\n&nbsp; <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n&nbsp; <span class=\"blue\">public</span> <span class=\"blue\">static</span> <span class=\"blue\">class</span> <span class=\"teal\">JtNamedGuidStorageSchema</span>\n&nbsp; {\n&nbsp; &nbsp; <span class=\"blue\">public</span> <span class=\"blue\">readonly</span> <span class=\"blue\">static</span> <span class=\"teal\">Guid</span> SchemaGuid = <span class=\"blue\">new</span> <span class=\"teal\">Guid</span>(\n&nbsp; &nbsp; &nbsp; <span class=\"maroon\">&quot;{5F374308-9C59-42AE-ACC3-A77EF45EC146}&quot;</span> );\n&nbsp;\n&nbsp; &nbsp; <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n&nbsp; &nbsp; <span class=\"gray\">///</span><span class=\"green\"> Retrieve our extensible storage schema </span>\n&nbsp; &nbsp; <span class=\"gray\">///</span><span class=\"green\"> or optionally create a new one if it does</span>\n&nbsp; &nbsp; <span class=\"gray\">///</span><span class=\"green\"> not yet exist.</span>\n&nbsp; &nbsp; <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n&nbsp; &nbsp; <span class=\"blue\">public</span> <span class=\"blue\">static</span> <span class=\"teal\">Schema</span> GetSchema(\n&nbsp; &nbsp; &nbsp; <span class=\"blue\">bool</span> create = <span class=\"blue\">true</span> )\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; <span class=\"teal\">Schema</span> schema = <span class=\"teal\">Schema</span>.Lookup( SchemaGuid );\n&nbsp;\n&nbsp; &nbsp; &nbsp; <span class=\"blue\">if</span>( create &amp;&amp; <span class=\"blue\">null</span> == schema )\n&nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; <span class=\"teal\">SchemaBuilder</span> schemaBuilder =\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=\"blue\">new</span> <span class=\"teal\">SchemaBuilder</span>( SchemaGuid );\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; schemaBuilder.SetSchemaName(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=\"maroon\">&quot;JtNamedGuidStorage&quot;</span> );\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; schemaBuilder.AddSimpleField(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=\"maroon\">&quot;Guid&quot;</span>, <span class=\"blue\">typeof</span>( <span class=\"teal\">Guid</span> ) );\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; schema = schemaBuilder.Finish();\n&nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; <span class=\"blue\">return</span> schema;\n&nbsp; &nbsp; }\n&nbsp; }\n&nbsp;\n&nbsp; <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n&nbsp; <span class=\"gray\">///</span><span class=\"green\"> Retrieve an existing named Guid </span>\n&nbsp; <span class=\"gray\">///</span><span class=\"green\"> in the specified Revit document or</span>\n&nbsp; <span class=\"gray\">///</span><span class=\"green\"> optionally create and return a new</span>\n&nbsp; <span class=\"gray\">///</span><span class=\"green\"> one if it does not yet exist.</span>\n&nbsp; <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n&nbsp; <span class=\"blue\">public</span> <span class=\"blue\">static</span> <span class=\"blue\">bool</span> Get(\n&nbsp; &nbsp; <span class=\"teal\">Document</span> doc,\n&nbsp; &nbsp; <span class=\"blue\">string</span> name,\n&nbsp; &nbsp; <span class=\"blue\">out</span> <span class=\"teal\">Guid</span> guid,\n&nbsp; &nbsp; <span class=\"blue\">bool</span> create = <span class=\"blue\">true</span> )\n&nbsp; {\n&nbsp; &nbsp; <span class=\"blue\">bool</span> rc = <span class=\"blue\">false</span>;\n&nbsp;\n&nbsp; &nbsp; guid = <span class=\"teal\">Guid</span>.Empty;\n&nbsp;\n&nbsp; &nbsp; <span class=\"green\">// Retrieve a DataStorage element with our</span>\n&nbsp; &nbsp; <span class=\"green\">// extensible storage entity attached to it</span>\n&nbsp; &nbsp; <span class=\"green\">// and the specified element name.</span>\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">ExtensibleStorageFilter</span> f\n&nbsp; &nbsp; &nbsp; = <span class=\"blue\">new</span> <span class=\"teal\">ExtensibleStorageFilter</span>(\n&nbsp; &nbsp; &nbsp; &nbsp; <span class=\"teal\">JtNamedGuidStorageSchema</span>.SchemaGuid );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">DataStorage</span> dataStorage\n&nbsp; &nbsp; &nbsp; = <span class=\"blue\">new</span> <span class=\"teal\">FilteredElementCollector</span>( doc )\n&nbsp; &nbsp; &nbsp; &nbsp; .OfClass( <span class=\"blue\">typeof</span>( <span class=\"teal\">DataStorage</span> ) )\n&nbsp; &nbsp; &nbsp; &nbsp; .WherePasses( f )\n&nbsp; &nbsp; &nbsp; &nbsp; .Where&lt;<span class=\"teal\">Element</span>&gt;( e =&gt; name.Equals( e.Name ) )\n&nbsp; &nbsp; &nbsp; &nbsp; .FirstOrDefault&lt;<span class=\"teal\">Element</span>&gt;() <span class=\"blue\">as</span> <span class=\"teal\">DataStorage</span>;\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">if</span>( dataStorage == <span class=\"blue\">null</span> )\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; <span class=\"blue\">if</span>( create )\n&nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; <span class=\"blue\">using</span>( <span class=\"teal\">Transaction</span> t = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; doc, <span class=\"maroon\">&quot;Create named Guid storage&quot;</span> ) )\n&nbsp; &nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t.Start();\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=\"green\">// Create named data storage element</span>\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dataStorage = <span class=\"teal\">DataStorage</span>.Create( doc );\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dataStorage.Name = name;\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=\"green\">// Create entity to store the Guid data</span>\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=\"teal\">Entity</span> entity = <span class=\"blue\">new</span> <span class=\"teal\">Entity</span>(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=\"teal\">JtNamedGuidStorageSchema</span>.GetSchema() );\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entity.Set( <span class=\"maroon\">&quot;Guid&quot;</span>, guid = <span class=\"teal\">Guid</span>.NewGuid() );\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class=\"green\">// Set entity to the data storage element</span>\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dataStorage.SetEntity( entity );\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t.Commit();\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rc = <span class=\"blue\">true</span>;\n&nbsp; &nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n&nbsp; &nbsp; <span class=\"blue\">else</span>\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; <span class=\"green\">// Retrieve entity from the data storage element.</span>\n&nbsp;\n&nbsp; &nbsp; &nbsp; <span class=\"teal\">Entity</span> entity = dataStorage.GetEntity(\n&nbsp; &nbsp; &nbsp; &nbsp; <span class=\"teal\">JtNamedGuidStorageSchema</span>.GetSchema( <span class=\"blue\">false</span> ) );\n&nbsp;\n&nbsp; &nbsp; &nbsp; <span class=\"teal\">Debug</span>.Assert( entity.IsValid(),\n&nbsp; &nbsp; &nbsp; &nbsp; <span class=\"maroon\">&quot;expected a valid extensible storage entity&quot;</span> );\n&nbsp;\n&nbsp; &nbsp; &nbsp; <span class=\"blue\">if</span>( entity.IsValid() )\n&nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; guid = entity.Get&lt;<span class=\"teal\">Guid</span>&gt;( <span class=\"maroon\">&quot;Guid&quot;</span> );\n&nbsp;\n&nbsp; &nbsp; &nbsp; &nbsp; rc = <span class=\"blue\">true</span>;\n&nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n&nbsp; &nbsp; <span class=\"blue\">return</span> rc;\n&nbsp; }\n}\n</pre>"
  },
  {
    "original_filename": "1422_named_guid_storage",
    "header_text": "<a name=\"3\"></a>CmdNamedGuidStorage Test Command",
    "local_header_href": "#a-name3acmdnamedguidstorage-test-command",
    "chunk_text": "#### <a name=\"3\"></a>CmdNamedGuidStorage Test Command\n\nAs you can see, the implementation defines one single public entry point `Get`.\n\nBy default, it retrieves an existing named Guid from the given Revit document, and creates a new one if none already exists.\n\nThe creation can be suppressed by passing a `false` value for the `create` argument.\n\nI exercise it in the trivial external command `CmdNamedGuidStorage` as follows:\n\n<pre class=\"code\">\n&nbsp; <span class=\"teal\">Result</span> rslt = <span class=\"teal\">Result</span>.Failed;\n&nbsp;\n&nbsp; <span class=\"blue\">string</span> name = <span class=\"maroon\">&quot;TrackChanges_project_identifier&quot;</span>;\n&nbsp; <span class=\"teal\">Guid</span> named_guid;\n&nbsp;\n&nbsp; <span class=\"blue\">bool</span> rc = <span class=\"teal\">JtNamedGuidStorage</span>.Get( doc,\n&nbsp; &nbsp; name, <span class=\"blue\">out</span> named_guid, <span class=\"blue\">false</span> );\n&nbsp;\n&nbsp; <span class=\"blue\">if</span>( rc )\n&nbsp; {\n&nbsp; &nbsp; <span class=\"teal\">Util</span>.InfoMsg( <span class=\"blue\">string</span>.Format(\n&nbsp; &nbsp; &nbsp; <span class=\"maroon\">&quot;This document already has a project &quot;</span>\n&nbsp; &nbsp; &nbsp; + <span class=\"maroon\">&quot;identifier: {0} = {1}&quot;</span>,\n&nbsp; &nbsp; &nbsp; name, named_guid.ToString() ) );\n&nbsp;\n&nbsp; &nbsp; rslt = <span class=\"teal\">Result</span>.Succeeded;\n&nbsp; }\n&nbsp; <span class=\"blue\">else</span>\n&nbsp; {\n&nbsp; &nbsp; rc = <span class=\"teal\">JtNamedGuidStorage</span>.Get( doc,\n&nbsp; &nbsp; &nbsp; name, <span class=\"blue\">out</span> named_guid, <span class=\"blue\">true</span> );\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">if</span>( rc )\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; <span class=\"teal\">Util</span>.InfoMsg( <span class=\"blue\">string</span>.Format(\n&nbsp; &nbsp; &nbsp; &nbsp; <span class=\"maroon\">&quot;Created a new project identifier &quot;</span>\n&nbsp; &nbsp; &nbsp; &nbsp; + <span class=\"maroon\">&quot;for this document: {0} = {1}&quot;</span>,\n&nbsp; &nbsp; &nbsp; &nbsp; name, named_guid.ToString() ) );\n&nbsp;\n&nbsp; &nbsp; &nbsp; rslt = <span class=\"teal\">Result</span>.Succeeded;\n&nbsp; &nbsp; }\n&nbsp; &nbsp; <span class=\"blue\">else</span>\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; <span class=\"teal\">Util</span>.ErrorMsg( <span class=\"maroon\">&quot;Something went wrong&quot;</span> );\n&nbsp; &nbsp; }\n&nbsp; }\n&nbsp; <span class=\"blue\">return</span> rslt;\n</pre>\n\nHere is the message box displayed and logged on the Visual Studio debug output console by the test command on creating a new named Guid storage:\n\n<center>\n<img src=\"img/named_guid_storage_01.png\" alt=\"Retrieving a named Guid from extensible storage on a DataStorage element\" width=\"345\">\n</center>\n\nA similar message is generated on retrieving an existing identifier:\n\n<pre>\nThis document already has a project identifier: TrackChanges_project_identifier = 4223cc56-e6ae-4ab9-92da-1da69c72bd10\n</pre>\n\nThe new functionality discussed above is included\nin [The Building Coder samples](https://github.com/jeremytammik/the_building_coder_samples)\n[release 2016.0.127.1](https://github.com/jeremytammik/the_building_coder_samples/releases/tag/2016.0.127.1).\n\nI look forward to hearing what you think of it.\nThank you in advance for any comments you may have.\n\nNow I am excited to get going with the TrackChangesCloud project again, after spending a lot of time last week answering Revit cases\nand [Revit API discussion forum](http://forums.autodesk.com/t5/revit-api/bd-p/160) questions."
  }
]