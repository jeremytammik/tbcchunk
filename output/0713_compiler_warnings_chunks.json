[
  {
    "original_filename": "0713_compiler_warnings",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0713_compiler_warnings",
    "header_text": "Eliminating Compiler Warnings and Deprecated Calls",
    "local_header_href": "#eliminating-compiler-warnings-and-deprecated-calls",
    "chunk_text": "<h3>Eliminating Compiler Warnings and Deprecated Calls</h3><p>Migrating Revit add-ins from one version to the next is a regular topic, obviously, since we are generally provided with a new release every year.\nTherefore, it is eminently sensible to ensure that an add-in is easy to migrate by avoiding use of all obsolete API functionality.\nIn some cases, you might also wish to \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2011/11/intermediate-api-update-releases.html\">\nsupport multiple versions</a>.\n\nI provided a simple example of an unusually graceful possibility to handle the differences between the Revit 2011 and 2012 \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2011/05/cascaded-events-and-renaming-the-active-document.html#2\">\nIdling event handler argument</a>.\nMost differences between different versions of the API will probably be slightly more difficult to handle as transparently as this.\n\n<p>Looking back at previous migrations, I discussed The Building Coder samples port from \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/03/porting-the-building-coder-samples-to-revit-2011.html\">\nRevit 2010 to the Revit 2011 API</a> and \n\nJoe Ye later \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/04/plugin-migration-steps.html\">\nadded more detailed information</a> on\n\nthat process.\n\n<p>The last time around, when migrating The Building Coder samples from \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2011/04/migrating-the-building-coder-samples-to-revit-2012.html\">\nRevit 2011 to 2012</a>, \n\nI provided an even more detailed description of the steps taken.\n\n<p>It still remained pretty quick and dirty, since I performed only very little random testing of the new version, just making sure that the add-in compiled correctly and a few of the numerous commands actually run.\n\n<p>So, until recently, the code was still making use of a number of deprecated API calls which caused compilation warnings.\n\n<p>I removed a few of those when updating the code accessing the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2012/01/materials-collection-and-filtering.html\">\nMaterials collection</a>, \n\nwhere I also provided the latest \n\n<span class=\"asset asset-generic at-xid-6a00e553e1689788330168e4fbbcc6970c\"><a href=\"http://thebuildingcoder.typepad.com/files/bc_12_96_3-1.zip\">version 2012.0.96.3</a></span> of \n\nthe solution.\n\n<p>The remaining warnings are caused by use of the Reference class ProximityParameter property and the FindReferencesByDirection method, which was replaced by FindReferencesWithContextByDirection.\n\n<p>Here they are in full – copy to a text editor to see the truncated lines:\n\n<pre>\nC:\\bc\\BuildingCoder\\BuildingCoder\\CmdNewSpotElevation.cs(69,11): warning CS0618: 'Autodesk.Revit.DB.Document.FindReferencesByDirection(Autodesk.Revit.DB.XYZ, Autodesk.Revit.DB.XYZ, Autodesk.Revit.DB.View3D)' is obsolete: 'This method will be removed, use FindReferencesWithContextByDirection().'\nC:\\bc\\BuildingCoder\\BuildingCoder\\CmdNewSpotElevation.cs(86,14): warning CS0618: 'Autodesk.Revit.DB.Reference.ProximityParameter' is obsolete: 'Property will be removed. Use ReferenceByContext.ProximityParameter instead (after obtaining ReferenceWithContext from Document.FindReferencesWithContextByDirection())'\nC:\\bc\\BuildingCoder\\BuildingCoder\\CmdNewSpotElevation.cs(89,21): warning CS0618: 'Autodesk.Revit.DB.Reference.ProximityParameter' is obsolete: 'Property will be removed. Use ReferenceByContext.ProximityParameter instead (after obtaining ReferenceWithContext from Document.FindReferencesWithContextByDirection())'\nC:\\bc\\BuildingCoder\\BuildingCoder\\CmdDimensionWallsFindRefs.cs(239,14): warning CS0618: 'Autodesk.Revit.DB.Document.FindReferencesByDirection(Autodesk.Revit.DB.XYZ, Autodesk.Revit.DB.XYZ, Autodesk.Revit.DB.View3D)' is obsolete: 'This method will be removed, use FindReferencesWithContextByDirection().'\nC:\\bc\\BuildingCoder\\BuildingCoder\\CmdDimensionWallsFindRefs.cs(295,17): warning CS0618: 'Autodesk.Revit.DB.Reference.ProximityParameter' is obsolete: 'Property will be removed. Use ReferenceByContext.ProximityParameter instead (after obtaining ReferenceWithContext from Document.FindReferencesWithContextByDirection())'\nC:\\bc\\BuildingCoder\\BuildingCoder\\CmdDimensionWallsFindRefs.cs(305,19): warning CS0618: 'Autodesk.Revit.DB.Reference.ProximityParameter' is obsolete: 'Property will be removed. Use ReferenceByContext.ProximityParameter instead (after obtaining ReferenceWithContext from Document.FindReferencesWithContextByDirection())'\nC:\\bc\\BuildingCoder\\BuildingCoder\\CmdDimensionWallsFindRefs.cs(308,34): warning CS0618: 'Autodesk.Revit.DB.Reference.ProximityParameter' is obsolete: 'Property will be removed. Use ReferenceByContext.ProximityParameter instead (after obtaining ReferenceWithContext from Document.FindReferencesWithContextByDirection())'\n\nCompile complete -- 0 errors, 7 warnings\n</pre>\n<p>Let's tackle those right here and now to future-proof this guy.\n\n<p>It turns out to be really simple.\n\n<p>Here is the original code snippet producing the warnings in the FindTopMostReference method in CmdNewSpotElevation.cs, which determines a reference 'ret' to the topmost face of a given element:\n\n<pre class=\"code\">\n  <span class=\"teal\">ReferenceArray</span> references\n    = doc.FindReferencesByDirection(\n      centerOfTopOfBox, viewDirection, view3D );\n\n  <span class=\"blue\">foreach</span>( <span class=\"teal\">Reference</span> r <span class=\"blue\">in</span> references )\n  {\n    <span class=\"teal\">Element</span> re = doc.GetElement( r );\n \n    <span class=\"blue\">if</span>( re.Id.IntegerValue == e.Id.IntegerValue\n      &amp;&amp; r.ProximityParameter &lt; closest )\n    {\n      ret = r;\n      closest = r.ProximityParameter;\n    }\n  }\n</pre>\n<p>Instead of FindReferencesByDirection, we now use FindReferencesWithContextByDirection.\nIt returns instances of the new ReferenceWithContext class instead of the old Reference class.\nThey are packaged in a generic .NET container, no longer making use of the obsolete custom ReferenceArray collection class.\nFinally, the ProximityParameter property has been renamed to just Proximity.\n\n<p>The old code can thus be replaced by the following equivalent new lines:\n\n<!-- making use of FindReferencesWithContextByDirection and the new ReferenceWithContext class: -->\n<pre class=\"code\">\n  <span class=\"teal\">IList</span>&lt;<span class=\"teal\">ReferenceWithContext</span>&gt; references\n    = doc.FindReferencesWithContextByDirection(\n      centerOfTopOfBox, viewDirection, view3D );\n\n  <span class=\"blue\">foreach</span>( <span class=\"teal\">ReferenceWithContext</span> r <span class=\"blue\">in</span> references )\n  {\n    <span class=\"teal\">Element</span> re = doc.GetElement( \n      r.GetReference() );\n \n    <span class=\"blue\">if</span>( re.Id.IntegerValue == e.Id.IntegerValue\n      &amp;&amp; r.Proximity &lt; closest )\n    {\n      ret = r.GetReference();\n      closest = r.Proximity;\n    }\n  }\n</pre>\n<p>I made similar changes in the other module using this same ray casting functionality, CmdDimensionWallsFindRefs.cs, and now the entire solution compiles with zero warnings.\n\n<p>Here is \n\n<a href=\"zip/bc_12_96_4.zip\">\nversion 2012.0.96.4</a> of\n\nThe Building Coder samples all deprecated API calls eliminated.\n\n<p>Most of the obsolete lines are marked with comments saying '// 2011', and their replacements are marked '// 2012'.\nIf you wish to analyse the exact differences, you can simply compare the code of this version with the \n\n<span class=\"asset asset-generic at-xid-6a00e553e1689788330168e4fbbcc6970c\"><a href=\"http://thebuildingcoder.typepad.com/files/bc_12_96_3-1.zip\">version 2012.0.96.3</a></span> mentioned above.\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  }
]