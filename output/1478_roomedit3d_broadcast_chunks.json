[
  {
    "original_filename": "1478_roomedit3d_broadcast",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<title>The Building Coder</title>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"/>\n<link rel=\"stylesheet\" type=\"text/css\" href=\"3dwc.css\"/>\n<script src=\"https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?autoload=true\" defer=\"defer\"></script>\n</head>\n\n<!---\n\n  \nRetrieving and Broadcasting the Roomedit3dv3 Translation @AutodeskForge #revitapi #3dwebcoder @AutodeskRevit #aec #bim @RTCEvents\n\nAs I discussed last week, the translation tool emits info about its activity via <code>socket.io</code>. Now I want to pick up that information higher up, in the viewer transform extension, and relay it to the node.js web server or broadcast it to the rest of the world. The existing sample call to <code>emit</code> is inside <code>onTxChange</code>, which is called on each mouse move. We do not need to track each mouse movement in such fine detail...\n\n-->"
  },
  {
    "original_filename": "1478_roomedit3d_broadcast",
    "header_text": "Retrieving and Broadcasting the Roomedit3dv3 Translation",
    "local_header_href": "#retrieving-and-broadcasting-the-roomedit3dv3-translation",
    "chunk_text": "### Retrieving and Broadcasting the Roomedit3dv3 Translation\n\nAs I discussed last week,\n[the translation tool emits info on its activity](http://thebuildingcoder.typepad.com/blog/2016/09/warning-swallower-and-roomedit3d-viewer-extension.html#3) via\n`socket.io`.\n\nNow I want to pick up that information higher up, in the viewer transform extension, and relay it to the node.js web server or broadcast it to the rest of the world.\n\nThe existing sample call to `emit` is inside `onTxChange`, which is called on each mouse move.\n\nWe do not need to track each mouse movement in such fine detail, just the beginning and end of the translation.\n\n<center>\n<img src=\"img/roomedit3dv3_broadcast.png\" alt=\"Roomedit3dv3 Forge extension in action\" width=\"385\">\n</center>\n\nLuckily, I can take a look back at the previous incarnation [roomedit3d](https://github.com/jeremytammik/roomedit3d),\nin the module [Roomedit3dTranslationTool.js](https://github.com/jeremytammik/roomedit3d/blob/master/www/js/extensions/Roomedit3dTranslationTool.js#L333-L366),\nwhere this is handled by the `handleButtonUp` function:\n\n<pre class=\"prettyprint\">\n  this.handleButtonUp = function(event, button) {\n\n    if( _isDirty && _externalId && _initialHitPoint ) {\n      var offset = subtract_point(\n        _transformControlTx.position,\n        _initialHitPoint );\n\n      _initialHitPoint = new THREE.Vector3(\n        _transformControlTx.position.x,\n        _transformControlTx.position.y,\n        _transformControlTx.position.z );\n\n      console.log( 'button up: external id '\n        + _externalId + ' offset by '\n        + pointString( offset ) );\n\n      var data = {\n        externalId : _externalId,\n        offset : offset\n      }\n\n      options.roomedit3dApi.postTransform(data);\n\n      _isDirty = false;\n    }\n\n    _isDragging = false;\n\n    if (_transformControlTx.onPointerUp(event))\n      return true;\n\n    return false;\n  };\n</pre>\n\nUsing that as a starting point for my exploration how to reproduce the same functionality in the new version, I found that this is all I need for the internal `emit` call from the translate tool to the transform extension:\n\n<pre class=\"prettyprint\">\n  handleButtonUp(event, button) {\n\n    console.log( 'transform.translate complete' );\n    \n    if (this._selection) {\n      if (this._selection.dbIdArray) {\n        var dbId = this._selection.dbIdArray[0]\n        \n        if(dbId) {\n         \n          var translation = new THREE.Vector3(\n            this._transformMesh.position.x - this._selection.model.offset.x,\n            this._transformMesh.position.y - this._selection.model.offset.y,\n            this._transformMesh.position.z - this._selection.model.offset.z)\n          \n          this._viewer.getProperties(dbId, (result) =&gt; {\n            \n            var externalId = result.externalId;\n            \n            console.log( 'transform.translate complete for '\n              + externalId\n              + ': ' + translation.x.toFixed( 2 )\n              + ','+ translation.y.toFixed( 2 )\n              + ','+ translation.z.toFixed( 2 ) );\n            \n            this.emit('transform.translate.complete', {\n              externalId: externalId,\n              translation: translation\n            })\n          });\n        }    \n      }\n    }\n    \n    this._isDragging = false\n\n    if (this._transformControlTx.onPointerUp(event))\n      return true\n\n    return false\n  }\n</pre>\n\nThis is much nicer and cleaner than my previous implementation, because I have not touched any of the other functionality or functions of the translation tool at all.\n\nTo pass on the information from the tool to the wide outside world via a `socket.io` broadcast in the viewer extension, I just added a couple of lines to its constructor:\n\n<pre class=\"prettyprint\">\nclass TransformExtension extends ExtensionBase {\n\n  /////////////////////////////////////////////////////////////////\n  // Class constructor\n  //\n  /////////////////////////////////////////////////////////////////\n  constructor (viewer, options) {\n\n    super (viewer, options)\n\n    this.translateTool = new TranslateTool(viewer)\n\n    this._viewer.toolController.registerTool(\n      this.translateTool)\n\n    this.rotateTool = new RotateTool(viewer)\n\n    this._viewer.toolController.registerTool(\n      this.rotateTool)\n    \n    this.translateTool.on('transform.translate.complete', (data) =&gt; {\n\n      console.log( 'broadcast transform of '\n        + data.externalId\n        + ': ' + data.translation.x.toFixed( 2 )\n        + ','+ data.translation.y.toFixed( 2 )\n        + ','+ data.translation.z.toFixed( 2 ) );\n      \n      var socketSvc = ServiceManager.getService('SocketSvc')\n  \n      // external id == Revit UniqueId\n      // THREE.Vector3 offset x y z\n    \n      socketSvc.broadcast('transform', data)\n      \n    })    \n  }\n  \n  // . . .\n</pre>\n\nSo things are going swimmingly on this front.\n\nI still have a bunch of other stuff to implement, test and document, though, before I can go off on my vacation next week feeling well prepared for \nthe [RTC Revit Technology Conference Europe](http://www.rtcevents.com/rtc2016eur) in Porto the week after that:\n\nIn fact, I have to go over my whole suite of samples connecting the desktop and the cloud, each consisting of a C# .NET Revit API desktop add-in and a web server:\n\n- [RoomEditorApp](https://github.com/jeremytammik/RoomEditorApp) and  the [roomeditdb](https://github.com/jeremytammik/roomedit) CouchDB\n\tdatabase and web server demonstrating real-time round-trip graphical editing of furniture family instance location and rotation plus textual editing of element properties in a simplified 2D representation of the 3D BIM.\n- [FireRatingCloud](https://github.com/jeremytammik/FireRatingCloud) and\n\tthe [fireratingdb](https://github.com/jeremytammik/firerating) node.js\n\tMongoDB web server demonstrating real-time round-trip editing of Revit element shared parameter values\n  &ndash; [Heroku](https://heroku.com) requires an update to MongoDB 3.2.\n- Update the [Roomedit3dApp](https://github.com/jeremytammik/Roomedit3dApp) Revit add-in to work with the \n  new [roomedit3dv3](https://github.com/Autodesk-Forge/forge-boilers.nodejs/tree/roomedit3d) Forge Viewer extension demonstrating translation of BIM element instances in the viewer and updating the Revit model in real time via a `socket.io` broadcast.\n\nFor the latter, I need to set up a production environment and deploy to Heroku.\n\nSo far, I have just been developing and testing in a `DEV` environment on the local machine.\n\nIt is rather complicated to connect to that from the virtual Windows machine running Revit and the add-in, though, so better to move to the real Internet and `PROD` first.\n\nWish me luck with the next steps."
  }
]