[
  {
    "original_filename": "0233_pressure_drop",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0233_pressure_drop",
    "header_text": "Modeless Pressure Drop Tool",
    "local_header_href": "#modeless-pressure-drop-tool",
    "chunk_text": "<h3>Modeless Pressure Drop Tool</h3><p>This weekend I went with a couple of men friends to spend two days together in Arcegno near \n\n<a href=\"http://en.wikipedia.org/wiki/Locarno\">\nLocarno</a>.\n\nOne afternoon we went climbing together in Ponte Brolla at the end of the Maggia Valley.\nWe did some very easy climbs, because some of us were absolute beginners, Jimmy (4b), Ostro (5a), Mekka (4c), and Muckel (5b), wonderful \n\n<a href=\"http://www.spadout.com/wiki/index.php/Slab\">\nslab climbing</a>\n\non the big, clean, warm sloping rock face. \nThe next day we went on a hike from Aurigeno, a few kilometres up the Maggia Valley, up to Capoli (1001 m), Prada, and Chegg, to beautiful old stone houses on a mountain path with no connection to any road and even a group of tipis and a view out over the Lago Maggiore.\nJust before boarding the train back into the colder and moister north, I took a very nice long walk along the bank of the lake from Locarno out toward Tenero in order to savour the beautiful clear and sunny Sunday afternoon.\n\n<p>Back home again I return to the Revit API and BIM analysis.\nOne simple BIM exploration required in the MEP HVAC domain is analysis of the pressure drop caused in a ventilation system by the various duct and fitting elements.\n\n<p>What would the ideal user interface for such an analysis tool look like?\n\n<p>One very minimalistic approach would be to hover over or pick the duct or fitting element of interest and see the result immediately displayed, wouldn't it?\n\n<p>This minimalistic interface can actually easily be implemented using the current Revit API, as we demonstrated in our discussion on \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/02/revit-window-handle-and-modeless-dialogues.html\">\nmodeless dialogues</a>.\n\nA modeless dialogue is especially useful for interactive exploration of the Revit model, since the dialogue box and the Revit user interface both remain active at the same time.\n\n<p>Joel Karr of\n\n<a href=\"http://www.cadworks.net\">\nCADworks</a> created\n\na very sweet little implementation of just this kind of modeless \n\n<a href=\"zip/PressureDropTool.zip\">\npressure drop tool</a> with \n\na number of interesting aspects, such as:\n\n<ul>\n<li>The command loop managing user interaction to select elements and control the modeless dialogue.\n<li>Functionality to determine the pressure drop data from a given Revit element.\n<li>Displaying the data to the user, which can be achieved very simply using an appropriate data container.\n</li></li></li></ul>\n<p>Joel shows us how to harness some powerful .NET framework functionality to implement the complete tool with a minimum of coding.\n\n<p>The tool is launched by invoking an external command. \nThis displays a modeless dialogue which initially has no data to display:</p>\n<center>\n<img alt=\"Pressure drop tool\" src=\"img/pressure_drop_2.png\"/>\n</center>\n<p>As long as it is running, it prompts the user to select a duct or fitting element.\nEvery time an element is selected, the dialogue updates to reflect the pressure drop in the selected element:</p>\n<center>\n<img alt=\"Pressure drop of a fitting\" src=\"img/pressure_drop_3.png\"/>\n</center>\n<p>As soon as the form is closed, the command terminates.\n\n<p>You will probably be surprised to see how little code is required to achieve this.\nIt takes much more text to describe it thoroughly in words, though:\n\n<ul>\n<li><a href=\"#1\">Data container</a>.\n<li><a href=\"#2\">Modeless form</a>.\n<li><a href=\"#3\">Determining the pressure drop</a>.\n<li><a href=\"#4\">Command loop</a>.\n<li><a href=\"#5\">Retrieve Revit window handle</a>.\n<li><a href=\"#6\">Retrieve pressure drop from selected element</a>.\n<li><a href=\"#7\">Displaying the data in the form</a>.\n<li><a href=\"#8\">Caveat</a>.\n<li><a href=\"#9\">Source code</a>.\n</li></li></li></li></li></li></li></li></li></ul>\n<p>Let's start by looking at Joel's minimalistic data container class:</p>\n<a name=\"1\"></a>\n<h4>Data Container</h4>\n<p>Here is a note from Joel on implementing his modeless pressure drop tool based on the original\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/02/revit-window-handle-and-modeless-dialogues.html\">\nmodeless dialogue</a> sample:\n\n<p style=\"color:darkblue\">I changed up your modeless dialogue a little bit to store the selection in a data class.  \nThat way when I dispose the form I can dispose the selection and change the using Boolean to false.  \nThen it can exit the while loop of the form.\n\n<p>The data container makes use of the \n\n<!-- C:\\a\\doc\\revit\\blog\\164_three_hints.htm -->\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/07/three-coding-and-performance-hints.html\">\nauto-implemented properties</a> which \n\nenables a very succinct implementation:\n\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Data</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">bool</span> UsingWindow { <span class=\"blue\">get</span>; <span class=\"blue\">set</span>; }\n  <span class=\"blue\">public</span> <span class=\"teal\">bool</span> GetElements { <span class=\"blue\">get</span>; <span class=\"blue\">set</span>; }\n  <span class=\"blue\">public</span> <span class=\"blue\">double</span> PressureDrop { <span class=\"blue\">get</span>; <span class=\"blue\">set</span>; }\n  <span class=\"blue\">public</span> <span class=\"teal\">Selection</span> Selection { <span class=\"blue\">get</span>; <span class=\"blue\">set</span>; }\n  <span class=\"blue\">public</span> Data()\n  {\n    UsingWindow = <span class=\"blue\">true</span>;\n    GetElements = <span class=\"blue\">true</span>;\n  }\n}\n</pre>\n<p>The two Boolean member variables are used to control the flow in the main command loop.\nThe other two store the current interactive user selection in Revit and the pressure drop calculated for the currently selected element.\nIt can't get much shorter than that, can it?\n\n\n<a name=\"2\"></a>\n<h4>Modeless dialogue form</h4>\n<p>The modeless dialogue used to display the data basically just defines the label to receive the pressure drop value.\nThe only code that needs to be added to the automatically generated Visual Studio designer code is the data container instance member and its initialisation:\n\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"blue\">partial</span> <span class=\"blue\">class</span> <span class=\"teal\">WindowHandleForm</span> : <span class=\"teal\">Form</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Data</span> CDWKSData { <span class=\"blue\">get</span>; <span class=\"blue\">set</span>; }\n \n  <span class=\"blue\">public</span> WindowHandleForm(<span class=\"teal\">Data</span> data)\n  {\n    InitializeComponent();\n \n    CDWKSData = data;\n  }\n}\n</pre>\n<p>We will see below how the pressure drop value is retrieved from the Revit database and sent to the label in the form.\n\n\n\n<a name=\"3\"></a>\n<h4>Determining the Pressure Drop</h4>\n<p>Now we come to the central question of querying the Revit element for its pressure drop.\n\n<p><strong>Question:</strong> I would like to be able to see the result of Revit's Pressure Drop Calculations for duct fittings.  \nI can choose the ASHRAE Table and the Loss Method but would like to see the result as the Pressure Drop parameter similar to the straight ducts.\nIs there a way to use the Pressure Drop Calculator through the API?  \nOr is there a way to make this show?\nHere is the area I would like to see populated:</p>\n<center>\n<img alt=\"Pressure drop data\" src=\"img/pressure_drop_0.png\"/>\n</center>\n<p>On a duct elbow, I looked at the value of the built-in parameter RBS_PressureDrop, but it is null when it is not filled out through the user interface.\nThe value is not filled in automatically when I view the duct fitting through Revit.  \nI need a method that actually calculates the pressure drop for a fitting.  \nTo do this by hand, an engineer can look at the size of the fitting, select the correct ASHRAE table, and then look up the value.  \nRevit does this automatically but does not display the result.\n\n<p><strong>Answer:</strong> This data is available from the connectors, not the fitting itself.\nYou can use the Connector.PressureDrop property, which returns the instantaneous pressure drop of a given connector, calculated according to system.\nThis means that to determine the pressure drop of fitting, such as a duct elbow, you need to iterate over its connectors and retrieve the data from them.\nThe pressure drop of the elbow maps to the one of the connectors on this family instance. \nThe Connector.PressureDrop property will not return a null value. \nHere is a pseudo-code snippet:\n\n<pre class=\"code\">\ndouble get_pressure_drop( \n  FamilyInstance ductElbow )\n{\n  foreach( Connector c in \n    ductElbow.MEPmodel.ConnectorManager.ConnectorSet )\n  {\n    if( this connector c is the one required )\n    {\n      break;\n    }\n  }\n  return c.PressureDrop;\n}\n</pre>\n<a name=\"4\"></a>\n<h4>Command Loop</h4>\n<p>Now we need to tie together the code accessing the pressure drop data to populate and drive the modeless form.\nHow does this all fit together to provide the useful functionality presented above?\n\n<p>Here is the entire definition of the external command class with the mainline code of its Execute method, including three collapsed code regions which we expand and explore in more detail below:\n\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Command</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">static</span> <span class=\"teal\">WindowHandle</span> _hWndRevit = <span class=\"blue\">null</span>;\n \n  <span class=\"blue\">public</span> <span class=\"teal\">CmdResult</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements)\n  {\n    <span class=\"blue\">#region</span> <u><b>Get Revit Window Handle</b></u>\n \n    Autodesk.Revit.<span class=\"teal\">Application</span> app \n      = commandData.Application;\n \n    <span class=\"teal\">Document</span> doc = app.ActiveDocument;\n \n    <span class=\"teal\">Data</span> data = <span class=\"blue\">new</span> <span class=\"teal\">Data</span>();\n    data.Selection = doc.Selection;\n \n    <span class=\"blue\">using</span>( <span class=\"teal\">WindowHandleForm</span> f \n      = <span class=\"blue\">new</span> <span class=\"teal\">WindowHandleForm</span>( data ) )\n    {\n      f.Show( _hWndRevit );\n \n      <span class=\"blue\">while</span>( data.UsingWindow )\n      {\n        <span class=\"blue\">if</span>( data.GetElements )\n        {\n          <span class=\"green\">// Clear Selection and Pressure Drop Value:</span>\n \n          data.Selection.Elements.Clear();\n          data.PressureDrop = 0;\n \n          <span class=\"green\">// User Selects an Element:</span>\n \n          data.Selection.StatusbarTip \n            = <span class=\"maroon\">\"Please select a duct fitting.\"</span>;\n \n          data.Selection.PickOne();\n \n          <span class=\"teal\">SelElementSet</span> ss = data.Selection.Elements;\n \n          <span class=\"blue\">#region</span> <u><b>Process Selection for Pressure Drop</b></u>\n\n          <span class=\"blue\">#region</span> <u><b>Send Information to Window Label</b></u>\n\n        }\n      }\n    }\n    <span class=\"blue\">return</span> <span class=\"teal\">CmdResult</span>.Succeeded;\n  }\n}\n</pre>\n<p>Note how the Boolean UsingWindow and GetElements member variables of the data container class are used to control the flow and termination of the loop.\n\n\n<a name=\"5\"></a>\n<h4>Retrieving the Revit Window Handle</h4>\n<p>The window handle is retrieved and stored in a WindowHandle helper class using the same code as in the initial discussion of the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/02/revit-window-handle-and-modeless-dialogues.html\">\nmodeless dialogue</a>:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Get Revit Window Handle\n<span class=\"blue\">if</span> (<span class=\"blue\">null</span> == _hWndRevit)\n{\n  <span class=\"teal\">Process</span> process\n    = <span class=\"teal\">Process</span>.GetCurrentProcess();\n \n  <span class=\"teal\">IntPtr</span> h = process.MainWindowHandle;\n \n  _hWndRevit = <span class=\"blue\">new</span> <span class=\"teal\">WindowHandle</span>(h);\n}\n<span class=\"blue\">#endregion</span> <span class=\"green\">// Get Revit Window Handle</span>\n</pre>\n<a name=\"6\"></a>\n<h4>Retrieving the Pressure Drop from a Selected Element</h4>\n<p>Here is the final resulting code to retrieve the pressure drop data from any applicable selected element, be it a duct or a fitting:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Process Selection for Pressure Drop\n\n<span class=\"blue\">foreach</span> (<span class=\"teal\">Element</span> e <span class=\"blue\">in</span> ss)\n{\n  <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">Duct</span>)\n  {\n    <span class=\"teal\">Duct</span> duct = e <span class=\"blue\">as</span> <span class=\"teal\">Duct</span>;\n \n    <span class=\"teal\">Parameter</span> p\n      = duct.ParametersMap.get_Item( \n        <span class=\"maroon\">\"Pressure Drop\"</span> );\n \n    data.PressureDrop = p.AsDouble();\n  }\n  <span class=\"blue\">else</span> <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">FamilyInstance</span>\n    <span class=\"green\">//&amp;&amp; e.Category.Name == \"Duct Fittings\"</span>\n    &amp;&amp; e.Category.Id.Value.Equals( \n      (<span class=\"blue\">int</span>) <span class=\"teal\">BuiltInCategory</span>.OST_DuctFitting ) )\n  {\n    <span class=\"teal\">FamilyInstance</span> fitting = e <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n \n    <span class=\"blue\">foreach</span> (<span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> \n      fitting.MEPModel.ConnectorManager.Connectors)\n    {\n      <span class=\"blue\">if</span> (c.PressureDrop &gt; data.PressureDrop)\n      {\n        data.PressureDrop = c.PressureDrop;\n      }\n    }\n  }\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<p>Identifying a duct element is easy, since the Revit API defines a dedicated class for it.\nIn that case, the pressure drop is available directly from the corresponding \"Pressure Drop\" element parameter.\n\n<p>On the other hand, a fitting is a family instance with a 'Duct Fittings' category, which we obviously identify using the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/07/language-independent-category-access.html\">\nlanguage independent built-in category comparison</a>.\n\nIf the selection is a fitting we need to loop through its connectors and retrieve the highest pressure drop value from those instead.\nMultiple branch fittings would need to return a different pressure drop value for each branch.\n\n\n<a name=\"7\"></a>\n<h4>Displaying the Data in the Form</h4>\n<p>To display the pressure drop in the modeless form, we simply loop through all the form's controls until we find one named lblPressure, and then set its window text:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Send Information to Window Label\n \n<span class=\"blue\">foreach</span>( System.Windows.Forms.<span class=\"teal\">Control</span> control\n  <span class=\"blue\">in</span> f.Controls.Find( <span class=\"maroon\">\"lblPressure\"</span>, <span class=\"blue\">true</span> ) )\n{\n  control.Text = <span class=\"teal\">Math</span>.Round( \n    data.PressureDrop, 4 ).ToString();\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<a name=\"8\"></a>\n<h4>Caveat</h4>\n<p>Only use modeless dialogues if you really know what you are doing.\nIn general, \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/export-family-instance-to-gbxml.html#1\">modal dialogues</a> are \n\npreferable because they are more robust, and easier to understand and implement.\nRevit is basically treating all external commands as modal, and the API is only partially functional once the command has returned.\nIn this example, the command actually does not return before the modeless form is closed, so that is a non-issue in this case.\n\n\n<a name=\"9\"></a>\n<h4>Source code</h4>\n<p>Here is the complete \n\n<a href=\"zip/PressureDropTool.zip\">\nPressureDropTool</a>\n\nsource code and Visual Studio solution.</p>\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0233_pressure_drop",
    "header_text": "Data Container",
    "local_header_href": "#data-container",
    "chunk_text": "<h4>Data Container</h4><p>Here is a note from Joel on implementing his modeless pressure drop tool based on the original\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/02/revit-window-handle-and-modeless-dialogues.html\">\nmodeless dialogue</a> sample:\n\n<p style=\"color:darkblue\">I changed up your modeless dialogue a little bit to store the selection in a data class.  \nThat way when I dispose the form I can dispose the selection and change the using Boolean to false.  \nThen it can exit the while loop of the form.\n\n<p>The data container makes use of the \n\n<!-- C:\\a\\doc\\revit\\blog\\164_three_hints.htm -->\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/07/three-coding-and-performance-hints.html\">\nauto-implemented properties</a> which \n\nenables a very succinct implementation:\n\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Data</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">bool</span> UsingWindow { <span class=\"blue\">get</span>; <span class=\"blue\">set</span>; }\n  <span class=\"blue\">public</span> <span class=\"teal\">bool</span> GetElements { <span class=\"blue\">get</span>; <span class=\"blue\">set</span>; }\n  <span class=\"blue\">public</span> <span class=\"blue\">double</span> PressureDrop { <span class=\"blue\">get</span>; <span class=\"blue\">set</span>; }\n  <span class=\"blue\">public</span> <span class=\"teal\">Selection</span> Selection { <span class=\"blue\">get</span>; <span class=\"blue\">set</span>; }\n  <span class=\"blue\">public</span> Data()\n  {\n    UsingWindow = <span class=\"blue\">true</span>;\n    GetElements = <span class=\"blue\">true</span>;\n  }\n}\n</pre>\n<p>The two Boolean member variables are used to control the flow in the main command loop.\nThe other two store the current interactive user selection in Revit and the pressure drop calculated for the currently selected element.\nIt can't get much shorter than that, can it?\n\n\n<a name=\"2\"></a>\n<h4>Modeless dialogue form</h4>\n<p>The modeless dialogue used to display the data basically just defines the label to receive the pressure drop value.\nThe only code that needs to be added to the automatically generated Visual Studio designer code is the data container instance member and its initialisation:\n\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"blue\">partial</span> <span class=\"blue\">class</span> <span class=\"teal\">WindowHandleForm</span> : <span class=\"teal\">Form</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Data</span> CDWKSData { <span class=\"blue\">get</span>; <span class=\"blue\">set</span>; }\n \n  <span class=\"blue\">public</span> WindowHandleForm(<span class=\"teal\">Data</span> data)\n  {\n    InitializeComponent();\n \n    CDWKSData = data;\n  }\n}\n</pre>\n<p>We will see below how the pressure drop value is retrieved from the Revit database and sent to the label in the form.\n\n\n\n<a name=\"3\"></a>\n<h4>Determining the Pressure Drop</h4>\n<p>Now we come to the central question of querying the Revit element for its pressure drop.\n\n<p><strong>Question:</strong> I would like to be able to see the result of Revit's Pressure Drop Calculations for duct fittings.  \nI can choose the ASHRAE Table and the Loss Method but would like to see the result as the Pressure Drop parameter similar to the straight ducts.\nIs there a way to use the Pressure Drop Calculator through the API?  \nOr is there a way to make this show?\nHere is the area I would like to see populated:</p>\n<center>\n<img alt=\"Pressure drop data\" src=\"img/pressure_drop_0.png\"/>\n</center>\n<p>On a duct elbow, I looked at the value of the built-in parameter RBS_PressureDrop, but it is null when it is not filled out through the user interface.\nThe value is not filled in automatically when I view the duct fitting through Revit.  \nI need a method that actually calculates the pressure drop for a fitting.  \nTo do this by hand, an engineer can look at the size of the fitting, select the correct ASHRAE table, and then look up the value.  \nRevit does this automatically but does not display the result.\n\n<p><strong>Answer:</strong> This data is available from the connectors, not the fitting itself.\nYou can use the Connector.PressureDrop property, which returns the instantaneous pressure drop of a given connector, calculated according to system.\nThis means that to determine the pressure drop of fitting, such as a duct elbow, you need to iterate over its connectors and retrieve the data from them.\nThe pressure drop of the elbow maps to the one of the connectors on this family instance. \nThe Connector.PressureDrop property will not return a null value. \nHere is a pseudo-code snippet:\n\n<pre class=\"code\">\ndouble get_pressure_drop( \n  FamilyInstance ductElbow )\n{\n  foreach( Connector c in \n    ductElbow.MEPmodel.ConnectorManager.ConnectorSet )\n  {\n    if( this connector c is the one required )\n    {\n      break;\n    }\n  }\n  return c.PressureDrop;\n}\n</pre>\n<a name=\"4\"></a>\n<h4>Command Loop</h4>\n<p>Now we need to tie together the code accessing the pressure drop data to populate and drive the modeless form.\nHow does this all fit together to provide the useful functionality presented above?\n\n<p>Here is the entire definition of the external command class with the mainline code of its Execute method, including three collapsed code regions which we expand and explore in more detail below:\n\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Command</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">static</span> <span class=\"teal\">WindowHandle</span> _hWndRevit = <span class=\"blue\">null</span>;\n \n  <span class=\"blue\">public</span> <span class=\"teal\">CmdResult</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements)\n  {\n    <span class=\"blue\">#region</span> <u><b>Get Revit Window Handle</b></u>\n \n    Autodesk.Revit.<span class=\"teal\">Application</span> app \n      = commandData.Application;\n \n    <span class=\"teal\">Document</span> doc = app.ActiveDocument;\n \n    <span class=\"teal\">Data</span> data = <span class=\"blue\">new</span> <span class=\"teal\">Data</span>();\n    data.Selection = doc.Selection;\n \n    <span class=\"blue\">using</span>( <span class=\"teal\">WindowHandleForm</span> f \n      = <span class=\"blue\">new</span> <span class=\"teal\">WindowHandleForm</span>( data ) )\n    {\n      f.Show( _hWndRevit );\n \n      <span class=\"blue\">while</span>( data.UsingWindow )\n      {\n        <span class=\"blue\">if</span>( data.GetElements )\n        {\n          <span class=\"green\">// Clear Selection and Pressure Drop Value:</span>\n \n          data.Selection.Elements.Clear();\n          data.PressureDrop = 0;\n \n          <span class=\"green\">// User Selects an Element:</span>\n \n          data.Selection.StatusbarTip \n            = <span class=\"maroon\">\"Please select a duct fitting.\"</span>;\n \n          data.Selection.PickOne();\n \n          <span class=\"teal\">SelElementSet</span> ss = data.Selection.Elements;\n \n          <span class=\"blue\">#region</span> <u><b>Process Selection for Pressure Drop</b></u>\n\n          <span class=\"blue\">#region</span> <u><b>Send Information to Window Label</b></u>\n\n        }\n      }\n    }\n    <span class=\"blue\">return</span> <span class=\"teal\">CmdResult</span>.Succeeded;\n  }\n}\n</pre>\n<p>Note how the Boolean UsingWindow and GetElements member variables of the data container class are used to control the flow and termination of the loop.\n\n\n<a name=\"5\"></a>\n<h4>Retrieving the Revit Window Handle</h4>\n<p>The window handle is retrieved and stored in a WindowHandle helper class using the same code as in the initial discussion of the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/02/revit-window-handle-and-modeless-dialogues.html\">\nmodeless dialogue</a>:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Get Revit Window Handle\n<span class=\"blue\">if</span> (<span class=\"blue\">null</span> == _hWndRevit)\n{\n  <span class=\"teal\">Process</span> process\n    = <span class=\"teal\">Process</span>.GetCurrentProcess();\n \n  <span class=\"teal\">IntPtr</span> h = process.MainWindowHandle;\n \n  _hWndRevit = <span class=\"blue\">new</span> <span class=\"teal\">WindowHandle</span>(h);\n}\n<span class=\"blue\">#endregion</span> <span class=\"green\">// Get Revit Window Handle</span>\n</pre>\n<a name=\"6\"></a>\n<h4>Retrieving the Pressure Drop from a Selected Element</h4>\n<p>Here is the final resulting code to retrieve the pressure drop data from any applicable selected element, be it a duct or a fitting:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Process Selection for Pressure Drop\n\n<span class=\"blue\">foreach</span> (<span class=\"teal\">Element</span> e <span class=\"blue\">in</span> ss)\n{\n  <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">Duct</span>)\n  {\n    <span class=\"teal\">Duct</span> duct = e <span class=\"blue\">as</span> <span class=\"teal\">Duct</span>;\n \n    <span class=\"teal\">Parameter</span> p\n      = duct.ParametersMap.get_Item( \n        <span class=\"maroon\">\"Pressure Drop\"</span> );\n \n    data.PressureDrop = p.AsDouble();\n  }\n  <span class=\"blue\">else</span> <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">FamilyInstance</span>\n    <span class=\"green\">//&amp;&amp; e.Category.Name == \"Duct Fittings\"</span>\n    &amp;&amp; e.Category.Id.Value.Equals( \n      (<span class=\"blue\">int</span>) <span class=\"teal\">BuiltInCategory</span>.OST_DuctFitting ) )\n  {\n    <span class=\"teal\">FamilyInstance</span> fitting = e <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n \n    <span class=\"blue\">foreach</span> (<span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> \n      fitting.MEPModel.ConnectorManager.Connectors)\n    {\n      <span class=\"blue\">if</span> (c.PressureDrop &gt; data.PressureDrop)\n      {\n        data.PressureDrop = c.PressureDrop;\n      }\n    }\n  }\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<p>Identifying a duct element is easy, since the Revit API defines a dedicated class for it.\nIn that case, the pressure drop is available directly from the corresponding \"Pressure Drop\" element parameter.\n\n<p>On the other hand, a fitting is a family instance with a 'Duct Fittings' category, which we obviously identify using the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/07/language-independent-category-access.html\">\nlanguage independent built-in category comparison</a>.\n\nIf the selection is a fitting we need to loop through its connectors and retrieve the highest pressure drop value from those instead.\nMultiple branch fittings would need to return a different pressure drop value for each branch.\n\n\n<a name=\"7\"></a>\n<h4>Displaying the Data in the Form</h4>\n<p>To display the pressure drop in the modeless form, we simply loop through all the form's controls until we find one named lblPressure, and then set its window text:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Send Information to Window Label\n \n<span class=\"blue\">foreach</span>( System.Windows.Forms.<span class=\"teal\">Control</span> control\n  <span class=\"blue\">in</span> f.Controls.Find( <span class=\"maroon\">\"lblPressure\"</span>, <span class=\"blue\">true</span> ) )\n{\n  control.Text = <span class=\"teal\">Math</span>.Round( \n    data.PressureDrop, 4 ).ToString();\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<a name=\"8\"></a>\n<h4>Caveat</h4>\n<p>Only use modeless dialogues if you really know what you are doing.\nIn general, \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/export-family-instance-to-gbxml.html#1\">modal dialogues</a> are \n\npreferable because they are more robust, and easier to understand and implement.\nRevit is basically treating all external commands as modal, and the API is only partially functional once the command has returned.\nIn this example, the command actually does not return before the modeless form is closed, so that is a non-issue in this case.\n\n\n<a name=\"9\"></a>\n<h4>Source code</h4>\n<p>Here is the complete \n\n<a href=\"zip/PressureDropTool.zip\">\nPressureDropTool</a>\n\nsource code and Visual Studio solution.</p>\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0233_pressure_drop",
    "header_text": "Modeless dialogue form",
    "local_header_href": "#modeless-dialogue-form",
    "chunk_text": "<h4>Modeless dialogue form</h4><p>The modeless dialogue used to display the data basically just defines the label to receive the pressure drop value.\nThe only code that needs to be added to the automatically generated Visual Studio designer code is the data container instance member and its initialisation:\n\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"blue\">partial</span> <span class=\"blue\">class</span> <span class=\"teal\">WindowHandleForm</span> : <span class=\"teal\">Form</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Data</span> CDWKSData { <span class=\"blue\">get</span>; <span class=\"blue\">set</span>; }\n \n  <span class=\"blue\">public</span> WindowHandleForm(<span class=\"teal\">Data</span> data)\n  {\n    InitializeComponent();\n \n    CDWKSData = data;\n  }\n}\n</pre>\n<p>We will see below how the pressure drop value is retrieved from the Revit database and sent to the label in the form.\n\n\n\n<a name=\"3\"></a>\n<h4>Determining the Pressure Drop</h4>\n<p>Now we come to the central question of querying the Revit element for its pressure drop.\n\n<p><strong>Question:</strong> I would like to be able to see the result of Revit's Pressure Drop Calculations for duct fittings.  \nI can choose the ASHRAE Table and the Loss Method but would like to see the result as the Pressure Drop parameter similar to the straight ducts.\nIs there a way to use the Pressure Drop Calculator through the API?  \nOr is there a way to make this show?\nHere is the area I would like to see populated:</p>\n<center>\n<img alt=\"Pressure drop data\" src=\"img/pressure_drop_0.png\"/>\n</center>\n<p>On a duct elbow, I looked at the value of the built-in parameter RBS_PressureDrop, but it is null when it is not filled out through the user interface.\nThe value is not filled in automatically when I view the duct fitting through Revit.  \nI need a method that actually calculates the pressure drop for a fitting.  \nTo do this by hand, an engineer can look at the size of the fitting, select the correct ASHRAE table, and then look up the value.  \nRevit does this automatically but does not display the result.\n\n<p><strong>Answer:</strong> This data is available from the connectors, not the fitting itself.\nYou can use the Connector.PressureDrop property, which returns the instantaneous pressure drop of a given connector, calculated according to system.\nThis means that to determine the pressure drop of fitting, such as a duct elbow, you need to iterate over its connectors and retrieve the data from them.\nThe pressure drop of the elbow maps to the one of the connectors on this family instance. \nThe Connector.PressureDrop property will not return a null value. \nHere is a pseudo-code snippet:\n\n<pre class=\"code\">\ndouble get_pressure_drop( \n  FamilyInstance ductElbow )\n{\n  foreach( Connector c in \n    ductElbow.MEPmodel.ConnectorManager.ConnectorSet )\n  {\n    if( this connector c is the one required )\n    {\n      break;\n    }\n  }\n  return c.PressureDrop;\n}\n</pre>\n<a name=\"4\"></a>\n<h4>Command Loop</h4>\n<p>Now we need to tie together the code accessing the pressure drop data to populate and drive the modeless form.\nHow does this all fit together to provide the useful functionality presented above?\n\n<p>Here is the entire definition of the external command class with the mainline code of its Execute method, including three collapsed code regions which we expand and explore in more detail below:\n\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Command</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">static</span> <span class=\"teal\">WindowHandle</span> _hWndRevit = <span class=\"blue\">null</span>;\n \n  <span class=\"blue\">public</span> <span class=\"teal\">CmdResult</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements)\n  {\n    <span class=\"blue\">#region</span> <u><b>Get Revit Window Handle</b></u>\n \n    Autodesk.Revit.<span class=\"teal\">Application</span> app \n      = commandData.Application;\n \n    <span class=\"teal\">Document</span> doc = app.ActiveDocument;\n \n    <span class=\"teal\">Data</span> data = <span class=\"blue\">new</span> <span class=\"teal\">Data</span>();\n    data.Selection = doc.Selection;\n \n    <span class=\"blue\">using</span>( <span class=\"teal\">WindowHandleForm</span> f \n      = <span class=\"blue\">new</span> <span class=\"teal\">WindowHandleForm</span>( data ) )\n    {\n      f.Show( _hWndRevit );\n \n      <span class=\"blue\">while</span>( data.UsingWindow )\n      {\n        <span class=\"blue\">if</span>( data.GetElements )\n        {\n          <span class=\"green\">// Clear Selection and Pressure Drop Value:</span>\n \n          data.Selection.Elements.Clear();\n          data.PressureDrop = 0;\n \n          <span class=\"green\">// User Selects an Element:</span>\n \n          data.Selection.StatusbarTip \n            = <span class=\"maroon\">\"Please select a duct fitting.\"</span>;\n \n          data.Selection.PickOne();\n \n          <span class=\"teal\">SelElementSet</span> ss = data.Selection.Elements;\n \n          <span class=\"blue\">#region</span> <u><b>Process Selection for Pressure Drop</b></u>\n\n          <span class=\"blue\">#region</span> <u><b>Send Information to Window Label</b></u>\n\n        }\n      }\n    }\n    <span class=\"blue\">return</span> <span class=\"teal\">CmdResult</span>.Succeeded;\n  }\n}\n</pre>\n<p>Note how the Boolean UsingWindow and GetElements member variables of the data container class are used to control the flow and termination of the loop.\n\n\n<a name=\"5\"></a>\n<h4>Retrieving the Revit Window Handle</h4>\n<p>The window handle is retrieved and stored in a WindowHandle helper class using the same code as in the initial discussion of the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/02/revit-window-handle-and-modeless-dialogues.html\">\nmodeless dialogue</a>:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Get Revit Window Handle\n<span class=\"blue\">if</span> (<span class=\"blue\">null</span> == _hWndRevit)\n{\n  <span class=\"teal\">Process</span> process\n    = <span class=\"teal\">Process</span>.GetCurrentProcess();\n \n  <span class=\"teal\">IntPtr</span> h = process.MainWindowHandle;\n \n  _hWndRevit = <span class=\"blue\">new</span> <span class=\"teal\">WindowHandle</span>(h);\n}\n<span class=\"blue\">#endregion</span> <span class=\"green\">// Get Revit Window Handle</span>\n</pre>\n<a name=\"6\"></a>\n<h4>Retrieving the Pressure Drop from a Selected Element</h4>\n<p>Here is the final resulting code to retrieve the pressure drop data from any applicable selected element, be it a duct or a fitting:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Process Selection for Pressure Drop\n\n<span class=\"blue\">foreach</span> (<span class=\"teal\">Element</span> e <span class=\"blue\">in</span> ss)\n{\n  <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">Duct</span>)\n  {\n    <span class=\"teal\">Duct</span> duct = e <span class=\"blue\">as</span> <span class=\"teal\">Duct</span>;\n \n    <span class=\"teal\">Parameter</span> p\n      = duct.ParametersMap.get_Item( \n        <span class=\"maroon\">\"Pressure Drop\"</span> );\n \n    data.PressureDrop = p.AsDouble();\n  }\n  <span class=\"blue\">else</span> <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">FamilyInstance</span>\n    <span class=\"green\">//&amp;&amp; e.Category.Name == \"Duct Fittings\"</span>\n    &amp;&amp; e.Category.Id.Value.Equals( \n      (<span class=\"blue\">int</span>) <span class=\"teal\">BuiltInCategory</span>.OST_DuctFitting ) )\n  {\n    <span class=\"teal\">FamilyInstance</span> fitting = e <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n \n    <span class=\"blue\">foreach</span> (<span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> \n      fitting.MEPModel.ConnectorManager.Connectors)\n    {\n      <span class=\"blue\">if</span> (c.PressureDrop &gt; data.PressureDrop)\n      {\n        data.PressureDrop = c.PressureDrop;\n      }\n    }\n  }\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<p>Identifying a duct element is easy, since the Revit API defines a dedicated class for it.\nIn that case, the pressure drop is available directly from the corresponding \"Pressure Drop\" element parameter.\n\n<p>On the other hand, a fitting is a family instance with a 'Duct Fittings' category, which we obviously identify using the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/07/language-independent-category-access.html\">\nlanguage independent built-in category comparison</a>.\n\nIf the selection is a fitting we need to loop through its connectors and retrieve the highest pressure drop value from those instead.\nMultiple branch fittings would need to return a different pressure drop value for each branch.\n\n\n<a name=\"7\"></a>\n<h4>Displaying the Data in the Form</h4>\n<p>To display the pressure drop in the modeless form, we simply loop through all the form's controls until we find one named lblPressure, and then set its window text:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Send Information to Window Label\n \n<span class=\"blue\">foreach</span>( System.Windows.Forms.<span class=\"teal\">Control</span> control\n  <span class=\"blue\">in</span> f.Controls.Find( <span class=\"maroon\">\"lblPressure\"</span>, <span class=\"blue\">true</span> ) )\n{\n  control.Text = <span class=\"teal\">Math</span>.Round( \n    data.PressureDrop, 4 ).ToString();\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<a name=\"8\"></a>\n<h4>Caveat</h4>\n<p>Only use modeless dialogues if you really know what you are doing.\nIn general, \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/export-family-instance-to-gbxml.html#1\">modal dialogues</a> are \n\npreferable because they are more robust, and easier to understand and implement.\nRevit is basically treating all external commands as modal, and the API is only partially functional once the command has returned.\nIn this example, the command actually does not return before the modeless form is closed, so that is a non-issue in this case.\n\n\n<a name=\"9\"></a>\n<h4>Source code</h4>\n<p>Here is the complete \n\n<a href=\"zip/PressureDropTool.zip\">\nPressureDropTool</a>\n\nsource code and Visual Studio solution.</p>\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0233_pressure_drop",
    "header_text": "Determining the Pressure Drop",
    "local_header_href": "#determining-the-pressure-drop",
    "chunk_text": "<h4>Determining the Pressure Drop</h4><p>Now we come to the central question of querying the Revit element for its pressure drop.\n\n<p><strong>Question:</strong> I would like to be able to see the result of Revit's Pressure Drop Calculations for duct fittings.  \nI can choose the ASHRAE Table and the Loss Method but would like to see the result as the Pressure Drop parameter similar to the straight ducts.\nIs there a way to use the Pressure Drop Calculator through the API?  \nOr is there a way to make this show?\nHere is the area I would like to see populated:</p>\n<center>\n<img alt=\"Pressure drop data\" src=\"img/pressure_drop_0.png\"/>\n</center>\n<p>On a duct elbow, I looked at the value of the built-in parameter RBS_PressureDrop, but it is null when it is not filled out through the user interface.\nThe value is not filled in automatically when I view the duct fitting through Revit.  \nI need a method that actually calculates the pressure drop for a fitting.  \nTo do this by hand, an engineer can look at the size of the fitting, select the correct ASHRAE table, and then look up the value.  \nRevit does this automatically but does not display the result.\n\n<p><strong>Answer:</strong> This data is available from the connectors, not the fitting itself.\nYou can use the Connector.PressureDrop property, which returns the instantaneous pressure drop of a given connector, calculated according to system.\nThis means that to determine the pressure drop of fitting, such as a duct elbow, you need to iterate over its connectors and retrieve the data from them.\nThe pressure drop of the elbow maps to the one of the connectors on this family instance. \nThe Connector.PressureDrop property will not return a null value. \nHere is a pseudo-code snippet:\n\n<pre class=\"code\">\ndouble get_pressure_drop( \n  FamilyInstance ductElbow )\n{\n  foreach( Connector c in \n    ductElbow.MEPmodel.ConnectorManager.ConnectorSet )\n  {\n    if( this connector c is the one required )\n    {\n      break;\n    }\n  }\n  return c.PressureDrop;\n}\n</pre>\n<a name=\"4\"></a>\n<h4>Command Loop</h4>\n<p>Now we need to tie together the code accessing the pressure drop data to populate and drive the modeless form.\nHow does this all fit together to provide the useful functionality presented above?\n\n<p>Here is the entire definition of the external command class with the mainline code of its Execute method, including three collapsed code regions which we expand and explore in more detail below:\n\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Command</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">static</span> <span class=\"teal\">WindowHandle</span> _hWndRevit = <span class=\"blue\">null</span>;\n \n  <span class=\"blue\">public</span> <span class=\"teal\">CmdResult</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements)\n  {\n    <span class=\"blue\">#region</span> <u><b>Get Revit Window Handle</b></u>\n \n    Autodesk.Revit.<span class=\"teal\">Application</span> app \n      = commandData.Application;\n \n    <span class=\"teal\">Document</span> doc = app.ActiveDocument;\n \n    <span class=\"teal\">Data</span> data = <span class=\"blue\">new</span> <span class=\"teal\">Data</span>();\n    data.Selection = doc.Selection;\n \n    <span class=\"blue\">using</span>( <span class=\"teal\">WindowHandleForm</span> f \n      = <span class=\"blue\">new</span> <span class=\"teal\">WindowHandleForm</span>( data ) )\n    {\n      f.Show( _hWndRevit );\n \n      <span class=\"blue\">while</span>( data.UsingWindow )\n      {\n        <span class=\"blue\">if</span>( data.GetElements )\n        {\n          <span class=\"green\">// Clear Selection and Pressure Drop Value:</span>\n \n          data.Selection.Elements.Clear();\n          data.PressureDrop = 0;\n \n          <span class=\"green\">// User Selects an Element:</span>\n \n          data.Selection.StatusbarTip \n            = <span class=\"maroon\">\"Please select a duct fitting.\"</span>;\n \n          data.Selection.PickOne();\n \n          <span class=\"teal\">SelElementSet</span> ss = data.Selection.Elements;\n \n          <span class=\"blue\">#region</span> <u><b>Process Selection for Pressure Drop</b></u>\n\n          <span class=\"blue\">#region</span> <u><b>Send Information to Window Label</b></u>\n\n        }\n      }\n    }\n    <span class=\"blue\">return</span> <span class=\"teal\">CmdResult</span>.Succeeded;\n  }\n}\n</pre>\n<p>Note how the Boolean UsingWindow and GetElements member variables of the data container class are used to control the flow and termination of the loop.\n\n\n<a name=\"5\"></a>\n<h4>Retrieving the Revit Window Handle</h4>\n<p>The window handle is retrieved and stored in a WindowHandle helper class using the same code as in the initial discussion of the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/02/revit-window-handle-and-modeless-dialogues.html\">\nmodeless dialogue</a>:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Get Revit Window Handle\n<span class=\"blue\">if</span> (<span class=\"blue\">null</span> == _hWndRevit)\n{\n  <span class=\"teal\">Process</span> process\n    = <span class=\"teal\">Process</span>.GetCurrentProcess();\n \n  <span class=\"teal\">IntPtr</span> h = process.MainWindowHandle;\n \n  _hWndRevit = <span class=\"blue\">new</span> <span class=\"teal\">WindowHandle</span>(h);\n}\n<span class=\"blue\">#endregion</span> <span class=\"green\">// Get Revit Window Handle</span>\n</pre>\n<a name=\"6\"></a>\n<h4>Retrieving the Pressure Drop from a Selected Element</h4>\n<p>Here is the final resulting code to retrieve the pressure drop data from any applicable selected element, be it a duct or a fitting:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Process Selection for Pressure Drop\n\n<span class=\"blue\">foreach</span> (<span class=\"teal\">Element</span> e <span class=\"blue\">in</span> ss)\n{\n  <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">Duct</span>)\n  {\n    <span class=\"teal\">Duct</span> duct = e <span class=\"blue\">as</span> <span class=\"teal\">Duct</span>;\n \n    <span class=\"teal\">Parameter</span> p\n      = duct.ParametersMap.get_Item( \n        <span class=\"maroon\">\"Pressure Drop\"</span> );\n \n    data.PressureDrop = p.AsDouble();\n  }\n  <span class=\"blue\">else</span> <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">FamilyInstance</span>\n    <span class=\"green\">//&amp;&amp; e.Category.Name == \"Duct Fittings\"</span>\n    &amp;&amp; e.Category.Id.Value.Equals( \n      (<span class=\"blue\">int</span>) <span class=\"teal\">BuiltInCategory</span>.OST_DuctFitting ) )\n  {\n    <span class=\"teal\">FamilyInstance</span> fitting = e <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n \n    <span class=\"blue\">foreach</span> (<span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> \n      fitting.MEPModel.ConnectorManager.Connectors)\n    {\n      <span class=\"blue\">if</span> (c.PressureDrop &gt; data.PressureDrop)\n      {\n        data.PressureDrop = c.PressureDrop;\n      }\n    }\n  }\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<p>Identifying a duct element is easy, since the Revit API defines a dedicated class for it.\nIn that case, the pressure drop is available directly from the corresponding \"Pressure Drop\" element parameter.\n\n<p>On the other hand, a fitting is a family instance with a 'Duct Fittings' category, which we obviously identify using the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/07/language-independent-category-access.html\">\nlanguage independent built-in category comparison</a>.\n\nIf the selection is a fitting we need to loop through its connectors and retrieve the highest pressure drop value from those instead.\nMultiple branch fittings would need to return a different pressure drop value for each branch.\n\n\n<a name=\"7\"></a>\n<h4>Displaying the Data in the Form</h4>\n<p>To display the pressure drop in the modeless form, we simply loop through all the form's controls until we find one named lblPressure, and then set its window text:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Send Information to Window Label\n \n<span class=\"blue\">foreach</span>( System.Windows.Forms.<span class=\"teal\">Control</span> control\n  <span class=\"blue\">in</span> f.Controls.Find( <span class=\"maroon\">\"lblPressure\"</span>, <span class=\"blue\">true</span> ) )\n{\n  control.Text = <span class=\"teal\">Math</span>.Round( \n    data.PressureDrop, 4 ).ToString();\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<a name=\"8\"></a>\n<h4>Caveat</h4>\n<p>Only use modeless dialogues if you really know what you are doing.\nIn general, \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/export-family-instance-to-gbxml.html#1\">modal dialogues</a> are \n\npreferable because they are more robust, and easier to understand and implement.\nRevit is basically treating all external commands as modal, and the API is only partially functional once the command has returned.\nIn this example, the command actually does not return before the modeless form is closed, so that is a non-issue in this case.\n\n\n<a name=\"9\"></a>\n<h4>Source code</h4>\n<p>Here is the complete \n\n<a href=\"zip/PressureDropTool.zip\">\nPressureDropTool</a>\n\nsource code and Visual Studio solution.</p>\n</p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0233_pressure_drop",
    "header_text": "Command Loop",
    "local_header_href": "#command-loop",
    "chunk_text": "<h4>Command Loop</h4><p>Now we need to tie together the code accessing the pressure drop data to populate and drive the modeless form.\nHow does this all fit together to provide the useful functionality presented above?\n\n<p>Here is the entire definition of the external command class with the mainline code of its Execute method, including three collapsed code regions which we expand and explore in more detail below:\n\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Command</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">static</span> <span class=\"teal\">WindowHandle</span> _hWndRevit = <span class=\"blue\">null</span>;\n \n  <span class=\"blue\">public</span> <span class=\"teal\">CmdResult</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements)\n  {\n    <span class=\"blue\">#region</span> <u><b>Get Revit Window Handle</b></u>\n \n    Autodesk.Revit.<span class=\"teal\">Application</span> app \n      = commandData.Application;\n \n    <span class=\"teal\">Document</span> doc = app.ActiveDocument;\n \n    <span class=\"teal\">Data</span> data = <span class=\"blue\">new</span> <span class=\"teal\">Data</span>();\n    data.Selection = doc.Selection;\n \n    <span class=\"blue\">using</span>( <span class=\"teal\">WindowHandleForm</span> f \n      = <span class=\"blue\">new</span> <span class=\"teal\">WindowHandleForm</span>( data ) )\n    {\n      f.Show( _hWndRevit );\n \n      <span class=\"blue\">while</span>( data.UsingWindow )\n      {\n        <span class=\"blue\">if</span>( data.GetElements )\n        {\n          <span class=\"green\">// Clear Selection and Pressure Drop Value:</span>\n \n          data.Selection.Elements.Clear();\n          data.PressureDrop = 0;\n \n          <span class=\"green\">// User Selects an Element:</span>\n \n          data.Selection.StatusbarTip \n            = <span class=\"maroon\">\"Please select a duct fitting.\"</span>;\n \n          data.Selection.PickOne();\n \n          <span class=\"teal\">SelElementSet</span> ss = data.Selection.Elements;\n \n          <span class=\"blue\">#region</span> <u><b>Process Selection for Pressure Drop</b></u>\n\n          <span class=\"blue\">#region</span> <u><b>Send Information to Window Label</b></u>\n\n        }\n      }\n    }\n    <span class=\"blue\">return</span> <span class=\"teal\">CmdResult</span>.Succeeded;\n  }\n}\n</pre>\n<p>Note how the Boolean UsingWindow and GetElements member variables of the data container class are used to control the flow and termination of the loop.\n\n\n<a name=\"5\"></a>\n<h4>Retrieving the Revit Window Handle</h4>\n<p>The window handle is retrieved and stored in a WindowHandle helper class using the same code as in the initial discussion of the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/02/revit-window-handle-and-modeless-dialogues.html\">\nmodeless dialogue</a>:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Get Revit Window Handle\n<span class=\"blue\">if</span> (<span class=\"blue\">null</span> == _hWndRevit)\n{\n  <span class=\"teal\">Process</span> process\n    = <span class=\"teal\">Process</span>.GetCurrentProcess();\n \n  <span class=\"teal\">IntPtr</span> h = process.MainWindowHandle;\n \n  _hWndRevit = <span class=\"blue\">new</span> <span class=\"teal\">WindowHandle</span>(h);\n}\n<span class=\"blue\">#endregion</span> <span class=\"green\">// Get Revit Window Handle</span>\n</pre>\n<a name=\"6\"></a>\n<h4>Retrieving the Pressure Drop from a Selected Element</h4>\n<p>Here is the final resulting code to retrieve the pressure drop data from any applicable selected element, be it a duct or a fitting:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Process Selection for Pressure Drop\n\n<span class=\"blue\">foreach</span> (<span class=\"teal\">Element</span> e <span class=\"blue\">in</span> ss)\n{\n  <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">Duct</span>)\n  {\n    <span class=\"teal\">Duct</span> duct = e <span class=\"blue\">as</span> <span class=\"teal\">Duct</span>;\n \n    <span class=\"teal\">Parameter</span> p\n      = duct.ParametersMap.get_Item( \n        <span class=\"maroon\">\"Pressure Drop\"</span> );\n \n    data.PressureDrop = p.AsDouble();\n  }\n  <span class=\"blue\">else</span> <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">FamilyInstance</span>\n    <span class=\"green\">//&amp;&amp; e.Category.Name == \"Duct Fittings\"</span>\n    &amp;&amp; e.Category.Id.Value.Equals( \n      (<span class=\"blue\">int</span>) <span class=\"teal\">BuiltInCategory</span>.OST_DuctFitting ) )\n  {\n    <span class=\"teal\">FamilyInstance</span> fitting = e <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n \n    <span class=\"blue\">foreach</span> (<span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> \n      fitting.MEPModel.ConnectorManager.Connectors)\n    {\n      <span class=\"blue\">if</span> (c.PressureDrop &gt; data.PressureDrop)\n      {\n        data.PressureDrop = c.PressureDrop;\n      }\n    }\n  }\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<p>Identifying a duct element is easy, since the Revit API defines a dedicated class for it.\nIn that case, the pressure drop is available directly from the corresponding \"Pressure Drop\" element parameter.\n\n<p>On the other hand, a fitting is a family instance with a 'Duct Fittings' category, which we obviously identify using the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/07/language-independent-category-access.html\">\nlanguage independent built-in category comparison</a>.\n\nIf the selection is a fitting we need to loop through its connectors and retrieve the highest pressure drop value from those instead.\nMultiple branch fittings would need to return a different pressure drop value for each branch.\n\n\n<a name=\"7\"></a>\n<h4>Displaying the Data in the Form</h4>\n<p>To display the pressure drop in the modeless form, we simply loop through all the form's controls until we find one named lblPressure, and then set its window text:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Send Information to Window Label\n \n<span class=\"blue\">foreach</span>( System.Windows.Forms.<span class=\"teal\">Control</span> control\n  <span class=\"blue\">in</span> f.Controls.Find( <span class=\"maroon\">\"lblPressure\"</span>, <span class=\"blue\">true</span> ) )\n{\n  control.Text = <span class=\"teal\">Math</span>.Round( \n    data.PressureDrop, 4 ).ToString();\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<a name=\"8\"></a>\n<h4>Caveat</h4>\n<p>Only use modeless dialogues if you really know what you are doing.\nIn general, \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/export-family-instance-to-gbxml.html#1\">modal dialogues</a> are \n\npreferable because they are more robust, and easier to understand and implement.\nRevit is basically treating all external commands as modal, and the API is only partially functional once the command has returned.\nIn this example, the command actually does not return before the modeless form is closed, so that is a non-issue in this case.\n\n\n<a name=\"9\"></a>\n<h4>Source code</h4>\n<p>Here is the complete \n\n<a href=\"zip/PressureDropTool.zip\">\nPressureDropTool</a>\n\nsource code and Visual Studio solution.</p>\n</p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0233_pressure_drop",
    "header_text": "Retrieving the Revit Window Handle",
    "local_header_href": "#retrieving-the-revit-window-handle",
    "chunk_text": "<h4>Retrieving the Revit Window Handle</h4><p>The window handle is retrieved and stored in a WindowHandle helper class using the same code as in the initial discussion of the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/02/revit-window-handle-and-modeless-dialogues.html\">\nmodeless dialogue</a>:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Get Revit Window Handle\n<span class=\"blue\">if</span> (<span class=\"blue\">null</span> == _hWndRevit)\n{\n  <span class=\"teal\">Process</span> process\n    = <span class=\"teal\">Process</span>.GetCurrentProcess();\n \n  <span class=\"teal\">IntPtr</span> h = process.MainWindowHandle;\n \n  _hWndRevit = <span class=\"blue\">new</span> <span class=\"teal\">WindowHandle</span>(h);\n}\n<span class=\"blue\">#endregion</span> <span class=\"green\">// Get Revit Window Handle</span>\n</pre>\n<a name=\"6\"></a>\n<h4>Retrieving the Pressure Drop from a Selected Element</h4>\n<p>Here is the final resulting code to retrieve the pressure drop data from any applicable selected element, be it a duct or a fitting:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Process Selection for Pressure Drop\n\n<span class=\"blue\">foreach</span> (<span class=\"teal\">Element</span> e <span class=\"blue\">in</span> ss)\n{\n  <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">Duct</span>)\n  {\n    <span class=\"teal\">Duct</span> duct = e <span class=\"blue\">as</span> <span class=\"teal\">Duct</span>;\n \n    <span class=\"teal\">Parameter</span> p\n      = duct.ParametersMap.get_Item( \n        <span class=\"maroon\">\"Pressure Drop\"</span> );\n \n    data.PressureDrop = p.AsDouble();\n  }\n  <span class=\"blue\">else</span> <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">FamilyInstance</span>\n    <span class=\"green\">//&amp;&amp; e.Category.Name == \"Duct Fittings\"</span>\n    &amp;&amp; e.Category.Id.Value.Equals( \n      (<span class=\"blue\">int</span>) <span class=\"teal\">BuiltInCategory</span>.OST_DuctFitting ) )\n  {\n    <span class=\"teal\">FamilyInstance</span> fitting = e <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n \n    <span class=\"blue\">foreach</span> (<span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> \n      fitting.MEPModel.ConnectorManager.Connectors)\n    {\n      <span class=\"blue\">if</span> (c.PressureDrop &gt; data.PressureDrop)\n      {\n        data.PressureDrop = c.PressureDrop;\n      }\n    }\n  }\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<p>Identifying a duct element is easy, since the Revit API defines a dedicated class for it.\nIn that case, the pressure drop is available directly from the corresponding \"Pressure Drop\" element parameter.\n\n<p>On the other hand, a fitting is a family instance with a 'Duct Fittings' category, which we obviously identify using the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/07/language-independent-category-access.html\">\nlanguage independent built-in category comparison</a>.\n\nIf the selection is a fitting we need to loop through its connectors and retrieve the highest pressure drop value from those instead.\nMultiple branch fittings would need to return a different pressure drop value for each branch.\n\n\n<a name=\"7\"></a>\n<h4>Displaying the Data in the Form</h4>\n<p>To display the pressure drop in the modeless form, we simply loop through all the form's controls until we find one named lblPressure, and then set its window text:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Send Information to Window Label\n \n<span class=\"blue\">foreach</span>( System.Windows.Forms.<span class=\"teal\">Control</span> control\n  <span class=\"blue\">in</span> f.Controls.Find( <span class=\"maroon\">\"lblPressure\"</span>, <span class=\"blue\">true</span> ) )\n{\n  control.Text = <span class=\"teal\">Math</span>.Round( \n    data.PressureDrop, 4 ).ToString();\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<a name=\"8\"></a>\n<h4>Caveat</h4>\n<p>Only use modeless dialogues if you really know what you are doing.\nIn general, \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/export-family-instance-to-gbxml.html#1\">modal dialogues</a> are \n\npreferable because they are more robust, and easier to understand and implement.\nRevit is basically treating all external commands as modal, and the API is only partially functional once the command has returned.\nIn this example, the command actually does not return before the modeless form is closed, so that is a non-issue in this case.\n\n\n<a name=\"9\"></a>\n<h4>Source code</h4>\n<p>Here is the complete \n\n<a href=\"zip/PressureDropTool.zip\">\nPressureDropTool</a>\n\nsource code and Visual Studio solution.</p>\n</p></p></p></p></p></p>"
  },
  {
    "original_filename": "0233_pressure_drop",
    "header_text": "Retrieving the Pressure Drop from a Selected Element",
    "local_header_href": "#retrieving-the-pressure-drop-from-a-selected-element",
    "chunk_text": "<h4>Retrieving the Pressure Drop from a Selected Element</h4><p>Here is the final resulting code to retrieve the pressure drop data from any applicable selected element, be it a duct or a fitting:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Process Selection for Pressure Drop\n\n<span class=\"blue\">foreach</span> (<span class=\"teal\">Element</span> e <span class=\"blue\">in</span> ss)\n{\n  <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">Duct</span>)\n  {\n    <span class=\"teal\">Duct</span> duct = e <span class=\"blue\">as</span> <span class=\"teal\">Duct</span>;\n \n    <span class=\"teal\">Parameter</span> p\n      = duct.ParametersMap.get_Item( \n        <span class=\"maroon\">\"Pressure Drop\"</span> );\n \n    data.PressureDrop = p.AsDouble();\n  }\n  <span class=\"blue\">else</span> <span class=\"blue\">if</span> (e <span class=\"blue\">is</span> <span class=\"teal\">FamilyInstance</span>\n    <span class=\"green\">//&amp;&amp; e.Category.Name == \"Duct Fittings\"</span>\n    &amp;&amp; e.Category.Id.Value.Equals( \n      (<span class=\"blue\">int</span>) <span class=\"teal\">BuiltInCategory</span>.OST_DuctFitting ) )\n  {\n    <span class=\"teal\">FamilyInstance</span> fitting = e <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n \n    <span class=\"blue\">foreach</span> (<span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> \n      fitting.MEPModel.ConnectorManager.Connectors)\n    {\n      <span class=\"blue\">if</span> (c.PressureDrop &gt; data.PressureDrop)\n      {\n        data.PressureDrop = c.PressureDrop;\n      }\n    }\n  }\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<p>Identifying a duct element is easy, since the Revit API defines a dedicated class for it.\nIn that case, the pressure drop is available directly from the corresponding \"Pressure Drop\" element parameter.\n\n<p>On the other hand, a fitting is a family instance with a 'Duct Fittings' category, which we obviously identify using the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/07/language-independent-category-access.html\">\nlanguage independent built-in category comparison</a>.\n\nIf the selection is a fitting we need to loop through its connectors and retrieve the highest pressure drop value from those instead.\nMultiple branch fittings would need to return a different pressure drop value for each branch.\n\n\n<a name=\"7\"></a>\n<h4>Displaying the Data in the Form</h4>\n<p>To display the pressure drop in the modeless form, we simply loop through all the form's controls until we find one named lblPressure, and then set its window text:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Send Information to Window Label\n \n<span class=\"blue\">foreach</span>( System.Windows.Forms.<span class=\"teal\">Control</span> control\n  <span class=\"blue\">in</span> f.Controls.Find( <span class=\"maroon\">\"lblPressure\"</span>, <span class=\"blue\">true</span> ) )\n{\n  control.Text = <span class=\"teal\">Math</span>.Round( \n    data.PressureDrop, 4 ).ToString();\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<a name=\"8\"></a>\n<h4>Caveat</h4>\n<p>Only use modeless dialogues if you really know what you are doing.\nIn general, \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/export-family-instance-to-gbxml.html#1\">modal dialogues</a> are \n\npreferable because they are more robust, and easier to understand and implement.\nRevit is basically treating all external commands as modal, and the API is only partially functional once the command has returned.\nIn this example, the command actually does not return before the modeless form is closed, so that is a non-issue in this case.\n\n\n<a name=\"9\"></a>\n<h4>Source code</h4>\n<p>Here is the complete \n\n<a href=\"zip/PressureDropTool.zip\">\nPressureDropTool</a>\n\nsource code and Visual Studio solution.</p>\n</p></p></p></p></p>"
  },
  {
    "original_filename": "0233_pressure_drop",
    "header_text": "Displaying the Data in the Form",
    "local_header_href": "#displaying-the-data-in-the-form",
    "chunk_text": "<h4>Displaying the Data in the Form</h4><p>To display the pressure drop in the modeless form, we simply loop through all the form's controls until we find one named lblPressure, and then set its window text:\n\n<pre class=\"code\">\n<span class=\"blue\">#region</span> Send Information to Window Label\n \n<span class=\"blue\">foreach</span>( System.Windows.Forms.<span class=\"teal\">Control</span> control\n  <span class=\"blue\">in</span> f.Controls.Find( <span class=\"maroon\">\"lblPressure\"</span>, <span class=\"blue\">true</span> ) )\n{\n  control.Text = <span class=\"teal\">Math</span>.Round( \n    data.PressureDrop, 4 ).ToString();\n}\n<span class=\"blue\">#endregion</span>\n</pre>\n<a name=\"8\"></a>\n<h4>Caveat</h4>\n<p>Only use modeless dialogues if you really know what you are doing.\nIn general, \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/export-family-instance-to-gbxml.html#1\">modal dialogues</a> are \n\npreferable because they are more robust, and easier to understand and implement.\nRevit is basically treating all external commands as modal, and the API is only partially functional once the command has returned.\nIn this example, the command actually does not return before the modeless form is closed, so that is a non-issue in this case.\n\n\n<a name=\"9\"></a>\n<h4>Source code</h4>\n<p>Here is the complete \n\n<a href=\"zip/PressureDropTool.zip\">\nPressureDropTool</a>\n\nsource code and Visual Studio solution.</p>\n</p></p>"
  },
  {
    "original_filename": "0233_pressure_drop",
    "header_text": "Caveat",
    "local_header_href": "#caveat",
    "chunk_text": "<h4>Caveat</h4><p>Only use modeless dialogues if you really know what you are doing.\nIn general, \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/export-family-instance-to-gbxml.html#1\">modal dialogues</a> are \n\npreferable because they are more robust, and easier to understand and implement.\nRevit is basically treating all external commands as modal, and the API is only partially functional once the command has returned.\nIn this example, the command actually does not return before the modeless form is closed, so that is a non-issue in this case.\n\n\n<a name=\"9\"></a>\n<h4>Source code</h4>\n<p>Here is the complete \n\n<a href=\"zip/PressureDropTool.zip\">\nPressureDropTool</a>\n\nsource code and Visual Studio solution.</p>\n</p>"
  },
  {
    "original_filename": "0233_pressure_drop",
    "header_text": "Source code",
    "local_header_href": "#source-code",
    "chunk_text": "<h4>Source code</h4><p>Here is the complete \n\n<a href=\"zip/PressureDropTool.zip\">\nPressureDropTool</a>\n\nsource code and Visual Studio solution.</p>"
  }
]