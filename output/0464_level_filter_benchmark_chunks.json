[
  {
    "original_filename": "0464_level_filter_benchmark",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0464_level_filter_benchmark",
    "header_text": "Level Filter Benchmark",
    "local_header_href": "#level-filter-benchmark",
    "chunk_text": "<h3>Level Filter Benchmark</h3><p>Yesterday I published Kevin Vandecar's handout document from his AEC DevCamp presentation on\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/10/filtered-element-collectors.html\">\nfiltered element collectors</a>,\n\nand right away an interesting case cropped up which motivated a closer look at one of his samples.\nBy the way, many of his samples are very interesting to have a closer look at, which I plan to do soon as well.\nFor now, let's start off with an analysis of the ElementLevelFilter, based on the following question:\n\n<p><strong>Question:</strong> A quick question this time:\nI want to retrieve a set of elements filtered by the floor level they are on.\nFor example – get all the rooms on Level 1.\n\n<p>I can use the Level property, but I understand this would be significantly slower than a parameter filter.\n\n<p>Among the countless built-in parameters, I cannot seem to find one for this purpose.\n\n<p>Any suggestions?\n\n<p><strong>Answer:</strong> Thank you for your short query.\nThe answer has turned out to be significantly longer and more interesting than I initially expected.\n\n<p>Just as you say, you could simply postprocess your elements by querying the Level property using LINQ or explicit coding, and that would indeed be slower than using some built-in Revit element filtering functionality.\n\n<p>To begin with, I thought that I can answer your question twice over by referring to the\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/06/parameter-filter.html#1\">\nparameter filter</a> blog post.\n\n<p>On one hand, it answers your question by pointing to the ElementLevelFilter, which is a slow filter used to match elements by their associated level, exactly as you require.\nExample code for using this filter is given in the Revit API help document RevitAPI.chm under 'ElementLevelFilter Class'.\n\n<p>On the other hand, the post also points out that this filter cannot be used for beams, since its Level property is not implemented, and for those you can use a parameter filter checking for the built-in parameter INSTANCE_REFERENCE_LEVEL_PARAM instead.\nThis parameter is probably not applicable for all elements, though, so you might have to use some other one for other element types.\n\n<p>Maybe (and hopefully) the ElementLevelFilter will fulfil all your specific needs.\n\n<p>On the third hand, assuming we don't run out of hands, I am just working on Kevin Vandecar's filtered element collector benchmark code which he created for AEC DevCamp in Boston back in June, and it includes one sample command which exactly answers your question and includes some benchmark code to prove the point.\n\n<p>The command FilterParameterEx2 determines all family instances on a specific level using and benchmarking three different methods:\n\n<ul>\n<li>ElementLevelFilter.\n<li>ElementParameterFilter based on the built-in FAMILY_LEVEL_PARAM parameter.\n<li>LINQ post-processing check of the family instance Level property.\n</li></li></li></ul>\n<p>Here is the complete code of the command:\n\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Automatic )]\n[<span class=\"teal\">Regeneration</span>( <span class=\"teal\">RegenerationOption</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">FilterParameterEx2</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">static</span> <span class=\"blue\">string</span> _level_name = <span class=\"maroon\">\"Level 2\"</span>; <span class=\"green\">// \"02 - Floor\"</span>\n \n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute( \n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">UIApplication</span> uiapp = commandData.Application;\n    <span class=\"teal\">UIDocument</span> uidoc = uiapp.ActiveUIDocument;\n    <span class=\"teal\">Application</span> app = uiapp.Application;\n    <span class=\"teal\">Document</span> doc = uidoc.Document;\n \n    <span class=\"green\">// Level 2 example criteria</span>\n    <span class=\"teal\">ElementId</span> levelId = <span class=\"teal\">Util</span>.FindLevelId( doc, \n      _level_name );\n \n    <span class=\"teal\">Stopwatch</span> sw = <span class=\"blue\">new</span> <span class=\"teal\">Stopwatch</span>();\n    <span class=\"blue\">string</span> names = <span class=\"blue\">string</span>.Empty;\n \n    <span class=\"green\">// Use the Level filter to find all </span>\n    <span class=\"green\">// FamilyInstances with desired Level.</span>\n    <span class=\"green\">// Note this is a slow filter.</span>\n \n    sw.Reset();\n    sw.Start();\n \n    <span class=\"teal\">ElementLevelFilter</span> filterElementsOnLevel \n      = <span class=\"blue\">new</span> <span class=\"teal\">ElementLevelFilter</span>( levelId );\n \n    <span class=\"teal\">FilteredElementCollector</span> collector1 \n      = <span class=\"blue\">new</span> <span class=\"teal\">FilteredElementCollector</span>( doc );\n \n    collector1.OfClass( <span class=\"blue\">typeof</span>( <span class=\"teal\">FamilyInstance</span> ) )\n      .WherePasses( filterElementsOnLevel );\n \n    <span class=\"teal\">ICollection</span>&lt;<span class=\"teal\">Element</span>&gt; listLevel \n      = collector1.ToElements();\n \n    <span class=\"green\">// Now that we have only what we want, </span>\n    <span class=\"green\">// foreach process them into a report.</span>\n \n    names = <span class=\"blue\">string</span>.Empty;\n    <span class=\"blue\">foreach</span>( <span class=\"teal\">FamilyInstance</span> instance <span class=\"blue\">in</span> listLevel )\n    {\n      names += <span class=\"maroon\">\"\\nLevel Name = \"</span> + instance.Level.Name \n        + <span class=\"maroon\">\"   Instance name = \"</span> + instance.Name \n        + <span class=\"maroon\">\"   id: \"</span> + instance.Id.ToString();\n    }\n \n    sw.Stop();\n \n    <span class=\"teal\">Util</span>.ShowElapsedTime( sw, \n      <span class=\"maroon\">\"Using ElementLevelFilter to find \"</span>\n      + listLevel.Count().ToString() \n      + <span class=\"maroon\">\" family instances on a given level: \"</span> \n      + names );\n \n    <span class=\"green\">// Use ElementParameterFilter to find all </span>\n    <span class=\"green\">// FamilyInstances with desired Level by </span>\n    <span class=\"green\">// finding the data in the FAMILY_LEVEL_PARAM </span>\n    <span class=\"green\">// parameter.</span>\n \n    sw.Reset();\n    sw.Start();\n \n    <span class=\"teal\">BuiltInParameter</span> bip \n      = <span class=\"teal\">BuiltInParameter</span>.FAMILY_LEVEL_PARAM;\n \n    <span class=\"teal\">ParameterValueProvider</span> provider = <span class=\"blue\">new</span> \n      <span class=\"teal\">ParameterValueProvider</span>( <span class=\"blue\">new</span> <span class=\"teal\">ElementId</span>( bip ) );\n \n    <span class=\"teal\">FilterNumericRuleEvaluator</span> evaluator \n      = <span class=\"blue\">new</span> <span class=\"teal\">FilterNumericEquals</span>();\n \n    <span class=\"teal\">FilterRule</span> rule = <span class=\"blue\">new</span> <span class=\"teal\">FilterElementIdRule</span>( \n      provider, evaluator, levelId );\n \n    <span class=\"teal\">ElementParameterFilter</span> filter \n      = <span class=\"blue\">new</span> <span class=\"teal\">ElementParameterFilter</span>( rule );\n \n    <span class=\"teal\">FilteredElementCollector</span> collector2 \n      = <span class=\"blue\">new</span> <span class=\"teal\">FilteredElementCollector</span>( doc );\n \n    collector2.OfClass( <span class=\"blue\">typeof</span>( <span class=\"teal\">FamilyInstance</span> ) )\n      .WherePasses( filter );\n \n    <span class=\"teal\">ICollection</span>&lt;<span class=\"teal\">Element</span>&gt; listLevelParam \n      = collector2.ToElements();\n \n    <span class=\"green\">// Now that we have only what we want, </span>\n    <span class=\"green\">// foreach process them into a report.</span>\n \n    names = <span class=\"blue\">string</span>.Empty;\n    <span class=\"blue\">foreach</span>( <span class=\"teal\">FamilyInstance</span> instance <span class=\"blue\">in</span> listLevelParam )\n    {\n      names += <span class=\"maroon\">\"\\nLevel Name = \"</span> + instance.Level.Name\n        + <span class=\"maroon\">\"   Instance name = \"</span> + instance.Name\n        + <span class=\"maroon\">\"   id: \"</span> + instance.Id.ToString();\n    }\n \n    sw.Stop();\n \n    <span class=\"teal\">Util</span>.ShowElapsedTime( sw, \n      <span class=\"maroon\">\"Using Element Parameter Filter: \"</span> \n      + listLevelParam.Count().ToString() + names );\n \n    <span class=\"green\">// Use LINQ to find all FamilyInstances </span>\n    <span class=\"green\">// with desired Level.</span>\n \n    sw.Reset();\n    sw.Start();\n    <span class=\"teal\">FilteredElementCollector</span> collector3 \n      = <span class=\"blue\">new</span> <span class=\"teal\">FilteredElementCollector</span>( doc );\n \n    collector3.OfClass( <span class=\"blue\">typeof</span>( <span class=\"teal\">FamilyInstance</span> ) );\n \n    <span class=\"teal\">IEnumerable</span>&lt;<span class=\"teal\">FamilyInstance</span>&gt; listLevelLINQ \n      = collector3.OfType&lt;<span class=\"teal\">FamilyInstance</span>&gt;();\n \n    <span class=\"green\">// Use LINQ to filter down those that </span>\n    <span class=\"green\">// match the desired level name.</span>\n \n    <span class=\"teal\">Level</span> level = <span class=\"blue\">null</span>;\n    <span class=\"teal\">IEnumerable</span>&lt;<span class=\"teal\">FamilyInstance</span>&gt; listFiOnLevelLINQ \n      = <span class=\"blue\">from</span> fi <span class=\"blue\">in</span> listLevelLINQ\n        <span class=\"blue\">where</span> ( ( level = fi.Level ) != <span class=\"blue\">null</span> ) \n          &amp;&amp; ( level.Id.Equals( levelId ) )\n        <span class=\"blue\">select</span> fi;\n \n    <span class=\"green\">// Now that we have only what we want, </span>\n    <span class=\"green\">// foreach process them into a report.</span>\n \n    names = <span class=\"blue\">string</span>.Empty;\n    <span class=\"blue\">foreach</span>( <span class=\"teal\">FamilyInstance</span> instance <span class=\"blue\">in</span> listFiOnLevelLINQ )\n    {\n      names += <span class=\"maroon\">\"\\nLevel Name = \"</span> + instance.Level.Name\n        + <span class=\"maroon\">\"   Instance name = \"</span> + instance.Name\n        + <span class=\"maroon\">\"   id: \"</span> + instance.Id.ToString();\n    }\n \n    sw.Stop();\n \n    <span class=\"teal\">Util</span>.ShowElapsedTime( sw, \n      <span class=\"maroon\">\"Using LINQ to find \"</span> \n      + listFiOnLevelLINQ.Count&lt;<span class=\"teal\">FamilyInstance</span>&gt;().ToString() \n      + <span class=\"maroon\">\" family instances on a specific level: \"</span> \n      + names );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>I ran it on the ArchSample.rvt model file included in Kevin's\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/10/filtered-element-collectors.html\">\npresentation material</a> posted yesterday.\n\n<p>The first results showed that the parameter filter was faster than the level filter, even doing the exact job that the element filter was designed to do.\nIn several different attempts, it consistently took more or less the following numbers of milliseconds to retrieve 52 elements using the three different methods:\n\n<ul>\n<li>48 ms - element level filter\n<li>38 ms - parameter filter\n<li>71 ms - LINQ\n</li></li></li></ul>\n<p>After rerunning the tests several more times, it does seem that the level filter is faster in general after all.\nHere are some more test run results in ArchSample.rvt, as well as in rac_advanced_sample_project.rvt, a sample file included in the basic Revit Architecture installation.\nTo run in the letter model, you need to change the target level name to something else than \"Level 2\", e.g. \"02 - Floor\".\n\n<p>In the following table, A stands for the ArchSample.rvt model file, B for rac_advanced_sample_project.rvt, and L, P and Q for the time for each run in milliseconds for the level filter, parameter filter and LINQ query, respectively:</p>\n<table>\n<tr><th align=\"right\">Model</th><th align=\"right\">L</th><th align=\"right\">P</th><th align=\"right\">Q</th></tr>\n<tr><td align=\"right\">A</td><td align=\"right\">11</td><td align=\"right\">24</td><td align=\"right\">38</td></tr>\n<tr><td align=\"right\">A</td><td align=\"right\">11</td><td align=\"right\">24</td><td align=\"right\">37</td></tr>\n<tr><td align=\"right\">A</td><td align=\"right\">11</td><td align=\"right\">8</td><td align=\"right\">62</td></tr>\n<tr><td align=\"right\">A</td><td align=\"right\">11</td><td align=\"right\">23</td><td align=\"right\">38</td></tr>\n<tr><td align=\"right\">A</td><td align=\"right\">7</td><td align=\"right\">24</td><td align=\"right\">37</td></tr>\n<tr><td align=\"right\">A</td><td align=\"right\">46</td><td align=\"right\">25</td><td align=\"right\">68</td></tr>\n<tr><td align=\"right\">A</td><td align=\"right\">23</td><td align=\"right\">28</td><td align=\"right\">39</td></tr>\n<tr><td align=\"right\">A</td><td align=\"right\">11</td><td align=\"right\">7</td><td align=\"right\">38</td></tr>\n<tr><td align=\"right\">A</td><td align=\"right\">13</td><td align=\"right\">24</td><td align=\"right\">11</td></tr>\n<tr><td align=\"right\">B</td><td align=\"right\">79</td><td align=\"right\">101</td><td align=\"right\">273</td></tr>\n<tr><td align=\"right\">B</td><td align=\"right\">56</td><td align=\"right\">102</td><td align=\"right\">276</td></tr>\n<tr><td align=\"right\">B</td><td align=\"right\">84</td><td align=\"right\">104</td><td align=\"right\">173</td></tr>\n</table>\n<p>It seems that the level filter is fastest after all, as we would hope.\nAnd certainly the LINQ query is consistently slowest.\n\n<p>You might want to compare the performances of the various filters with your own data sets.\n\n<p>I would also assume that the level filter provides maximum simplicity and probably minimal future maintenance worries.\n\n<p>Here is\n\n<a href=\"zip/FilterExamples02.zip\">FilterExamples02.zip</a> containing\n\nan updated version of Kevin's code samples and benchmarking code.\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  }
]