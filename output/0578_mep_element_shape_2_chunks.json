[
  {
    "original_filename": "0578_mep_element_shape_2",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0578_mep_element_shape_2",
    "header_text": "Improved MEP Element Shape and Ararat",
    "local_header_href": "#improved-mep-element-shape-and-ararat",
    "chunk_text": "<h3>Improved MEP Element Shape and Ararat</h3><p>We recently talked about \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2011/03/distinguishing-mep-element-shape.html\">\ndistinguishing Revit MEP duct element shapes</a>, \n\nand Max aka \n\n<a href=\"http://maciejszlek.pl\">\nMaciej Szlek</a> presented \n\na solution based on the analysis of the string value of the duct's Size parameter.\n\n<p>I suggested that the algorithm might be improved, both to make it more general and robust and also to remove the dependency on the different string formats used for imperial and metric units. \nIt probably becomes more efficient as well, by the way.\n\n<p>Instead of looking at the duct size parameter, one can query it for its connectors and extract the shape from them directly, avoiding all string manipulations and language or unit dependencies.\n\n<p>Max went ahead and implemented this new algorithm.\nSimultaneously, he demonstrates that some useful helper methods can be reused from the Revit SDK samples, in this case ExtractMechanicalOrPipingSystem and ExtractSystemFromConnectors from the TraverseSystem sample.\nHere is the code of the new algorithm:\n\n<pre class=\"code\">\n<span class=\"blue\">static</span> <span class=\"blue\">public</span> <span class=\"blue\">string</span> GetElementShape(\n  <span class=\"teal\">Element</span> e,\n  <span class=\"teal\">Element</span> pe = <span class=\"blue\">null</span>,\n  <span class=\"teal\">Element</span> ne = <span class=\"blue\">null</span> )\n{\n  <span class=\"blue\">if</span>( is_element_of_category( e, \n    <span class=\"teal\">BuiltInCategory</span>.OST_DuctCurves ) )\n  {\n    <span class=\"green\">// assuming that transition is using to change shape..</span>\n \n    <span class=\"teal\">ConnectorManager</span> cm = ( e <span class=\"blue\">as</span> <span class=\"teal\">MEPCurve</span> )\n      .ConnectorManager;\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> cm.Connectors )\n      <span class=\"blue\">return</span> c.Shape.ToString() \n        + <span class=\"maroon\">\" 2 \"</span> + c.Shape.ToString();\n  }\n  <span class=\"blue\">else</span> <span class=\"blue\">if</span>( is_element_of_category( e, \n    <span class=\"teal\">BuiltInCategory</span>.OST_DuctFitting ) )\n  {\n    <span class=\"teal\">MEPSystem</span> system \n      = ExtractMechanicalOrPipingSystem( e );\n \n    <span class=\"teal\">FamilyInstance</span> fi = e <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n    <span class=\"teal\">MEPModel</span> mm = fi.MEPModel;\n \n    <span class=\"teal\">ConnectorSet</span> connectors \n      = mm.ConnectorManager.Connectors;\n \n    <span class=\"blue\">if</span>( fi != <span class=\"blue\">null</span> &amp;&amp; mm <span class=\"blue\">is</span> <span class=\"teal\">MechanicalFitting</span> )\n    {\n      <span class=\"teal\">PartType</span> partType \n        = ( mm <span class=\"blue\">as</span> <span class=\"teal\">MechanicalFitting</span> ).PartType;\n \n      <span class=\"blue\">if</span>( <span class=\"teal\">PartType</span>.Elbow == partType )\n      {\n        <span class=\"green\">// assuming that transition is using to change shape..</span>\n \n        <span class=\"blue\">foreach</span>( <span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> connectors )\n        {\n          <span class=\"blue\">return</span> c.Shape.ToString() \n            + <span class=\"maroon\">\" 2 \"</span> + c.Shape.ToString();\n        }\n      }\n      <span class=\"blue\">else</span> <span class=\"blue\">if</span>( <span class=\"teal\">PartType</span>.Transition == partType )\n      {\n        <span class=\"blue\">string</span>[] tmp = <span class=\"blue\">new</span> <span class=\"blue\">string</span>[2];\n \n        <span class=\"blue\">if</span>( system != <span class=\"blue\">null</span> )\n        {\n          <span class=\"blue\">foreach</span>( <span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> connectors )\n          {\n            <span class=\"blue\">if</span>( c.Direction == <span class=\"teal\">FlowDirectionType</span>.In )\n              tmp[0] = c.Shape.ToString();\n \n            <span class=\"blue\">if</span>( c.Direction == <span class=\"teal\">FlowDirectionType</span>.Out )\n              tmp[1] = c.Shape.ToString();\n          }\n          <span class=\"blue\">return</span> <span class=\"blue\">string</span>.Join( <span class=\"maroon\">\" 2 \"</span>, tmp );\n        }\n        <span class=\"blue\">else</span>\n        {\n          <span class=\"blue\">int</span> i = 0;\n \n          <span class=\"blue\">foreach</span>( <span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> connectors )\n          {\n            <span class=\"blue\">if</span>( pe != <span class=\"blue\">null</span> )\n            {\n              <span class=\"blue\">if</span>( is_connected_to( c, pe ) )\n                tmp[0] = c.Shape.ToString();\n              <span class=\"blue\">else</span>\n                tmp[1] = c.Shape.ToString();\n            }\n            <span class=\"blue\">else</span>\n            {\n              tmp[i] = c.Shape.ToString();\n            }\n            ++i;\n          }\n \n          <span class=\"blue\">if</span>( pe != <span class=\"blue\">null</span> )\n            <span class=\"blue\">return</span> <span class=\"blue\">string</span>.Join( <span class=\"maroon\">\" 2 \"</span>, tmp );\n \n          <span class=\"blue\">return</span> <span class=\"blue\">string</span>.Join( <span class=\"maroon\">\"-\"</span>, tmp );\n        }\n      }\n      <span class=\"blue\">else</span> <span class=\"blue\">if</span>( <span class=\"teal\">PartType</span>.Tee == partType\n        || <span class=\"teal\">PartType</span>.Cross == partType\n        || <span class=\"teal\">PartType</span>.Pants == partType\n        || <span class=\"teal\">PartType</span>.Wye == partType )\n      {\n        <span class=\"blue\">string</span> from, to;\n        from = to = <span class=\"blue\">null</span>;\n        <span class=\"teal\">List</span>&lt;<span class=\"blue\">string</span>&gt; unk = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"blue\">string</span>&gt;();\n \n        <span class=\"blue\">if</span>( system != <span class=\"blue\">null</span> )\n        {\n          <span class=\"blue\">foreach</span>( <span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> connectors )\n          {\n            <span class=\"blue\">if</span>( c.Direction == <span class=\"teal\">FlowDirectionType</span>.In )\n              from = c.Shape.ToString();\n            <span class=\"blue\">else</span>\n              unk.Add( c.Shape.ToString() );\n \n            <span class=\"blue\">if</span>( ne != <span class=\"blue\">null</span> &amp;&amp; is_connected_to( c, ne ) )\n              to = c.Shape.ToString();\n          }\n \n          <span class=\"blue\">if</span>( to != <span class=\"blue\">null</span> )\n            <span class=\"blue\">return</span> from + <span class=\"maroon\">\" 2 \"</span> + to;\n \n          <span class=\"blue\">return</span> from + <span class=\"maroon\">\" 2 \"</span> + <span class=\"blue\">string</span>.Join( <span class=\"maroon\">\"-\"</span>, \n            unk.ToArray() );\n        }\n        <span class=\"blue\">else</span>\n        {\n          <span class=\"blue\">foreach</span>( <span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> connectors )\n          {\n            <span class=\"blue\">if</span>( ne != <span class=\"blue\">null</span> &amp;&amp; is_connected_to( \n              c, ne ) )\n            {\n              to = c.Shape.ToString();\n              <span class=\"blue\">continue</span>;\n            }\n \n            <span class=\"blue\">if</span>( pe != <span class=\"blue\">null</span> &amp;&amp; is_connected_to( \n              c, pe ) )\n            {\n              from = c.Shape.ToString();\n              <span class=\"blue\">continue</span>;\n            }\n \n            unk.Add( c.Shape.ToString() );\n          }\n \n          <span class=\"blue\">if</span>( to != <span class=\"blue\">null</span> )\n            <span class=\"blue\">return</span> from + <span class=\"maroon\">\" 2 \"</span> + to;\n \n          <span class=\"blue\">if</span>( from != <span class=\"blue\">null</span> )\n            <span class=\"blue\">return</span> from + <span class=\"maroon\">\" 2 \"</span> \n              + <span class=\"blue\">string</span>.Join( <span class=\"maroon\">\"-\"</span>, unk.ToArray() );\n \n          <span class=\"blue\">return</span> <span class=\"blue\">string</span>.Join( <span class=\"maroon\">\"-\"</span>, unk.ToArray() );\n        }\n      }\n    }\n  }\n  <span class=\"blue\">return</span> <span class=\"maroon\">\"unknown\"</span>;\n}\n \n</pre>\n<p>It is encapsulated as a static method in the class MepElementShape.\nI created a second wrapper class MepElementShapeV1 for the first implementation and call them both in The Building Coder sample CmdMepElementShape external command Execute method like this:\n\n<pre class=\"code\">\n  <span class=\"teal\">Element</span> e = &lt;selected element&gt;;\n \n  <span class=\"teal\">Util</span>.InfoMsg( <span class=\"blue\">string</span>.Format(\n    <span class=\"maroon\">\"{0} is {1} ({2})\"</span>,\n    <span class=\"teal\">Util</span>.ElementDescription( e ),\n    <span class=\"teal\">MepElementShape</span>.GetElementShape( e ),\n    <span class=\"teal\">MepElementShapeV1</span>.GetElementShape( e ) ) );\n \n</pre>\n<p>This prints the following in the Visual Studio debug output window on selecting some of the elements generated by the AvoidObstruction SDK sample:\n\n<pre>\nMechanical Equipment Parallel Fan Powered VAV \n  &lt;378728 Size 4 - 10 inch Inlet&gt; is unknown (unknown)\n\nDuct Fittings Rectangular Duct Radius Elbow &lt;382720 1.5 W&gt; \n  is RectProfile 2 RectProfile (rectangular2rectangular)\n\nDucts &lt;382719 Radius Elbows / Tees&gt; \n  is RectProfile 2 RectProfile (rectangular)\n\nDuct Fittings Rectangular Duct Tee &lt;382736 Standard&gt; \n  is RectProfile 2 RectProfile-RectProfile (unknown)\n\nAir Terminals Supply Diffuser \n  &lt;378716 24 x 24 Face 12 x 12 Connection&gt; is unknown (unknown)\n</pre>\n<p>As you see, the results are the same for the string-based first version as for the new connector-based one, except for the tee junction, which was not handled properly by the former.\n\n<p>Very many thanks to Max for implementing and sharing this!\n\n<p>Here is an updated\n\n<a href=\"zip/bc_12_87_3.zip\">\nversion 2012.0.87.3</a> of\n\nThe Building Coder sample code including this new classification method.\n\n\n<a name=\"2\"></a>\n<h4>Climbing the Ararat</h4>\n<p>I am off for another break now, this time a bit more adventurous, to climb \n\n<a href=\"http://en.wikipedia.org/wiki/Mount_Ararat\">\nMount Ararat</a> in far Eastern Turkey.\n\nThe flight from Istanbul to \n\n<a href=\"http://simple.wikipedia.org/wiki/Van,_Turkey\">\nVan</a>, the closest city, is longer than the one from Switzerland to Istanbul!\n\n<p>Since I am also busy preparing my \n\n<a href=\"http://through-the-interface.typepad.com/through_the_interface/2011/04/call-for-au-2011-proposals.html\">\nAutodesk University proposals</a>, \n\nwhich are due for submission today, as well as the upcoming Revit 2012 API webcast, I am pretty occupied and having difficulty finding time to even pack.\nWith skis and winter clothing and mountain equipment, that is a non-trivial task...\n\nStill, I will make it, I am sure.</p>\n<center>\n<img alt=\"Mount Ararat\" src=\"img/ararat.jpg\"/>\n</center>\n</p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0578_mep_element_shape_2",
    "header_text": "Climbing the Ararat",
    "local_header_href": "#climbing-the-ararat",
    "chunk_text": "<h4>Climbing the Ararat</h4><p>I am off for another break now, this time a bit more adventurous, to climb \n\n<a href=\"http://en.wikipedia.org/wiki/Mount_Ararat\">\nMount Ararat</a> in far Eastern Turkey.\n\nThe flight from Istanbul to \n\n<a href=\"http://simple.wikipedia.org/wiki/Van,_Turkey\">\nVan</a>, the closest city, is longer than the one from Switzerland to Istanbul!\n\n<p>Since I am also busy preparing my \n\n<a href=\"http://through-the-interface.typepad.com/through_the_interface/2011/04/call-for-au-2011-proposals.html\">\nAutodesk University proposals</a>, \n\nwhich are due for submission today, as well as the upcoming Revit 2012 API webcast, I am pretty occupied and having difficulty finding time to even pack.\nWith skis and winter clothing and mountain equipment, that is a non-trivial task...\n\nStill, I will make it, I am sure.</p>\n<center>\n<img alt=\"Mount Ararat\" src=\"img/ararat.jpg\"/>\n</center>\n</p>"
  }
]