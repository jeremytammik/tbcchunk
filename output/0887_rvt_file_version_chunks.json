[
  {
    "original_filename": "0887_rvt_file_version",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<meta content=\"text/html; charset=utf-8\" http-equiv=\"Content-Type\"/>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0887_rvt_file_version",
    "header_text": "Basic File Info and RVT File Version",
    "local_header_href": "#basic-file-info-and-rvt-file-version",
    "chunk_text": "<h3>Basic File Info and RVT File Version</h3><p>I presented an initial solution in Python for\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2008/10/rvt-file-version.html\">\ndetermining the version of an RVT file on disk</a> from\n\noutside Revit making use of its OLE document Structured Storage format back in 2008.\nDavid Echols later shared a more full-fledged\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/06/open-revit-ole-storage.html\">\nC# Revit OLE Storage viewer</a> listing\n\nmore information and displaying the preview image.\n\n<p>Since then, the Revit API added support for reading basic RVT file info through the BasicFileInfo class.</p>\n<p>Victor Chekalin now presents another C# console application showing how some of this data can be accessed independently of the Revit API.</p>\n<p>Before looking at that, here are some other topics that also came up in the past day or two:</p>\n<ul>\n<li><a href=\"#2\">Building Setout Points</a> used commercially</li>\n<li><a href=\"#3\">Screen recording</a> with Camtasia on the Mac</li>\n<li><a href=\"#4\">Sustainable Autodesk Offices</a></li>\n<li>Reading the <a href=\"#5\">RVT file version</a> without using the Revit API</li>\n</ul>\n<a name=\"2\"></a>\n<h4>Building Setout Points Used in a Commercial Application</h4>\n<p>I am glad to say that one of the sample add-ins I am particularly happy with now made its way into a commercial application.</p>\n<p>Here is an excerpt from the current Australian\n\n<a href=\"http://www.arsoftwaresolutions.com.au\">\nARSoftwareSolutions</a>\n\nnewsletter:\n\n<p>A recent meander through the TheBuildingCoder website led me to a routine for\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2012/08/structural-concrete-setout-point-add-in.html\">\nmarking the corners of structural concrete corners</a>.\n\nOnce marked the points could be scheduled and provided to the builder as a file of set out point coordinates.\nThese can then be established on site using various surveying tools.\nThis seemed like something a lot of companies could benefit from so I set about including it in my software.\n(Please refer to <a href=\"http://thebuildingcoder.typepad.com/blog/rst\">http://thebuildingcoder.typepad.com/blog/rst</a> for more complete details.\nThank you to both Paul Hellawell of GHD and Jeremy Tammik for the idea and some of the coding.)\n\n<p>Of course I couldn't just leave it the way it was so I expanded on the concept, added extra functionality, and this now forms a part of ARUtils - Leader.\n\n<p>The basic concept is to mark all structural concrete corners with a \"SetoutPoint\" family.\nCritical setout points can then use a \"Major\" type of that family to indicate they are a critical point.\nAlternatively other points can be automatically designated as minor, centre points of curves, control points of splines, or just intermediate points along curves.\nPoints can be promoted to Major or demoted to Minor as required for construction or changing needs.\n\n<p>When automatically placed at a point, each marker has the X,Y, and Z coordinates assigned to the marker.\nOnce this has been done, the families can be scheduled and the points exported for use by the builder.\nThe routine also keeps track of the item that generated the points so points can be grouped on a generating object basis.\n\n<center>\n<img alt=\"Point markers\" src=\"img/setout_points_ar1.jpeg\"/>\n<p><i>Points marked. Diagram shows Major, Minor, Centre, Control and Curve following points.</i></p>\n<img alt=\"Tagged points\" src=\"img/setout_points_ar2.jpeg\"/>\n<p><i>Tagged points</i></p>\n<img alt=\"Key setout points\" src=\"img/setout_points_ar3.png\"/>\n<p><i>Scheduled Keypoints</i></p>\n<img alt=\"Schedule of all points\" src=\"img/setout_points_ar4.png\"/>\n<p><i>Schedule - All points</i></p>\n<img alt=\"Interface\" src=\"img/setout_points_ar5.jpeg\"/>\n<p><i>The interface</i></p>\n</center>\n<p>Note: You can automatically mark all structural concrete items, or pick specific items of any type to have markers placed.\n\n<p>Note: Should the project location change the coordinates can be automatically synchronised using the \"Renumber / Update\" option.\n\n<p>I am happy to see my efforts helping people and making their way out into the world  :-)\n\n\n\n<a name=\"3\"></a>\n<h4>Screen Recording on the Mac</h4>\n<p>On a completely different topic, I have been struggling a bit the past few days to set up a proper screen recording environment for myself to create a canned presentation.</p>\n<p>I want to show some Powerpoint slides, record my narration, and also make use of Revit and Visual Studio for add-in demonstrations.</p>\n<p>I planned to use Camtasia for this, as I have past experience with it and it does a good job.</p>\n<p>The Revit and Visual Studio requirements led me to believe that I had to install Camtasia in my Windows virtual machine.</p>\n<p>When I did that, I discovered that the Windows version that I had installed was European and therefore lacked the Windows Media Player, which caused Camtasia to fail. It took a while to find out, though.</p>\n<p>I went off and downloaded a US version of Windows, created a new virtual machine, installed Revit, Visual Studio, Camtasia, and some other bits and pieces on it.</p>\n<p>After doing all that, I discovered that the Camtasia output quality from this setup is suboptimal, and there are often problems with the audio getting lost completely.</p>\n<p>After struggling a bit more with that, a colleague told me that the easiest thing to do is just to use Camtasia in the native Mac system and record the full screen.\nI can display the Powerpoint slides in full screen, record my narration, and switch back and forth to a full-screen virtual Windows machine at any time.\nSo I wasted a lot of time there.\nNow I can get going with my recording just as soon as I finish this post.</p>\n<a name=\"4\"></a>\n<h4>Sustainable Autodesk Offices</h4>\n<p>Back to the architectural realm, two new case studies on the green office design of the Autodesk offices in Milan and Farnborough are now live on the Autodesk Sustainable Design Center:\n\n<ul>\n<li><a href=\"http://images.autodesk.com/adsk/files/customer_stories_us_4p_farnborough_r3.pdf\">Farnborough</a></li>\n<li><a href=\"http://images.autodesk.com/adsk/files/customer_stories_us_2p_milan_r3.pdf\">Milano</a></li>\n</ul>\n<p>These projects were implemented by Morgan Lovell plc and Goring &amp; Straja Architects, respectively.\nThe case studies describe the projects, challenges, solutions, results and learning experiences made.</p>\n<p>I hope you find this interesting, useful and feel inspired to pursue the same kind of greening efforts in your own company  :-)\n\n\n\n<a name=\"5\"></a>\n<h4>Determining the RVT File Version Without Revit</h4>\n<p>Back to the main topic that I started discussing above.</p>\n<p>This came up again prompted by a\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2008/10/rvt-file-version.html?cid=6a00e553e168978833017d4061ff1d970c#comment-6a00e553e168978833017d4061ff1d970c\">\ncomment</a> by\n\nVictor Chekalin, or Виктор Чекалин, on the\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2008/10/rvt-file-version.html\">\noriginal post</a>.</p>\n<p>He points to a stackflow discussion thread:\n\n<a href=\"http://stackoverflow.com/questions/14481652/how-can-i-get-the-revit-file-version-using-the-revit-api/14493458\">\nHow can I get the Revit file version using the Revit API?</a>\n<p><strong>Question:</strong> In the Revit API I know that I can get the version of the Revit instance that is currently running:\n\n<ul>\n<li><code>ControlledApplication.VersionBuild</code></li>\n<li><code>ControlledApplication.VersionName</code></li>\n<li><code>ControlledApplication.VersionNumber</code></li>\n</ul>\n<p>However, I would like to get the version of a Revit file itself before I open it.\nThis way I could stop the automatic upgrade dialog that shows when a user opens an older Revit file in a newer version of Revit.\nI'm using Revit 2013 and expecting files from 2011, 2012, and 2013.\n\n\n<p><strong>Answer from\n\n<a href=\"http://stackoverflow.com/users/180529/skeletank\">\nskeletank</a>:</strong>\n\nI took a closer look at the\n\n<a href=\"http://www.revitforum.org/architecture-general-revit-questions/6853-there-tool-determine-what-version-revit.html\">\ndiscussion group posting</a> from\n\nmy question and found that the version information is actually human readable among the other gibberish of the file.\nThe \".rvt\" file is stored in OLE format so you can see the content if you use a tool like\n<a href=\"http://www.mitec.cz/ssv.html\">Structured Storage Viewer</a>.\nIt will be located under <em>BasicFileInfo</em>.</p>\n<p>If you wanted to then you could probably use an\n<a href=\"http://stackoverflow.com/questions/2897328/is-there-any-library-to-access-ole-structured-storage-from-c\">\nOLE library for .NET</a> to\n\nread the data but I used a <code>StreamReader</code> and a <code>Regex</code> instead.</p>\n<p>Here is the regular expression:\n\n<p><code>Revit\\sArchitecture\\s(?<year>\\d{4})\\s(Build:\\s(?<build>\\w*)\\((?<processor>\\w{3})\\)\\)</processor></build></year></code></p>\n<p>Here is the code:\n\n<pre class=\"code\">\n<span class=\"blue\">private</span> <span class=\"blue\">void</span> ControlledApplication_DocumentOpening(\n  <span class=\"blue\">object</span> sender,\n  DocumentOpeningEventArgs e )\n{\n  <span class=\"teal\">FileInfo</span> revitFileToUpgrade\n    = <span class=\"blue\">new</span> <span class=\"teal\">FileInfo</span>( e.PathName );\n \n  Regex buildInfoRegex = <span class=\"blue\">new</span> Regex(\n    <span class=\"maroon\">@\"Revit\\sArchitecture\\s(?&lt;Year&gt;\\d{4})\\s\"</span>\n    +<span class=\"maroon\">@\"\\(Build:\\s(?&lt;Build&gt;\\w*)\\((&lt;Processor&gt;\\w{3})\\)\\)\"</span> );\n \n  <span class=\"blue\">using</span>( <span class=\"teal\">StreamReader</span> streamReader =\n    <span class=\"blue\">new</span> <span class=\"teal\">StreamReader</span>( e.PathName, Encoding.Unicode ) )\n  {\n    <span class=\"blue\">string</span> fileContents = streamReader.ReadToEnd();\n \n    Match buildInfo = buildInfoRegex.Match( fileContents );\n    <span class=\"blue\">string</span> year = buildInfo.Groups[<span class=\"maroon\">\"Year\"</span>].Value;\n    <span class=\"blue\">string</span> build = buildInfo.Groups[<span class=\"maroon\">\"Build\"</span>].Value;\n    <span class=\"blue\">string</span> processor = buildInfo.Groups[<span class=\"maroon\">\"Processor\"</span>].Value;\n  }\n}\n</pre>\n<p>This will allow you to get the year, build number, and the type of processor.\nNotice, however, that my version checks specifically for Architecture so you will need to modify it for MEP or Structural.\n\n\n\n<p><strong>Answer from\n\n<a href=\"http://stackoverflow.com/users/989259/victor-chekalin\">\nVictor Chekalin</a>:</strong>\n<p>As you said, Revit file format is a Structured Storage document and information you need is stored in the BasicFileInfo stream.\n\n<p>Within the Revit 2013 API you can use the SavedInVersion method of the BasicFileInfo class.\n\n<p>Here is the\n\n<a href=\"http://pastebin.com/FUBcmSRx\">\nfull console application</a> demonstrating\n\nhow to extract BasicFileInfo data without the Revit API.\n\n<p>Unfortunately I don't now the format of the BasicFileInfoStream. But if you read it as string you can get version in which file was created.\n\n<p>Reading only the BasicFileInfo is much better than reading the whole file.\nImagine if the Revit project is over 500 MB.\nYou will read the whole file into memory when you call\n\n<pre class=\"code\">\n  <span class=\"blue\">string</span> fileContents = streamReader.ReadToEnd();\n</pre>\n<p>Also, Regular expression on the huge file works slow.\n\n<p>I think you should use\n\n<pre class=\"code\">\n  <span class=\"blue\">var</span> rawString = System.Text.<span class=\"teal\">Encoding</span>.Unicode\n    .GetString( rawData );\n</pre>\n<p>from my sample and use Regex in the rawString instead the whole file.\n\n<p>For your convenience, here is the full source code of Victor's solution:\n\n<pre class=\"code\">\n<span class=\"blue\">using</span> System;\n<span class=\"blue\">using</span> System.IO;\n<span class=\"blue\">using</span> System.IO.Packaging;\n<span class=\"blue\">using</span> System.Reflection;\n<span class=\"blue\">using</span> System.Runtime.InteropServices;\n \n<span class=\"blue\">namespace</span> ConsoleApplication1\n{\n  <span class=\"blue\">class</span> <span class=\"teal\">Program</span>\n  {\n    <span class=\"blue\">private</span> <span class=\"blue\">const</span> <span class=\"blue\">string</span> StreamName = <span class=\"maroon\">\"BasicFileInfo\"</span>;\n \n    <span class=\"blue\">static</span> <span class=\"blue\">void</span> Main( <span class=\"blue\">string</span>[] args )\n    {\n      <span class=\"blue\">string</span> pathToRevitFile = ( 1 == args.Length )\n        ? args[0]\n        : <span class=\"maroon\">@\"pathToRevitFile\"</span>;\n \n \n      <span class=\"blue\">if</span>( !<span class=\"teal\">StructuredStorageUtils</span>.IsFileStucturedStorage(\n        pathToRevitFile ) )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">NotSupportedException</span>(\n          <span class=\"maroon\">\"File is not a structured storage file\"</span> );\n      }\n \n      <span class=\"blue\">var</span> rawData = GetRawBasicFileInfo( pathToRevitFile );\n \n      <span class=\"blue\">var</span> rawString = System.Text.<span class=\"teal\">Encoding</span>.Unicode.GetString(\n        rawData );\n \n      <span class=\"blue\">var</span> fileInfoData = rawString.Split(\n        <span class=\"blue\">new</span> <span class=\"blue\">string</span>[] { <span class=\"maroon\">\"\\0\"</span>, <span class=\"maroon\">\"\\r\\n\"</span> },\n        <span class=\"teal\">StringSplitOptions</span>.RemoveEmptyEntries );\n \n      <span class=\"blue\">foreach</span>( <span class=\"blue\">var</span> info <span class=\"blue\">in</span> fileInfoData )\n      {\n        <span class=\"teal\">Console</span>.WriteLine( info );\n      }\n    }\n \n    <span class=\"blue\">private</span> <span class=\"blue\">static</span> <span class=\"blue\">byte</span>[] GetRawBasicFileInfo(\n      <span class=\"blue\">string</span> revitFileName )\n    {\n      <span class=\"blue\">if</span>( !<span class=\"teal\">StructuredStorageUtils</span>.IsFileStucturedStorage(\n        revitFileName ) )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">NotSupportedException</span>(\n          <span class=\"maroon\">\"File is not a structured storage file\"</span> );\n      }\n \n      <span class=\"blue\">using</span>( <span class=\"teal\">StructuredStorageRoot</span> ssRoot =\n          <span class=\"blue\">new</span> <span class=\"teal\">StructuredStorageRoot</span>( revitFileName ) )\n      {\n        <span class=\"blue\">if</span>( !ssRoot.BaseRoot.StreamExists( StreamName ) )\n          <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">NotSupportedException</span>( <span class=\"blue\">string</span>.Format(\n            <span class=\"maroon\">\"File doesn't contain {0} stream\"</span>, StreamName ) );\n \n        <span class=\"teal\">StreamInfo</span> imageStreamInfo =\n            ssRoot.BaseRoot.GetStreamInfo( StreamName );\n \n        <span class=\"blue\">using</span>( <span class=\"teal\">Stream</span> stream = imageStreamInfo.GetStream(\n          <span class=\"teal\">FileMode</span>.Open, <span class=\"teal\">FileAccess</span>.Read ) )\n        {\n          <span class=\"blue\">byte</span>[] buffer = <span class=\"blue\">new</span> <span class=\"blue\">byte</span>[stream.Length];\n          stream.Read( buffer, 0, buffer.Length );\n          <span class=\"blue\">return</span> buffer;\n        }\n      }\n    }\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">static</span> <span class=\"blue\">class</span> <span class=\"teal\">StructuredStorageUtils</span>\n  {\n    [<span class=\"teal\">DllImport</span>( <span class=\"maroon\">\"ole32.dll\"</span> )]\n    <span class=\"blue\">static</span> <span class=\"blue\">extern</span> <span class=\"blue\">int</span> StgIsStorageFile(\n      [<span class=\"teal\">MarshalAs</span>( <span class=\"teal\">UnmanagedType</span>.LPWStr )]\n      <span class=\"blue\">string</span> pwcsName );\n \n    <span class=\"blue\">public</span> <span class=\"blue\">static</span> <span class=\"blue\">bool</span> IsFileStucturedStorage(\n      <span class=\"blue\">string</span> fileName )\n    {\n      <span class=\"blue\">int</span> res = StgIsStorageFile( fileName );\n \n      <span class=\"blue\">if</span>( res == 0 )\n        <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n \n      <span class=\"blue\">if</span>( res == 1 )\n        <span class=\"blue\">return</span> <span class=\"blue\">false</span>;\n \n      <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">FileNotFoundException</span>(\n        <span class=\"maroon\">\"File not found\"</span>, fileName );\n    }\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">StructuredStorageException</span> : <span class=\"teal\">Exception</span>\n  {\n    <span class=\"blue\">public</span> StructuredStorageException()\n    {\n    }\n \n    <span class=\"blue\">public</span> StructuredStorageException( <span class=\"blue\">string</span> message )\n      : <span class=\"blue\">base</span>( message )\n    {\n    }\n \n    <span class=\"blue\">public</span> StructuredStorageException(\n      <span class=\"blue\">string</span> message,\n      <span class=\"teal\">Exception</span> innerException )\n      : <span class=\"blue\">base</span>( message, innerException )\n    {\n    }\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">StructuredStorageRoot</span> : <span class=\"teal\">IDisposable</span>\n  {\n    <span class=\"teal\">StorageInfo</span> _storageRoot;\n \n    <span class=\"blue\">public</span> StructuredStorageRoot( <span class=\"teal\">Stream</span> stream )\n    {\n      <span class=\"blue\">try</span>\n      {\n        _storageRoot\n          = (<span class=\"teal\">StorageInfo</span>)InvokeStorageRootMethod(\n            <span class=\"blue\">null</span>, <span class=\"maroon\">\"CreateOnStream\"</span>, stream );\n      }\n      <span class=\"blue\">catch</span>( <span class=\"teal\">Exception</span> ex )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">StructuredStorageException</span>(\n          <span class=\"maroon\">\"Cannot get StructuredStorageRoot\"</span>, ex );\n      }\n    }\n \n    <span class=\"blue\">public</span> StructuredStorageRoot( <span class=\"blue\">string</span> fileName )\n    {\n      <span class=\"blue\">try</span>\n      {\n        _storageRoot\n          = (<span class=\"teal\">StorageInfo</span>)InvokeStorageRootMethod(\n            <span class=\"blue\">null</span>, <span class=\"maroon\">\"Open\"</span>, fileName, <span class=\"teal\">FileMode</span>.Open,\n            <span class=\"teal\">FileAccess</span>.Read, <span class=\"teal\">FileShare</span>.Read );\n      }\n      <span class=\"blue\">catch</span>( <span class=\"teal\">Exception</span> ex )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">StructuredStorageException</span>(\n          <span class=\"maroon\">\"Cannot get StructuredStorageRoot\"</span>, ex );\n      }\n    }\n \n    <span class=\"blue\">private</span> <span class=\"blue\">static</span> <span class=\"blue\">object</span> InvokeStorageRootMethod(\n      <span class=\"teal\">StorageInfo</span> storageRoot,\n      <span class=\"blue\">string</span> methodName,\n      <span class=\"blue\">params</span> <span class=\"blue\">object</span>[] methodArgs )\n    {\n      <span class=\"teal\">Type</span> storageRootType\n        = <span class=\"blue\">typeof</span>( <span class=\"teal\">StorageInfo</span> ).Assembly.GetType(\n          <span class=\"maroon\">\"System.IO.Packaging.StorageRoot\"</span>,\n          <span class=\"blue\">true</span>, <span class=\"blue\">false</span> );\n \n      <span class=\"blue\">object</span> result = storageRootType.InvokeMember(\n        methodName,\n        <span class=\"teal\">BindingFlags</span>.Static | <span class=\"teal\">BindingFlags</span>.Instance\n        | <span class=\"teal\">BindingFlags</span>.Public | <span class=\"teal\">BindingFlags</span>.NonPublic\n        | <span class=\"teal\">BindingFlags</span>.InvokeMethod,\n        <span class=\"blue\">null</span>, storageRoot, methodArgs );\n \n      <span class=\"blue\">return</span> result;\n    }\n \n    <span class=\"blue\">private</span> <span class=\"blue\">void</span> CloseStorageRoot()\n    {\n      InvokeStorageRootMethod( _storageRoot, <span class=\"maroon\">\"Close\"</span> );\n    }\n \n<span class=\"blue\">    #region</span> Implementation of IDisposable\n \n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> Dispose()\n    {\n      CloseStorageRoot();\n    }\n \n<span class=\"blue\">    #endregion</span>\n \n    <span class=\"blue\">public</span> <span class=\"teal\">StorageInfo</span> BaseRoot\n    {\n      <span class=\"blue\">get</span> { <span class=\"blue\">return</span> _storageRoot; }\n    }\n  }\n}\n</pre>\n<p>For your even greater convenience, I am also providing\n\n<a href=\"zip/RevitBasicFileInfo.zip\">RevitBasicFileInfo.zip</a> containing\n\nthe full Visual Studio solution that I created to test it.</p>\n<p>Here is the result of running this on a sample model on my system:</p>\n<center>\n<img alt=\"Basic File Info\" src=\"img/basic_file_info.png\"/>\n</center>\n<p>Many thanks to Victor for his clear explanation and solution!</p>\n<p><strong>Addendum:</strong> To get access to the StreamInfo class you need reference the WindowsBase.dll assembly.\n\n<p>The question marks displayed in the result console above are due to the fact that one part of BasicFileInfo is encoded in Unicode and another in BigEndianUnicode.\n\n<p>The second part is rendered legible by accessing it like this instead:\n\n<pre>\n  var rawString = System.Text.Encoding\n    .BigEndianUnicode.GetString( rawData );\n</pre>\n<p>Here is the same file information presented twice, once in standard little endian and once in big endian decoding:</p>\n<center>\n<img alt=\"Basic File Info in little and big endian decoding\" src=\"img/basic_file_info2.png\"/>\n</center>\n<p>This is a summary of the resulting readable text fields:</p>\n<ul>\n<li>Little-endian:</li>\n<ul>\n<li>Autodesk Revit 2013 (Build: 20120716_1115)</li>\n<li>C:\\j\\tmp\\rvt\\floor_slab.rvt</li>\n</ul>\n<li>Big-endian:</li>\n<ul>\n<li>00000000-0000-0000-0000-000000000000</li>\n<li>Worksharing: Not enabled</li>\n<li>Username:</li>\n<li>Central Model Path:</li>\n<li>Revit Build: Autodesk Revit 2013 (Build: 20120716_1115)</li>\n<li>Last Save Path: C:\\j\\tmp\\rvt\\floor_slab.rvt</li>\n<li>Open Workset Default: 3</li>\n<li>Project Spark File: 0</li>\n<li>Central Model Identity: 00000000-0000-0000-0000-000000000000</li>\n<li>Locale when saved: ENU</li>\n</ul>\n</ul>\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0887_rvt_file_version",
    "header_text": "Building Setout Points Used in a Commercial Application",
    "local_header_href": "#building-setout-points-used-in-a-commercial-application",
    "chunk_text": "<h4>Building Setout Points Used in a Commercial Application</h4><p>I am glad to say that one of the sample add-ins I am particularly happy with now made its way into a commercial application.</p><p>Here is an excerpt from the current Australian\n\n<a href=\"http://www.arsoftwaresolutions.com.au\">\nARSoftwareSolutions</a>\n\nnewsletter:\n\n<p>A recent meander through the TheBuildingCoder website led me to a routine for\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2012/08/structural-concrete-setout-point-add-in.html\">\nmarking the corners of structural concrete corners</a>.\n\nOnce marked the points could be scheduled and provided to the builder as a file of set out point coordinates.\nThese can then be established on site using various surveying tools.\nThis seemed like something a lot of companies could benefit from so I set about including it in my software.\n(Please refer to <a href=\"http://thebuildingcoder.typepad.com/blog/rst\">http://thebuildingcoder.typepad.com/blog/rst</a> for more complete details.\nThank you to both Paul Hellawell of GHD and Jeremy Tammik for the idea and some of the coding.)\n\n<p>Of course I couldn't just leave it the way it was so I expanded on the concept, added extra functionality, and this now forms a part of ARUtils - Leader.\n\n<p>The basic concept is to mark all structural concrete corners with a \"SetoutPoint\" family.\nCritical setout points can then use a \"Major\" type of that family to indicate they are a critical point.\nAlternatively other points can be automatically designated as minor, centre points of curves, control points of splines, or just intermediate points along curves.\nPoints can be promoted to Major or demoted to Minor as required for construction or changing needs.\n\n<p>When automatically placed at a point, each marker has the X,Y, and Z coordinates assigned to the marker.\nOnce this has been done, the families can be scheduled and the points exported for use by the builder.\nThe routine also keeps track of the item that generated the points so points can be grouped on a generating object basis.\n\n<center>\n<img alt=\"Point markers\" src=\"img/setout_points_ar1.jpeg\"/>\n<p><i>Points marked. Diagram shows Major, Minor, Centre, Control and Curve following points.</i></p>\n<img alt=\"Tagged points\" src=\"img/setout_points_ar2.jpeg\"/>\n<p><i>Tagged points</i></p>\n<img alt=\"Key setout points\" src=\"img/setout_points_ar3.png\"/>\n<p><i>Scheduled Keypoints</i></p>\n<img alt=\"Schedule of all points\" src=\"img/setout_points_ar4.png\"/>\n<p><i>Schedule - All points</i></p>\n<img alt=\"Interface\" src=\"img/setout_points_ar5.jpeg\"/>\n<p><i>The interface</i></p>\n</center>\n<p>Note: You can automatically mark all structural concrete items, or pick specific items of any type to have markers placed.\n\n<p>Note: Should the project location change the coordinates can be automatically synchronised using the \"Renumber / Update\" option.\n\n<p>I am happy to see my efforts helping people and making their way out into the world  :-)\n\n\n\n<a name=\"3\"></a>\n<h4>Screen Recording on the Mac</h4>\n<p>On a completely different topic, I have been struggling a bit the past few days to set up a proper screen recording environment for myself to create a canned presentation.</p>\n<p>I want to show some Powerpoint slides, record my narration, and also make use of Revit and Visual Studio for add-in demonstrations.</p>\n<p>I planned to use Camtasia for this, as I have past experience with it and it does a good job.</p>\n<p>The Revit and Visual Studio requirements led me to believe that I had to install Camtasia in my Windows virtual machine.</p>\n<p>When I did that, I discovered that the Windows version that I had installed was European and therefore lacked the Windows Media Player, which caused Camtasia to fail. It took a while to find out, though.</p>\n<p>I went off and downloaded a US version of Windows, created a new virtual machine, installed Revit, Visual Studio, Camtasia, and some other bits and pieces on it.</p>\n<p>After doing all that, I discovered that the Camtasia output quality from this setup is suboptimal, and there are often problems with the audio getting lost completely.</p>\n<p>After struggling a bit more with that, a colleague told me that the easiest thing to do is just to use Camtasia in the native Mac system and record the full screen.\nI can display the Powerpoint slides in full screen, record my narration, and switch back and forth to a full-screen virtual Windows machine at any time.\nSo I wasted a lot of time there.\nNow I can get going with my recording just as soon as I finish this post.</p>\n<a name=\"4\"></a>\n<h4>Sustainable Autodesk Offices</h4>\n<p>Back to the architectural realm, two new case studies on the green office design of the Autodesk offices in Milan and Farnborough are now live on the Autodesk Sustainable Design Center:\n\n<ul>\n<li><a href=\"http://images.autodesk.com/adsk/files/customer_stories_us_4p_farnborough_r3.pdf\">Farnborough</a></li>\n<li><a href=\"http://images.autodesk.com/adsk/files/customer_stories_us_2p_milan_r3.pdf\">Milano</a></li>\n</ul>\n<p>These projects were implemented by Morgan Lovell plc and Goring &amp; Straja Architects, respectively.\nThe case studies describe the projects, challenges, solutions, results and learning experiences made.</p>\n<p>I hope you find this interesting, useful and feel inspired to pursue the same kind of greening efforts in your own company  :-)\n\n\n\n<a name=\"5\"></a>\n<h4>Determining the RVT File Version Without Revit</h4>\n<p>Back to the main topic that I started discussing above.</p>\n<p>This came up again prompted by a\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2008/10/rvt-file-version.html?cid=6a00e553e168978833017d4061ff1d970c#comment-6a00e553e168978833017d4061ff1d970c\">\ncomment</a> by\n\nVictor Chekalin, or Виктор Чекалин, on the\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2008/10/rvt-file-version.html\">\noriginal post</a>.</p>\n<p>He points to a stackflow discussion thread:\n\n<a href=\"http://stackoverflow.com/questions/14481652/how-can-i-get-the-revit-file-version-using-the-revit-api/14493458\">\nHow can I get the Revit file version using the Revit API?</a>\n<p><strong>Question:</strong> In the Revit API I know that I can get the version of the Revit instance that is currently running:\n\n<ul>\n<li><code>ControlledApplication.VersionBuild</code></li>\n<li><code>ControlledApplication.VersionName</code></li>\n<li><code>ControlledApplication.VersionNumber</code></li>\n</ul>\n<p>However, I would like to get the version of a Revit file itself before I open it.\nThis way I could stop the automatic upgrade dialog that shows when a user opens an older Revit file in a newer version of Revit.\nI'm using Revit 2013 and expecting files from 2011, 2012, and 2013.\n\n\n<p><strong>Answer from\n\n<a href=\"http://stackoverflow.com/users/180529/skeletank\">\nskeletank</a>:</strong>\n\nI took a closer look at the\n\n<a href=\"http://www.revitforum.org/architecture-general-revit-questions/6853-there-tool-determine-what-version-revit.html\">\ndiscussion group posting</a> from\n\nmy question and found that the version information is actually human readable among the other gibberish of the file.\nThe \".rvt\" file is stored in OLE format so you can see the content if you use a tool like\n<a href=\"http://www.mitec.cz/ssv.html\">Structured Storage Viewer</a>.\nIt will be located under <em>BasicFileInfo</em>.</p>\n<p>If you wanted to then you could probably use an\n<a href=\"http://stackoverflow.com/questions/2897328/is-there-any-library-to-access-ole-structured-storage-from-c\">\nOLE library for .NET</a> to\n\nread the data but I used a <code>StreamReader</code> and a <code>Regex</code> instead.</p>\n<p>Here is the regular expression:\n\n<p><code>Revit\\sArchitecture\\s(?<year>\\d{4})\\s(Build:\\s(?<build>\\w*)\\((?<processor>\\w{3})\\)\\)</processor></build></year></code></p>\n<p>Here is the code:\n\n<pre class=\"code\">\n<span class=\"blue\">private</span> <span class=\"blue\">void</span> ControlledApplication_DocumentOpening(\n  <span class=\"blue\">object</span> sender,\n  DocumentOpeningEventArgs e )\n{\n  <span class=\"teal\">FileInfo</span> revitFileToUpgrade\n    = <span class=\"blue\">new</span> <span class=\"teal\">FileInfo</span>( e.PathName );\n \n  Regex buildInfoRegex = <span class=\"blue\">new</span> Regex(\n    <span class=\"maroon\">@\"Revit\\sArchitecture\\s(?&lt;Year&gt;\\d{4})\\s\"</span>\n    +<span class=\"maroon\">@\"\\(Build:\\s(?&lt;Build&gt;\\w*)\\((&lt;Processor&gt;\\w{3})\\)\\)\"</span> );\n \n  <span class=\"blue\">using</span>( <span class=\"teal\">StreamReader</span> streamReader =\n    <span class=\"blue\">new</span> <span class=\"teal\">StreamReader</span>( e.PathName, Encoding.Unicode ) )\n  {\n    <span class=\"blue\">string</span> fileContents = streamReader.ReadToEnd();\n \n    Match buildInfo = buildInfoRegex.Match( fileContents );\n    <span class=\"blue\">string</span> year = buildInfo.Groups[<span class=\"maroon\">\"Year\"</span>].Value;\n    <span class=\"blue\">string</span> build = buildInfo.Groups[<span class=\"maroon\">\"Build\"</span>].Value;\n    <span class=\"blue\">string</span> processor = buildInfo.Groups[<span class=\"maroon\">\"Processor\"</span>].Value;\n  }\n}\n</pre>\n<p>This will allow you to get the year, build number, and the type of processor.\nNotice, however, that my version checks specifically for Architecture so you will need to modify it for MEP or Structural.\n\n\n\n<p><strong>Answer from\n\n<a href=\"http://stackoverflow.com/users/989259/victor-chekalin\">\nVictor Chekalin</a>:</strong>\n<p>As you said, Revit file format is a Structured Storage document and information you need is stored in the BasicFileInfo stream.\n\n<p>Within the Revit 2013 API you can use the SavedInVersion method of the BasicFileInfo class.\n\n<p>Here is the\n\n<a href=\"http://pastebin.com/FUBcmSRx\">\nfull console application</a> demonstrating\n\nhow to extract BasicFileInfo data without the Revit API.\n\n<p>Unfortunately I don't now the format of the BasicFileInfoStream. But if you read it as string you can get version in which file was created.\n\n<p>Reading only the BasicFileInfo is much better than reading the whole file.\nImagine if the Revit project is over 500 MB.\nYou will read the whole file into memory when you call\n\n<pre class=\"code\">\n  <span class=\"blue\">string</span> fileContents = streamReader.ReadToEnd();\n</pre>\n<p>Also, Regular expression on the huge file works slow.\n\n<p>I think you should use\n\n<pre class=\"code\">\n  <span class=\"blue\">var</span> rawString = System.Text.<span class=\"teal\">Encoding</span>.Unicode\n    .GetString( rawData );\n</pre>\n<p>from my sample and use Regex in the rawString instead the whole file.\n\n<p>For your convenience, here is the full source code of Victor's solution:\n\n<pre class=\"code\">\n<span class=\"blue\">using</span> System;\n<span class=\"blue\">using</span> System.IO;\n<span class=\"blue\">using</span> System.IO.Packaging;\n<span class=\"blue\">using</span> System.Reflection;\n<span class=\"blue\">using</span> System.Runtime.InteropServices;\n \n<span class=\"blue\">namespace</span> ConsoleApplication1\n{\n  <span class=\"blue\">class</span> <span class=\"teal\">Program</span>\n  {\n    <span class=\"blue\">private</span> <span class=\"blue\">const</span> <span class=\"blue\">string</span> StreamName = <span class=\"maroon\">\"BasicFileInfo\"</span>;\n \n    <span class=\"blue\">static</span> <span class=\"blue\">void</span> Main( <span class=\"blue\">string</span>[] args )\n    {\n      <span class=\"blue\">string</span> pathToRevitFile = ( 1 == args.Length )\n        ? args[0]\n        : <span class=\"maroon\">@\"pathToRevitFile\"</span>;\n \n \n      <span class=\"blue\">if</span>( !<span class=\"teal\">StructuredStorageUtils</span>.IsFileStucturedStorage(\n        pathToRevitFile ) )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">NotSupportedException</span>(\n          <span class=\"maroon\">\"File is not a structured storage file\"</span> );\n      }\n \n      <span class=\"blue\">var</span> rawData = GetRawBasicFileInfo( pathToRevitFile );\n \n      <span class=\"blue\">var</span> rawString = System.Text.<span class=\"teal\">Encoding</span>.Unicode.GetString(\n        rawData );\n \n      <span class=\"blue\">var</span> fileInfoData = rawString.Split(\n        <span class=\"blue\">new</span> <span class=\"blue\">string</span>[] { <span class=\"maroon\">\"\\0\"</span>, <span class=\"maroon\">\"\\r\\n\"</span> },\n        <span class=\"teal\">StringSplitOptions</span>.RemoveEmptyEntries );\n \n      <span class=\"blue\">foreach</span>( <span class=\"blue\">var</span> info <span class=\"blue\">in</span> fileInfoData )\n      {\n        <span class=\"teal\">Console</span>.WriteLine( info );\n      }\n    }\n \n    <span class=\"blue\">private</span> <span class=\"blue\">static</span> <span class=\"blue\">byte</span>[] GetRawBasicFileInfo(\n      <span class=\"blue\">string</span> revitFileName )\n    {\n      <span class=\"blue\">if</span>( !<span class=\"teal\">StructuredStorageUtils</span>.IsFileStucturedStorage(\n        revitFileName ) )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">NotSupportedException</span>(\n          <span class=\"maroon\">\"File is not a structured storage file\"</span> );\n      }\n \n      <span class=\"blue\">using</span>( <span class=\"teal\">StructuredStorageRoot</span> ssRoot =\n          <span class=\"blue\">new</span> <span class=\"teal\">StructuredStorageRoot</span>( revitFileName ) )\n      {\n        <span class=\"blue\">if</span>( !ssRoot.BaseRoot.StreamExists( StreamName ) )\n          <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">NotSupportedException</span>( <span class=\"blue\">string</span>.Format(\n            <span class=\"maroon\">\"File doesn't contain {0} stream\"</span>, StreamName ) );\n \n        <span class=\"teal\">StreamInfo</span> imageStreamInfo =\n            ssRoot.BaseRoot.GetStreamInfo( StreamName );\n \n        <span class=\"blue\">using</span>( <span class=\"teal\">Stream</span> stream = imageStreamInfo.GetStream(\n          <span class=\"teal\">FileMode</span>.Open, <span class=\"teal\">FileAccess</span>.Read ) )\n        {\n          <span class=\"blue\">byte</span>[] buffer = <span class=\"blue\">new</span> <span class=\"blue\">byte</span>[stream.Length];\n          stream.Read( buffer, 0, buffer.Length );\n          <span class=\"blue\">return</span> buffer;\n        }\n      }\n    }\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">static</span> <span class=\"blue\">class</span> <span class=\"teal\">StructuredStorageUtils</span>\n  {\n    [<span class=\"teal\">DllImport</span>( <span class=\"maroon\">\"ole32.dll\"</span> )]\n    <span class=\"blue\">static</span> <span class=\"blue\">extern</span> <span class=\"blue\">int</span> StgIsStorageFile(\n      [<span class=\"teal\">MarshalAs</span>( <span class=\"teal\">UnmanagedType</span>.LPWStr )]\n      <span class=\"blue\">string</span> pwcsName );\n \n    <span class=\"blue\">public</span> <span class=\"blue\">static</span> <span class=\"blue\">bool</span> IsFileStucturedStorage(\n      <span class=\"blue\">string</span> fileName )\n    {\n      <span class=\"blue\">int</span> res = StgIsStorageFile( fileName );\n \n      <span class=\"blue\">if</span>( res == 0 )\n        <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n \n      <span class=\"blue\">if</span>( res == 1 )\n        <span class=\"blue\">return</span> <span class=\"blue\">false</span>;\n \n      <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">FileNotFoundException</span>(\n        <span class=\"maroon\">\"File not found\"</span>, fileName );\n    }\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">StructuredStorageException</span> : <span class=\"teal\">Exception</span>\n  {\n    <span class=\"blue\">public</span> StructuredStorageException()\n    {\n    }\n \n    <span class=\"blue\">public</span> StructuredStorageException( <span class=\"blue\">string</span> message )\n      : <span class=\"blue\">base</span>( message )\n    {\n    }\n \n    <span class=\"blue\">public</span> StructuredStorageException(\n      <span class=\"blue\">string</span> message,\n      <span class=\"teal\">Exception</span> innerException )\n      : <span class=\"blue\">base</span>( message, innerException )\n    {\n    }\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">StructuredStorageRoot</span> : <span class=\"teal\">IDisposable</span>\n  {\n    <span class=\"teal\">StorageInfo</span> _storageRoot;\n \n    <span class=\"blue\">public</span> StructuredStorageRoot( <span class=\"teal\">Stream</span> stream )\n    {\n      <span class=\"blue\">try</span>\n      {\n        _storageRoot\n          = (<span class=\"teal\">StorageInfo</span>)InvokeStorageRootMethod(\n            <span class=\"blue\">null</span>, <span class=\"maroon\">\"CreateOnStream\"</span>, stream );\n      }\n      <span class=\"blue\">catch</span>( <span class=\"teal\">Exception</span> ex )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">StructuredStorageException</span>(\n          <span class=\"maroon\">\"Cannot get StructuredStorageRoot\"</span>, ex );\n      }\n    }\n \n    <span class=\"blue\">public</span> StructuredStorageRoot( <span class=\"blue\">string</span> fileName )\n    {\n      <span class=\"blue\">try</span>\n      {\n        _storageRoot\n          = (<span class=\"teal\">StorageInfo</span>)InvokeStorageRootMethod(\n            <span class=\"blue\">null</span>, <span class=\"maroon\">\"Open\"</span>, fileName, <span class=\"teal\">FileMode</span>.Open,\n            <span class=\"teal\">FileAccess</span>.Read, <span class=\"teal\">FileShare</span>.Read );\n      }\n      <span class=\"blue\">catch</span>( <span class=\"teal\">Exception</span> ex )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">StructuredStorageException</span>(\n          <span class=\"maroon\">\"Cannot get StructuredStorageRoot\"</span>, ex );\n      }\n    }\n \n    <span class=\"blue\">private</span> <span class=\"blue\">static</span> <span class=\"blue\">object</span> InvokeStorageRootMethod(\n      <span class=\"teal\">StorageInfo</span> storageRoot,\n      <span class=\"blue\">string</span> methodName,\n      <span class=\"blue\">params</span> <span class=\"blue\">object</span>[] methodArgs )\n    {\n      <span class=\"teal\">Type</span> storageRootType\n        = <span class=\"blue\">typeof</span>( <span class=\"teal\">StorageInfo</span> ).Assembly.GetType(\n          <span class=\"maroon\">\"System.IO.Packaging.StorageRoot\"</span>,\n          <span class=\"blue\">true</span>, <span class=\"blue\">false</span> );\n \n      <span class=\"blue\">object</span> result = storageRootType.InvokeMember(\n        methodName,\n        <span class=\"teal\">BindingFlags</span>.Static | <span class=\"teal\">BindingFlags</span>.Instance\n        | <span class=\"teal\">BindingFlags</span>.Public | <span class=\"teal\">BindingFlags</span>.NonPublic\n        | <span class=\"teal\">BindingFlags</span>.InvokeMethod,\n        <span class=\"blue\">null</span>, storageRoot, methodArgs );\n \n      <span class=\"blue\">return</span> result;\n    }\n \n    <span class=\"blue\">private</span> <span class=\"blue\">void</span> CloseStorageRoot()\n    {\n      InvokeStorageRootMethod( _storageRoot, <span class=\"maroon\">\"Close\"</span> );\n    }\n \n<span class=\"blue\">    #region</span> Implementation of IDisposable\n \n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> Dispose()\n    {\n      CloseStorageRoot();\n    }\n \n<span class=\"blue\">    #endregion</span>\n \n    <span class=\"blue\">public</span> <span class=\"teal\">StorageInfo</span> BaseRoot\n    {\n      <span class=\"blue\">get</span> { <span class=\"blue\">return</span> _storageRoot; }\n    }\n  }\n}\n</pre>\n<p>For your even greater convenience, I am also providing\n\n<a href=\"zip/RevitBasicFileInfo.zip\">RevitBasicFileInfo.zip</a> containing\n\nthe full Visual Studio solution that I created to test it.</p>\n<p>Here is the result of running this on a sample model on my system:</p>\n<center>\n<img alt=\"Basic File Info\" src=\"img/basic_file_info.png\"/>\n</center>\n<p>Many thanks to Victor for his clear explanation and solution!</p>\n<p><strong>Addendum:</strong> To get access to the StreamInfo class you need reference the WindowsBase.dll assembly.\n\n<p>The question marks displayed in the result console above are due to the fact that one part of BasicFileInfo is encoded in Unicode and another in BigEndianUnicode.\n\n<p>The second part is rendered legible by accessing it like this instead:\n\n<pre>\n  var rawString = System.Text.Encoding\n    .BigEndianUnicode.GetString( rawData );\n</pre>\n<p>Here is the same file information presented twice, once in standard little endian and once in big endian decoding:</p>\n<center>\n<img alt=\"Basic File Info in little and big endian decoding\" src=\"img/basic_file_info2.png\"/>\n</center>\n<p>This is a summary of the resulting readable text fields:</p>\n<ul>\n<li>Little-endian:</li>\n<ul>\n<li>Autodesk Revit 2013 (Build: 20120716_1115)</li>\n<li>C:\\j\\tmp\\rvt\\floor_slab.rvt</li>\n</ul>\n<li>Big-endian:</li>\n<ul>\n<li>00000000-0000-0000-0000-000000000000</li>\n<li>Worksharing: Not enabled</li>\n<li>Username:</li>\n<li>Central Model Path:</li>\n<li>Revit Build: Autodesk Revit 2013 (Build: 20120716_1115)</li>\n<li>Last Save Path: C:\\j\\tmp\\rvt\\floor_slab.rvt</li>\n<li>Open Workset Default: 3</li>\n<li>Project Spark File: 0</li>\n<li>Central Model Identity: 00000000-0000-0000-0000-000000000000</li>\n<li>Locale when saved: ENU</li>\n</ul>\n</ul>\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0887_rvt_file_version",
    "header_text": "Screen Recording on the Mac",
    "local_header_href": "#screen-recording-on-the-mac",
    "chunk_text": "<h4>Screen Recording on the Mac</h4><p>On a completely different topic, I have been struggling a bit the past few days to set up a proper screen recording environment for myself to create a canned presentation.</p><p>I want to show some Powerpoint slides, record my narration, and also make use of Revit and Visual Studio for add-in demonstrations.</p><p>I planned to use Camtasia for this, as I have past experience with it and it does a good job.</p><p>The Revit and Visual Studio requirements led me to believe that I had to install Camtasia in my Windows virtual machine.</p><p>When I did that, I discovered that the Windows version that I had installed was European and therefore lacked the Windows Media Player, which caused Camtasia to fail. It took a while to find out, though.</p><p>I went off and downloaded a US version of Windows, created a new virtual machine, installed Revit, Visual Studio, Camtasia, and some other bits and pieces on it.</p><p>After doing all that, I discovered that the Camtasia output quality from this setup is suboptimal, and there are often problems with the audio getting lost completely.</p><p>After struggling a bit more with that, a colleague told me that the easiest thing to do is just to use Camtasia in the native Mac system and record the full screen.\nI can display the Powerpoint slides in full screen, record my narration, and switch back and forth to a full-screen virtual Windows machine at any time.\nSo I wasted a lot of time there.\nNow I can get going with my recording just as soon as I finish this post.</p><a name=\"4\"></a>"
  },
  {
    "original_filename": "0887_rvt_file_version",
    "header_text": "Sustainable Autodesk Offices",
    "local_header_href": "#sustainable-autodesk-offices",
    "chunk_text": "<h4>Sustainable Autodesk Offices</h4><p>Back to the architectural realm, two new case studies on the green office design of the Autodesk offices in Milan and Farnborough are now live on the Autodesk Sustainable Design Center:\n\n<ul>\n<li><a href=\"http://images.autodesk.com/adsk/files/customer_stories_us_4p_farnborough_r3.pdf\">Farnborough</a></li>\n<li><a href=\"http://images.autodesk.com/adsk/files/customer_stories_us_2p_milan_r3.pdf\">Milano</a></li>\n</ul>\n<p>These projects were implemented by Morgan Lovell plc and Goring &amp; Straja Architects, respectively.\nThe case studies describe the projects, challenges, solutions, results and learning experiences made.</p>\n<p>I hope you find this interesting, useful and feel inspired to pursue the same kind of greening efforts in your own company  :-)\n\n\n\n<a name=\"5\"></a>\n<h4>Determining the RVT File Version Without Revit</h4>\n<p>Back to the main topic that I started discussing above.</p>\n<p>This came up again prompted by a\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2008/10/rvt-file-version.html?cid=6a00e553e168978833017d4061ff1d970c#comment-6a00e553e168978833017d4061ff1d970c\">\ncomment</a> by\n\nVictor Chekalin, or Виктор Чекалин, on the\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2008/10/rvt-file-version.html\">\noriginal post</a>.</p>\n<p>He points to a stackflow discussion thread:\n\n<a href=\"http://stackoverflow.com/questions/14481652/how-can-i-get-the-revit-file-version-using-the-revit-api/14493458\">\nHow can I get the Revit file version using the Revit API?</a>\n<p><strong>Question:</strong> In the Revit API I know that I can get the version of the Revit instance that is currently running:\n\n<ul>\n<li><code>ControlledApplication.VersionBuild</code></li>\n<li><code>ControlledApplication.VersionName</code></li>\n<li><code>ControlledApplication.VersionNumber</code></li>\n</ul>\n<p>However, I would like to get the version of a Revit file itself before I open it.\nThis way I could stop the automatic upgrade dialog that shows when a user opens an older Revit file in a newer version of Revit.\nI'm using Revit 2013 and expecting files from 2011, 2012, and 2013.\n\n\n<p><strong>Answer from\n\n<a href=\"http://stackoverflow.com/users/180529/skeletank\">\nskeletank</a>:</strong>\n\nI took a closer look at the\n\n<a href=\"http://www.revitforum.org/architecture-general-revit-questions/6853-there-tool-determine-what-version-revit.html\">\ndiscussion group posting</a> from\n\nmy question and found that the version information is actually human readable among the other gibberish of the file.\nThe \".rvt\" file is stored in OLE format so you can see the content if you use a tool like\n<a href=\"http://www.mitec.cz/ssv.html\">Structured Storage Viewer</a>.\nIt will be located under <em>BasicFileInfo</em>.</p>\n<p>If you wanted to then you could probably use an\n<a href=\"http://stackoverflow.com/questions/2897328/is-there-any-library-to-access-ole-structured-storage-from-c\">\nOLE library for .NET</a> to\n\nread the data but I used a <code>StreamReader</code> and a <code>Regex</code> instead.</p>\n<p>Here is the regular expression:\n\n<p><code>Revit\\sArchitecture\\s(?<year>\\d{4})\\s(Build:\\s(?<build>\\w*)\\((?<processor>\\w{3})\\)\\)</processor></build></year></code></p>\n<p>Here is the code:\n\n<pre class=\"code\">\n<span class=\"blue\">private</span> <span class=\"blue\">void</span> ControlledApplication_DocumentOpening(\n  <span class=\"blue\">object</span> sender,\n  DocumentOpeningEventArgs e )\n{\n  <span class=\"teal\">FileInfo</span> revitFileToUpgrade\n    = <span class=\"blue\">new</span> <span class=\"teal\">FileInfo</span>( e.PathName );\n \n  Regex buildInfoRegex = <span class=\"blue\">new</span> Regex(\n    <span class=\"maroon\">@\"Revit\\sArchitecture\\s(?&lt;Year&gt;\\d{4})\\s\"</span>\n    +<span class=\"maroon\">@\"\\(Build:\\s(?&lt;Build&gt;\\w*)\\((&lt;Processor&gt;\\w{3})\\)\\)\"</span> );\n \n  <span class=\"blue\">using</span>( <span class=\"teal\">StreamReader</span> streamReader =\n    <span class=\"blue\">new</span> <span class=\"teal\">StreamReader</span>( e.PathName, Encoding.Unicode ) )\n  {\n    <span class=\"blue\">string</span> fileContents = streamReader.ReadToEnd();\n \n    Match buildInfo = buildInfoRegex.Match( fileContents );\n    <span class=\"blue\">string</span> year = buildInfo.Groups[<span class=\"maroon\">\"Year\"</span>].Value;\n    <span class=\"blue\">string</span> build = buildInfo.Groups[<span class=\"maroon\">\"Build\"</span>].Value;\n    <span class=\"blue\">string</span> processor = buildInfo.Groups[<span class=\"maroon\">\"Processor\"</span>].Value;\n  }\n}\n</pre>\n<p>This will allow you to get the year, build number, and the type of processor.\nNotice, however, that my version checks specifically for Architecture so you will need to modify it for MEP or Structural.\n\n\n\n<p><strong>Answer from\n\n<a href=\"http://stackoverflow.com/users/989259/victor-chekalin\">\nVictor Chekalin</a>:</strong>\n<p>As you said, Revit file format is a Structured Storage document and information you need is stored in the BasicFileInfo stream.\n\n<p>Within the Revit 2013 API you can use the SavedInVersion method of the BasicFileInfo class.\n\n<p>Here is the\n\n<a href=\"http://pastebin.com/FUBcmSRx\">\nfull console application</a> demonstrating\n\nhow to extract BasicFileInfo data without the Revit API.\n\n<p>Unfortunately I don't now the format of the BasicFileInfoStream. But if you read it as string you can get version in which file was created.\n\n<p>Reading only the BasicFileInfo is much better than reading the whole file.\nImagine if the Revit project is over 500 MB.\nYou will read the whole file into memory when you call\n\n<pre class=\"code\">\n  <span class=\"blue\">string</span> fileContents = streamReader.ReadToEnd();\n</pre>\n<p>Also, Regular expression on the huge file works slow.\n\n<p>I think you should use\n\n<pre class=\"code\">\n  <span class=\"blue\">var</span> rawString = System.Text.<span class=\"teal\">Encoding</span>.Unicode\n    .GetString( rawData );\n</pre>\n<p>from my sample and use Regex in the rawString instead the whole file.\n\n<p>For your convenience, here is the full source code of Victor's solution:\n\n<pre class=\"code\">\n<span class=\"blue\">using</span> System;\n<span class=\"blue\">using</span> System.IO;\n<span class=\"blue\">using</span> System.IO.Packaging;\n<span class=\"blue\">using</span> System.Reflection;\n<span class=\"blue\">using</span> System.Runtime.InteropServices;\n \n<span class=\"blue\">namespace</span> ConsoleApplication1\n{\n  <span class=\"blue\">class</span> <span class=\"teal\">Program</span>\n  {\n    <span class=\"blue\">private</span> <span class=\"blue\">const</span> <span class=\"blue\">string</span> StreamName = <span class=\"maroon\">\"BasicFileInfo\"</span>;\n \n    <span class=\"blue\">static</span> <span class=\"blue\">void</span> Main( <span class=\"blue\">string</span>[] args )\n    {\n      <span class=\"blue\">string</span> pathToRevitFile = ( 1 == args.Length )\n        ? args[0]\n        : <span class=\"maroon\">@\"pathToRevitFile\"</span>;\n \n \n      <span class=\"blue\">if</span>( !<span class=\"teal\">StructuredStorageUtils</span>.IsFileStucturedStorage(\n        pathToRevitFile ) )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">NotSupportedException</span>(\n          <span class=\"maroon\">\"File is not a structured storage file\"</span> );\n      }\n \n      <span class=\"blue\">var</span> rawData = GetRawBasicFileInfo( pathToRevitFile );\n \n      <span class=\"blue\">var</span> rawString = System.Text.<span class=\"teal\">Encoding</span>.Unicode.GetString(\n        rawData );\n \n      <span class=\"blue\">var</span> fileInfoData = rawString.Split(\n        <span class=\"blue\">new</span> <span class=\"blue\">string</span>[] { <span class=\"maroon\">\"\\0\"</span>, <span class=\"maroon\">\"\\r\\n\"</span> },\n        <span class=\"teal\">StringSplitOptions</span>.RemoveEmptyEntries );\n \n      <span class=\"blue\">foreach</span>( <span class=\"blue\">var</span> info <span class=\"blue\">in</span> fileInfoData )\n      {\n        <span class=\"teal\">Console</span>.WriteLine( info );\n      }\n    }\n \n    <span class=\"blue\">private</span> <span class=\"blue\">static</span> <span class=\"blue\">byte</span>[] GetRawBasicFileInfo(\n      <span class=\"blue\">string</span> revitFileName )\n    {\n      <span class=\"blue\">if</span>( !<span class=\"teal\">StructuredStorageUtils</span>.IsFileStucturedStorage(\n        revitFileName ) )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">NotSupportedException</span>(\n          <span class=\"maroon\">\"File is not a structured storage file\"</span> );\n      }\n \n      <span class=\"blue\">using</span>( <span class=\"teal\">StructuredStorageRoot</span> ssRoot =\n          <span class=\"blue\">new</span> <span class=\"teal\">StructuredStorageRoot</span>( revitFileName ) )\n      {\n        <span class=\"blue\">if</span>( !ssRoot.BaseRoot.StreamExists( StreamName ) )\n          <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">NotSupportedException</span>( <span class=\"blue\">string</span>.Format(\n            <span class=\"maroon\">\"File doesn't contain {0} stream\"</span>, StreamName ) );\n \n        <span class=\"teal\">StreamInfo</span> imageStreamInfo =\n            ssRoot.BaseRoot.GetStreamInfo( StreamName );\n \n        <span class=\"blue\">using</span>( <span class=\"teal\">Stream</span> stream = imageStreamInfo.GetStream(\n          <span class=\"teal\">FileMode</span>.Open, <span class=\"teal\">FileAccess</span>.Read ) )\n        {\n          <span class=\"blue\">byte</span>[] buffer = <span class=\"blue\">new</span> <span class=\"blue\">byte</span>[stream.Length];\n          stream.Read( buffer, 0, buffer.Length );\n          <span class=\"blue\">return</span> buffer;\n        }\n      }\n    }\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">static</span> <span class=\"blue\">class</span> <span class=\"teal\">StructuredStorageUtils</span>\n  {\n    [<span class=\"teal\">DllImport</span>( <span class=\"maroon\">\"ole32.dll\"</span> )]\n    <span class=\"blue\">static</span> <span class=\"blue\">extern</span> <span class=\"blue\">int</span> StgIsStorageFile(\n      [<span class=\"teal\">MarshalAs</span>( <span class=\"teal\">UnmanagedType</span>.LPWStr )]\n      <span class=\"blue\">string</span> pwcsName );\n \n    <span class=\"blue\">public</span> <span class=\"blue\">static</span> <span class=\"blue\">bool</span> IsFileStucturedStorage(\n      <span class=\"blue\">string</span> fileName )\n    {\n      <span class=\"blue\">int</span> res = StgIsStorageFile( fileName );\n \n      <span class=\"blue\">if</span>( res == 0 )\n        <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n \n      <span class=\"blue\">if</span>( res == 1 )\n        <span class=\"blue\">return</span> <span class=\"blue\">false</span>;\n \n      <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">FileNotFoundException</span>(\n        <span class=\"maroon\">\"File not found\"</span>, fileName );\n    }\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">StructuredStorageException</span> : <span class=\"teal\">Exception</span>\n  {\n    <span class=\"blue\">public</span> StructuredStorageException()\n    {\n    }\n \n    <span class=\"blue\">public</span> StructuredStorageException( <span class=\"blue\">string</span> message )\n      : <span class=\"blue\">base</span>( message )\n    {\n    }\n \n    <span class=\"blue\">public</span> StructuredStorageException(\n      <span class=\"blue\">string</span> message,\n      <span class=\"teal\">Exception</span> innerException )\n      : <span class=\"blue\">base</span>( message, innerException )\n    {\n    }\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">StructuredStorageRoot</span> : <span class=\"teal\">IDisposable</span>\n  {\n    <span class=\"teal\">StorageInfo</span> _storageRoot;\n \n    <span class=\"blue\">public</span> StructuredStorageRoot( <span class=\"teal\">Stream</span> stream )\n    {\n      <span class=\"blue\">try</span>\n      {\n        _storageRoot\n          = (<span class=\"teal\">StorageInfo</span>)InvokeStorageRootMethod(\n            <span class=\"blue\">null</span>, <span class=\"maroon\">\"CreateOnStream\"</span>, stream );\n      }\n      <span class=\"blue\">catch</span>( <span class=\"teal\">Exception</span> ex )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">StructuredStorageException</span>(\n          <span class=\"maroon\">\"Cannot get StructuredStorageRoot\"</span>, ex );\n      }\n    }\n \n    <span class=\"blue\">public</span> StructuredStorageRoot( <span class=\"blue\">string</span> fileName )\n    {\n      <span class=\"blue\">try</span>\n      {\n        _storageRoot\n          = (<span class=\"teal\">StorageInfo</span>)InvokeStorageRootMethod(\n            <span class=\"blue\">null</span>, <span class=\"maroon\">\"Open\"</span>, fileName, <span class=\"teal\">FileMode</span>.Open,\n            <span class=\"teal\">FileAccess</span>.Read, <span class=\"teal\">FileShare</span>.Read );\n      }\n      <span class=\"blue\">catch</span>( <span class=\"teal\">Exception</span> ex )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">StructuredStorageException</span>(\n          <span class=\"maroon\">\"Cannot get StructuredStorageRoot\"</span>, ex );\n      }\n    }\n \n    <span class=\"blue\">private</span> <span class=\"blue\">static</span> <span class=\"blue\">object</span> InvokeStorageRootMethod(\n      <span class=\"teal\">StorageInfo</span> storageRoot,\n      <span class=\"blue\">string</span> methodName,\n      <span class=\"blue\">params</span> <span class=\"blue\">object</span>[] methodArgs )\n    {\n      <span class=\"teal\">Type</span> storageRootType\n        = <span class=\"blue\">typeof</span>( <span class=\"teal\">StorageInfo</span> ).Assembly.GetType(\n          <span class=\"maroon\">\"System.IO.Packaging.StorageRoot\"</span>,\n          <span class=\"blue\">true</span>, <span class=\"blue\">false</span> );\n \n      <span class=\"blue\">object</span> result = storageRootType.InvokeMember(\n        methodName,\n        <span class=\"teal\">BindingFlags</span>.Static | <span class=\"teal\">BindingFlags</span>.Instance\n        | <span class=\"teal\">BindingFlags</span>.Public | <span class=\"teal\">BindingFlags</span>.NonPublic\n        | <span class=\"teal\">BindingFlags</span>.InvokeMethod,\n        <span class=\"blue\">null</span>, storageRoot, methodArgs );\n \n      <span class=\"blue\">return</span> result;\n    }\n \n    <span class=\"blue\">private</span> <span class=\"blue\">void</span> CloseStorageRoot()\n    {\n      InvokeStorageRootMethod( _storageRoot, <span class=\"maroon\">\"Close\"</span> );\n    }\n \n<span class=\"blue\">    #region</span> Implementation of IDisposable\n \n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> Dispose()\n    {\n      CloseStorageRoot();\n    }\n \n<span class=\"blue\">    #endregion</span>\n \n    <span class=\"blue\">public</span> <span class=\"teal\">StorageInfo</span> BaseRoot\n    {\n      <span class=\"blue\">get</span> { <span class=\"blue\">return</span> _storageRoot; }\n    }\n  }\n}\n</pre>\n<p>For your even greater convenience, I am also providing\n\n<a href=\"zip/RevitBasicFileInfo.zip\">RevitBasicFileInfo.zip</a> containing\n\nthe full Visual Studio solution that I created to test it.</p>\n<p>Here is the result of running this on a sample model on my system:</p>\n<center>\n<img alt=\"Basic File Info\" src=\"img/basic_file_info.png\"/>\n</center>\n<p>Many thanks to Victor for his clear explanation and solution!</p>\n<p><strong>Addendum:</strong> To get access to the StreamInfo class you need reference the WindowsBase.dll assembly.\n\n<p>The question marks displayed in the result console above are due to the fact that one part of BasicFileInfo is encoded in Unicode and another in BigEndianUnicode.\n\n<p>The second part is rendered legible by accessing it like this instead:\n\n<pre>\n  var rawString = System.Text.Encoding\n    .BigEndianUnicode.GetString( rawData );\n</pre>\n<p>Here is the same file information presented twice, once in standard little endian and once in big endian decoding:</p>\n<center>\n<img alt=\"Basic File Info in little and big endian decoding\" src=\"img/basic_file_info2.png\"/>\n</center>\n<p>This is a summary of the resulting readable text fields:</p>\n<ul>\n<li>Little-endian:</li>\n<ul>\n<li>Autodesk Revit 2013 (Build: 20120716_1115)</li>\n<li>C:\\j\\tmp\\rvt\\floor_slab.rvt</li>\n</ul>\n<li>Big-endian:</li>\n<ul>\n<li>00000000-0000-0000-0000-000000000000</li>\n<li>Worksharing: Not enabled</li>\n<li>Username:</li>\n<li>Central Model Path:</li>\n<li>Revit Build: Autodesk Revit 2013 (Build: 20120716_1115)</li>\n<li>Last Save Path: C:\\j\\tmp\\rvt\\floor_slab.rvt</li>\n<li>Open Workset Default: 3</li>\n<li>Project Spark File: 0</li>\n<li>Central Model Identity: 00000000-0000-0000-0000-000000000000</li>\n<li>Locale when saved: ENU</li>\n</ul>\n</ul>\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0887_rvt_file_version",
    "header_text": "Determining the RVT File Version Without Revit",
    "local_header_href": "#determining-the-rvt-file-version-without-revit",
    "chunk_text": "<h4>Determining the RVT File Version Without Revit</h4><p>Back to the main topic that I started discussing above.</p><p>This came up again prompted by a\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2008/10/rvt-file-version.html?cid=6a00e553e168978833017d4061ff1d970c#comment-6a00e553e168978833017d4061ff1d970c\">\ncomment</a> by\n\nVictor Chekalin, or Виктор Чекалин, on the\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2008/10/rvt-file-version.html\">\noriginal post</a>.</p><p>He points to a stackflow discussion thread:\n\n<a href=\"http://stackoverflow.com/questions/14481652/how-can-i-get-the-revit-file-version-using-the-revit-api/14493458\">\nHow can I get the Revit file version using the Revit API?</a>\n<p><strong>Question:</strong> In the Revit API I know that I can get the version of the Revit instance that is currently running:\n\n<ul>\n<li><code>ControlledApplication.VersionBuild</code></li>\n<li><code>ControlledApplication.VersionName</code></li>\n<li><code>ControlledApplication.VersionNumber</code></li>\n</ul>\n<p>However, I would like to get the version of a Revit file itself before I open it.\nThis way I could stop the automatic upgrade dialog that shows when a user opens an older Revit file in a newer version of Revit.\nI'm using Revit 2013 and expecting files from 2011, 2012, and 2013.\n\n\n<p><strong>Answer from\n\n<a href=\"http://stackoverflow.com/users/180529/skeletank\">\nskeletank</a>:</strong>\n\nI took a closer look at the\n\n<a href=\"http://www.revitforum.org/architecture-general-revit-questions/6853-there-tool-determine-what-version-revit.html\">\ndiscussion group posting</a> from\n\nmy question and found that the version information is actually human readable among the other gibberish of the file.\nThe \".rvt\" file is stored in OLE format so you can see the content if you use a tool like\n<a href=\"http://www.mitec.cz/ssv.html\">Structured Storage Viewer</a>.\nIt will be located under <em>BasicFileInfo</em>.</p>\n<p>If you wanted to then you could probably use an\n<a href=\"http://stackoverflow.com/questions/2897328/is-there-any-library-to-access-ole-structured-storage-from-c\">\nOLE library for .NET</a> to\n\nread the data but I used a <code>StreamReader</code> and a <code>Regex</code> instead.</p>\n<p>Here is the regular expression:\n\n<p><code>Revit\\sArchitecture\\s(?<year>\\d{4})\\s(Build:\\s(?<build>\\w*)\\((?<processor>\\w{3})\\)\\)</processor></build></year></code></p>\n<p>Here is the code:\n\n<pre class=\"code\">\n<span class=\"blue\">private</span> <span class=\"blue\">void</span> ControlledApplication_DocumentOpening(\n  <span class=\"blue\">object</span> sender,\n  DocumentOpeningEventArgs e )\n{\n  <span class=\"teal\">FileInfo</span> revitFileToUpgrade\n    = <span class=\"blue\">new</span> <span class=\"teal\">FileInfo</span>( e.PathName );\n \n  Regex buildInfoRegex = <span class=\"blue\">new</span> Regex(\n    <span class=\"maroon\">@\"Revit\\sArchitecture\\s(?&lt;Year&gt;\\d{4})\\s\"</span>\n    +<span class=\"maroon\">@\"\\(Build:\\s(?&lt;Build&gt;\\w*)\\((&lt;Processor&gt;\\w{3})\\)\\)\"</span> );\n \n  <span class=\"blue\">using</span>( <span class=\"teal\">StreamReader</span> streamReader =\n    <span class=\"blue\">new</span> <span class=\"teal\">StreamReader</span>( e.PathName, Encoding.Unicode ) )\n  {\n    <span class=\"blue\">string</span> fileContents = streamReader.ReadToEnd();\n \n    Match buildInfo = buildInfoRegex.Match( fileContents );\n    <span class=\"blue\">string</span> year = buildInfo.Groups[<span class=\"maroon\">\"Year\"</span>].Value;\n    <span class=\"blue\">string</span> build = buildInfo.Groups[<span class=\"maroon\">\"Build\"</span>].Value;\n    <span class=\"blue\">string</span> processor = buildInfo.Groups[<span class=\"maroon\">\"Processor\"</span>].Value;\n  }\n}\n</pre>\n<p>This will allow you to get the year, build number, and the type of processor.\nNotice, however, that my version checks specifically for Architecture so you will need to modify it for MEP or Structural.\n\n\n\n<p><strong>Answer from\n\n<a href=\"http://stackoverflow.com/users/989259/victor-chekalin\">\nVictor Chekalin</a>:</strong>\n<p>As you said, Revit file format is a Structured Storage document and information you need is stored in the BasicFileInfo stream.\n\n<p>Within the Revit 2013 API you can use the SavedInVersion method of the BasicFileInfo class.\n\n<p>Here is the\n\n<a href=\"http://pastebin.com/FUBcmSRx\">\nfull console application</a> demonstrating\n\nhow to extract BasicFileInfo data without the Revit API.\n\n<p>Unfortunately I don't now the format of the BasicFileInfoStream. But if you read it as string you can get version in which file was created.\n\n<p>Reading only the BasicFileInfo is much better than reading the whole file.\nImagine if the Revit project is over 500 MB.\nYou will read the whole file into memory when you call\n\n<pre class=\"code\">\n  <span class=\"blue\">string</span> fileContents = streamReader.ReadToEnd();\n</pre>\n<p>Also, Regular expression on the huge file works slow.\n\n<p>I think you should use\n\n<pre class=\"code\">\n  <span class=\"blue\">var</span> rawString = System.Text.<span class=\"teal\">Encoding</span>.Unicode\n    .GetString( rawData );\n</pre>\n<p>from my sample and use Regex in the rawString instead the whole file.\n\n<p>For your convenience, here is the full source code of Victor's solution:\n\n<pre class=\"code\">\n<span class=\"blue\">using</span> System;\n<span class=\"blue\">using</span> System.IO;\n<span class=\"blue\">using</span> System.IO.Packaging;\n<span class=\"blue\">using</span> System.Reflection;\n<span class=\"blue\">using</span> System.Runtime.InteropServices;\n \n<span class=\"blue\">namespace</span> ConsoleApplication1\n{\n  <span class=\"blue\">class</span> <span class=\"teal\">Program</span>\n  {\n    <span class=\"blue\">private</span> <span class=\"blue\">const</span> <span class=\"blue\">string</span> StreamName = <span class=\"maroon\">\"BasicFileInfo\"</span>;\n \n    <span class=\"blue\">static</span> <span class=\"blue\">void</span> Main( <span class=\"blue\">string</span>[] args )\n    {\n      <span class=\"blue\">string</span> pathToRevitFile = ( 1 == args.Length )\n        ? args[0]\n        : <span class=\"maroon\">@\"pathToRevitFile\"</span>;\n \n \n      <span class=\"blue\">if</span>( !<span class=\"teal\">StructuredStorageUtils</span>.IsFileStucturedStorage(\n        pathToRevitFile ) )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">NotSupportedException</span>(\n          <span class=\"maroon\">\"File is not a structured storage file\"</span> );\n      }\n \n      <span class=\"blue\">var</span> rawData = GetRawBasicFileInfo( pathToRevitFile );\n \n      <span class=\"blue\">var</span> rawString = System.Text.<span class=\"teal\">Encoding</span>.Unicode.GetString(\n        rawData );\n \n      <span class=\"blue\">var</span> fileInfoData = rawString.Split(\n        <span class=\"blue\">new</span> <span class=\"blue\">string</span>[] { <span class=\"maroon\">\"\\0\"</span>, <span class=\"maroon\">\"\\r\\n\"</span> },\n        <span class=\"teal\">StringSplitOptions</span>.RemoveEmptyEntries );\n \n      <span class=\"blue\">foreach</span>( <span class=\"blue\">var</span> info <span class=\"blue\">in</span> fileInfoData )\n      {\n        <span class=\"teal\">Console</span>.WriteLine( info );\n      }\n    }\n \n    <span class=\"blue\">private</span> <span class=\"blue\">static</span> <span class=\"blue\">byte</span>[] GetRawBasicFileInfo(\n      <span class=\"blue\">string</span> revitFileName )\n    {\n      <span class=\"blue\">if</span>( !<span class=\"teal\">StructuredStorageUtils</span>.IsFileStucturedStorage(\n        revitFileName ) )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">NotSupportedException</span>(\n          <span class=\"maroon\">\"File is not a structured storage file\"</span> );\n      }\n \n      <span class=\"blue\">using</span>( <span class=\"teal\">StructuredStorageRoot</span> ssRoot =\n          <span class=\"blue\">new</span> <span class=\"teal\">StructuredStorageRoot</span>( revitFileName ) )\n      {\n        <span class=\"blue\">if</span>( !ssRoot.BaseRoot.StreamExists( StreamName ) )\n          <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">NotSupportedException</span>( <span class=\"blue\">string</span>.Format(\n            <span class=\"maroon\">\"File doesn't contain {0} stream\"</span>, StreamName ) );\n \n        <span class=\"teal\">StreamInfo</span> imageStreamInfo =\n            ssRoot.BaseRoot.GetStreamInfo( StreamName );\n \n        <span class=\"blue\">using</span>( <span class=\"teal\">Stream</span> stream = imageStreamInfo.GetStream(\n          <span class=\"teal\">FileMode</span>.Open, <span class=\"teal\">FileAccess</span>.Read ) )\n        {\n          <span class=\"blue\">byte</span>[] buffer = <span class=\"blue\">new</span> <span class=\"blue\">byte</span>[stream.Length];\n          stream.Read( buffer, 0, buffer.Length );\n          <span class=\"blue\">return</span> buffer;\n        }\n      }\n    }\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">static</span> <span class=\"blue\">class</span> <span class=\"teal\">StructuredStorageUtils</span>\n  {\n    [<span class=\"teal\">DllImport</span>( <span class=\"maroon\">\"ole32.dll\"</span> )]\n    <span class=\"blue\">static</span> <span class=\"blue\">extern</span> <span class=\"blue\">int</span> StgIsStorageFile(\n      [<span class=\"teal\">MarshalAs</span>( <span class=\"teal\">UnmanagedType</span>.LPWStr )]\n      <span class=\"blue\">string</span> pwcsName );\n \n    <span class=\"blue\">public</span> <span class=\"blue\">static</span> <span class=\"blue\">bool</span> IsFileStucturedStorage(\n      <span class=\"blue\">string</span> fileName )\n    {\n      <span class=\"blue\">int</span> res = StgIsStorageFile( fileName );\n \n      <span class=\"blue\">if</span>( res == 0 )\n        <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n \n      <span class=\"blue\">if</span>( res == 1 )\n        <span class=\"blue\">return</span> <span class=\"blue\">false</span>;\n \n      <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">FileNotFoundException</span>(\n        <span class=\"maroon\">\"File not found\"</span>, fileName );\n    }\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">StructuredStorageException</span> : <span class=\"teal\">Exception</span>\n  {\n    <span class=\"blue\">public</span> StructuredStorageException()\n    {\n    }\n \n    <span class=\"blue\">public</span> StructuredStorageException( <span class=\"blue\">string</span> message )\n      : <span class=\"blue\">base</span>( message )\n    {\n    }\n \n    <span class=\"blue\">public</span> StructuredStorageException(\n      <span class=\"blue\">string</span> message,\n      <span class=\"teal\">Exception</span> innerException )\n      : <span class=\"blue\">base</span>( message, innerException )\n    {\n    }\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">StructuredStorageRoot</span> : <span class=\"teal\">IDisposable</span>\n  {\n    <span class=\"teal\">StorageInfo</span> _storageRoot;\n \n    <span class=\"blue\">public</span> StructuredStorageRoot( <span class=\"teal\">Stream</span> stream )\n    {\n      <span class=\"blue\">try</span>\n      {\n        _storageRoot\n          = (<span class=\"teal\">StorageInfo</span>)InvokeStorageRootMethod(\n            <span class=\"blue\">null</span>, <span class=\"maroon\">\"CreateOnStream\"</span>, stream );\n      }\n      <span class=\"blue\">catch</span>( <span class=\"teal\">Exception</span> ex )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">StructuredStorageException</span>(\n          <span class=\"maroon\">\"Cannot get StructuredStorageRoot\"</span>, ex );\n      }\n    }\n \n    <span class=\"blue\">public</span> StructuredStorageRoot( <span class=\"blue\">string</span> fileName )\n    {\n      <span class=\"blue\">try</span>\n      {\n        _storageRoot\n          = (<span class=\"teal\">StorageInfo</span>)InvokeStorageRootMethod(\n            <span class=\"blue\">null</span>, <span class=\"maroon\">\"Open\"</span>, fileName, <span class=\"teal\">FileMode</span>.Open,\n            <span class=\"teal\">FileAccess</span>.Read, <span class=\"teal\">FileShare</span>.Read );\n      }\n      <span class=\"blue\">catch</span>( <span class=\"teal\">Exception</span> ex )\n      {\n        <span class=\"blue\">throw</span> <span class=\"blue\">new</span> <span class=\"teal\">StructuredStorageException</span>(\n          <span class=\"maroon\">\"Cannot get StructuredStorageRoot\"</span>, ex );\n      }\n    }\n \n    <span class=\"blue\">private</span> <span class=\"blue\">static</span> <span class=\"blue\">object</span> InvokeStorageRootMethod(\n      <span class=\"teal\">StorageInfo</span> storageRoot,\n      <span class=\"blue\">string</span> methodName,\n      <span class=\"blue\">params</span> <span class=\"blue\">object</span>[] methodArgs )\n    {\n      <span class=\"teal\">Type</span> storageRootType\n        = <span class=\"blue\">typeof</span>( <span class=\"teal\">StorageInfo</span> ).Assembly.GetType(\n          <span class=\"maroon\">\"System.IO.Packaging.StorageRoot\"</span>,\n          <span class=\"blue\">true</span>, <span class=\"blue\">false</span> );\n \n      <span class=\"blue\">object</span> result = storageRootType.InvokeMember(\n        methodName,\n        <span class=\"teal\">BindingFlags</span>.Static | <span class=\"teal\">BindingFlags</span>.Instance\n        | <span class=\"teal\">BindingFlags</span>.Public | <span class=\"teal\">BindingFlags</span>.NonPublic\n        | <span class=\"teal\">BindingFlags</span>.InvokeMethod,\n        <span class=\"blue\">null</span>, storageRoot, methodArgs );\n \n      <span class=\"blue\">return</span> result;\n    }\n \n    <span class=\"blue\">private</span> <span class=\"blue\">void</span> CloseStorageRoot()\n    {\n      InvokeStorageRootMethod( _storageRoot, <span class=\"maroon\">\"Close\"</span> );\n    }\n \n<span class=\"blue\">    #region</span> Implementation of IDisposable\n \n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> Dispose()\n    {\n      CloseStorageRoot();\n    }\n \n<span class=\"blue\">    #endregion</span>\n \n    <span class=\"blue\">public</span> <span class=\"teal\">StorageInfo</span> BaseRoot\n    {\n      <span class=\"blue\">get</span> { <span class=\"blue\">return</span> _storageRoot; }\n    }\n  }\n}\n</pre>\n<p>For your even greater convenience, I am also providing\n\n<a href=\"zip/RevitBasicFileInfo.zip\">RevitBasicFileInfo.zip</a> containing\n\nthe full Visual Studio solution that I created to test it.</p>\n<p>Here is the result of running this on a sample model on my system:</p>\n<center>\n<img alt=\"Basic File Info\" src=\"img/basic_file_info.png\"/>\n</center>\n<p>Many thanks to Victor for his clear explanation and solution!</p>\n<p><strong>Addendum:</strong> To get access to the StreamInfo class you need reference the WindowsBase.dll assembly.\n\n<p>The question marks displayed in the result console above are due to the fact that one part of BasicFileInfo is encoded in Unicode and another in BigEndianUnicode.\n\n<p>The second part is rendered legible by accessing it like this instead:\n\n<pre>\n  var rawString = System.Text.Encoding\n    .BigEndianUnicode.GetString( rawData );\n</pre>\n<p>Here is the same file information presented twice, once in standard little endian and once in big endian decoding:</p>\n<center>\n<img alt=\"Basic File Info in little and big endian decoding\" src=\"img/basic_file_info2.png\"/>\n</center>\n<p>This is a summary of the resulting readable text fields:</p>\n<ul>\n<li>Little-endian:</li>\n<ul>\n<li>Autodesk Revit 2013 (Build: 20120716_1115)</li>\n<li>C:\\j\\tmp\\rvt\\floor_slab.rvt</li>\n</ul>\n<li>Big-endian:</li>\n<ul>\n<li>00000000-0000-0000-0000-000000000000</li>\n<li>Worksharing: Not enabled</li>\n<li>Username:</li>\n<li>Central Model Path:</li>\n<li>Revit Build: Autodesk Revit 2013 (Build: 20120716_1115)</li>\n<li>Last Save Path: C:\\j\\tmp\\rvt\\floor_slab.rvt</li>\n<li>Open Workset Default: 3</li>\n<li>Project Spark File: 0</li>\n<li>Central Model Identity: 00000000-0000-0000-0000-000000000000</li>\n<li>Locale when saved: ENU</li>\n</ul>\n</ul>\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  }
]