[
  {
    "original_filename": "0465_access_deleted_element",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0465_access_deleted_element",
    "header_text": "Access Deleted Element",
    "local_header_href": "#access-deleted-element",
    "chunk_text": "<h3>Access Deleted Element</h3><p>Here is a \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/10/power-to-the-user-and-application.html?cid=6a00e553e1689788330133f5511cc1970b#comment-6a00e553e1689788330133f5511cc1970b\">\nquestion</a> posted \n\nby Kristian (Krispy5) Parsons, Systems Analyst - Design at\n\n<a href=\"http://www.westfield.com\">\nWestfield Design &amp; Construction Pty. Ltd.</a> on \n\naccessing deleted element data in the DocumentChanged event handler:\n\n<p><strong>Question:</strong> How do I find the category of the deleted elements? \nWhen I try to get the Element from the ElementId it fails since the element has already been deleted.\n\n<p>In my case I would like to warn users when they have deleted a floor.\n\n<p><strong>Answer:</strong> I was planning to test your assertion by looking at the Revit SDK ChangesMonitor sample which demonstrates the use of the DocumentChanged method.\n\n<p>I assume that your question is based on using that event to be notified of the deleted elements. Looking at the ChangesMonitor DocumentChanged event handler, I note that it calls a helper method AddChangeInfoRow to list the added, deleted and modified element information in its modeless form. That method includes the following statements and comments which clearly tell you that the deleted element information is no longer accessible:\n\n<pre class=\"code\">\n<span class=\"blue\">private</span> <span class=\"blue\">void</span> AddChangeInfoRow(\n  <span class=\"teal\">ElementId</span> id,\n  <span class=\"teal\">Document</span> doc,\n  <span class=\"blue\">string</span> changeType )\n{\n  <span class=\"green\">// retrieve the changed element</span>\n  <span class=\"teal\">Element</span> elem = doc.get_Element( id );\n \n  <span class=\"teal\">DataRow</span> newRow = m_ChangesInfoTable.NewRow();\n \n  <span class=\"green\">// set the relative information of </span>\n  <span class=\"green\">// this event into the table.</span>\n \n  <span class=\"blue\">if</span>( elem == <span class=\"blue\">null</span> )\n  {\n    <span class=\"green\">// this branch is for deleted element due </span>\n    <span class=\"green\">// to the deleted element cannot be retrieved </span>\n    <span class=\"green\">// from the document.</span>\n \n    newRow[<span class=\"maroon\">\"ChangeType\"</span>] = changeType;\n    newRow[<span class=\"maroon\">\"Id\"</span>] = id.IntegerValue.ToString();\n    newRow[<span class=\"maroon\">\"Name\"</span>] = <span class=\"maroon\">\"\"</span>;\n    newRow[<span class=\"maroon\">\"Category\"</span>] = <span class=\"maroon\">\"\"</span>;\n    newRow[<span class=\"maroon\">\"Document\"</span>] = <span class=\"maroon\">\"\"</span>;\n  }\n  <span class=\"blue\">else</span>\n  {\n    newRow[<span class=\"maroon\">\"ChangeType\"</span>] = changeType;\n    newRow[<span class=\"maroon\">\"Id\"</span>] = id.IntegerValue.ToString();\n    newRow[<span class=\"maroon\">\"Name\"</span>] = elem.Name;\n \n    newRow[<span class=\"maroon\">\"Category\"</span>] = (<span class=\"blue\">null</span> == elem.Category)\n      ? <span class=\"maroon\">\"&lt;null&gt;\"</span> \n      : elem.Category.Name; <span class=\"green\">// added by jeremy</span>\n \n    newRow[<span class=\"maroon\">\"Document\"</span>] = doc.Title;\n  }\n  m_ChangesInfoTable.Rows.Add( newRow );\n}\n</pre>\n<p>So the answer to your question is presumably 'no way', and that is as designed.\n\n<p>There is an obvious workaround, though:\n\n<p>The DocumentChanged event is a very simple notification after the fact. The transaction in which the document was modified has already been closed, you cannot do anything more about it yourself, and as we have seen, you cannot even query the deleted elements for their data.\n\n<p>If you wish to access the document before the transaction is closed, there is a very powerful alternative possibility, the dynamic model update framework or DMU. It enables you to register an updater to be triggered by certain events, and also to react on these events within the same transaction that triggered them.\nIt is demonstrated by the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/04/element-level-events.html#2\">\nDynamicModelUpdate and DistanceToSurfaces SDK samples</a> and\n\nSaikat's \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/08/structural-dynamic-model-update-sample.html\">\nStructural DMU sample</a>.\n\n<p>In your case, you can easily implement an updater that simply brings up a message box as described above, and register a trigger for it which reacts to the deletion of floors and nothing else. \n\n<!--\n<p>Your updater Execute method will be called while the transaction is still open, and you can analyse and even modify the elements being deleted before the transaction is terminated.\n-->\n<p>Your updater Execute method will be called while the transaction is still open.\nUnfortunately, even though the transaction is open, you can no longer access or modify the elements that have already been deleted.\n\n<p>The only information available to you at this point is the element id of the deleted element.\nIf you are interested in floors only, you can maintain a list of all floor element ids and ensure that it is kept up to date using either DMU or the DocumentChanged event.\n\n<p><strong>Response:</strong> Yes that all looks good. \nBy the way, your assumption is correct that I was using the DocumentChanged event.\n\n<p>I looked into the 'dynamic model update framework'.\nThis sounds like what I want.\n\n<p>Later: Thanks again, this solved my problem and was easy to implement.\n\n<p>I filter for floors and use the 'GetChangeTypeElementDeletion' in the 'AddTrigger' call, then in my 'IUpdater' class in the 'Execute' method I simply display a task dialog showing the number of floors being deleted.\nThere is no need for any more filtering, I can just use 'data.GetDeletedElementIds().Count'.\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  }
]