[
  {
    "original_filename": "0712_performance_adviser",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0712_performance_adviser",
    "header_text": "The Performance Adviser API",
    "local_header_href": "#the-performance-adviser-api",
    "chunk_text": "<h3>The Performance Adviser API</h3><p>Unbelievable as it may seem, there are still a number of new areas of functionality added in the Revit 2012 API that we have not even got around to covering here yet at all.\nOne of these is the performance adviser.\nHere is an article on that by my colleague Saikat Bhattacharya from the ADN AEC newsletter.\n\n<p>The Performance Adviser API added in Revit 2012 allows developers to execute a set of built-in or custom rules against a given model, and to display a warning dialog about the elements that fail to satisfy the rules. You can use this feature to flag the user about possible performance degradations, and to create your own rules that could be run on a model to check for adherence to certain design guidelines. For example, you may want to signal the user where walls may be overlapping.\n\n<p>This article provides an overview and discusses how to \n\n<a href=\"#1\">access performance adviser rules</a>, \n<a href=\"#2\">execute rules</a>, and \n<a href=\"#3\">define custom rules</a>. \n\n\n<a name=\"1\"></a>\n<h4>Accessing Performance Adviser Rules</h4>\n<p>The performance adviser rules are a set of application-wide rules. To work with performance adviser rules, we use an application-wide, singleton class called PerformanceAdviser. This class is a \u001cregistry\u001d of all the performance checking rules as well as an engine to execute the rules. You can access the singleton PerformanceAdviser instance using a PerformanceAdviser.GetPerformanceAdviser static method.\n\n<p>Once we have access to the PerformanceAdviser object, we can use the GetAllRuleIds method to obtain a list of rule IDs registered in the application. We can then iterate through each rule ID and get the rule information for the corresponding rule ID, using the methods, such as GetRuleName and GetRuleDescription.\n\n<p>The following command illustrates how to list all the registered performance adviser: \n\n<pre class=\"code\">\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n<span class=\"gray\">///</span><span class=\"green\"> List all registered performance adviser rules</span>\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">ListPerformanceAdviserRules</span> \n  : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> Autodesk.Revit.UI.<span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"green\">// Get access to Performance Adviser object</span>\n \n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    <span class=\"green\">// Access the rules</span>\n \n    <span class=\"teal\">IList</span>&lt;<span class=\"teal\">PerformanceAdviserRuleId</span>&gt; ruleIds \n      = adviser.GetAllRuleIds();\n \n    <span class=\"teal\">String</span> ruleInfo = <span class=\"teal\">String</span>.Empty;\n \n    <span class=\"green\">// Loop through each rule Id and get rule name and description</span>\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">PerformanceAdviserRuleId</span> ruleId \n      <span class=\"blue\">in</span> ruleIds )\n    {\n      ruleInfo += <span class=\"maroon\">\"\\n\"</span> + adviser.GetRuleName( ruleId )\n        + <span class=\"maroon\">\" : \"</span> + adviser.GetRuleDescription( ruleId );\n    }\n \n    <span class=\"teal\">TaskDialog</span>.Show( <span class=\"maroon\">\"Existing Rules Info\"</span>, ruleInfo );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<a name=\"2\"></a>\n<h4>Executing a Performance Adviser Rule</h4>\n<p>Once you know the ids of rules that you are interested in, you can use the PerformanceAdviser.ExecuteRules method to execute the given rules. \nThis method takes a document and a set of rule ids as input arguments. \nIt returns a list of FailureMessages, which we can iterate through and display, for instance, in a standard Revit warning dialog using Document.PostFailure method. \n\n<p>For an introductory discussion about Failure Posting and Handling, please refer to \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/04/failure-api.html\">\nthis introduction</a>,\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/11/failure-api-take-two.html\">\nits follow-up</a>, \n\nand the ADN <i>AEC Customization Newsletter – BIM Edition – Winter 2011</i>.\n\n<!--\n350_failure_api.htm  484_failure_api.htm  732_failure_idling.htm\n-->\n<p>The following command shows a simple example of executing the overlapping walls\u001d performance adviser rule: \n\n<pre class=\"code\">\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n<span class=\"gray\">///</span><span class=\"green\"> Execute overlapping walls? </span>\n<span class=\"gray\">///</span><span class=\"green\"> performance adviser rule.</span>\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">ExecutePerformanceRule</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">Document</span> doc = commandData.Application\n      .ActiveUIDocument.Document;\n \n    <span class=\"green\">// Access the Performance Adviser object</span>\n \n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    <span class=\"green\">// List all the rules</span>\n \n    <span class=\"teal\">IList</span>&lt;<span class=\"teal\">PerformanceAdviserRuleId</span>&gt; ruleIds = adviser.GetAllRuleIds();\n \n    <span class=\"green\">// Create an empty list for </span>\n    <span class=\"green\">// the rules to be executed</span>\n \n    <span class=\"teal\">IList</span>&lt;<span class=\"teal\">PerformanceAdviserRuleId</span>&gt; rulesIdsToExecute =\n      <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">PerformanceAdviserRuleId</span>&gt;();\n \n    <span class=\"green\">// Iterate through each</span>\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">PerformanceAdviserRuleId</span> ruleId <span class=\"blue\">in</span> ruleIds )\n    {\n      <span class=\"blue\">if</span>( adviser.GetRuleName( ruleId ).Equals( <span class=\"maroon\">\"Overlapping walls\"</span> ) )\n      {\n        rulesIdsToExecute.Add( ruleId );\n        <span class=\"blue\">break</span>;\n      }\n    }\n \n    <span class=\"green\">// Now we need to post the results</span>\n \n    <span class=\"teal\">IList</span>&lt;<span class=\"teal\">FailureMessage</span>&gt; failureMessages =\n      adviser.ExecuteRules( doc, rulesIdsToExecute );\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">FailureMessage</span> fm <span class=\"blue\">in</span> failureMessages )\n    {\n      <span class=\"teal\">Transaction</span> trans = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc );\n      trans.Start( <span class=\"maroon\">\"Failure Reporting\"</span> );\n      doc.PostFailure( fm );\n      trans.Commit();\n    }\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<a name=\"3\"></a>\n<h4>Defining a Custom Rule</h4>\n<p>Now, the most powerful part of this API is that we define custom adviser rules. To create our own, we define a class implementing an interface called IPerformanceAdviserRule. Your custom adviser class then needs to define the following methods:\n\n<ul>\n<li>GetName – returns the name of this rule.\n\n<li>GetDescription – provides the description of this custom rule.\n\n<li>InitCheck – performs the initialization work before running the rule. For example, it could be a task like clearing a collection of elements that we will be storing elements that fail the rule execution test.\n\n<li>WillCheckElements – sets whether the rule will iterate through elements or not.\n\n<li>GetElementFilter – provides the element filter which can help narrow down the type or category of elements that a certain rule is expected to work with.\n\n<li>ExecuteElementCheck – This method contains most of the implementation steps for a given rule. It examines the element passed to it (which is filtered by the GetElementFilter) and checks for all elements that fail the criteria laid by the rule.\n\n<li>FinalizeCheck – This method gets called by the PerformanceAdviser after all the elements in a document matching the element filter in the GetElementFilter method have been checked by the ExecuteElementCheck method. This method usually will contain the code to check if there are elements which fail the rule test and if there are, the names of the elements are listed along with the standard warning failure message.\n</li></li></li></li></li></li></li></ul>\n<p>The code below shows an example of a custom performance adviser rule, which provides warnings if there are clashes between ducts in a Revit model: \n\n<pre class=\"code\">\n<span class=\"green\">// A custom performance adviser rule class.</span>\n<span class=\"green\">// This rule provides a warning if the model </span>\n<span class=\"green\">// contains ducts which clash each other.  </span>\n \n<span class=\"blue\">using</span> System;\n<span class=\"blue\">using</span> System.Collections.Generic;\n<span class=\"blue\">using</span> System.Linq;\n<span class=\"blue\">using</span> System.Text;\n \n<span class=\"blue\">using</span> Autodesk.Revit.UI;\n<span class=\"blue\">using</span> Autodesk.Revit.DB;\n<span class=\"blue\">using</span> Autodesk.Revit.Attributes;\n<span class=\"blue\">using</span> Autodesk.Revit.DB.Mechanical;\n<span class=\"blue\">using</span> System.Diagnostics;\n \n<span class=\"blue\">namespace</span> BuildingCoder\n{\n  <span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">DuctClashDetection</span> \n    : <span class=\"teal\">IPerformanceAdviserRule</span>\n  {\n    <span class=\"blue\">private</span> <span class=\"teal\">FailureDefinition</span> m_warning;\n    <span class=\"blue\">private</span> <span class=\"teal\">FailureDefinitionId</span> m_warningId;\n    <span class=\"blue\">private</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt; m_ClashingDucts;\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> DuctClashDetection Constructor</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> DuctClashDetection()\n    {\n      <span class=\"green\">// Create failure message</span>\n \n      m_warningId = <span class=\"blue\">new</span> <span class=\"teal\">FailureDefinitionId</span>(\n        <span class=\"blue\">new</span> <span class=\"teal\">Guid</span>( <span class=\"maroon\">\"AACC9C09-7956-4B36-9D27-FF8A64544C31\"</span> ) );\n \n      m_warning = <span class=\"teal\">FailureDefinition</span>.CreateFailureDefinition(\n        m_warningId, <span class=\"teal\">FailureSeverity</span>.Warning,\n        <span class=\"maroon\">\"Some ducts clash with each other\"</span> );\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> This method does most of the work of the </span>\n    <span class=\"gray\">///</span><span class=\"green\"> IPerformanceAdviserRule implementation. </span>\n    <span class=\"gray\">///</span><span class=\"green\"> It is called by PerformanceAdviser and </span>\n    <span class=\"gray\">///</span><span class=\"green\"> examines the element passed to it </span>\n    <span class=\"gray\">///</span><span class=\"green\"> (which was previously filtered by the filter </span>\n    <span class=\"gray\">///</span><span class=\"green\"> returned by GetElementFilter).  This method </span>\n    <span class=\"gray\">///</span><span class=\"green\"> is checking for all elements that intersect </span>\n    <span class=\"gray\">///</span><span class=\"green\"> with current duct and adds them to the list </span>\n    <span class=\"gray\">///</span><span class=\"green\"> of elements.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> ExecuteElementCheck(\n      <span class=\"teal\">Document</span> document,\n      <span class=\"teal\">Element</span> element )\n    {\n      <span class=\"green\">// For each of the elements, check if there is </span>\n      <span class=\"green\">// any intersection with the specific element </span>\n      <span class=\"green\">// being passed on via the method signature</span>\n \n      <span class=\"teal\">FilteredElementCollector</span> collector \n        = <span class=\"blue\">new</span> <span class=\"teal\">FilteredElementCollector</span>( document );\n \n      <span class=\"green\">// Use the Elements Intersection Filter to get elements</span>\n      <span class=\"green\">// that intersect with the specified element</span>\n \n      <span class=\"teal\">ElementIntersectsElementFilter</span> elementFilter =\n        <span class=\"blue\">new</span> <span class=\"teal\">ElementIntersectsElementFilter</span>( element, <span class=\"blue\">false</span> );\n \n      collector.WherePasses( elementFilter );\n \n      <span class=\"green\">// Exclude the element in the intersection</span>\n \n      <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt; excludes = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt;();\n      excludes.Add( element.Id );\n      collector.Excluding( excludes );\n \n      <span class=\"green\">// Save the intersecting ducts</span>\n \n      <span class=\"blue\">foreach</span>( <span class=\"teal\">Element</span> elem <span class=\"blue\">in</span> collector )\n      {\n        m_ClashingDucts.Add( elem.Id );\n      }\n    }\n \n    <span class=\"green\">// The rule ID for this rule;</span>\n \n    <span class=\"blue\">public</span> <span class=\"teal\">PerformanceAdviserRuleId</span> Id =\n      <span class=\"blue\">new</span> <span class=\"teal\">PerformanceAdviserRuleId</span>(\n        <span class=\"blue\">new</span> <span class=\"teal\">Guid</span>( <span class=\"maroon\">\"C00CEF6D-2C4B-402C-9AED-160DFA1785BE\"</span> ) );\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> This method is called by PerformanceAdviser </span>\n    <span class=\"gray\">///</span><span class=\"green\"> after all elements in document matching the </span>\n    <span class=\"gray\">///</span><span class=\"green\"> ElementFilter from GetElementFilter() are </span>\n    <span class=\"gray\">///</span><span class=\"green\"> checked by ExecuteElementCheck(). It checks to </span>\n    <span class=\"gray\">///</span><span class=\"green\"> see if there are any ducts in the </span>\n    <span class=\"gray\">///</span><span class=\"green\"> m_ClashingDucts list. If so, it iterates </span>\n    <span class=\"gray\">///</span><span class=\"green\"> through that list and reports the failures.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> FinalizeCheck( <span class=\"teal\">Document</span> document )\n    {\n      <span class=\"blue\">try</span>\n      {\n        <span class=\"green\">// If no ducts clash</span>\n \n        <span class=\"blue\">if</span>( m_ClashingDucts.Count == 0 )\n        {\n          <span class=\"teal\">Debug</span>.WriteLine(\n            <span class=\"maroon\">\"No clashing ducts. Test passed.\"</span> );\n        }\n        <span class=\"blue\">else</span>\n        {\n          <span class=\"green\">// Pass the element IDs of the clashing ducts to the revit</span>\n          <span class=\"green\">// failure reporting APIs.</span>\n \n          <span class=\"teal\">FailureMessage</span> fm =\n            <span class=\"blue\">new</span> <span class=\"teal\">FailureMessage</span>( m_warningId );\n \n          fm.SetFailingElements( m_ClashingDucts );\n \n          <span class=\"teal\">Transaction</span> failureReportingTransaction =\n            <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( document );\n \n          failureReportingTransaction.Start( \n            <span class=\"maroon\">\"Failure reporting\"</span> );\n \n          <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser()\n            .PostWarning( fm );\n \n          failureReportingTransaction.Commit();\n \n          m_ClashingDucts.Clear();\n        }\n      }\n      <span class=\"blue\">catch</span>( System.<span class=\"teal\">Exception</span> ex )\n      {\n        <span class=\"teal\">TaskDialog</span>.Show( <span class=\"maroon\">\"Oops!\"</span>, ex.Message );\n      }\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Return rule description.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">string</span> GetDescription()\n    {\n      <span class=\"blue\">return</span> <span class=\"maroon\">\"Detects clash between ducts\"</span>;\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Provide the filter to focus on elements </span>\n    <span class=\"gray\">///</span><span class=\"green\"> that this rule should be focused on.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"teal\">ElementFilter</span> GetElementFilter( \n      <span class=\"teal\">Document</span> document )\n    {\n      <span class=\"blue\">return</span> <span class=\"blue\">new</span> <span class=\"teal\">ElementClassFilter</span>( <span class=\"blue\">typeof</span>( <span class=\"teal\">Duct</span> ) );\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Return name of rule.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">string</span> GetName()\n    {\n      <span class=\"blue\">return</span> <span class=\"maroon\">\"Duct Clash Detection\"</span>;\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Perform initial/preliminary work </span>\n    <span class=\"gray\">///</span><span class=\"green\"> before executing the tests.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> InitCheck( <span class=\"teal\">Document</span> document )\n    {\n      <span class=\"blue\">if</span>( m_ClashingDucts == <span class=\"blue\">null</span> )\n        m_ClashingDucts = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt;();\n      <span class=\"blue\">else</span>\n        m_ClashingDucts.Clear();\n \n      <span class=\"blue\">return</span>;\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Return true if this rule will iterate </span>\n    <span class=\"gray\">///</span><span class=\"green\"> through elements and check them, </span>\n    <span class=\"gray\">///</span><span class=\"green\"> else return false.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">bool</span> WillCheckElements()\n    {\n      <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n    }\n  }\n}\n</pre>\n<p>Once we have defined a class for our custom rule, our next step is to register the rule. You can do this by calling PerformanceAdvisor.AddRule. \nThis is done at the start-up of Revit using the OnStartup event of IExternalApplication.\n\n<p>Similarly, we can unregister the Performance Adviser rule at the OnShutdown event. The following code shows an example of how the custom rule is registered and unregistered:\n\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">AddPerformanceRule</span> : <span class=\"teal\">IExternalApplication</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">DuctClashDetection</span> ductClashDetect;\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Unregister the custom rule.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> OnShutdown( \n    <span class=\"teal\">UIControlledApplication</span> application )\n  {\n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    adviser.DeleteRule( ductClashDetect.Id );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Register the custom rule.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> OnStartup( \n    <span class=\"teal\">UIControlledApplication</span> application )\n  {\n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    ductClashDetect = <span class=\"blue\">new</span> <span class=\"teal\">DuctClashDetection</span>();\n \n    adviser.AddRule( ductClashDetect.Id, ductClashDetect );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>Once the custom rule has been added, we can execute it in the same way as the predefined rules. \nUsing the code used in this article against a given set of clashing ducts, this new API can report the clash results as shown below:</p>\n<center>\n<img alt=\"Collision test rule\" src=\"img/performance_adviser_collision_test.jpg\" width=\"400\"/>\n</center>\n<p>In this article, we have shown you that the performance adviser API provides the ability to define custom rules, execute them, and report potentially problematic results via the failure message APIs. \nThe Revit SDK PerformanceAdviserControl sample shows more comprehensive examples of this API. \nIt presents a list of rules for the users to select and execute. \nPlease refer to the sample for more details.\n\n<p>Many thanks to Saikat for this helpful overview!\n\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0712_performance_adviser",
    "header_text": "Accessing Performance Adviser Rules",
    "local_header_href": "#accessing-performance-adviser-rules",
    "chunk_text": "<h4>Accessing Performance Adviser Rules</h4><p>The performance adviser rules are a set of application-wide rules. To work with performance adviser rules, we use an application-wide, singleton class called PerformanceAdviser. This class is a \u001cregistry\u001d of all the performance checking rules as well as an engine to execute the rules. You can access the singleton PerformanceAdviser instance using a PerformanceAdviser.GetPerformanceAdviser static method.\n\n<p>Once we have access to the PerformanceAdviser object, we can use the GetAllRuleIds method to obtain a list of rule IDs registered in the application. We can then iterate through each rule ID and get the rule information for the corresponding rule ID, using the methods, such as GetRuleName and GetRuleDescription.\n\n<p>The following command illustrates how to list all the registered performance adviser: \n\n<pre class=\"code\">\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n<span class=\"gray\">///</span><span class=\"green\"> List all registered performance adviser rules</span>\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">ListPerformanceAdviserRules</span> \n  : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> Autodesk.Revit.UI.<span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"green\">// Get access to Performance Adviser object</span>\n \n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    <span class=\"green\">// Access the rules</span>\n \n    <span class=\"teal\">IList</span>&lt;<span class=\"teal\">PerformanceAdviserRuleId</span>&gt; ruleIds \n      = adviser.GetAllRuleIds();\n \n    <span class=\"teal\">String</span> ruleInfo = <span class=\"teal\">String</span>.Empty;\n \n    <span class=\"green\">// Loop through each rule Id and get rule name and description</span>\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">PerformanceAdviserRuleId</span> ruleId \n      <span class=\"blue\">in</span> ruleIds )\n    {\n      ruleInfo += <span class=\"maroon\">\"\\n\"</span> + adviser.GetRuleName( ruleId )\n        + <span class=\"maroon\">\" : \"</span> + adviser.GetRuleDescription( ruleId );\n    }\n \n    <span class=\"teal\">TaskDialog</span>.Show( <span class=\"maroon\">\"Existing Rules Info\"</span>, ruleInfo );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<a name=\"2\"></a>\n<h4>Executing a Performance Adviser Rule</h4>\n<p>Once you know the ids of rules that you are interested in, you can use the PerformanceAdviser.ExecuteRules method to execute the given rules. \nThis method takes a document and a set of rule ids as input arguments. \nIt returns a list of FailureMessages, which we can iterate through and display, for instance, in a standard Revit warning dialog using Document.PostFailure method. \n\n<p>For an introductory discussion about Failure Posting and Handling, please refer to \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/04/failure-api.html\">\nthis introduction</a>,\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/11/failure-api-take-two.html\">\nits follow-up</a>, \n\nand the ADN <i>AEC Customization Newsletter – BIM Edition – Winter 2011</i>.\n\n<!--\n350_failure_api.htm  484_failure_api.htm  732_failure_idling.htm\n-->\n<p>The following command shows a simple example of executing the overlapping walls\u001d performance adviser rule: \n\n<pre class=\"code\">\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n<span class=\"gray\">///</span><span class=\"green\"> Execute overlapping walls? </span>\n<span class=\"gray\">///</span><span class=\"green\"> performance adviser rule.</span>\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">ExecutePerformanceRule</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">Document</span> doc = commandData.Application\n      .ActiveUIDocument.Document;\n \n    <span class=\"green\">// Access the Performance Adviser object</span>\n \n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    <span class=\"green\">// List all the rules</span>\n \n    <span class=\"teal\">IList</span>&lt;<span class=\"teal\">PerformanceAdviserRuleId</span>&gt; ruleIds = adviser.GetAllRuleIds();\n \n    <span class=\"green\">// Create an empty list for </span>\n    <span class=\"green\">// the rules to be executed</span>\n \n    <span class=\"teal\">IList</span>&lt;<span class=\"teal\">PerformanceAdviserRuleId</span>&gt; rulesIdsToExecute =\n      <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">PerformanceAdviserRuleId</span>&gt;();\n \n    <span class=\"green\">// Iterate through each</span>\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">PerformanceAdviserRuleId</span> ruleId <span class=\"blue\">in</span> ruleIds )\n    {\n      <span class=\"blue\">if</span>( adviser.GetRuleName( ruleId ).Equals( <span class=\"maroon\">\"Overlapping walls\"</span> ) )\n      {\n        rulesIdsToExecute.Add( ruleId );\n        <span class=\"blue\">break</span>;\n      }\n    }\n \n    <span class=\"green\">// Now we need to post the results</span>\n \n    <span class=\"teal\">IList</span>&lt;<span class=\"teal\">FailureMessage</span>&gt; failureMessages =\n      adviser.ExecuteRules( doc, rulesIdsToExecute );\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">FailureMessage</span> fm <span class=\"blue\">in</span> failureMessages )\n    {\n      <span class=\"teal\">Transaction</span> trans = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc );\n      trans.Start( <span class=\"maroon\">\"Failure Reporting\"</span> );\n      doc.PostFailure( fm );\n      trans.Commit();\n    }\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<a name=\"3\"></a>\n<h4>Defining a Custom Rule</h4>\n<p>Now, the most powerful part of this API is that we define custom adviser rules. To create our own, we define a class implementing an interface called IPerformanceAdviserRule. Your custom adviser class then needs to define the following methods:\n\n<ul>\n<li>GetName – returns the name of this rule.\n\n<li>GetDescription – provides the description of this custom rule.\n\n<li>InitCheck – performs the initialization work before running the rule. For example, it could be a task like clearing a collection of elements that we will be storing elements that fail the rule execution test.\n\n<li>WillCheckElements – sets whether the rule will iterate through elements or not.\n\n<li>GetElementFilter – provides the element filter which can help narrow down the type or category of elements that a certain rule is expected to work with.\n\n<li>ExecuteElementCheck – This method contains most of the implementation steps for a given rule. It examines the element passed to it (which is filtered by the GetElementFilter) and checks for all elements that fail the criteria laid by the rule.\n\n<li>FinalizeCheck – This method gets called by the PerformanceAdviser after all the elements in a document matching the element filter in the GetElementFilter method have been checked by the ExecuteElementCheck method. This method usually will contain the code to check if there are elements which fail the rule test and if there are, the names of the elements are listed along with the standard warning failure message.\n</li></li></li></li></li></li></li></ul>\n<p>The code below shows an example of a custom performance adviser rule, which provides warnings if there are clashes between ducts in a Revit model: \n\n<pre class=\"code\">\n<span class=\"green\">// A custom performance adviser rule class.</span>\n<span class=\"green\">// This rule provides a warning if the model </span>\n<span class=\"green\">// contains ducts which clash each other.  </span>\n \n<span class=\"blue\">using</span> System;\n<span class=\"blue\">using</span> System.Collections.Generic;\n<span class=\"blue\">using</span> System.Linq;\n<span class=\"blue\">using</span> System.Text;\n \n<span class=\"blue\">using</span> Autodesk.Revit.UI;\n<span class=\"blue\">using</span> Autodesk.Revit.DB;\n<span class=\"blue\">using</span> Autodesk.Revit.Attributes;\n<span class=\"blue\">using</span> Autodesk.Revit.DB.Mechanical;\n<span class=\"blue\">using</span> System.Diagnostics;\n \n<span class=\"blue\">namespace</span> BuildingCoder\n{\n  <span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">DuctClashDetection</span> \n    : <span class=\"teal\">IPerformanceAdviserRule</span>\n  {\n    <span class=\"blue\">private</span> <span class=\"teal\">FailureDefinition</span> m_warning;\n    <span class=\"blue\">private</span> <span class=\"teal\">FailureDefinitionId</span> m_warningId;\n    <span class=\"blue\">private</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt; m_ClashingDucts;\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> DuctClashDetection Constructor</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> DuctClashDetection()\n    {\n      <span class=\"green\">// Create failure message</span>\n \n      m_warningId = <span class=\"blue\">new</span> <span class=\"teal\">FailureDefinitionId</span>(\n        <span class=\"blue\">new</span> <span class=\"teal\">Guid</span>( <span class=\"maroon\">\"AACC9C09-7956-4B36-9D27-FF8A64544C31\"</span> ) );\n \n      m_warning = <span class=\"teal\">FailureDefinition</span>.CreateFailureDefinition(\n        m_warningId, <span class=\"teal\">FailureSeverity</span>.Warning,\n        <span class=\"maroon\">\"Some ducts clash with each other\"</span> );\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> This method does most of the work of the </span>\n    <span class=\"gray\">///</span><span class=\"green\"> IPerformanceAdviserRule implementation. </span>\n    <span class=\"gray\">///</span><span class=\"green\"> It is called by PerformanceAdviser and </span>\n    <span class=\"gray\">///</span><span class=\"green\"> examines the element passed to it </span>\n    <span class=\"gray\">///</span><span class=\"green\"> (which was previously filtered by the filter </span>\n    <span class=\"gray\">///</span><span class=\"green\"> returned by GetElementFilter).  This method </span>\n    <span class=\"gray\">///</span><span class=\"green\"> is checking for all elements that intersect </span>\n    <span class=\"gray\">///</span><span class=\"green\"> with current duct and adds them to the list </span>\n    <span class=\"gray\">///</span><span class=\"green\"> of elements.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> ExecuteElementCheck(\n      <span class=\"teal\">Document</span> document,\n      <span class=\"teal\">Element</span> element )\n    {\n      <span class=\"green\">// For each of the elements, check if there is </span>\n      <span class=\"green\">// any intersection with the specific element </span>\n      <span class=\"green\">// being passed on via the method signature</span>\n \n      <span class=\"teal\">FilteredElementCollector</span> collector \n        = <span class=\"blue\">new</span> <span class=\"teal\">FilteredElementCollector</span>( document );\n \n      <span class=\"green\">// Use the Elements Intersection Filter to get elements</span>\n      <span class=\"green\">// that intersect with the specified element</span>\n \n      <span class=\"teal\">ElementIntersectsElementFilter</span> elementFilter =\n        <span class=\"blue\">new</span> <span class=\"teal\">ElementIntersectsElementFilter</span>( element, <span class=\"blue\">false</span> );\n \n      collector.WherePasses( elementFilter );\n \n      <span class=\"green\">// Exclude the element in the intersection</span>\n \n      <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt; excludes = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt;();\n      excludes.Add( element.Id );\n      collector.Excluding( excludes );\n \n      <span class=\"green\">// Save the intersecting ducts</span>\n \n      <span class=\"blue\">foreach</span>( <span class=\"teal\">Element</span> elem <span class=\"blue\">in</span> collector )\n      {\n        m_ClashingDucts.Add( elem.Id );\n      }\n    }\n \n    <span class=\"green\">// The rule ID for this rule;</span>\n \n    <span class=\"blue\">public</span> <span class=\"teal\">PerformanceAdviserRuleId</span> Id =\n      <span class=\"blue\">new</span> <span class=\"teal\">PerformanceAdviserRuleId</span>(\n        <span class=\"blue\">new</span> <span class=\"teal\">Guid</span>( <span class=\"maroon\">\"C00CEF6D-2C4B-402C-9AED-160DFA1785BE\"</span> ) );\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> This method is called by PerformanceAdviser </span>\n    <span class=\"gray\">///</span><span class=\"green\"> after all elements in document matching the </span>\n    <span class=\"gray\">///</span><span class=\"green\"> ElementFilter from GetElementFilter() are </span>\n    <span class=\"gray\">///</span><span class=\"green\"> checked by ExecuteElementCheck(). It checks to </span>\n    <span class=\"gray\">///</span><span class=\"green\"> see if there are any ducts in the </span>\n    <span class=\"gray\">///</span><span class=\"green\"> m_ClashingDucts list. If so, it iterates </span>\n    <span class=\"gray\">///</span><span class=\"green\"> through that list and reports the failures.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> FinalizeCheck( <span class=\"teal\">Document</span> document )\n    {\n      <span class=\"blue\">try</span>\n      {\n        <span class=\"green\">// If no ducts clash</span>\n \n        <span class=\"blue\">if</span>( m_ClashingDucts.Count == 0 )\n        {\n          <span class=\"teal\">Debug</span>.WriteLine(\n            <span class=\"maroon\">\"No clashing ducts. Test passed.\"</span> );\n        }\n        <span class=\"blue\">else</span>\n        {\n          <span class=\"green\">// Pass the element IDs of the clashing ducts to the revit</span>\n          <span class=\"green\">// failure reporting APIs.</span>\n \n          <span class=\"teal\">FailureMessage</span> fm =\n            <span class=\"blue\">new</span> <span class=\"teal\">FailureMessage</span>( m_warningId );\n \n          fm.SetFailingElements( m_ClashingDucts );\n \n          <span class=\"teal\">Transaction</span> failureReportingTransaction =\n            <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( document );\n \n          failureReportingTransaction.Start( \n            <span class=\"maroon\">\"Failure reporting\"</span> );\n \n          <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser()\n            .PostWarning( fm );\n \n          failureReportingTransaction.Commit();\n \n          m_ClashingDucts.Clear();\n        }\n      }\n      <span class=\"blue\">catch</span>( System.<span class=\"teal\">Exception</span> ex )\n      {\n        <span class=\"teal\">TaskDialog</span>.Show( <span class=\"maroon\">\"Oops!\"</span>, ex.Message );\n      }\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Return rule description.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">string</span> GetDescription()\n    {\n      <span class=\"blue\">return</span> <span class=\"maroon\">\"Detects clash between ducts\"</span>;\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Provide the filter to focus on elements </span>\n    <span class=\"gray\">///</span><span class=\"green\"> that this rule should be focused on.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"teal\">ElementFilter</span> GetElementFilter( \n      <span class=\"teal\">Document</span> document )\n    {\n      <span class=\"blue\">return</span> <span class=\"blue\">new</span> <span class=\"teal\">ElementClassFilter</span>( <span class=\"blue\">typeof</span>( <span class=\"teal\">Duct</span> ) );\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Return name of rule.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">string</span> GetName()\n    {\n      <span class=\"blue\">return</span> <span class=\"maroon\">\"Duct Clash Detection\"</span>;\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Perform initial/preliminary work </span>\n    <span class=\"gray\">///</span><span class=\"green\"> before executing the tests.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> InitCheck( <span class=\"teal\">Document</span> document )\n    {\n      <span class=\"blue\">if</span>( m_ClashingDucts == <span class=\"blue\">null</span> )\n        m_ClashingDucts = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt;();\n      <span class=\"blue\">else</span>\n        m_ClashingDucts.Clear();\n \n      <span class=\"blue\">return</span>;\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Return true if this rule will iterate </span>\n    <span class=\"gray\">///</span><span class=\"green\"> through elements and check them, </span>\n    <span class=\"gray\">///</span><span class=\"green\"> else return false.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">bool</span> WillCheckElements()\n    {\n      <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n    }\n  }\n}\n</pre>\n<p>Once we have defined a class for our custom rule, our next step is to register the rule. You can do this by calling PerformanceAdvisor.AddRule. \nThis is done at the start-up of Revit using the OnStartup event of IExternalApplication.\n\n<p>Similarly, we can unregister the Performance Adviser rule at the OnShutdown event. The following code shows an example of how the custom rule is registered and unregistered:\n\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">AddPerformanceRule</span> : <span class=\"teal\">IExternalApplication</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">DuctClashDetection</span> ductClashDetect;\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Unregister the custom rule.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> OnShutdown( \n    <span class=\"teal\">UIControlledApplication</span> application )\n  {\n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    adviser.DeleteRule( ductClashDetect.Id );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Register the custom rule.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> OnStartup( \n    <span class=\"teal\">UIControlledApplication</span> application )\n  {\n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    ductClashDetect = <span class=\"blue\">new</span> <span class=\"teal\">DuctClashDetection</span>();\n \n    adviser.AddRule( ductClashDetect.Id, ductClashDetect );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>Once the custom rule has been added, we can execute it in the same way as the predefined rules. \nUsing the code used in this article against a given set of clashing ducts, this new API can report the clash results as shown below:</p>\n<center>\n<img alt=\"Collision test rule\" src=\"img/performance_adviser_collision_test.jpg\" width=\"400\"/>\n</center>\n<p>In this article, we have shown you that the performance adviser API provides the ability to define custom rules, execute them, and report potentially problematic results via the failure message APIs. \nThe Revit SDK PerformanceAdviserControl sample shows more comprehensive examples of this API. \nIt presents a list of rules for the users to select and execute. \nPlease refer to the sample for more details.\n\n<p>Many thanks to Saikat for this helpful overview!\n\n</p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0712_performance_adviser",
    "header_text": "Executing a Performance Adviser Rule",
    "local_header_href": "#executing-a-performance-adviser-rule",
    "chunk_text": "<h4>Executing a Performance Adviser Rule</h4><p>Once you know the ids of rules that you are interested in, you can use the PerformanceAdviser.ExecuteRules method to execute the given rules. \nThis method takes a document and a set of rule ids as input arguments. \nIt returns a list of FailureMessages, which we can iterate through and display, for instance, in a standard Revit warning dialog using Document.PostFailure method. \n\n<p>For an introductory discussion about Failure Posting and Handling, please refer to \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/04/failure-api.html\">\nthis introduction</a>,\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/11/failure-api-take-two.html\">\nits follow-up</a>, \n\nand the ADN <i>AEC Customization Newsletter – BIM Edition – Winter 2011</i>.\n\n<!--\n350_failure_api.htm  484_failure_api.htm  732_failure_idling.htm\n-->\n<p>The following command shows a simple example of executing the overlapping walls\u001d performance adviser rule: \n\n<pre class=\"code\">\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n<span class=\"gray\">///</span><span class=\"green\"> Execute overlapping walls? </span>\n<span class=\"gray\">///</span><span class=\"green\"> performance adviser rule.</span>\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">ExecutePerformanceRule</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">Document</span> doc = commandData.Application\n      .ActiveUIDocument.Document;\n \n    <span class=\"green\">// Access the Performance Adviser object</span>\n \n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    <span class=\"green\">// List all the rules</span>\n \n    <span class=\"teal\">IList</span>&lt;<span class=\"teal\">PerformanceAdviserRuleId</span>&gt; ruleIds = adviser.GetAllRuleIds();\n \n    <span class=\"green\">// Create an empty list for </span>\n    <span class=\"green\">// the rules to be executed</span>\n \n    <span class=\"teal\">IList</span>&lt;<span class=\"teal\">PerformanceAdviserRuleId</span>&gt; rulesIdsToExecute =\n      <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">PerformanceAdviserRuleId</span>&gt;();\n \n    <span class=\"green\">// Iterate through each</span>\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">PerformanceAdviserRuleId</span> ruleId <span class=\"blue\">in</span> ruleIds )\n    {\n      <span class=\"blue\">if</span>( adviser.GetRuleName( ruleId ).Equals( <span class=\"maroon\">\"Overlapping walls\"</span> ) )\n      {\n        rulesIdsToExecute.Add( ruleId );\n        <span class=\"blue\">break</span>;\n      }\n    }\n \n    <span class=\"green\">// Now we need to post the results</span>\n \n    <span class=\"teal\">IList</span>&lt;<span class=\"teal\">FailureMessage</span>&gt; failureMessages =\n      adviser.ExecuteRules( doc, rulesIdsToExecute );\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">FailureMessage</span> fm <span class=\"blue\">in</span> failureMessages )\n    {\n      <span class=\"teal\">Transaction</span> trans = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc );\n      trans.Start( <span class=\"maroon\">\"Failure Reporting\"</span> );\n      doc.PostFailure( fm );\n      trans.Commit();\n    }\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<a name=\"3\"></a>\n<h4>Defining a Custom Rule</h4>\n<p>Now, the most powerful part of this API is that we define custom adviser rules. To create our own, we define a class implementing an interface called IPerformanceAdviserRule. Your custom adviser class then needs to define the following methods:\n\n<ul>\n<li>GetName – returns the name of this rule.\n\n<li>GetDescription – provides the description of this custom rule.\n\n<li>InitCheck – performs the initialization work before running the rule. For example, it could be a task like clearing a collection of elements that we will be storing elements that fail the rule execution test.\n\n<li>WillCheckElements – sets whether the rule will iterate through elements or not.\n\n<li>GetElementFilter – provides the element filter which can help narrow down the type or category of elements that a certain rule is expected to work with.\n\n<li>ExecuteElementCheck – This method contains most of the implementation steps for a given rule. It examines the element passed to it (which is filtered by the GetElementFilter) and checks for all elements that fail the criteria laid by the rule.\n\n<li>FinalizeCheck – This method gets called by the PerformanceAdviser after all the elements in a document matching the element filter in the GetElementFilter method have been checked by the ExecuteElementCheck method. This method usually will contain the code to check if there are elements which fail the rule test and if there are, the names of the elements are listed along with the standard warning failure message.\n</li></li></li></li></li></li></li></ul>\n<p>The code below shows an example of a custom performance adviser rule, which provides warnings if there are clashes between ducts in a Revit model: \n\n<pre class=\"code\">\n<span class=\"green\">// A custom performance adviser rule class.</span>\n<span class=\"green\">// This rule provides a warning if the model </span>\n<span class=\"green\">// contains ducts which clash each other.  </span>\n \n<span class=\"blue\">using</span> System;\n<span class=\"blue\">using</span> System.Collections.Generic;\n<span class=\"blue\">using</span> System.Linq;\n<span class=\"blue\">using</span> System.Text;\n \n<span class=\"blue\">using</span> Autodesk.Revit.UI;\n<span class=\"blue\">using</span> Autodesk.Revit.DB;\n<span class=\"blue\">using</span> Autodesk.Revit.Attributes;\n<span class=\"blue\">using</span> Autodesk.Revit.DB.Mechanical;\n<span class=\"blue\">using</span> System.Diagnostics;\n \n<span class=\"blue\">namespace</span> BuildingCoder\n{\n  <span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">DuctClashDetection</span> \n    : <span class=\"teal\">IPerformanceAdviserRule</span>\n  {\n    <span class=\"blue\">private</span> <span class=\"teal\">FailureDefinition</span> m_warning;\n    <span class=\"blue\">private</span> <span class=\"teal\">FailureDefinitionId</span> m_warningId;\n    <span class=\"blue\">private</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt; m_ClashingDucts;\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> DuctClashDetection Constructor</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> DuctClashDetection()\n    {\n      <span class=\"green\">// Create failure message</span>\n \n      m_warningId = <span class=\"blue\">new</span> <span class=\"teal\">FailureDefinitionId</span>(\n        <span class=\"blue\">new</span> <span class=\"teal\">Guid</span>( <span class=\"maroon\">\"AACC9C09-7956-4B36-9D27-FF8A64544C31\"</span> ) );\n \n      m_warning = <span class=\"teal\">FailureDefinition</span>.CreateFailureDefinition(\n        m_warningId, <span class=\"teal\">FailureSeverity</span>.Warning,\n        <span class=\"maroon\">\"Some ducts clash with each other\"</span> );\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> This method does most of the work of the </span>\n    <span class=\"gray\">///</span><span class=\"green\"> IPerformanceAdviserRule implementation. </span>\n    <span class=\"gray\">///</span><span class=\"green\"> It is called by PerformanceAdviser and </span>\n    <span class=\"gray\">///</span><span class=\"green\"> examines the element passed to it </span>\n    <span class=\"gray\">///</span><span class=\"green\"> (which was previously filtered by the filter </span>\n    <span class=\"gray\">///</span><span class=\"green\"> returned by GetElementFilter).  This method </span>\n    <span class=\"gray\">///</span><span class=\"green\"> is checking for all elements that intersect </span>\n    <span class=\"gray\">///</span><span class=\"green\"> with current duct and adds them to the list </span>\n    <span class=\"gray\">///</span><span class=\"green\"> of elements.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> ExecuteElementCheck(\n      <span class=\"teal\">Document</span> document,\n      <span class=\"teal\">Element</span> element )\n    {\n      <span class=\"green\">// For each of the elements, check if there is </span>\n      <span class=\"green\">// any intersection with the specific element </span>\n      <span class=\"green\">// being passed on via the method signature</span>\n \n      <span class=\"teal\">FilteredElementCollector</span> collector \n        = <span class=\"blue\">new</span> <span class=\"teal\">FilteredElementCollector</span>( document );\n \n      <span class=\"green\">// Use the Elements Intersection Filter to get elements</span>\n      <span class=\"green\">// that intersect with the specified element</span>\n \n      <span class=\"teal\">ElementIntersectsElementFilter</span> elementFilter =\n        <span class=\"blue\">new</span> <span class=\"teal\">ElementIntersectsElementFilter</span>( element, <span class=\"blue\">false</span> );\n \n      collector.WherePasses( elementFilter );\n \n      <span class=\"green\">// Exclude the element in the intersection</span>\n \n      <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt; excludes = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt;();\n      excludes.Add( element.Id );\n      collector.Excluding( excludes );\n \n      <span class=\"green\">// Save the intersecting ducts</span>\n \n      <span class=\"blue\">foreach</span>( <span class=\"teal\">Element</span> elem <span class=\"blue\">in</span> collector )\n      {\n        m_ClashingDucts.Add( elem.Id );\n      }\n    }\n \n    <span class=\"green\">// The rule ID for this rule;</span>\n \n    <span class=\"blue\">public</span> <span class=\"teal\">PerformanceAdviserRuleId</span> Id =\n      <span class=\"blue\">new</span> <span class=\"teal\">PerformanceAdviserRuleId</span>(\n        <span class=\"blue\">new</span> <span class=\"teal\">Guid</span>( <span class=\"maroon\">\"C00CEF6D-2C4B-402C-9AED-160DFA1785BE\"</span> ) );\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> This method is called by PerformanceAdviser </span>\n    <span class=\"gray\">///</span><span class=\"green\"> after all elements in document matching the </span>\n    <span class=\"gray\">///</span><span class=\"green\"> ElementFilter from GetElementFilter() are </span>\n    <span class=\"gray\">///</span><span class=\"green\"> checked by ExecuteElementCheck(). It checks to </span>\n    <span class=\"gray\">///</span><span class=\"green\"> see if there are any ducts in the </span>\n    <span class=\"gray\">///</span><span class=\"green\"> m_ClashingDucts list. If so, it iterates </span>\n    <span class=\"gray\">///</span><span class=\"green\"> through that list and reports the failures.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> FinalizeCheck( <span class=\"teal\">Document</span> document )\n    {\n      <span class=\"blue\">try</span>\n      {\n        <span class=\"green\">// If no ducts clash</span>\n \n        <span class=\"blue\">if</span>( m_ClashingDucts.Count == 0 )\n        {\n          <span class=\"teal\">Debug</span>.WriteLine(\n            <span class=\"maroon\">\"No clashing ducts. Test passed.\"</span> );\n        }\n        <span class=\"blue\">else</span>\n        {\n          <span class=\"green\">// Pass the element IDs of the clashing ducts to the revit</span>\n          <span class=\"green\">// failure reporting APIs.</span>\n \n          <span class=\"teal\">FailureMessage</span> fm =\n            <span class=\"blue\">new</span> <span class=\"teal\">FailureMessage</span>( m_warningId );\n \n          fm.SetFailingElements( m_ClashingDucts );\n \n          <span class=\"teal\">Transaction</span> failureReportingTransaction =\n            <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( document );\n \n          failureReportingTransaction.Start( \n            <span class=\"maroon\">\"Failure reporting\"</span> );\n \n          <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser()\n            .PostWarning( fm );\n \n          failureReportingTransaction.Commit();\n \n          m_ClashingDucts.Clear();\n        }\n      }\n      <span class=\"blue\">catch</span>( System.<span class=\"teal\">Exception</span> ex )\n      {\n        <span class=\"teal\">TaskDialog</span>.Show( <span class=\"maroon\">\"Oops!\"</span>, ex.Message );\n      }\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Return rule description.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">string</span> GetDescription()\n    {\n      <span class=\"blue\">return</span> <span class=\"maroon\">\"Detects clash between ducts\"</span>;\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Provide the filter to focus on elements </span>\n    <span class=\"gray\">///</span><span class=\"green\"> that this rule should be focused on.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"teal\">ElementFilter</span> GetElementFilter( \n      <span class=\"teal\">Document</span> document )\n    {\n      <span class=\"blue\">return</span> <span class=\"blue\">new</span> <span class=\"teal\">ElementClassFilter</span>( <span class=\"blue\">typeof</span>( <span class=\"teal\">Duct</span> ) );\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Return name of rule.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">string</span> GetName()\n    {\n      <span class=\"blue\">return</span> <span class=\"maroon\">\"Duct Clash Detection\"</span>;\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Perform initial/preliminary work </span>\n    <span class=\"gray\">///</span><span class=\"green\"> before executing the tests.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> InitCheck( <span class=\"teal\">Document</span> document )\n    {\n      <span class=\"blue\">if</span>( m_ClashingDucts == <span class=\"blue\">null</span> )\n        m_ClashingDucts = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt;();\n      <span class=\"blue\">else</span>\n        m_ClashingDucts.Clear();\n \n      <span class=\"blue\">return</span>;\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Return true if this rule will iterate </span>\n    <span class=\"gray\">///</span><span class=\"green\"> through elements and check them, </span>\n    <span class=\"gray\">///</span><span class=\"green\"> else return false.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">bool</span> WillCheckElements()\n    {\n      <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n    }\n  }\n}\n</pre>\n<p>Once we have defined a class for our custom rule, our next step is to register the rule. You can do this by calling PerformanceAdvisor.AddRule. \nThis is done at the start-up of Revit using the OnStartup event of IExternalApplication.\n\n<p>Similarly, we can unregister the Performance Adviser rule at the OnShutdown event. The following code shows an example of how the custom rule is registered and unregistered:\n\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">AddPerformanceRule</span> : <span class=\"teal\">IExternalApplication</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">DuctClashDetection</span> ductClashDetect;\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Unregister the custom rule.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> OnShutdown( \n    <span class=\"teal\">UIControlledApplication</span> application )\n  {\n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    adviser.DeleteRule( ductClashDetect.Id );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Register the custom rule.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> OnStartup( \n    <span class=\"teal\">UIControlledApplication</span> application )\n  {\n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    ductClashDetect = <span class=\"blue\">new</span> <span class=\"teal\">DuctClashDetection</span>();\n \n    adviser.AddRule( ductClashDetect.Id, ductClashDetect );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>Once the custom rule has been added, we can execute it in the same way as the predefined rules. \nUsing the code used in this article against a given set of clashing ducts, this new API can report the clash results as shown below:</p>\n<center>\n<img alt=\"Collision test rule\" src=\"img/performance_adviser_collision_test.jpg\" width=\"400\"/>\n</center>\n<p>In this article, we have shown you that the performance adviser API provides the ability to define custom rules, execute them, and report potentially problematic results via the failure message APIs. \nThe Revit SDK PerformanceAdviserControl sample shows more comprehensive examples of this API. \nIt presents a list of rules for the users to select and execute. \nPlease refer to the sample for more details.\n\n<p>Many thanks to Saikat for this helpful overview!\n\n</p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0712_performance_adviser",
    "header_text": "Defining a Custom Rule",
    "local_header_href": "#defining-a-custom-rule",
    "chunk_text": "<h4>Defining a Custom Rule</h4><p>Now, the most powerful part of this API is that we define custom adviser rules. To create our own, we define a class implementing an interface called IPerformanceAdviserRule. Your custom adviser class then needs to define the following methods:\n\n<ul>\n<li>GetName – returns the name of this rule.\n\n<li>GetDescription – provides the description of this custom rule.\n\n<li>InitCheck – performs the initialization work before running the rule. For example, it could be a task like clearing a collection of elements that we will be storing elements that fail the rule execution test.\n\n<li>WillCheckElements – sets whether the rule will iterate through elements or not.\n\n<li>GetElementFilter – provides the element filter which can help narrow down the type or category of elements that a certain rule is expected to work with.\n\n<li>ExecuteElementCheck – This method contains most of the implementation steps for a given rule. It examines the element passed to it (which is filtered by the GetElementFilter) and checks for all elements that fail the criteria laid by the rule.\n\n<li>FinalizeCheck – This method gets called by the PerformanceAdviser after all the elements in a document matching the element filter in the GetElementFilter method have been checked by the ExecuteElementCheck method. This method usually will contain the code to check if there are elements which fail the rule test and if there are, the names of the elements are listed along with the standard warning failure message.\n</li></li></li></li></li></li></li></ul>\n<p>The code below shows an example of a custom performance adviser rule, which provides warnings if there are clashes between ducts in a Revit model: \n\n<pre class=\"code\">\n<span class=\"green\">// A custom performance adviser rule class.</span>\n<span class=\"green\">// This rule provides a warning if the model </span>\n<span class=\"green\">// contains ducts which clash each other.  </span>\n \n<span class=\"blue\">using</span> System;\n<span class=\"blue\">using</span> System.Collections.Generic;\n<span class=\"blue\">using</span> System.Linq;\n<span class=\"blue\">using</span> System.Text;\n \n<span class=\"blue\">using</span> Autodesk.Revit.UI;\n<span class=\"blue\">using</span> Autodesk.Revit.DB;\n<span class=\"blue\">using</span> Autodesk.Revit.Attributes;\n<span class=\"blue\">using</span> Autodesk.Revit.DB.Mechanical;\n<span class=\"blue\">using</span> System.Diagnostics;\n \n<span class=\"blue\">namespace</span> BuildingCoder\n{\n  <span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">DuctClashDetection</span> \n    : <span class=\"teal\">IPerformanceAdviserRule</span>\n  {\n    <span class=\"blue\">private</span> <span class=\"teal\">FailureDefinition</span> m_warning;\n    <span class=\"blue\">private</span> <span class=\"teal\">FailureDefinitionId</span> m_warningId;\n    <span class=\"blue\">private</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt; m_ClashingDucts;\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> DuctClashDetection Constructor</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> DuctClashDetection()\n    {\n      <span class=\"green\">// Create failure message</span>\n \n      m_warningId = <span class=\"blue\">new</span> <span class=\"teal\">FailureDefinitionId</span>(\n        <span class=\"blue\">new</span> <span class=\"teal\">Guid</span>( <span class=\"maroon\">\"AACC9C09-7956-4B36-9D27-FF8A64544C31\"</span> ) );\n \n      m_warning = <span class=\"teal\">FailureDefinition</span>.CreateFailureDefinition(\n        m_warningId, <span class=\"teal\">FailureSeverity</span>.Warning,\n        <span class=\"maroon\">\"Some ducts clash with each other\"</span> );\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> This method does most of the work of the </span>\n    <span class=\"gray\">///</span><span class=\"green\"> IPerformanceAdviserRule implementation. </span>\n    <span class=\"gray\">///</span><span class=\"green\"> It is called by PerformanceAdviser and </span>\n    <span class=\"gray\">///</span><span class=\"green\"> examines the element passed to it </span>\n    <span class=\"gray\">///</span><span class=\"green\"> (which was previously filtered by the filter </span>\n    <span class=\"gray\">///</span><span class=\"green\"> returned by GetElementFilter).  This method </span>\n    <span class=\"gray\">///</span><span class=\"green\"> is checking for all elements that intersect </span>\n    <span class=\"gray\">///</span><span class=\"green\"> with current duct and adds them to the list </span>\n    <span class=\"gray\">///</span><span class=\"green\"> of elements.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> ExecuteElementCheck(\n      <span class=\"teal\">Document</span> document,\n      <span class=\"teal\">Element</span> element )\n    {\n      <span class=\"green\">// For each of the elements, check if there is </span>\n      <span class=\"green\">// any intersection with the specific element </span>\n      <span class=\"green\">// being passed on via the method signature</span>\n \n      <span class=\"teal\">FilteredElementCollector</span> collector \n        = <span class=\"blue\">new</span> <span class=\"teal\">FilteredElementCollector</span>( document );\n \n      <span class=\"green\">// Use the Elements Intersection Filter to get elements</span>\n      <span class=\"green\">// that intersect with the specified element</span>\n \n      <span class=\"teal\">ElementIntersectsElementFilter</span> elementFilter =\n        <span class=\"blue\">new</span> <span class=\"teal\">ElementIntersectsElementFilter</span>( element, <span class=\"blue\">false</span> );\n \n      collector.WherePasses( elementFilter );\n \n      <span class=\"green\">// Exclude the element in the intersection</span>\n \n      <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt; excludes = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt;();\n      excludes.Add( element.Id );\n      collector.Excluding( excludes );\n \n      <span class=\"green\">// Save the intersecting ducts</span>\n \n      <span class=\"blue\">foreach</span>( <span class=\"teal\">Element</span> elem <span class=\"blue\">in</span> collector )\n      {\n        m_ClashingDucts.Add( elem.Id );\n      }\n    }\n \n    <span class=\"green\">// The rule ID for this rule;</span>\n \n    <span class=\"blue\">public</span> <span class=\"teal\">PerformanceAdviserRuleId</span> Id =\n      <span class=\"blue\">new</span> <span class=\"teal\">PerformanceAdviserRuleId</span>(\n        <span class=\"blue\">new</span> <span class=\"teal\">Guid</span>( <span class=\"maroon\">\"C00CEF6D-2C4B-402C-9AED-160DFA1785BE\"</span> ) );\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> This method is called by PerformanceAdviser </span>\n    <span class=\"gray\">///</span><span class=\"green\"> after all elements in document matching the </span>\n    <span class=\"gray\">///</span><span class=\"green\"> ElementFilter from GetElementFilter() are </span>\n    <span class=\"gray\">///</span><span class=\"green\"> checked by ExecuteElementCheck(). It checks to </span>\n    <span class=\"gray\">///</span><span class=\"green\"> see if there are any ducts in the </span>\n    <span class=\"gray\">///</span><span class=\"green\"> m_ClashingDucts list. If so, it iterates </span>\n    <span class=\"gray\">///</span><span class=\"green\"> through that list and reports the failures.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> FinalizeCheck( <span class=\"teal\">Document</span> document )\n    {\n      <span class=\"blue\">try</span>\n      {\n        <span class=\"green\">// If no ducts clash</span>\n \n        <span class=\"blue\">if</span>( m_ClashingDucts.Count == 0 )\n        {\n          <span class=\"teal\">Debug</span>.WriteLine(\n            <span class=\"maroon\">\"No clashing ducts. Test passed.\"</span> );\n        }\n        <span class=\"blue\">else</span>\n        {\n          <span class=\"green\">// Pass the element IDs of the clashing ducts to the revit</span>\n          <span class=\"green\">// failure reporting APIs.</span>\n \n          <span class=\"teal\">FailureMessage</span> fm =\n            <span class=\"blue\">new</span> <span class=\"teal\">FailureMessage</span>( m_warningId );\n \n          fm.SetFailingElements( m_ClashingDucts );\n \n          <span class=\"teal\">Transaction</span> failureReportingTransaction =\n            <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( document );\n \n          failureReportingTransaction.Start( \n            <span class=\"maroon\">\"Failure reporting\"</span> );\n \n          <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser()\n            .PostWarning( fm );\n \n          failureReportingTransaction.Commit();\n \n          m_ClashingDucts.Clear();\n        }\n      }\n      <span class=\"blue\">catch</span>( System.<span class=\"teal\">Exception</span> ex )\n      {\n        <span class=\"teal\">TaskDialog</span>.Show( <span class=\"maroon\">\"Oops!\"</span>, ex.Message );\n      }\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Return rule description.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">string</span> GetDescription()\n    {\n      <span class=\"blue\">return</span> <span class=\"maroon\">\"Detects clash between ducts\"</span>;\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Provide the filter to focus on elements </span>\n    <span class=\"gray\">///</span><span class=\"green\"> that this rule should be focused on.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"teal\">ElementFilter</span> GetElementFilter( \n      <span class=\"teal\">Document</span> document )\n    {\n      <span class=\"blue\">return</span> <span class=\"blue\">new</span> <span class=\"teal\">ElementClassFilter</span>( <span class=\"blue\">typeof</span>( <span class=\"teal\">Duct</span> ) );\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Return name of rule.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">string</span> GetName()\n    {\n      <span class=\"blue\">return</span> <span class=\"maroon\">\"Duct Clash Detection\"</span>;\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Perform initial/preliminary work </span>\n    <span class=\"gray\">///</span><span class=\"green\"> before executing the tests.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">void</span> InitCheck( <span class=\"teal\">Document</span> document )\n    {\n      <span class=\"blue\">if</span>( m_ClashingDucts == <span class=\"blue\">null</span> )\n        m_ClashingDucts = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;<span class=\"teal\">ElementId</span>&gt;();\n      <span class=\"blue\">else</span>\n        m_ClashingDucts.Clear();\n \n      <span class=\"blue\">return</span>;\n    }\n \n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n    <span class=\"gray\">///</span><span class=\"green\"> Return true if this rule will iterate </span>\n    <span class=\"gray\">///</span><span class=\"green\"> through elements and check them, </span>\n    <span class=\"gray\">///</span><span class=\"green\"> else return false.</span>\n    <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n    <span class=\"blue\">public</span> <span class=\"blue\">bool</span> WillCheckElements()\n    {\n      <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n    }\n  }\n}\n</pre>\n<p>Once we have defined a class for our custom rule, our next step is to register the rule. You can do this by calling PerformanceAdvisor.AddRule. \nThis is done at the start-up of Revit using the OnStartup event of IExternalApplication.\n\n<p>Similarly, we can unregister the Performance Adviser rule at the OnShutdown event. The following code shows an example of how the custom rule is registered and unregistered:\n\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">AddPerformanceRule</span> : <span class=\"teal\">IExternalApplication</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">DuctClashDetection</span> ductClashDetect;\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Unregister the custom rule.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> OnShutdown( \n    <span class=\"teal\">UIControlledApplication</span> application )\n  {\n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    adviser.DeleteRule( ductClashDetect.Id );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Register the custom rule.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> OnStartup( \n    <span class=\"teal\">UIControlledApplication</span> application )\n  {\n    <span class=\"teal\">PerformanceAdviser</span> adviser \n      = <span class=\"teal\">PerformanceAdviser</span>.GetPerformanceAdviser();\n \n    ductClashDetect = <span class=\"blue\">new</span> <span class=\"teal\">DuctClashDetection</span>();\n \n    adviser.AddRule( ductClashDetect.Id, ductClashDetect );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>Once the custom rule has been added, we can execute it in the same way as the predefined rules. \nUsing the code used in this article against a given set of clashing ducts, this new API can report the clash results as shown below:</p>\n<center>\n<img alt=\"Collision test rule\" src=\"img/performance_adviser_collision_test.jpg\" width=\"400\"/>\n</center>\n<p>In this article, we have shown you that the performance adviser API provides the ability to define custom rules, execute them, and report potentially problematic results via the failure message APIs. \nThe Revit SDK PerformanceAdviserControl sample shows more comprehensive examples of this API. \nIt presents a list of rules for the users to select and execute. \nPlease refer to the sample for more details.\n\n<p>Many thanks to Saikat for this helpful overview!\n\n</p></p></p></p></p></p>"
  }
]