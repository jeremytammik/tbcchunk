[
  {
    "original_filename": "1460_reload_links",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<title>The Building Coder</title>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\"/>\n<link rel=\"stylesheet\" type=\"text/css\" href=\"3dwc.css\"/>\n<script src=\"https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js?autoload=true\" defer=\"defer\"></script>\n</head>\n\n<!---\n\nMiroslav Schonauer RE: Links not automatically reloaded after migrating Revit model to 2016\n\nAutomatically Reload Links After Migration #revitapi #3dwebcoder @AutodeskRevit @AutodeskForge #aec #bim\n\n...\n\n-->"
  },
  {
    "original_filename": "1460_reload_links",
    "header_text": "Automatically Reload Links After Migration",
    "local_header_href": "#automatically-reload-links-after-migration",
    "chunk_text": "### Automatically Reload Links After Migration\n\nToday, my colleagues Michael Brian Lee and Miroslav Schonauer share a solution for links that are not automatically reloaded after migrating the model to Revit 2016."
  },
  {
    "original_filename": "1460_reload_links",
    "header_text": "<a name=\"2\"></a>Question",
    "local_header_href": "#a-name2aquestion",
    "chunk_text": "#### <a name=\"2\"></a>Question\n\nI implemented a batch tool to migrate Revit Server 2015 models to Revit Server 2016.\n\nDanny Polkinhorn’s SaveAsNewCentral code was a great starting point, and the tool is successfully migrating the models.\n\nThe workflow for the migration is to open 2015 model detached from central with all worksets closed,  which starts an automatic upgrade process, then save to the 2016 server.\n\nThe assumption was that links will be taken care of automatically.\n \nTo verify the migration and upgrade I perform the following steps:\n\n- Open model in Revit Server 2016 with all worksets closed.\n- Go to Manage Links.\n- Check Saved Path &ndash; it seems correct.\n- Click on the Reload button.\n\nThat displays the following error saying that the linked file cannot be found:\n\n<center>\n<img src=\"img/reload_links_1.jpeg\" alt=\"Link not found\" width=\"500\">\n</center>\n\nI then click on Reload From, navigate to the exactly the same path as shown in the Saved Path, and the link is loaded.\n \nAny idea of why the Reload does not find the model, even if the path is correct?\n\nIt is possible that the automatic upgrade changed the GUID of the models?\n\nHow can I get around this?\n\nAt the moment I think I'll need to implement and run another batch tool once all models are migrated.\n\nThe second tool could reload all links using `RevitLinkLoadResult.LoadFrom` and then sync to central.\n\nWould that work?\n\nIs there any other way around this?\n\nSecond question:\n\nIn some of my tests, I see some strange characters on some of the server paths:\n\n<center>\n<img src=\"img/reload_links_2.png\" alt=\"Strange characters\" width=\"450\">\n</center>\n\nWhat might be causing that, please?"
  },
  {
    "original_filename": "1460_reload_links",
    "header_text": "<a name=\"3\"></a>Answer",
    "local_header_href": "#a-name3aanswer",
    "chunk_text": "#### <a name=\"3\"></a>Answer\n\nI suspect that this is an artefact of how link resolution is achieved with Revit Server.\n\nAlthough, from the UI, it looks as if it is resolving by a path, in reality, it is actually resolving by a unique GUID that corresponds to the central model.  This allows us to transparently repath a link if it is moved to a new folder or server, or if it is renamed.  However, the trade-off is that it cannot automatically repath to a new model replacing an old one, even if the name and location are the same.  That’s because each new model, when saved to the server for the first time, is equipped with a new unique GUID."
  },
  {
    "original_filename": "1460_reload_links",
    "header_text": "<a name=\"4\"></a>Solution",
    "local_header_href": "#a-name4asolution",
    "chunk_text": "#### <a name=\"4\"></a>Solution\n\nThank you for the official confirmation, Mike &ndash; it is good to know we are not doing anything fundamentally wrong in our scripts and Revit Server code.\n\nFurther good news: we managed to implement a programmatic solution for this Revit Server workflow issue.\n\nBasically, we prototyped a custom add-in command that now fully simulates the manual UI solution, i.e., it automates selecting 'Reload from….' in Manage Links and browsing to basically the same location as the 'Saved Path' shown does.\n\nIt took a bit of time to find the right classes as there are no less than four levels of indirection to get from `RevitLinkType` to the 'Saved Path' and then use that in the call to `LoadFrom`.\n\nHere are the most important steps:\n\n<pre class=\"code\">\n&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Loop&nbsp;all&nbsp;RVT&nbsp;Links</span>\n\n&nbsp;&nbsp;<span style=\"color:blue;\">foreach</span>(&nbsp;<span style=\"color:#2b91af;\">RevitLinkType</span>&nbsp;typeLink&nbsp;<span style=\"color:blue;\">in</span>&nbsp;fecLinkTypes&nbsp;)\n&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;...</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Skip1&nbsp;-&nbsp;not&nbsp;IsFromRevitServer</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;!typeLink.IsFromRevitServer()&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//…</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">continue</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Skip2&nbsp;-&nbsp;not&nbsp;ExternalFileReference</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;99%&nbsp;it&nbsp;would&nbsp;already&nbsp;skip&nbsp;above&nbsp;as&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;RevitServer&nbsp;MUST&nbsp;be&nbsp;ExternalFileReference,&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;but&nbsp;leave&nbsp;just&nbsp;in&nbsp;case...</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">ExternalFileReference</span>&nbsp;er&nbsp;=&nbsp;typeLink.GetExternalFileReference();\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;er&nbsp;==&nbsp;<span style=\"color:blue;\">null</span>&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;...</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">continue</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;If&nbsp;here,&nbsp;we&nbsp;can&nbsp;cache&nbsp;ModelPath&nbsp;related&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;info&nbsp;and&nbsp;show&nbsp;to&nbsp;user&nbsp;regardless&nbsp;if&nbsp;we&nbsp;skip&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;on&nbsp;next&nbsp;checks&nbsp;or&nbsp;not....</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">ModelPath</span>&nbsp;mp&nbsp;=&nbsp;er.GetPath();\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">string</span>&nbsp;userVisiblePath&nbsp;=&nbsp;<span style=\"color:#2b91af;\">ModelPathUtils</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.ConvertModelPathToUserVisiblePath(&nbsp;mp&nbsp;);\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Skip3&nbsp;-&nbsp;if&nbsp;ModelPath&nbsp;is&nbsp;NOT&nbsp;Server&nbsp;Path&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;99%&nbsp;redundant&nbsp;as&nbsp;we&nbsp;already&nbsp;checked&nbsp;raw&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;RevitLinkType&nbsp;for&nbsp;this,&nbsp;but&nbsp;keep&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;just&nbsp;in&nbsp;case...</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;!mp.ServerPath&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;...</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">continue</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Skip4&nbsp;-&nbsp;if&nbsp;NOT&nbsp;&quot;NOT&nbsp;Found&quot;&nbsp;problematic&nbsp;one&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;there&nbsp;is&nbsp;nothing&nbsp;to&nbsp;fix</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;er.GetLinkedFileStatus()\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!=&nbsp;<span style=\"color:#2b91af;\">LinkedFileStatus</span>.NotFound&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;...</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">continue</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Skip5&nbsp;-&nbsp;if&nbsp;Nested&nbsp;Link&nbsp;(can’t&nbsp;(re)load&nbsp;these!)</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;typeLink.IsNestedLink&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;...</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">continue</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;If&nbsp;here,&nbsp;we&nbsp;MUST&nbsp;offer&nbsp;user&nbsp;to&nbsp;&quot;Reload&nbsp;from...&quot;</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;...</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">RevitLinkLoadResult</span>&nbsp;res&nbsp;=&nbsp;<span style=\"color:blue;\">null</span>;\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">try</span>\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;This&nbsp;fails&nbsp;for&nbsp;problematic&nbsp;Server&nbsp;files&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;since&nbsp;it&nbsp;also&nbsp;fails&nbsp;on&nbsp;&quot;Reload&quot;&nbsp;button&nbsp;in&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;UI&nbsp;(due&nbsp;to&nbsp;the&nbsp;GUID&nbsp;issue&nbsp;in&nbsp;the&nbsp;answer)</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//res&nbsp;=&nbsp;typeLink.Reload();</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;This&nbsp;fails&nbsp;same&nbsp;as&nbsp;above&nbsp;:-(!</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//res&nbsp;=&nbsp;typeLink.Load();</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;This&nbsp;WORKS!</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Basically,&nbsp;this&nbsp;is&nbsp;the&nbsp;equivalent&nbsp;of&nbsp;UI&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;&quot;Reload&nbsp;from...&quot;&nbsp;+&nbsp;browsing&nbsp;to&nbsp;the&nbsp;*same*&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Saved&nbsp;path&nbsp;showing&nbsp;in&nbsp;the&nbsp;manage&nbsp;Links&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;dialogue.</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;ToDo:&nbsp;Check&nbsp;if&nbsp;we&nbsp;need&nbsp;to&nbsp;do&nbsp;anything&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;special&nbsp;with&nbsp;WorksetConfiguration?&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;In&nbsp;tests,&nbsp;it&nbsp;works&nbsp;fine&nbsp;with&nbsp;the&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;default&nbsp;c-tor.</span>\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">ModelPath</span>&nbsp;mpForReload&nbsp;=&nbsp;<span style=\"color:#2b91af;\">ModelPathUtils</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.ConvertUserVisiblePathToModelPath(\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;userVisiblePath&nbsp;);\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;res&nbsp;=&nbsp;typeLink.LoadFrom(&nbsp;mpForReload,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">WorksetConfiguration</span>()&nbsp;);\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">Util</span>.InfoMsg(&nbsp;<span style=\"color:blue;\">string</span>.Format(\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#a31515;\">&quot;Result&nbsp;=&nbsp;{0}&quot;</span>,&nbsp;res.LoadResult&nbsp;)&nbsp;);\n&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">catch</span>(&nbsp;<span style=\"color:#2b91af;\">Exception</span>&nbsp;ex&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;...</span>\n&nbsp;&nbsp;&nbsp;&nbsp;}\n}\n</pre>\n\nMany thanks to Miro for solving and sharing this solution!"
  }
]