[
  {
    "original_filename": "1037_move_duct_join",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<meta content=\"text/html; charset=utf-8\" http-equiv=\"Content-Type\"/>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "1037_move_duct_join",
    "header_text": "Move Duct Join with Video and GitHub Support",
    "local_header_href": "#move-duct-join-with-video-and-github-support",
    "chunk_text": "<h3>Move Duct Join with Video and GitHub Support</h3><p>I am always happy to take a look at a real MEP issue, so this case caught my eye and prompted me to sit down and do some actual coding again for a change:</p><p><strong>Question:</strong> How can I programmatically move the join of two ducts, effectively changing their end points?</p><p>I do not want to delete and re-enter them because they will normally be connected at the other end as well.</p><p><strong>Answer:</strong> In general, when working on programmatic manipulation of duct system geometry, you have two options for driving the desired changes:</p><ul>\n<li>Define the ducts, and let Revit automatically insert the required fittings when you ask them to be connected.</li>\n<li>Define the fittings, and let Revit automatically create the required ducts when you ask them to be connected.</li>\n</ul><p>This issue is a little bit different, in that all the required components are already present, and you just want to move them around relatively to another.</p><p>I took a look at it and implemented an add-in named MoveDuctJoin defining two separate external commands, because they illustrate the different options so clearly:</p><ul>\n<li><a href=\"#4\">CmdDisconnect</a> – this command just moves one duct connector, so the link to the neighbouring duct is broken, causing a disconnect.</li>\n<li><a href=\"#5\">CmdReconnect</a> – this command moves the fitting between the two ducts. That keeps the system connected.</li>\n</ul><a name=\"2\"></a>"
  },
  {
    "original_filename": "1037_move_duct_join",
    "header_text": "Mini Demo and Some Video Options",
    "local_header_href": "#mini-demo-and-some-video-options",
    "chunk_text": "<h4>Mini Demo and Some Video Options</h4><p>To keep things brief, here is a 25 second video that hopefully explains it all:</p><p>By the way, since this is so small and short and sweet, I really wanted to embed it inline, which is most easily achieved by converting it to GIF file format.</p><p>Camtasia for Windows supports conversion of MP4 to GIF, but Camtasia for Mac does not.</p><p>However, I just uploaded it to the\n\n<a href=\"http://www.zamzar.com\">Zamzar online converter</a> and\n\nreceived back the converted GIF file result within a minute or two, so that was that.</p><p>Oops.\nWell, maybe not quite.\nIt took a lot longer than that, and the resulting GIF file is 386 MB in size, whereas the original MP4 was smaller than 1 MB.\nMaybe I won't post it after all.\nIn fact, I even cancelled the download before it finished.</p><p>Instead, I uploaded the video to\n\n<a href=\"http://screencast.com\">Screencast.com</a>,\n\nto compare it with YouTube, which I used in the past.</p><p>Here is the\n\n<a href=\"http://www.screencast.com/t/4wGPF9f5DN\">result on Screencast.com</a>:</p><center>\n<object data=\"http://content.screencast.com/users/jeremytammik/folders/Default/media/bd999b95-965f-4bf4-b09f-deff4b3f2ff5/scplayer.swf\" height=\"315\" id=\"scPlayer\" type=\"application/x-shockwave-flash\" width=\"420\">\n<param name=\"movie\" value=\"http://content.screencast.com/users/jeremytammik/folders/Default/media/bd999b95-965f-4bf4-b09f-deff4b3f2ff5/scplayer.swf\"/>\n<param name=\"quality\" value=\"high\"/>\n<param name=\"bgcolor\" value=\"#FFFFFF\"/>\n<param name=\"flashVars\" value=\"thumb=http://content.screencast.com/users/jeremytammik/folders/Default/media/bd999b95-965f-4bf4-b09f-deff4b3f2ff5/FirstFrame.jpg&amp;containerwidth=800&amp;containerheight=600&amp;xmp=sc.xmp&amp;content=http://content.screencast.com/users/jeremytammik/folders/Default/media/bd999b95-965f-4bf4-b09f-deff4b3f2ff5/MoveDuctJoin.mp4&amp;blurover=false\"/>\n<param name=\"allowFullScreen\" value=\"true\"/>\n<param name=\"scale\" value=\"showall\"/>\n<param name=\"allowScriptAccess\" value=\"always\"/>\n<param name=\"base\" value=\"http://content.screencast.com/users/jeremytammik/folders/Default/media/bd999b95-965f-4bf4-b09f-deff4b3f2ff5/\"/>\n<iframe frameborder=\"0\" height=\"315\" scrolling=\"no\" src=\"http://www.screencast.com/users/jeremytammik/folders/Default/media/bd999b95-965f-4bf4-b09f-deff4b3f2ff5/embed\" style=\"overflow:hidden;\" type=\"text/html\" width=\"420\"></iframe>\n</object>\n</center><p>For comparison purposes, here is the same\n\n<a href=\"http://www.youtube.com/watch?v=kCpAymJkNrc\">video hosted on YouTube</a>:</p><center>\n<iframe allowfullscreen=\"\" frameborder=\"0\" height=\"315\" src=\"http://www.youtube.com/embed/kCpAymJkNrc\" width=\"420\"></iframe>\n</center><p>Actually, I find the latter slightly handier, so far.</p><p>I wish either of them would scale up the video, or at least pad it in white and not waste all that space with the huge black border around it.</p><a name=\"3\"></a>"
  },
  {
    "original_filename": "1037_move_duct_join",
    "header_text": "External Command User Interaction",
    "local_header_href": "#external-command-user-interaction",
    "chunk_text": "<h4>External Command User Interaction</h4><p>The user interaction of both external commands consists of exactly three clicks:</p><ul>\n<li>Launch the command.</li>\n<li>Click a duct close to the source connector to be relocated.</li>\n<li>Pick another point on the duct close to the target point to move it to.</li>\n</ul><p>Just for the sake of completeness, or in case the videos above do not display correctly, here are three screen snapshots showing the original situation and the result of running CmdDisconnect and CmdReconnect on it, respectively:</p><center>\n<img alt=\"Two original ducts\" src=\"img/two_ducts_original.png\"/>\n</center><p>As said, CmdDisconnect just moves the connector of the selected duct, breaking its link to the neighbouring fitting:</p><center>\n<img alt=\"CmdDisconnect result\" src=\"img/two_ducts_disconnect.png\"/>\n</center><p>CmdReconnect moves the fitting instead, retaining its links to both neighbouring ducts:</p><center>\n<img alt=\"CmdReconnect result\" src=\"img/two_ducts_reconnect.png\"/>\n</center><p>Now let's look at how that is implemented, and the similarities and differences between the two approaches.</p><a name=\"4\"></a>"
  },
  {
    "original_filename": "1037_move_duct_join",
    "header_text": "CmdDisconnect – Move the Connector",
    "local_header_href": "#cmddisconnect-move-the-connector",
    "chunk_text": "<h4>CmdDisconnect – Move the Connector</h4><p>The differences between the two commands are very small, so most of the code is duplicated, I'm afraid.</p><p>CmdDisconnect implements the following steps:</p><ul>\n<li>Prompt user to pick duct close to the source connector to be moved.</li>\n<li>Prompt user to pick target point on duct to move it to.</li>\n<li>Determine the connector object closest to first point.</li>\n<li>Project the second point onto the duct centre line.</li>\n<li>Move the connector to the projected target point.</li>\n</ul><p>The first four items are reused unchanged for the other command as well.</p><p>Only the last item does any real work and thus requires a transaction:</p><pre class=\"code\">\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n<span class=\"gray\">///</span><span class=\"green\"> External command to move a duct connector </span>\n<span class=\"gray\">///</span><span class=\"green\"> away from its original position along the</span>\n<span class=\"gray\">///</span><span class=\"green\"> duct centre line, disconnecting from the</span>\n<span class=\"gray\">///</span><span class=\"green\"> neighbour element.</span>\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">CmdDisconnect</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">UIApplication</span> uiapp = commandData.Application;\n    <span class=\"teal\">UIDocument</span> uidoc = uiapp.ActiveUIDocument;\n    <span class=\"teal\">Document</span> doc = uidoc.Document;\n    <span class=\"teal\">Selection</span> sel = uidoc.Selection;\n    <span class=\"teal\">Duct</span> duct = <span class=\"blue\">null</span>;\n    <span class=\"teal\">XYZ</span> pFrom = <span class=\"blue\">null</span>;\n    <span class=\"teal\">XYZ</span> pTo = <span class=\"blue\">null</span>;\n \n    <span class=\"blue\">try</span>\n    {\n      <span class=\"teal\">Reference</span> r = sel.PickObject(\n        <span class=\"teal\">ObjectType</span>.Element,\n        <span class=\"blue\">new</span> <span class=\"teal\">DuctSelectionFilter</span>(),\n        <span class=\"maroon\">\"Please pick a duct at the \"</span>\n        + <span class=\"maroon\">\"connection to move.\"</span> );\n \n      duct = doc.GetElement( r.ElementId ) <span class=\"blue\">as</span> <span class=\"teal\">Duct</span>;\n      pFrom = r.GlobalPoint;\n \n      r = sel.PickObject(\n        <span class=\"teal\">ObjectType</span>.Element,\n        <span class=\"blue\">new</span> <span class=\"teal\">DuctSelectionFilter</span>(),\n        <span class=\"maroon\">\"Please pick a target point on the \"</span>\n        + <span class=\"maroon\">\"duct to move the connection to.\"</span> );\n \n      pTo = r.GlobalPoint;\n    }\n    <span class=\"blue\">catch</span>( Autodesk.Revit.Exceptions\n      .<span class=\"teal\">OperationCanceledException</span> )\n    {\n      <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Cancelled;\n    }\n \n    <span class=\"green\">// Determine connector closest to picked point</span>\n \n    <span class=\"teal\">ConnectorSet</span> connectors\n      = duct.ConnectorManager.Connectors;\n \n    <span class=\"teal\">Connector</span> con = <span class=\"blue\">null</span>;\n    <span class=\"blue\">double</span> d, dmin = <span class=\"blue\">double</span>.MaxValue;\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> connectors )\n    {\n      d = pFrom.DistanceTo( c.Origin );\n \n      <span class=\"blue\">if</span>( d &lt; dmin )\n      {\n        dmin = d;\n        con = c;\n      }\n    }\n \n    <span class=\"green\">// Determine target point to move it to</span>\n \n    <span class=\"teal\">Transform</span> cs = con.CoordinateSystem;\n \n    <span class=\"teal\">Debug</span>.Assert(\n      con.Origin.IsAlmostEqualTo( cs.Origin ),\n      <span class=\"maroon\">\"expected same origin\"</span> );\n \n    <span class=\"teal\">Line</span> line = <span class=\"teal\">Line</span>.CreateUnbound( cs.Origin, cs.BasisZ );\n \n    <span class=\"teal\">IntersectionResult</span> ir = line.Project( pTo );\n \n    pTo = ir.XYZPoint;\n \n    <span class=\"teal\">Debug</span>.Assert( line.Distance( pTo ) &lt; 1e-9,\n      <span class=\"maroon\">\"expected projected point on line\"</span> );\n \n    <span class=\"green\">// Modify document within a transaction</span>\n \n    <span class=\"blue\">using</span>( <span class=\"teal\">Transaction</span> tx = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc ) )\n    {\n      tx.Start( <span class=\"maroon\">\"Move Duct Connector\"</span> );\n      con.Origin = pTo;\n      tx.Commit();\n    }\n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre><a name=\"5\"></a>"
  },
  {
    "original_filename": "1037_move_duct_join",
    "header_text": "CmdReconnect – Move the Fitting",
    "local_header_href": "#cmdreconnect-move-the-fitting",
    "chunk_text": "<h4>CmdReconnect – Move the Fitting</h4><p>CmdReconnect implements the following steps, which include the first four from above unchanged:</p><ul>\n<li>Prompt user to pick duct close to the source connector to be moved.</li>\n<li>Prompt user to pick target point on duct to move it to.</li>\n<li>Determine the connector object closest to first point.</li>\n<li>Project the second point onto the duct centre line.</li>\n<li>Determine translation vector from the source to the projected target point.</li>\n<li>Determine the neighbouring fitting.</li>\n<li>Move the fitting to the projected target point.</li>\n</ul><p>We access the neighbouring fitting by first retrieving one of its connectors, which is connected to the duct one closest to the first picked point.\nThe fitting element itself is then provided by the Connector.Owner property.</p><p>This is achieved using the GetConnectedConnector method adapted from the TraversalTree.cs module of the TraverseSystem SDK sample:</p><pre class=\"code\">\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Return the connector </span>\n  <span class=\"gray\">///</span><span class=\"green\"> connected to the one given.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">static</span> <span class=\"teal\">Connector</span> GetConnectedConnector(\n    <span class=\"teal\">Connector</span> con )\n  {\n    <span class=\"teal\">Connector</span> neighbour = <span class=\"blue\">null</span>;\n \n    <span class=\"blue\">int</span> ownerId = con.Owner.Id.IntegerValue;\n \n    <span class=\"teal\">ConnectorSet</span> refs = con.AllRefs;\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> refs )\n    {\n      <span class=\"green\">// Ignore non-End connectors and  </span>\n      <span class=\"green\">// connectors on the same element</span>\n \n      <span class=\"blue\">if</span>( c.ConnectorType == <span class=\"teal\">ConnectorType</span>.End\n        &amp;&amp; !ownerId.Equals(\n          c.Owner.Id.IntegerValue ) )\n      {\n        neighbour = c;\n        <span class=\"blue\">break</span>;\n      }\n    }\n    <span class=\"blue\">return</span> neighbour;\n  }\n</pre><p>With that in place, the rest of the command implementation looks like this:</p><pre class=\"code\">\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n<span class=\"gray\">///</span><span class=\"green\"> External command to move a duct connector </span>\n<span class=\"gray\">///</span><span class=\"green\"> away from its original position along the</span>\n<span class=\"gray\">///</span><span class=\"green\"> duct centre line, disconnecting from the</span>\n<span class=\"gray\">///</span><span class=\"green\"> neighbour element.</span>\n<span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">CmdReconnect</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">UIApplication</span> uiapp = commandData.Application;\n    <span class=\"teal\">UIDocument</span> uidoc = uiapp.ActiveUIDocument;\n    <span class=\"teal\">Document</span> doc = uidoc.Document;\n    <span class=\"teal\">Selection</span> sel = uidoc.Selection;\n    <span class=\"teal\">Duct</span> duct = <span class=\"blue\">null</span>;\n    <span class=\"teal\">XYZ</span> pFrom = <span class=\"blue\">null</span>;\n    <span class=\"teal\">XYZ</span> pTo = <span class=\"blue\">null</span>;\n \n    <span class=\"blue\">try</span>\n    {\n      <span class=\"teal\">Reference</span> r = sel.PickObject(\n        <span class=\"teal\">ObjectType</span>.Element,\n        <span class=\"blue\">new</span> <span class=\"teal\">DuctSelectionFilter</span>(),\n        <span class=\"maroon\">\"Please pick a duct at the \"</span>\n        + <span class=\"maroon\">\"connection to move.\"</span> );\n \n      duct = doc.GetElement( r.ElementId ) <span class=\"blue\">as</span> <span class=\"teal\">Duct</span>;\n      pFrom = r.GlobalPoint;\n \n      r = sel.PickObject(\n        <span class=\"teal\">ObjectType</span>.Element,\n        <span class=\"blue\">new</span> <span class=\"teal\">DuctSelectionFilter</span>(),\n        <span class=\"maroon\">\"Please pick a target point on the \"</span>\n        + <span class=\"maroon\">\"duct to move the connection to.\"</span> );\n \n      pTo = r.GlobalPoint;\n    }\n    <span class=\"blue\">catch</span>( Autodesk.Revit.Exceptions\n      .<span class=\"teal\">OperationCanceledException</span> )\n    {\n      <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Cancelled;\n    }\n \n    <span class=\"green\">// Determine connector closest to picked point</span>\n \n    <span class=\"teal\">ConnectorSet</span> connectors\n      = duct.ConnectorManager.Connectors;\n \n    <span class=\"teal\">Connector</span> con = <span class=\"blue\">null</span>;\n    <span class=\"blue\">double</span> d, dmin = <span class=\"blue\">double</span>.MaxValue;\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">Connector</span> c <span class=\"blue\">in</span> connectors )\n    {\n      d = pFrom.DistanceTo( c.Origin );\n \n      <span class=\"blue\">if</span>( d &lt; dmin )\n      {\n        dmin = d;\n        con = c;\n      }\n    }\n \n    <span class=\"green\">// Determine target point to move it to</span>\n \n    <span class=\"teal\">Transform</span> cs = con.CoordinateSystem;\n \n    <span class=\"teal\">Debug</span>.Assert(\n      con.Origin.IsAlmostEqualTo( cs.Origin ),\n      <span class=\"maroon\">\"expected same origin\"</span> );\n \n    <span class=\"teal\">Line</span> line = <span class=\"teal\">Line</span>.CreateUnbound( cs.Origin, cs.BasisZ );\n \n    <span class=\"teal\">IntersectionResult</span> ir = line.Project( pTo );\n \n    pTo = ir.XYZPoint;\n \n    <span class=\"teal\">Debug</span>.Assert( line.Distance( pTo ) &lt; 1e-9,\n      <span class=\"maroon\">\"expected projected point on line\"</span> );\n \n    <span class=\"green\">// Determine translation vector</span>\n \n    <span class=\"teal\">XYZ</span> v = pTo - pFrom;\n \n    <span class=\"green\">// Determine neighbouring fitting connector</span>\n \n    <span class=\"teal\">Connector</span> neighbour\n      = GetConnectedConnector( con );\n \n    <span class=\"green\">// Modify document within a transaction</span>\n \n    <span class=\"blue\">using</span>( <span class=\"teal\">Transaction</span> tx = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc ) )\n    {\n      tx.Start( <span class=\"maroon\">\"Move Fitting\"</span> );\n \n      <span class=\"teal\">ElementTransformUtils</span>.MoveElement(\n        doc, neighbour.Owner.Id, v );\n \n      tx.Commit();\n    }\n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre><p>Note the similarities and differences between the two commands, and their different effects.</p><a name=\"6\"></a>"
  },
  {
    "original_filename": "1037_move_duct_join",
    "header_text": "The MoveDuctJoin GitHub Repository",
    "local_header_href": "#the-moveductjoin-github-repository",
    "chunk_text": "<h4>The MoveDuctJoin GitHub Repository</h4><p>At this point, I would normally be attaching the complete project including source code, Visual Studio solution and add-in manifest as an archive file.</p><p>For the first time, however, I am doing the right thing instead, which means creating a GitHub repository for it and not forgetting to attach a\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2013/10/the-building-coder-samples-on-github.html#2\">\nlicense</a>.</p><p>Here are the steps I performed to create and properly populate the MoveDuctJoin GitHub repository:</p><ol>\n<li>Create a new repository on\n\n<a href=\"https://github.com\">GitHub</a> and\n\ninitialise it with a readme, license and C# .gitignore file.</li>\n<li><a href=\"http://gitref.org/creating/#clone\">Clone</a> it to the local system:\n<pre>\ngit clone repository_url\n</pre>\n</li>\n<li><a href=\"http://gitref.org/basic/#add\">Add</a> all the add-in source files to it:\n<pre>\ngit add .\n</pre>\n</li>\n<li><a href=\"http://gitref.org/basic/#commit\">Commit</a> the changes, optionally preconfiguring your user name and email address:\n<pre>\ngit commit\n</pre>\n</li>\n<li><a href=\"http://gitref.org/basic/#push\">Push</a> the changes back to the server:\n<pre>\n/v/C/a/vs/MoveDuctJoin/ $ git push\nUsername for 'https://github.com': jeremytammik\nPassword for 'https://jeremytammik@github.com':\nCounting objects: 13, done.\nDelta compression using up to 8 threads.\nCompressing objects: 100% (10/10), done.\nWriting objects: 100% (11/11), 5.26 KiB, done.\nTotal 11 (delta 0), reused 0 (delta 0)\nTo https://github.com/jeremytammik/MoveDuctJoin\n   944fbf8..7eb010f  master -&gt; master\n</pre>\n</li>\n</ol><p>There you are.\nYou now have the\n\n<a href=\"https://github.com/jeremytammik/MoveDuctJoin\">MoveDuctJoin</a> repository,\n\nincluding the direct link to download the\n\n<a href=\"https://github.com/jeremytammik/MoveDuctJoin/archive/master.zip\">\nlatest version</a>.</p><p>Keeping in mind our future generations, as discussed yesterday on\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2013/10/the-building-coder-samples-on-github.html#4\">\nbranching and tagging</a>,\n\nI also created an official first Revit 2014 release of it,\n\n<a href=\"https://github.com/jeremytammik/MoveDuctJoin/archive/2014.0.0.0.zip\">version 2014.0.0.0</a>,\n\nin case somebody wants to retrieve that specific release sometime later on.</p>"
  }
]