[
  {
    "original_filename": "0174_journal_file_replay",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<style>\n.blue { color: blue; }\n.teal { color: teal; }\n.maroon { color: maroon; }\n.green { color: green; }\n.gray { color: gray; }\n</style>"
  },
  {
    "original_filename": "0174_journal_file_replay",
    "header_text": "Journal File Replay",
    "local_header_href": "#journal-file-replay",
    "chunk_text": "<h3>Journal File Replay</h3><p>In spite of pretty mixed weather I went on a climb in the alps with my friend Robert on Saturday, the route \n\n<a href=\"http://www.bergtour.ch/tourenfuehrer/routen/id/943\">\nKurze Kombination</a>\n\n(4c) on the mountain \n\n<a href=\"http://www.bergtour.ch/tourenfuehrer/bilder/id/1047\">\nSchmalstöckli</a> \n\n(2012 m) close to the Lidernenen Hütte.</p><center>\n<img alt=\"Schmalstöckli mountain\" src=\"img/schmalstoeckli.jpg\"/>\n</center><p>Here I am after the climb, just below the summit:</p><center>\n<img alt=\"Jeremy near Schmalstöckli summit\" src=\"img/jeremy_near_schmalstoeckli_summit.jpg\"/>\n</center><p>And this is Robert on the summit itself:</p><center>\n<img alt=\"Robert on Schmalstöckli summit\" src=\"img/robert_on_schmalstoeckli_summit.jpg\"/>\n</center><p>We would made another climb on the same mountain if the weather had not been pretty grey and moist.\nAnyway, now it is Monday morning, and I am back again to Revit programming.</p><p>We mentioned the Revit journal file repeatedly in previous posts, but a basic introduction to this topic was still missing.\nThere is a good reason for this, because Autodesk does not provide any official support for the usage of journal files as a means of automating a portion of the design or production process. \nThe only official support for journal files is as a replay mechanism for testing or reporting issues.\nOne can make use of the journaling mechanism totally at one's own risk, and there will almost certainly be changes, incompatibilities between versions, and other problems.</p><p>The testing and reporting mechanism provided by the journaling mechanism is fully accessible to Revit add-ins as well.\nThis access is demonstrated by the Revit SDK Journaling sample. \nAnyone interested in making use of journaling for any purpose whatsoever should have a good look at this sample in order to understand the mechanism in more depth.</p><p>Being unsupported, the journaling mechanism should be used only as a last resort.\n\nOne example of a preferable approach for some tasks is to \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/07/prompt-the-user-for-pinning-and-ifc-export.html\">\nprompt the user</a> \n\ninstead.</p><p>Still, with some imagination and due to the lack of automation support for \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2008/12/driving-revit-from-outside.html\">\ndriving Revit from outside</a>\n\nor \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/05/vb-samples-and-other-questions.html#1\">\ninvoking Revit commands</a> \n\nsuch as the IFC export programmatically, it does sometimes offer interesting possibilities.</p><p>All the uses mentioned above are related to driving Revit by replaying an existing or an automatically generated journal file.\nAnother way of using the journal file is to read out its contents dynamically during an on-going session to find out what is going on. \nI mentioned an idea to \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/volume-computation-enable.html?cid=6a00e553e1689788330115708fd987970c#comment-6a00e553e1689788330115708fd987970c\">\ndetermine the last Revit command</a>\n\nfrom it, and Greg Wesner discussed \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/02/getting-the-journal-file-path.html\">\ngetting the journal file path</a>\n\nfor other monitoring purposes.</p><p>Here are some recent questions on this topic, one of which lead to me finally putting together an example and proving to myself that a journal file can be used pretty reliably to drive a completely encapsulated sequence of commands, including Revit start up and shutdown. But first, let us look at a negative result.</p><p><strong>Question:</strong>\nIs it possible to play back a Revit journal file while Revit is already running and a document is already opened?\n\n<p><strong>Answer:</strong>\nSorry, I am not aware of any way to play back a journal file in the middle of a running session, with an opened document. \nThe only way I know of using journal files for programmatic purposes is to include the entire sequence of starting up Revit, opening the document, executing the desired action, and closing down Revit again within the journal file execution. \nYou may possibly omit the closing down part, in which case Revit will be left open, if you are willing to give up control to the user at that point.</p>\n<p>Here is the question that led me to test running Revit from a journal file and including steps in it which provide me API access for additional control during the replay process:</p>\n<p><strong>Question:</strong>\nIs it possible to use the Revit API to create a new family within the OnStartup method of an external application?</p>\n<p><strong>Answer:</strong>\nThe argument provided to OnStartup is a ControlledApplication instance. \nThis object provides methods to manipulate the ribbon, access the shared parameters file, access some application level properties and set up application level event handler.</p>\n<p>It does not include access to the documents. \nThat access is provided by the Documents collection on the Application class, which is provided as an argument to external commands, which are only active after OnStartup has completed and a document has been opened.</p>\n<p>If you wish to start up Revit and immediately create a new family document, you can do so once manually and save the journal file that is generated by this interaction. \nThe journal file can then later be used to restart Revit and re-execute this process.</p>\n<p>If you wish to continue working programmatically with the new family document, you can set up an event handler for the DocumentCreated or DocumentOpened notification.</p>\n<p>Some notes on external applications and document event handling are provided by the blog entries:</p>\n<ul>\n<li><a href=\"http://thebuildingcoder.typepad.com/blog/2009/05/vb-samples-and-other-questions.html#3\">External application OnStartup implementation in VB</a>.</li>\n<li><a href=\"http://thebuildingcoder.typepad.com/blog/2009/01/barcelona-questions.html\">External application implementing automatic synchronisation using document save and close events</a>.</li>\n<li><a href=\"http://thebuildingcoder.typepad.com/blog/2009/04/new-2010-events.html\">Transactions and document modification in a DocumentOpened event handler</a>.</li>\n<li><a href=\"http://thebuildingcoder.typepad.com/blog/2009/05/document-modification-in-an-event.html\">Document modification in the DocumentClosing event handler</a>.</li>\n<li><a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/autoconfirm-save-using-dialogboxshowing-event.html\">Programmatic handling of dialogue box events</a>.</li>\n</ul>\n<p>Following this suggestion to implement an external application reacting to an event to programmatically process a newly created family file created by driving Revit from a journal file led to the following new question:</p>\n<p><strong>Question:</strong>\nI have created a journal file that opens a family document on Revit start up.\nHowever, it issues an error when calling my external application's OnStartup method saying \"The journal file could not be run to completion.\"</p>\n<p><strong>Answer:</strong>\n\nI cannot reproduce the problem you describe.\nIn my experience, the message that the journal file could not run to completion is due to other problems. \nI do not believe it is caused by the event handler registration.\nTo test this, I implemented a new external application AutoExecuteOnOpen which does what you say, registering event handlers for the DocumentCreated and DocumentOpened events in the OnStartup method. \nBoth of these simply print a message to the Visual Studio debug output window:</p>\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"teal\">IExternalApplication</span>.<span class=\"teal\">Result</span> OnStartup(\n  <span class=\"teal\">ControlledApplication</span> a )\n{\n  a.DocumentCreated \n    += <span class=\"blue\">new</span> <span class=\"teal\">EventHandler</span>&lt;<span class=\"teal\">DocumentCreatedEventArgs</span>&gt;( \n      a_DocumentCreated );\n \n  a.DocumentOpened \n    += <span class=\"blue\">new</span> <span class=\"teal\">EventHandler</span>&lt;<span class=\"teal\">DocumentOpenedEventArgs</span>&gt;( \n      a_DocumentOpened );\n \n  <span class=\"blue\">return</span> <span class=\"teal\">IExternalApplication</span>.<span class=\"teal\">Result</span>.Succeeded;\n}\n \n<span class=\"blue\">public</span> <span class=\"teal\">IExternalApplication</span>.<span class=\"teal\">Result</span> OnShutdown(\n  <span class=\"teal\">ControlledApplication</span> a )\n{\n  a.DocumentCreated\n    -= <span class=\"blue\">new</span> <span class=\"teal\">EventHandler</span>&lt;<span class=\"teal\">DocumentCreatedEventArgs</span>&gt;(\n      a_DocumentCreated );\n \n  a.DocumentOpened\n    -= <span class=\"blue\">new</span> <span class=\"teal\">EventHandler</span>&lt;<span class=\"teal\">DocumentOpenedEventArgs</span>&gt;(\n      a_DocumentOpened );\n \n  <span class=\"blue\">return</span> <span class=\"teal\">IExternalApplication</span>.<span class=\"teal\">Result</span>.Succeeded;\n}\n \n<span class=\"blue\">void</span> a_DocumentCreated( <span class=\"blue\">object</span> sender, Autodesk.Revit.Events.<span class=\"teal\">DocumentCreatedEventArgs</span> e )\n{\n  <span class=\"teal\">Debug</span>.Print( <span class=\"maroon\">\"DocumentCreated\"</span> );\n}\n \n<span class=\"blue\">void</span> a_DocumentOpened( <span class=\"blue\">object</span> sender, <span class=\"teal\">DocumentOpenedEventArgs</span> e )\n{\n  <span class=\"teal\">Debug</span>.Print( <span class=\"maroon\">\"DocumentOpened\"</span> );\n}\n</pre>\n<p>I registered this external application in Revit.ini.</p>\n<p>I then ran through the following sequence and saved the resulting journal file:</p>\n<ul>\n<li>Start up Revit.\n<li>Open a family document.\n<li>Close the family document.\n<li>Shut down Revit.\n</li></li></li></li></ul>\n<p>These steps resulted in a new journal file:</p>\n<pre>\nC:\\Program Files\\Autodesk Revit Architecture 2010\\Journals\\journal.0180.txt\n</pre>\n<p>I saved this journal file for replay and had no problem rerunning it. \nIt executes all the following expected steps without problems:</p>\n<ul>\n<li>Start up Revit.\n<li>Load the external application.\n<li>Open a family document.\n<li>Fire the DocumentOpened event.\n<li>Print the message.\n<li>Close the family document.\n<li>Shut down Revit.\n</li></li></li></li></li></li></li></ul>\n<p>In the first attempt at implementing my external application event handlers, I displayed a message box.\nThis did not work, at least not when run from the debugger, because clicking OK in the message box had no effect, so the journal file execution was blocked at that point. \nReplacing the message box by a simple Debug.Print statement solved that problem. \nThis shows that the entire execution process is very sensitive and picky, though.</p>\n<p>Here is a copy of my \n\n<a href=\"zip/journal_file.txt\">\njournal file</a>, \n\nand here the entire Visual Studio solution \n\n<a href=\"zip/AutoExecuteOnOpen.zip\">\nAutoExecuteOnOpen</a>.</p>\n</p>"
  }
]