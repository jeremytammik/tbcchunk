[
  {
    "original_filename": "0735_demo_mode",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0735_demo_mode",
    "header_text": "Determine Revit Demo Mode",
    "local_header_href": "#determine-revit-demo-mode",
    "chunk_text": "<h3>Determine Revit Demo Mode</h3><p>Here is yet another interesting example of an apparent gap in the Revit API that can be easily filled using a little workaround.\n\n<p>We have seen numerous examples of performing a certain operation within a temporary transaction that is then rolled back to cancel it, such as to determine gross \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/02/material-quantity-extraction.html\">\nmaterial quantities</a> for\n\nan element with openings, a\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/host-reference.html\">\nhost reference</a> and, \n\nmore generally, all\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/03/object-relationships.html\">\nobject relationships</a>.\n\n<p>Here is an example of using a related but different approach: the trick consists in attempting to perform a certain operation and gracefully handling a specific expected failure condition, in ths case a specific exception being thrown, to determine whether Revit is running in demo mode:\n\n<p><strong>Question:</strong> Is it possible to determine whether Revit runs in demo mode? \nI need this for two different reasons:\n\n<ul>\n<li>It is a licensing issue, since read-only viewing should not occupy a license.\n<li>Some add-in commands should be greyed out or hidden in the ribbon bar in demo mode.\n</li></li></ul>\n<p><strong>Answer:</strong> You could try to save the model (after making a modification!) and then see if you get an InvalidLicenseException.\n\n<p>I implemented a little sample application TestDemoMode to test a simplified version of this idea.\n\n<p>Here is the test method I created:\n\n<pre class=\"code\">\n  <span class=\"blue\">static</span> <span class=\"blue\">bool</span> IsDemoMode( <span class=\"teal\">Document</span> doc )\n  {\n    <span class=\"teal\">Application</span> app = doc.Application;\n \n    <span class=\"blue\">try</span>\n    {\n      <span class=\"teal\">Transaction</span> tx = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc );\n \n      tx.Start( <span class=\"maroon\">\"Modify Document\"</span> );\n \n      <span class=\"teal\">SketchPlane</span> sp \n        = <span class=\"blue\">new</span> <span class=\"teal\">FilteredElementCollector</span>( doc )\n          .OfClass( <span class=\"blue\">typeof</span>( <span class=\"teal\">SketchPlane</span> ) )\n          .FirstElement() <span class=\"blue\">as</span> <span class=\"teal\">SketchPlane</span>;\n \n      <span class=\"teal\">Line</span> line = app.Create.NewLineBound( \n        <span class=\"teal\">XYZ</span>.Zero, <span class=\"teal\">XYZ</span>.BasisX );\n \n      <span class=\"teal\">ModelCurve</span> mc = doc.Create.NewModelCurve(\n        line, sp );\n \n      tx.Commit();\n \n      <span class=\"blue\">string</span> filename = <span class=\"teal\">Path</span>.GetTempFileName();\n      <span class=\"teal\">File</span>.Delete( filename );\n \n      doc.SaveAs( filename );\n      <span class=\"teal\">File</span>.Delete( filename );\n \n      tx.Start( <span class=\"maroon\">\"Unmodify Document\"</span> );\n      doc.Delete( mc );\n      tx.Commit();\n \n      <span class=\"blue\">return</span> <span class=\"blue\">false</span>;\n    }\n    <span class=\"blue\">catch</span>( <span class=\"teal\">InvalidLicenseException</span> ex )\n    {\n      <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n    }\n  }\n</pre>\n<p>This is the external command Execute mainline code:\n\n<pre class=\"code\">\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">UIApplication</span> uiapp = commandData.Application;\n    <span class=\"teal\">UIDocument</span> uidoc = uiapp.ActiveUIDocument;\n    <span class=\"teal\">Document</span> doc = uidoc.Document;\n \n    <span class=\"blue\">bool</span> rc = IsDemoMode( doc );\n \n    <span class=\"blue\">string</span> s = <span class=\"blue\">string</span>.Format( \n      <span class=\"maroon\">\"This is {0}a Revit demo version.\"</span>, \n      rc ? <span class=\"maroon\">\"\"</span> : <span class=\"maroon\">\"not \"</span> );\n \n    <span class=\"teal\">TaskDialog</span>.Show( <span class=\"maroon\">\"Test Demo Mode\"</span>, s );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n</pre>\n<p>I have not tested it for both cases, though, since I do not have a demo version handy.\n\n<p>I did run it in a non-demo version, which was correctly reported:\n\n<center>\n<img alt=\"Not a demo version\" src=\"img/not_demo_version.png\"/>\n</center>\n<p>I have also not added any checks to determine whether the write and save attempt may be failing due to the document being read-only, disk full, or anything like that.\n\n<p>A much better approach would be to create a new document from scratch and attempt to save that.\n\n<p>Anyway, here is \n\n<a href=\"zip/TestDemoMode.zip\">\nTestDemoMode.zip</a> including \n\nthe source code, add-in manifest and full Visual Studio solution of the simplified test command.\n\n<p>A full-blown implementation requires a number of additional considerations and lots of testing, of course.\nAs said, the '1 new document' - '2 edit document' - '3 save as' strategy might be best. \nHopefully all exceptions thrown during the first two steps will have to do with the licensing.\nStep three is less certain, since for instance the hard drive may be full.\n\n<p>Saving the current document is a really bad idea and might take a long time, without even thinking about detaching from central and keeping work-shares.\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  }
]