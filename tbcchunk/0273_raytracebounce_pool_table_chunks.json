[
  {
    "original_filename": "0273_raytracebounce_pool_table",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0273_raytracebounce_pool_table",
    "header_text": "RayTraceBounce Pool Table",
    "local_header_href": "#raytracebounce-pool-table",
    "chunk_text": "<h3>RayTraceBounce Pool Table</h3><p>In spite of yesterday's promise to stop, here is yet one more last minute  Christmas present from Harry Matttison of the Revit API development team.\nIn Harry's own words: \"Here is a modification to make the ray shooting SDK example RayTraceBounce a bit more fun ... it works and can amuse a 6 year old, if nothing else.\"\n\n<p>Harry's sample uses the ray tracing capabilities of the FindReferencesByDirection method to simulate a pool table.\nThe model defines the table, six pockets, and a cue.\nThe cue can be positioned in any way you like.\nOnce positioned, you launch the RaytraceBouncePool command to calculate the walls that the ball will encounter if leaving the cue in a straight line and the reflections off them until it hits a pocket.\nThe number of total reflections required is counted and reported.\nHere is a shot with four reflections:</p>\n<center>\n<img alt=\"Pool table simulation in Revit\" src=\"img/pool_table_1.png\"/>\n</center>\n<p>Here is another one with just two:</p>\n<center>\n<img alt=\"Pool table simulation in Revit\" src=\"img/pool_table_2.png\"/>\n</center>\n<p>The command makes use of a couple of handy utility methods:\n\n<ul>\n<li>Get3DView returns the view named \"{3D}\" in the current document.\n<li>DeleteLines deletes the lines from the previous run.\n<li>MakeLine creates a model line with the given start point, end point, and line style.\n</li></li></li></ul>\n<p>Here is the source code of the entire external command and its utility methods, which Harry placed in the namespace RayTraceBounce:\n\n<pre class=\"code\">\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">RaytraceBouncePool</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"green\">// have a line style \"bounce\" created in the </span>\n  <span class=\"green\">// document before running this</span>\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Maximum number of bounces to calculate.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">const</span> <span class=\"blue\">int</span> _max_bounces = 100;\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Message box caption.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">const</span> <span class=\"blue\">string</span> _caption = <span class=\"maroon\">\"RayTraceBounce Pool Table\"</span>;\n \n  <span class=\"teal\">ExternalCommandData</span> cdata;\n  <span class=\"teal\">Application</span> app;\n  <span class=\"teal\">Document</span> doc;\n  <span class=\"teal\">Face</span> face = <span class=\"blue\">null</span>;\n  <span class=\"teal\">Reference</span> rClosest = <span class=\"blue\">null</span>;\n  <span class=\"teal\">View3D</span> view = <span class=\"blue\">null</span>;\n  <span class=\"blue\">static</span> <span class=\"blue\">double</span> epsilon = 0.00000001;\n  <span class=\"blue\">int</span> LineCount = 0;\n  <span class=\"blue\">int</span> RayCount = 0;\n \n  <span class=\"blue\">public</span> <span class=\"teal\">IExternalCommand</span>.<span class=\"teal\">Result</span> Execute( \n    <span class=\"teal\">ExternalCommandData</span> commandData, \n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message, \n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    cdata = commandData;\n    app = commandData.Application;\n    doc = app.ActiveDocument;\n    Get3DView();\n    DeleteLines();\n \n    <span class=\"green\">// find the cue</span>\n \n    <span class=\"teal\">XYZ</span> direction = <span class=\"blue\">null</span>;\n    <span class=\"teal\">XYZ</span> startpt = <span class=\"blue\">null</span>;\n \n    <span class=\"teal\">List</span>&lt;Autodesk.Revit.<span class=\"teal\">Element</span>&gt; list \n      = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;Autodesk.Revit.<span class=\"teal\">Element</span>&gt;();\n \n    <span class=\"teal\">Filter</span> filter = app.Create.Filter\n      .NewTypeFilter( <span class=\"blue\">typeof</span>( <span class=\"teal\">FamilyInstance</span> ) );\n \n    <span class=\"blue\">int</span> num = app.ActiveDocument.get_Elements( \n      filter, list );\n \n    <span class=\"blue\">foreach</span>( Autodesk.Revit.<span class=\"teal\">Element</span> e <span class=\"blue\">in</span> list )\n    {\n      <span class=\"blue\">if</span>( e.Name == <span class=\"maroon\">\"cue\"</span> )\n      {\n        <span class=\"teal\">LocationCurve</span> lc = e.Location \n          <span class=\"blue\">as</span> <span class=\"teal\">LocationCurve</span>;\n \n        direction = lc.Curve.ComputeDerivatives( \n          0, <span class=\"blue\">true</span> ).BasisX;\n \n        startpt = lc.Curve.get_EndPoint( 1 );\n \n        <span class=\"blue\">break</span>;\n      }\n    }\n    <span class=\"blue\">if</span>( <span class=\"blue\">null</span> == view )\n    {\n      <span class=\"teal\">MessageBox</span>.Show( <span class=\"maroon\">\"A default 3D view (named {3D}) \"</span>\n        + <span class=\"maroon\">\" must exist before running this command\"</span>,\n        _caption );\n    }\n    <span class=\"blue\">else</span>\n    {\n      <span class=\"blue\">for</span>( <span class=\"blue\">int</span> ctr = 1; ctr &lt;= _max_bounces; ++ctr )\n      {\n        <span class=\"teal\">ReferenceArray</span> references \n          = doc.FindReferencesByDirection( \n            startpt, direction, view );\n \n        rClosest = <span class=\"blue\">null</span>;\n        FindClosestReference( references );\n \n        <span class=\"blue\">if</span>( rClosest == <span class=\"blue\">null</span> )\n        {\n          <span class=\"teal\">MessageBox</span>.Show( <span class=\"maroon\">\"Ray \"</span> + ctr + <span class=\"maroon\">\" aborted. \"</span>\n            + <span class=\"maroon\">\"No closest face reference found.\"</span>,\n            _caption );\n \n          <span class=\"blue\">return</span> <span class=\"teal\">IExternalCommand</span>.<span class=\"teal\">Result</span>.Succeeded;\n        }\n        <span class=\"blue\">else</span>\n        {\n          <span class=\"teal\">XYZ</span> endpt = <span class=\"blue\">new</span> <span class=\"teal\">XYZ</span>( \n            rClosest.GlobalPoint.X, \n            rClosest.GlobalPoint.Y, \n            rClosest.GlobalPoint.Z );\n \n          <span class=\"blue\">if</span>( startpt.AlmostEqual( endpt ) )\n          {\n            <span class=\"teal\">MessageBox</span>.Show( \n              <span class=\"maroon\">\"Start and end points are equal. Ray \"</span> \n              + ctr + <span class=\"maroon\">\" aborted\\n\"</span> \n              + startpt.X + <span class=\"maroon\">\", \"</span> \n              + startpt.Y + <span class=\"maroon\">\", \"</span> \n              + startpt.Z,\n              _caption );\n \n            <span class=\"blue\">break</span>;\n          }\n          <span class=\"blue\">else</span>\n          {\n            MakeLine( startpt, endpt, direction, <span class=\"maroon\">\"bounce\"</span> );\n            RayCount = RayCount + 1;\n            face = rClosest.GeometryObject <span class=\"blue\">as</span> <span class=\"teal\">Face</span>;\n            <span class=\"blue\">if</span>( rClosest.Element.Category.Name == <span class=\"maroon\">\"Doors\"</span> )\n            {\n              <span class=\"teal\">MessageBox</span>.Show( <span class=\"maroon\">\"You sank the ball with \"</span> \n                + ctr + <span class=\"maroon\">\" shots.\"</span>, _caption );\n \n              <span class=\"blue\">return</span> <span class=\"teal\">IExternalCommand</span>.<span class=\"teal\">Result</span>.Succeeded;\n            }\n            <span class=\"teal\">UV</span> endptUV = rClosest.UVPoint;\n \n            <span class=\"green\">// face normal where ray hits</span>\n \n            <span class=\"teal\">XYZ</span> faceNormal = face.ComputeDerivatives( \n              endptUV ).BasisZ;\n \n            <span class=\"green\">// transformation to get it in terms of </span>\n            <span class=\"green\">// document coordinates instead of the </span>\n            <span class=\"green\">// parent symbol</span>\n \n            faceNormal = rClosest.Transform.OfVector( \n              faceNormal );\n \n            <span class=\"green\">// http://www.fvastro.org/presentations/ray_tracing.htm</span>\n \n            <span class=\"teal\">XYZ</span> directionMirrored = direction \n              - 2 * direction.Dot( faceNormal ) * faceNormal;\n \n            <span class=\"green\">// get ready to shoot the next ray</span>\n \n            direction = directionMirrored; \n \n            startpt = endpt;\n          }\n        }\n      }\n    }\n    <span class=\"blue\">return</span> <span class=\"teal\">IExternalCommand</span>.<span class=\"teal\">Result</span>.Succeeded;\n  }\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Find closest reference.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;param name=\"references\"&gt;</span><span class=\"green\">Input array of references</span><span class=\"gray\">&lt;/param&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;returns&gt;&lt;/returns&gt;</span>\n  <span class=\"blue\">public</span> <span class=\"teal\">Reference</span> FindClosestReference( \n    <span class=\"teal\">ReferenceArray</span> references )\n  {\n    <span class=\"blue\">double</span> face_prox = <span class=\"teal\">Double</span>.PositiveInfinity;\n    <span class=\"blue\">double</span> edge_prox = <span class=\"teal\">Double</span>.PositiveInfinity;\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">Reference</span> r <span class=\"blue\">in</span> references )\n    {\n      <span class=\"blue\">if</span>( r.Element.Category.Name != <span class=\"maroon\">\"Generic Models\"</span> )\n      {\n        face = <span class=\"blue\">null</span>;\n        face = r.GeometryObject <span class=\"blue\">as</span> <span class=\"teal\">Face</span>;\n        <span class=\"teal\">Edge</span> edge = <span class=\"blue\">null</span>;\n        edge = r.GeometryObject <span class=\"blue\">as</span> <span class=\"teal\">Edge</span>;\n        <span class=\"blue\">if</span>( face != <span class=\"blue\">null</span> )\n        {\n          <span class=\"green\">// when startpoint is on a surface, should </span>\n          <span class=\"green\">// FindReferencesByDirection find that surface?</span>\n \n          <span class=\"blue\">if</span>( <span class=\"teal\">Math</span>.Abs( r.ProximityParameter ) &lt; face_prox \n            &amp;&amp; r.ProximityParameter &gt; epsilon ) \n          {\n            rClosest = r;\n            face_prox = <span class=\"teal\">Math</span>.Abs( r.ProximityParameter );\n          }\n        }\n        <span class=\"blue\">if</span>( edge != <span class=\"blue\">null</span> )\n        {\n          <span class=\"green\">// when startpoint is on a surface, should </span>\n          <span class=\"green\">// FindReferencesByDirection find that surface?</span>\n \n          <span class=\"blue\">if</span>( <span class=\"teal\">Math</span>.Abs( r.ProximityParameter ) &lt; edge_prox \n            &amp;&amp; r.ProximityParameter &gt; epsilon ) \n          {\n            edge_prox = <span class=\"teal\">Math</span>.Abs( r.ProximityParameter );\n          }\n        }\n      }\n    }\n \n    <span class=\"green\">// stop bouncing if there is an edge at least </span>\n    <span class=\"green\">// as close as the neareast face - there is no </span>\n    <span class=\"green\">// single angle of reflection for a ray </span>\n    <span class=\"green\">// striking a line</span>\n \n    <span class=\"blue\">if</span>( edge_prox &lt;= face_prox )\n    {\n      rClosest = <span class=\"blue\">null</span>;\n    }\n    <span class=\"blue\">return</span> rClosest;\n  }\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Create a model line with the given start, end point, and line style.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;param name=\"sp\"&gt;</span><span class=\"green\">Start point</span><span class=\"gray\">&lt;/param&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;param name=\"ep\"&gt;</span><span class=\"green\">End point</span><span class=\"gray\">&lt;/param&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;param name=\"direction\"&gt;</span><span class=\"green\">Sketch plane normal vector</span><span class=\"gray\">&lt;/param&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;param name=\"style\"&gt;</span><span class=\"green\">Line style name</span><span class=\"gray\">&lt;/param&gt;</span>\n  <span class=\"blue\">public</span> <span class=\"blue\">void</span> MakeLine( \n    <span class=\"teal\">XYZ</span> sp, \n    <span class=\"teal\">XYZ</span> ep, \n    <span class=\"teal\">XYZ</span> direction, \n    <span class=\"blue\">string</span> style )\n  {\n    LineCount = LineCount + 1;\n \n    <span class=\"teal\">Line</span> line = app.Create.NewLineBound( sp, ep );\n \n    <span class=\"teal\">Plane</span> geometryPlane = app.Create.NewPlane( \n      direction, sp );\n \n    <span class=\"teal\">Document</span> doc = app.ActiveDocument;\n \n    <span class=\"teal\">SketchPlane</span> skplane = doc.Create.NewSketchPlane( \n      geometryPlane );\n \n    <span class=\"teal\">ModelCurve</span> mcurve = doc.Create.NewModelCurve( \n      line, skplane );\n \n    <span class=\"teal\">ElementArray</span> lsArr = mcurve.LineStyles;\n \n    <span class=\"blue\">foreach</span>( Autodesk.Revit.<span class=\"teal\">Element</span> e <span class=\"blue\">in</span> lsArr )\n    {\n      <span class=\"blue\">if</span>( e.Name == style )\n      {\n        mcurve.LineStyle = e;\n        <span class=\"blue\">break</span>;\n      }\n    }\n  }\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Return the view named \"{3D}\" in the current document.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">public</span> <span class=\"blue\">void</span> Get3DView()\n  {\n    <span class=\"teal\">List</span>&lt;Autodesk.Revit.<span class=\"teal\">Element</span>&gt; list \n      = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;Autodesk.Revit.<span class=\"teal\">Element</span>&gt;();\n \n    <span class=\"teal\">Filter</span> filter = app.Create.Filter.NewTypeFilter( \n      <span class=\"blue\">typeof</span>( <span class=\"teal\">View3D</span> ) );\n \n    <span class=\"teal\">Int64</span> num = app.ActiveDocument.get_Elements( \n      filter, list );\n \n    <span class=\"blue\">foreach</span>( Autodesk.Revit.<span class=\"teal\">Element</span> v <span class=\"blue\">in</span> list )\n    {\n      <span class=\"blue\">if</span>( v.Name == <span class=\"maroon\">\"{3D}\"</span> )\n      {\n        view = v <span class=\"blue\">as</span> <span class=\"teal\">View3D</span>;\n        <span class=\"blue\">break</span>;\n      }\n    }\n  }\n \n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;summary&gt;</span>\n  <span class=\"gray\">///</span><span class=\"green\"> Delete the lines from the previous run.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span><span class=\"gray\">&lt;/summary&gt;</span>\n  <span class=\"blue\">public</span> <span class=\"blue\">void</span> DeleteLines()\n  {\n    <span class=\"teal\">List</span>&lt;Autodesk.Revit.<span class=\"teal\">Element</span>&gt; list \n      = <span class=\"blue\">new</span> <span class=\"teal\">List</span>&lt;Autodesk.Revit.<span class=\"teal\">Element</span>&gt;();\n \n    <span class=\"teal\">Filter</span> filter = app.Create.Filter.NewTypeFilter( \n      <span class=\"blue\">typeof</span>( <span class=\"teal\">CurveElement</span> ), <span class=\"blue\">true</span> );\n \n    <span class=\"teal\">Int64</span> num = app.ActiveDocument.get_Elements( \n      filter, list );\n \n    <span class=\"blue\">foreach</span>( Autodesk.Revit.<span class=\"teal\">Element</span> e <span class=\"blue\">in</span> list )\n    {\n      <span class=\"teal\">ModelCurve</span> mc = e <span class=\"blue\">as</span> <span class=\"teal\">ModelCurve</span>;\n      <span class=\"blue\">if</span>( mc != <span class=\"blue\">null</span> )\n      {\n        <span class=\"blue\">if</span>( mc.LineStyle.Name == <span class=\"maroon\">\"bounce\"</span>\n          || mc.LineStyle.Name == <span class=\"maroon\">\"normal\"</span> )\n        {\n          app.ActiveDocument.Delete( e );\n        }\n      }\n    }\n  }\n}\n</pre>\n<p>I integrated this into the standard RayTraceBounce SDK sample code by adding a second external command implementation class named RaytraceBouncePool to the existing project, and the following lines to my RvtSamples.txt file that I use to load all the SDK samples:\n\n<pre>\nGeometry\nRayTraceBounce Pool Table\nSimulate a pool table.\nLargeImage: \nImage: \nC:\\...\\SDK\\Samples\\RaytraceBounce\\RayTraceBounce.dll\nRayTraceBounce.RaytraceBouncePool\n</pre>\n<p>Here is the source file \n\n<a href=\"C:\\a\\lib\\revit\\2010\\SDK\\Samples\\RaytraceBounce\\CS\\RaytraceBouncePool.cs\">\nRaytraceBouncePool.cs</a> and the sample project \n\n<a href=\"C:\\a\\lib\\revit\\2010\\SDK\\Samples\\RaytraceBounce\\PoolTable.rvt\">\nPoolTable.rvt</a> defining \n\nthe pool table and cue for downloading.\nI placed the sample project into the RaytraceBounce subdirectory of the SDK Samples folder, and the source file into the CS subdirectory below it.</p>\n<p>I hope this helps further understanding of the possibilities of the Revit API and the FindReferencesByDirection method, and provides a bit of fun as well.\n\n<p>Many thanks to Harry for this nice sample!\n\n<p>Once again, and this time for good, a Very Merry Christmas and a Happy New Year to you all!</p>\n<center>\n<img alt=\"Merry Chsristmas\" src=\"img/merry_christmas.jpg\"/>\n</center>\n<h4>Addenda</h4>\n<p>Harry added some notes on this later:\n\n<p>It's fine to publish it, but I will feel bad if anyone considers an API example like this a Christmas gift   :-)   \nI'd feel bad because I don't think it is a very good present – sort of like getting underwear or socks as a gift. Not exactly a new iPod or Wii.\nBut that is no reason not to post it and I hope others enjoy it.\nAfter all, underwear and socks are useful and necessary.\n\n<p>By the way, this is a lot more fun if you add doc.Save() at the beginning and then after each call to MakeLine so that the view updates after each bounce.\n\n<p>Anthony '8-Ball' Hauck noted that the message displayed should actually read \"You sank the ball with 5 banks.\"\n</p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0273_raytracebounce_pool_table",
    "header_text": "Addenda",
    "local_header_href": "#addenda",
    "chunk_text": "<h4>Addenda</h4><p>Harry added some notes on this later:\n\n<p>It's fine to publish it, but I will feel bad if anyone considers an API example like this a Christmas gift   :-)   \nI'd feel bad because I don't think it is a very good present – sort of like getting underwear or socks as a gift. Not exactly a new iPod or Wii.\nBut that is no reason not to post it and I hope others enjoy it.\nAfter all, underwear and socks are useful and necessary.\n\n<p>By the way, this is a lot more fun if you add doc.Save() at the beginning and then after each call to MakeLine so that the view updates after each bounce.\n\n<p>Anthony '8-Ball' Hauck noted that the message displayed should actually read \"You sank the ball with 5 banks.\"\n</p></p></p></p>"
  }
]