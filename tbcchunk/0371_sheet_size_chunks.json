[
  {
    "original_filename": "0371_sheet_size",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0371_sheet_size",
    "header_text": "Determine Sheet Size",
    "local_header_href": "#determine-sheet-size",
    "chunk_text": "<h3>Determine Sheet Size</h3><p>We already discussed some issues related to sheets and title blocks, such as the\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/01/viewports-and-sheets.html\">\nrelationship between viewports and sheets</a> and how to \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/11/title-block-of-sheet.html\">\nretrieve the title block of a sheet</a>.\n\n<p>Here is a question on determining the size of a sheet which provides an opportunity to update these explorations based on the Revit 2011 platform.\n\n<p><strong>Question:</strong> Using the pre-release 2011 RevitAPI.dll I was able to detect the sheet width/height by iterating the ParameterSet collection for each element in the ViewSheet.ElementSet object. I was able to locate the \"Sheet Height\" and \"Sheet Width\" definitions.\n\n<p>With the new Revit 2011 release there are some major changes in the API. Could you please briefly explain how I can get the sheet's width/height with the new API?\n\n<p><strong>Answer:</strong> The approach you describe sounds rather inefficient. \nDo you mean that you iterated over all the elements in the ViewSheet.ElementSet, and for each element iterated over all its parameters?\n\n<p>I would suggest that you enhance that, even if it did still work. \nThere is no need to iterate over all parameters, since you can access the specific parameters you want, either using the built-in parameter enumeration or their display name. Using the enumeration is much better, of course, since it is language independent.\n\n<p>Similarly, there is no need to iterate over multiple elements, since you can determine exactly which elements you need to access to obtain the data for a specific sheet.\n\n<p>As far as I can tell, the sheet itself does not have any information about its width and height. On the other hand, though, each sheet seems to have exactly one title block instance assigned to it, and that does include information on the sheet width and height.\n\n<p>I analysed a sample project using the Revit API Introduction labs built-in parameter checker and was unable to find any width and height data on the sheet itself. On the other hand, I did find the built-in parameters SHEET_WIDTH and SHEET_HEIGHT on the title block of the sheet. \n\n<p>The document also has a collection of all loaded title block types which is accessible through the TitleBlocks property. These types do not list the sheet size themselves. Instead, they are referenced by the title block instances which do.\n\n<p>The relationship between sheets and their associated title blocks can be determined through the sheet number, which is available on both of these elements.\n\n<p>I implemented a new Building Coder sample command CmdSheetSize which illustrates some relationships between the title block, sheet and title block types. \nIt includes source code to access the sheet size for all title blocks. \nFor a given sheet number, you can locate the associated title block and retrieve the sheet size from that.\nHere are the steps it performs:\n\n<ul>\n<li>Iterate over the document TitleBlocks collection and lists some data for each title block element type.\n<li>Use a filtered element collector to retrieve and list the same elements.\n<li>Retrieves all title block and view sheet instances in the model.\n<li>List the sheet size defined by the title block instance.\n<li>Display the one-to-on correspondence between title block and view sheet instances, linked through the sheet number. \n</li></li></li></li></li></ul>\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.ReadOnly )]\n[<span class=\"teal\">Regeneration</span>( <span class=\"teal\">RegenerationOption</span>.Manual )]\n<span class=\"blue\">class</span> <span class=\"teal\">CmdSheetSize</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"gray\">///</span><span class=\"green\"> </span>\n  <span class=\"gray\">///</span><span class=\"green\"> Return a string value for the specified </span>\n  <span class=\"gray\">///</span><span class=\"green\"> built-in parameter if it is available on </span>\n  <span class=\"gray\">///</span><span class=\"green\"> the given element, else an empty string.</span>\n  <span class=\"gray\">///</span><span class=\"green\"> </span>\n  <span class=\"blue\">string</span> GetParameterValueString( \n    <span class=\"teal\">Element</span> e, \n    <span class=\"teal\">BuiltInParameter</span> bip )\n  {\n    <span class=\"teal\">Parameter</span> p = e.get_Parameter( bip );\n \n    <span class=\"blue\">string</span> s = <span class=\"blue\">string</span>.Empty;\n \n    <span class=\"blue\">if</span>( <span class=\"blue\">null</span> != p )\n    {\n      <span class=\"blue\">switch</span>( p.StorageType )\n      {\n        <span class=\"blue\">case</span> <span class=\"teal\">StorageType</span>.Integer: \n          s = p.AsInteger().ToString(); \n          <span class=\"blue\">break</span>;\n \n        <span class=\"blue\">case</span> <span class=\"teal\">StorageType</span>.ElementId: \n          s = p.AsElementId().IntegerValue.ToString(); \n          <span class=\"blue\">break</span>;\n \n        <span class=\"blue\">case</span> <span class=\"teal\">StorageType</span>.Double: \n          s = <span class=\"teal\">Util</span>.RealString( p.AsDouble() ); \n          <span class=\"blue\">break</span>;\n \n        <span class=\"blue\">case</span> <span class=\"teal\">StorageType</span>.String: \n          s = <span class=\"blue\">string</span>.Format( <span class=\"maroon\">\"{0} ({1})\"</span>, \n            p.AsValueString(), \n            <span class=\"teal\">Util</span>.RealString( p.AsDouble() ) ); \n          <span class=\"blue\">break</span>;\n \n        <span class=\"blue\">default</span>: s = <span class=\"maroon\">\"\"</span>; \n          <span class=\"blue\">break</span>;\n      }\n      s = <span class=\"maroon\">\", \"</span> + bip.ToString() + <span class=\"maroon\">\"=\"</span> + s;\n    }\n    <span class=\"blue\">return</span> s;\n  }\n \n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"teal\">String</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">UIApplication</span> app = commandData.Application;\n    <span class=\"teal\">Document</span> doc = app.ActiveUIDocument.Document;\n \n    <span class=\"teal\">FilteredElementCollector</span> a;\n    <span class=\"teal\">Parameter</span> p;\n    <span class=\"blue\">string</span> s;\n \n    <span class=\"blue\">int</span> n = doc.TitleBlocks.Size;\n \n    <span class=\"teal\">Debug</span>.Print( \n      <span class=\"maroon\">\"{0} title block element type{1} listed \"</span>\n      + <span class=\"maroon\">\"in doc.TitleBlocks collection{2}\"</span>,\n      n, \n      ( 1 == n ? <span class=\"maroon\">\"\"</span> : <span class=\"maroon\">\"s\"</span> ), \n      ( 0 == n ? <span class=\"maroon\">\".\"</span> : <span class=\"maroon\">\":\"</span> ) );\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">FamilySymbol</span> tb <span class=\"blue\">in</span> doc.TitleBlocks )\n    {\n      <span class=\"green\">// these are the family symbols, </span>\n      <span class=\"green\">// i.e. the title block element types,</span>\n      <span class=\"green\">// i.e. not instances, i.e. not sheets, </span>\n      <span class=\"green\">// and they obviously do not have any sheet </span>\n      <span class=\"green\">// number, width or height, so 's' ends up empty:</span>\n \n      s = GetParameterValueString( tb, <span class=\"teal\">BuiltInParameter</span>.SHEET_NUMBER )\n        + GetParameterValueString( tb, <span class=\"teal\">BuiltInParameter</span>.SHEET_WIDTH )\n        + GetParameterValueString( tb, <span class=\"teal\">BuiltInParameter</span>.SHEET_HEIGHT );\n \n      <span class=\"teal\">Debug</span>.Print(\n        <span class=\"maroon\">\"Title block element type {0} {1}\"</span> + s,\n        tb.Name, tb.Id.IntegerValue );\n    }\n \n    <span class=\"green\">// using this filter returns the same elements</span>\n    <span class=\"green\">// as the doc.TitleBlocks collection:</span>\n \n    a = <span class=\"blue\">new</span> <span class=\"teal\">FilteredElementCollector</span>( doc );\n    a.OfCategory( <span class=\"teal\">BuiltInCategory</span>.OST_TitleBlocks );\n    a.OfClass( <span class=\"blue\">typeof</span>( <span class=\"teal\">FamilySymbol</span> ) );\n \n    <span class=\"teal\">Debug</span>.Print( <span class=\"maroon\">\"{0} title block element type{1} \"</span>\n      + <span class=\"maroon\">\"retrieved by filtered element collector{2}\"</span>,\n      n, \n      ( 1 == n ? <span class=\"maroon\">\"\"</span> : <span class=\"maroon\">\"s\"</span> ), \n      ( 0 == n ? <span class=\"maroon\">\".\"</span> : <span class=\"maroon\">\":\"</span> ) );\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">FamilySymbol</span> symbol <span class=\"blue\">in</span> a )\n    {\n      <span class=\"teal\">Debug</span>.Print(\n        <span class=\"maroon\">\"Title block element type {0} {1}\"</span>,\n        symbol.Name, symbol.Id.IntegerValue );\n    }\n \n    <span class=\"green\">// retrieve the title block instances:</span>\n \n    a = <span class=\"blue\">new</span> <span class=\"teal\">FilteredElementCollector</span>( doc );\n    a.OfCategory( <span class=\"teal\">BuiltInCategory</span>.OST_TitleBlocks );\n    a.OfClass( <span class=\"blue\">typeof</span>( <span class=\"teal\">FamilyInstance</span> ) );\n \n    <span class=\"teal\">Debug</span>.Print( <span class=\"maroon\">\"Title block instances:\"</span> );\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">FamilyInstance</span> e <span class=\"blue\">in</span> a )\n    {\n      p = e.get_Parameter( \n        <span class=\"teal\">BuiltInParameter</span>.SHEET_NUMBER );\n \n      <span class=\"teal\">Debug</span>.Assert( <span class=\"blue\">null</span> != p, \n        <span class=\"maroon\">\"expected valid sheet number\"</span> );\n \n      <span class=\"blue\">string</span> sheet_number = p.AsString();\n \n      p = e.get_Parameter( \n        <span class=\"teal\">BuiltInParameter</span>.SHEET_WIDTH );\n \n      <span class=\"teal\">Debug</span>.Assert( <span class=\"blue\">null</span> != p, \n        <span class=\"maroon\">\"expected valid sheet width\"</span> );\n \n      <span class=\"blue\">string</span> swidth = p.AsValueString();\n      <span class=\"blue\">double</span> width = p.AsDouble();\n \n      p = e.get_Parameter( \n        <span class=\"teal\">BuiltInParameter</span>.SHEET_HEIGHT );\n \n      <span class=\"teal\">Debug</span>.Assert( <span class=\"blue\">null</span> != p, \n        <span class=\"maroon\">\"expected valid sheet height\"</span> );\n \n      <span class=\"blue\">string</span> sheight = p.AsValueString();\n      <span class=\"blue\">double</span> height = p.AsDouble();\n \n      <span class=\"teal\">ElementId</span> typeId = e.GetTypeId();\n      <span class=\"teal\">Element</span> type = doc.get_Element( typeId );\n \n      <span class=\"teal\">Debug</span>.Print(\n        <span class=\"maroon\">\"Sheet number {0} size is {1} x {2} \"</span>\n        + <span class=\"maroon\">\"({3} x {4}), id {5}, type {6} {7}\"</span>,\n        sheet_number, swidth, sheight,\n        <span class=\"teal\">Util</span>.RealString( width ),\n        <span class=\"teal\">Util</span>.RealString( height ),\n        e.Id.IntegerValue,\n        type.Name, typeId.IntegerValue );\n    }\n \n    <span class=\"green\">// retrieve the view sheet instances:</span>\n \n    a = <span class=\"blue\">new</span> <span class=\"teal\">FilteredElementCollector</span>( doc );\n    a.OfClass( <span class=\"blue\">typeof</span>( <span class=\"teal\">ViewSheet</span> ) );\n \n    <span class=\"teal\">Debug</span>.Print( <span class=\"maroon\">\"View sheet instances:\"</span> );\n \n    <span class=\"blue\">foreach</span>( <span class=\"teal\">ViewSheet</span> vs <span class=\"blue\">in</span> a )\n    {\n      <span class=\"blue\">string</span> number = vs.SheetNumber;\n      <span class=\"teal\">Debug</span>.Print(\n        <span class=\"maroon\">\"View sheet name {0} number {1} id {2}\"</span>,\n        vs.Name, vs.SheetNumber, \n        vs.Id.IntegerValue );\n    }\n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>As said, it iterates over the document TitleBlocks collection and lists some data for each title block element type, then shows that the same elements are also available through the filtered element collector.\n\n<p>It then retrieves the title block and the view sheet instances and shows that there is a one-to-on correspondence between them, linked through the sheet number.\n\n<p>Here is the output from this command in my sample project:\n\n<pre>\n2 title block element types listed in doc.TitleBlocks collection:\nTitle block element type A0 metric 28295\nTitle block element type A4 metric 129886\n2 title block element types retrieved by filtered element collector:\nTitle block element type A0 metric 28295\nTitle block element type A4 metric 129886\nTitle block instances:\nSheet number A101 size is 1188.0 x 840.0 (3.9 x 2.76), id 127154, type A0 metric 28295\nSheet number A102 size is 1188.0 x 840.0 (3.9 x 2.76), id 127168, type A0 metric 28295\nSheet number A103 size is 1188.0 x 840.0 (3.9 x 2.76), id 127182, type A0 metric 28295\nSheet number A104 size is 210.0 x 297.0 (0.69 x 0.97), id 129892, type A4 metric 129886\nView sheet instances:\nView sheet name Unnamed number A101 id 127148\nView sheet name Unnamed number A102 id 127162\nView sheet name Unnamed number A103 id 127176\nView sheet name Unnamed number A104 id 129888\n</pre>\n<p>If you have a need for a direct mapping between the view sheets and the title block sizes, you could obviously use this information to create a bidirectional mapping as described for the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2008/10/relationship-in.html\">\nrelationship inverter</a>.\n\nThen, for a given sheet 's', you might be able to use something like 'title_block[s.Number].Width/Height'.\n\n<p>Another little snippet of source code demonstrating these relationships is given by the sample code in the Revit API help file RevitAPI.chm in the description of the Document.NewViewSheet method.\n\n<p>Here is\n\n<a href=\"zip/bc_11_68.zip\">\nversion 2011.0.68.0</a>\n\nof The Building Coder sample source code and Visual Studio solution including the new command.\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  }
]