[
  {
    "original_filename": "0448_extract_part_atom",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0448_extract_part_atom",
    "header_text": "Extract Part Atom Revisited",
    "local_header_href": "#extract-part-atom-revisited",
    "chunk_text": "<h3>Extract Part Atom Revisited</h3><p>We briefly discussed the use of the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/11/extract-part-atoms.html\">\nExtractPartAtomFromFamilyFile</a> method in Revit 2010.\n\nNow the question on using this method arose again in the context of the Revit 2011 API:\n\n<p><strong>Question:</strong> I invoked the Autodesk.Revit.ApplicationServices.Application ExtractPartAtomFromFamilyFile method of on an RFA file, using the following code:\n\n<pre class=\"code\">\n<span class=\"blue\">private</span> <span class=\"blue\">void</span> createPartAtomFile(\n  <span class=\"teal\">Application</span> app,\n  <span class=\"blue\">string</span> rfaFilePath,\n  <span class=\"blue\">string</span> partAtomFilePath )\n{\n  app.ExtractPartAtomFromFamilyFile(\n    rfaFilePath,\n    partAtomFilePath );\n}\n</pre>\n\nThis threw an AccessViolationException with the following stack trace:\n\n<pre>\nAccessViolationException: Attempted to read or write protected memory. This is often an indication that other memory is corrupt. \nat extractPartAtomFromFamilyFile(AString* , AString* ) \nat Autodesk.Revit.ApplicationServices.Application.ExtractPartAtomFromFamilyFile(String familyFilePath, String xmlFilePath) \n... \n... \n</pre>\n<p>How can I avoid this exception and successfully generate the part atom XML for the RFA file? \n\n<p><strong>Answer:</strong> Based on an answer to this question by my colleague Saikat Bhattacharya, I wrote a new Building Coder sample command CmdPartAtom to test run this method.\nThe command implementation is achieved in the following few lines of code and successfully generates the part atom XML file:\n\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n[<span class=\"teal\">Regeneration</span>( <span class=\"teal\">RegenerationOption</span>.Manual )]\n<span class=\"blue\">class</span> <span class=\"teal\">CmdPartAtom</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">UIApplication</span> uiapp = commandData.Application;\n    <span class=\"teal\">UIDocument</span> uidoc = uiapp.ActiveUIDocument;\n    <span class=\"teal\">Application</span> app = uiapp.Application;\n    <span class=\"teal\">Document</span> doc = uidoc.Document;\n \n    <span class=\"teal\">Transaction</span> trans = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc, \n      <span class=\"maroon\">\"Extract Part Atom\"</span> );\n \n    trans.Start();\n \n    <span class=\"blue\">string</span> familyFilePath \n      = <span class=\"maroon\">\"C:/Documents and Settings/All Users\"</span>\n      + <span class=\"maroon\">\"/Application Data/Autodesk/RAC 2011\"</span>\n      + <span class=\"maroon\">\"/Metric Library/Doors/M_Double-Flush.rfa\"</span>;\n \n    <span class=\"blue\">string</span> xmlPath = <span class=\"maroon\">\"C:/tmp/ExtractPartAtom.xml\"</span>;\n \n    app.ExtractPartAtomFromFamilyFile( \n      familyFilePath, xmlPath );\n \n    trans.Commit();\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>Here is a screen snapshot of the resulting XML file displayed in the browser, with all except one of the A:part nodes collapsed:</p>\n<center>\n<img alt=\"ExtractPartAtom XML output\" src=\"img/ExtractPartAtomXml.png\"/>\n</center>\n<p>In Saikat's words: \nLooking at the exception you have received, I am not sure if it is related to the TransactionMode and RegenerationOption attributes used in your plug-in. \nIn my case, I used the Manual mode for both the attributes. \nPlease try using my code snippet and steps to see if it works well at your end too.\n\n<p>Many thanks to Saikat for this exploration!\n\n<p>Here is \n\n<!-- C:\\a\\doc\\revit\\blog\\zip\\bc_11_75.zip -->\n<a href=\"zip/bc_11_75.zip\">\nversion 2011.0.75.0</a>\n\nof The Building Coder samples including the complete source code and Visual Studio solution with the new command.\n\n<p>More recently, we have heard that there is currently a problem with this API call on 64 bit systems, so right now this will only work in the 32 bit version.\nAs Steve points out below, the issue might be occurring only on certain platforms, e.g. on 64 bit Windows 7 OS running 64-bit Revit Architecture 2011. \nIt has been resolved internally, though, so the next update should have the issue fixed.\n</p></p></p></p></p></p></p></p>"
  }
]