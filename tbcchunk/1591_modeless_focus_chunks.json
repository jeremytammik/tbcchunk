[
  {
    "original_filename": "1591_modeless_focus",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\n<link rel=\"stylesheet\" type=\"text/css\" href=\"bc.css\">\n<!--\n<script src=\"run_prettify.js\" type=\"text/javascript\"></script>\n<script src=\"https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js\" type=\"text/javascript\"></script>\n-->\n<script src=\"https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js\" type=\"text/javascript\"></script>\n</head>\n\n<!---\n\n- 13270564 [Revit 2018 loses focus on close of modeless Addin]\n  two workarunds to keep Revit on top\n\n- Dianne Phillips\n  RE: An update on your post \"Ensure WPF Add-in Remains in Foreground\"\n\nModeless Form Keep Revit Focus and On Top #RevitAPI @AutodeskRevit #bim #dynamobim @AutodeskForge #ForgeDevCon http://bit.ly/modelessfocus\n\nI am back from a nice break in Italy.\nNext, I am attending the European Autodesk University in Darmstadt, Germany.\nMeanwhile, solutions for two issues on keeping Revit focused and on top when working with a modeless form, and an important heads-up warning from the Revit development team on a future change coming.\nWe here at Ideate Software are seeing what appears to be Revit add-in ownership issues with Revit's main window. \nThe behavior has changed between Revit 2017 and Revit 2018 for modeless add-ins.\nFor Revit 2018, when a modeless add-in is closed, Revit does not retain is focus; it is pushed behind another application...\n\n--->"
  },
  {
    "original_filename": "1591_modeless_focus",
    "header_text": "Modeless Form Keep Revit Focus and On Top",
    "local_header_href": "#modeless-form-keep-revit-focus-and-on-top",
    "chunk_text": "### Modeless Form Keep Revit Focus and On Top\n\nI am back from a nice break in Italy, including a visit to\nthe [Giardino dei Tarocchi](https://en.wikipedia.org/wiki/Tarot_Garden),\nthe Tarot Garden sculpture garden based on the tarot cards, created by Niki de Saint Phalle\n([photos](https://flic.kr/s/aHsm6U4nnA)):\n\n<center>\n<img src=\"img/975_beach_breakfast_1k.jpg\" alt=\"Breakfost on the beach\" width=\"500\"/>\n</center>\n\nBefore I get back to work properly attending the European Autodesk University in Darmstadt, Germany, here is a note from Hank DiVincenzo, Sr. Software Engineer at [Ideate, Inc](http://www.ideateinc.com), on keeping Revit focused and on top when working with a modeless form, and an important heads-up warning from the Revit development team on a future change coming:\n\n- [Two issues](#2)\n- [First issue problem](#3)\n- [The first resolution](#4)\n- [Code example for first resolution](#5)\n- [Second issue context](#6)\n- [The second problem](#7)\n- [The second resolution](#8)\n- [Code example for second resolution](#9)\n- [Warning! Things will change in the next release](#10)\n\nWe here at Ideate Software are seeing what appears to be Revit add-in ownership issues with Revit's main window. \n\nThe behavior has changed between Revit 2017 and Revit 2018 for modeless add-ins.\n\nFor Revit 2018, when a modeless add-in is closed, Revit does not retain is focus; it is pushed behind another application. \n\nWith some experimentation, it was found the application that had focus before Revit is the one that gains focus after the modeless add-in is closed. \n\nRevit 2016 and 2017 do not show this behavior, only Revit 2018 does. \n\n<!--- Looking for advice on this issue. Is this a known issue? And is there a known method to solve it?  --->\n\nAlso Note: \n\nWhat we understand as the preferred method of getting Revit's MainWindowHandle has issues when there are multiple modeless add-ins opened. \n\nWhen the MainWindowHandle is gotten from the Revit process (i.e. using the `Process.GetCurrentProcess()` `MainWindowHandle` property), modeless add-in ownership is incorrect. \n\nAny modeless add-in that is started after the first one has its ownership set to that previous modeless add-in. This can be seen by closing any of the interim modeless add-ins and any modeless add-ins started after the one being closed, also closes. \n\nWhat I have called 'owner' is also known as the parent-child window relationship.\n\n<!---\nAny information or assistance on this would be appreciated, though our current concern is the change in the 2018 behavior.\n\n**Answer:**\n\nI assume that you in fact mean 'parent relationship of the modeless form' when you say 'ownership of the add-in'.\n\nIs that assumption correct?\n\nI myself have always used the JtWindowHandle class to retrieve the main Revit window handle, and set up the parent window relationship for my modeless forms using that as described here:\n\nhttp://thebuildingcoder.typepad.com/blog/2010/06/revit-parent-window.html\n\nI have been notified by the development team that this method will cease to work in the next major release of Revit, after Revit 2018.\n\nI am not aware of any such issues in Revit 2018.\n\nDid it appear in the initial release or a subsequent update?\n\n**Response:**\n\nFirst thanks for the response and yes, what I have called Owner is the parent relationship. \n\nFurther note:\n\n- The add-in is a WPF add-in. \n- The Revit focus issue is only seen in Revit 2018 \n\nTo reproduce the Revit 2018 focus issue: \n\n1) Start another app, like the Windows File Manager \n2) Start Revit 2018 \n3) From the Addin-Ins Tab >> External Tool Panel Start the app “Id8 SearchWindow Owner Setup” \n4) From the add-in's dialog open the model dialog by pressing the button “Start Dialog” in the lower right corner of the add-in dialog. \n5) Close the second/modal dialog \n6) Close the add-in \n7) At this point the first app that was started, “File Manager”, will be brought to the foreground, covering Revit; Revit is no longer the top application having focus. \n\nNow for Some perinate history: \n\nWithin the External Tools there are two applications. \n\nThe “Search Window” add-in is currently how we are getting Revit's main window and exhibits the issue I am talking about. \n\nThe second or “Id8 MainWindow Owner Setup” is how we use to get Revit's main window, and uses the prescribed way of getting the main window the Process.GetCurrentProcess.MainWindow property. \n\nWhen we moved to using WPF add-ins, using the “current process” MainWindow property had issues and we came up with the current method what I am calling the “Search Window”. This method of getting Revit's Main Window is somewhat complicated but got us working for the Revit 2017 release, it was only during the 2018 release did we see the loss of focus issue within Revit 2018. \n\nNow the issues we had with using the Process.GetCurrentProcess.MainWindow property. \n\nWhen multiple (any number) of modeless add-ins are started, when the first add-in that was open is closed all of the modeless add-ins close. \n\nMatter of fact if any modeless add-in is closed all modeless add-in start after the one being closed also close. \n\ni.e. if three modeless add-ins are opened, if the second add-in is closed the third started add-in is closed also. \n\nNOTE: this was first seen with two Forms base add-ins so WPF was not in play when we ran into this behavior. \n\nTo Reproduce the original Closing issue: \n\n1) Start Revit \n2) From the Addin-Ins Tab >> External Tool Panel Start the app “Id8 MainWindow Owner Setup” \n3) Start a second “Id8 MainWindow Owner Setup” \n4) Start a third “Id8 MainWindow Owner Setup” \n5) Close the first “Id8 MainWindow Owner Setup” App \n6) All three of the “Id8 MainWindow Owner Setup” Apps close down. \n\n**Answer:**\n\nCan you work around it for the time being, or live with it?\n\nThe reason I ask is the following information I received from the development team:\n\nOne of the Revit Advanced Steel developers pointed out that they followed The Building Code advice in building a new add-in:\n\nhttp://thebuildingcoder.typepad.com/blog/2012/10/ensure-wpf-add-in-remains-in-foreground.html\n\nThis was written about 5 years ago.\n\nPlease note that as of Revit 2019, the method described in the blog will no longer work. \n\nThere is a way to fix this. The Revit API team has added two new APIs that provide an official way to get the application window handle:\n\n- `Autodesk.Revit.UI.UIControlledApplication.MainWindowHandle`\n- `Autodesk.Revit.UI.UIApplication.MainWindowHandle`\n- Get the handle of the Revit main window.\n- Returns the main window handle of the Revit application. This handle should be used when displaying modal dialogs and message windows to ensure that they are properly parented. This property replaces the System.Diagnostics.Process.GetCurrentProcess().MainWindowHandle property, which is no longer a reliable method for retrieving the main window handle starting with Revit 2019.\n\nTherefore, the issue you describe has already been resolved for future versions.\n\nI don't know how much can be done about it for the current version.\n\nI would expect that an experienced Windows programming expert could devise some kind of workaround.\n\nDo you have one already, or can you create one?\n\n**Response:**\n\nYes, I did solve it but was hoping there was a solution like you have explained below, where an add-in could just get the Main Window handle from a Revit API call, so this is good news, I will look for it in the latest Revit Preview?\n\nI am more than willing to do a write up on what was done to solve the issue. Let me know what form you want it in, via this case, a direct email, etc.\n\nLet me know if you need more information or clarification.\n\nThe project is a Visual Studio 2013 project.\n\nThanks, Hank\n\n--->\n\nHere is the write-up of the two window issues we ran into and have solved.\n\nTo demonstrate, I am also sharing the Visual Studio 2013\nproject [ModelessAddinSolution.zip](zip/hdv_ModelessAddinSolution.zip).\n\nIt implements an add-in that can be used to demonstrate the focus issue and its solution following the instructions provided below. It also includes the add-in manifest `.addin` file in the *External Application* folder.\n\n\n####<a name=\"2\"></a>Two Issues\n\nThis describes my journey to solve two issues with Revit add-in windows.\n\nThe first issue was a general problem seen in all version of Revit, the second issue was specific to Revit 2018.\n\n####<a name=\"3\"></a>First Issue Problem\n\nWhile developing a second modeless add-in, we ran into an issue with add-in window parenting/ownership. The problem manifested itself when having two modeless add-ins open: when the first add-in opened was closed, the second add-in opened also closed. With this behavior, it was apparent the second add-in was somehow being associated with the first add-in. We were using *Process.GetCurrentProcess().MainWindow* to get main Revit window. Somehow, once the first modeless add-in was opened, the `MainWindow` property for the Revit process changed. A new method for getting Revit's main window was needed.\n\n####<a name=\"4\"></a>The First Resolution\n\nAn alternate solution was needed to get the window handle for Revit's main window, the window that holds the ribbon and is the first window opened.\n\nThe following solution was implemented:\n\n- Find all windows within the Revit process\n- Find the Revit windows that do not have a parent assigned to them, i.e. their parent/owner property is null.\n\nThe thought here is windows that have no parent are those opened by the OS and not another part of Revit.\n\n- Then, for the Revit windows not having a parent, find the one window that has “Autodesk Revit” within its title.\n\nThis method seems fragile because it depends on text from Revit's main window title, but it consistently gets the Revit main window no matter what add-ins are open. And localization is not an issue, the main window title text “Autodesk Revit” does not change for other languages, cf. the following two language examples.\n\nFrench:\n\n<center>\n<img src=\"img/revit_title_bar_french.jpg\" alt=\"French Revit title bar\" width=\"925\"/>\n</center>\n\nGerman:\n\n<center>\n<img src=\"img/revit_title_bar_german.png\" alt=\"German Revit title bar\" width=\"967\"/>\n</center>\n\n####<a name=\"5\"></a>Code Example for First Resolution\n\nClass usage within the add-in's main window; the add-in is WPF a app:\n\n<pre class=\"code\">\n  <span style=\"color:green;\">//&nbsp;Set&nbsp;Revit&nbsp;as&nbsp;owner&nbsp;of&nbsp;given&nbsp;child&nbsp;window</span>\n  <span style=\"color:#2b91af;\">WindowHandleSearch</span>&nbsp;handle\n  &nbsp;&nbsp;=&nbsp;<span style=\"color:#2b91af;\">WindowHandleSearch</span>.MainWindowHandle;\n  \n  handle.SetAsOwner(<span style=\"color:blue;\">this</span>);\n</pre>\n\nMain Window Handle Class:\n \n<pre class=\"code\">\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;Wrapper&nbsp;class&nbsp;for&nbsp;window&nbsp;handles</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;/</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">class</span>&nbsp;<span style=\"color:#2b91af;\">WindowHandleSearch</span>\n&nbsp;&nbsp;:&nbsp;IWin32Window,&nbsp;System.Windows.Forms.IWin32Window\n{\n&nbsp;&nbsp;<span style=\"color:blue;\">#region</span>&nbsp;Static&nbsp;methods\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;Revit&nbsp;main&nbsp;window&nbsp;handle</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;/</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:#2b91af;\">WindowHandleSearch</span>&nbsp;MainWindowHandle\n&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">get</span>\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Get&nbsp;handle&nbsp;of&nbsp;main&nbsp;window</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;revitProcess&nbsp;=&nbsp;<span style=\"color:#2b91af;\">Process</span>.GetCurrentProcess();\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">return</span>&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">WindowHandleSearch</span>(\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetMainWindow(&nbsp;revitProcess.Id&nbsp;)&nbsp;);\n&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;}\n&nbsp;&nbsp;<span style=\"color:blue;\">#endregion</span>\n \n&nbsp;&nbsp;<span style=\"color:blue;\">#region</span>&nbsp;Constructor\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;Constructor&nbsp;-&nbsp;From&nbsp;WinForms&nbsp;window&nbsp;handle</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;/</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">param</span><span style=\"color:gray;\">&nbsp;name</span><span style=\"color:gray;\">=</span><span style=\"color:gray;\">&quot;</span>hwnd<span style=\"color:gray;\">&quot;</span><span style=\"color:gray;\">&gt;</span><span style=\"color:green;\">Window&nbsp;handle</span><span style=\"color:gray;\">&lt;/</span><span style=\"color:gray;\">param</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:blue;\">public</span>&nbsp;WindowHandleSearch(&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>&nbsp;hwnd&nbsp;)\n&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Assert&nbsp;valid&nbsp;window&nbsp;handle</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">Debug</span>.Assert(&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>.Zero&nbsp;!=&nbsp;hwnd,\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#a31515;\">&quot;Null&nbsp;window&nbsp;handle&quot;</span>&nbsp;);\n \n&nbsp;&nbsp;&nbsp;&nbsp;Handle&nbsp;=&nbsp;hwnd;\n&nbsp;&nbsp;}\n&nbsp;&nbsp;<span style=\"color:blue;\">#endregion</span>\n \n&nbsp;&nbsp;<span style=\"color:blue;\">#region</span>&nbsp;Methods\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;Window&nbsp;handle</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;/</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>&nbsp;Handle&nbsp;{&nbsp;<span style=\"color:blue;\">get</span>;&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">set</span>;&nbsp;}\n \n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;Set&nbsp;this&nbsp;window&nbsp;handle&nbsp;as&nbsp;the&nbsp;owner&nbsp;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;of&nbsp;the&nbsp;given&nbsp;window</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;/</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">param</span><span style=\"color:gray;\">&nbsp;name</span><span style=\"color:gray;\">=</span><span style=\"color:gray;\">&quot;</span>childWindow<span style=\"color:gray;\">&quot;</span><span style=\"color:gray;\">&gt;</span><span style=\"color:green;\">Child&nbsp;window&nbsp;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;whose&nbsp;parent&nbsp;will&nbsp;be&nbsp;set&nbsp;to&nbsp;be&nbsp;this&nbsp;window&nbsp;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;handle</span><span style=\"color:gray;\">&lt;/</span><span style=\"color:gray;\">param</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">void</span>&nbsp;SetAsOwner(&nbsp;Window&nbsp;childWindow&nbsp;)\n&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">var</span>&nbsp;helper&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;WindowInteropHelper(\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;childWindow&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;Owner&nbsp;=&nbsp;Handle&nbsp;};\n&nbsp;&nbsp;}\n \n&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;User32.dll&nbsp;calls&nbsp;used&nbsp;to&nbsp;get&nbsp;the&nbsp;Main&nbsp;Window&nbsp;for&nbsp;a&nbsp;Process&nbsp;Id&nbsp;(PID)</span>\n&nbsp;&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">delegate</span>&nbsp;<span style=\"color:blue;\">bool</span>&nbsp;<span style=\"color:#2b91af;\">EnumWindowsProc</span>(\n&nbsp;&nbsp;&nbsp;&nbsp;HWND&nbsp;hWnd,&nbsp;<span style=\"color:blue;\">int</span>&nbsp;lParam&nbsp;);\n \n&nbsp;&nbsp;[DllImport(&nbsp;<span style=\"color:#a31515;\">&quot;user32.DLL&quot;</span>&nbsp;)]\n&nbsp;&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">extern</span>&nbsp;<span style=\"color:blue;\">bool</span>&nbsp;EnumWindows(\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">EnumWindowsProc</span>&nbsp;enumFunc,&nbsp;<span style=\"color:blue;\">int</span>&nbsp;lParam&nbsp;);\n \n&nbsp;&nbsp;[DllImport(&nbsp;<span style=\"color:#a31515;\">&quot;user32.dll&quot;</span>,&nbsp;ExactSpelling&nbsp;=&nbsp;<span style=\"color:blue;\">true</span>,\n&nbsp;&nbsp;&nbsp;&nbsp;CharSet&nbsp;=&nbsp;CharSet.Auto&nbsp;)]\n&nbsp;&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">extern</span>&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>&nbsp;GetParent(&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>&nbsp;hWnd&nbsp;);\n \n&nbsp;&nbsp;[DllImport(&nbsp;<span style=\"color:#a31515;\">&quot;user32.dll&quot;</span>,&nbsp;SetLastError&nbsp;=&nbsp;<span style=\"color:blue;\">true</span>&nbsp;)]\n&nbsp;&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">extern</span>&nbsp;<span style=\"color:blue;\">uint</span>&nbsp;GetWindowThreadProcessId(\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>&nbsp;hWnd,&nbsp;<span style=\"color:blue;\">out</span>&nbsp;<span style=\"color:blue;\">uint</span>&nbsp;processId&nbsp;);\n \n&nbsp;&nbsp;[DllImport(&nbsp;<span style=\"color:#a31515;\">&quot;user32.DLL&quot;</span>&nbsp;)]\n&nbsp;&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">extern</span>&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>&nbsp;GetShellWindow();\n \n&nbsp;&nbsp;[DllImport(&nbsp;<span style=\"color:#a31515;\">&quot;user32.DLL&quot;</span>&nbsp;)]\n&nbsp;&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">extern</span>&nbsp;<span style=\"color:blue;\">bool</span>&nbsp;IsWindowVisible(&nbsp;HWND&nbsp;hWnd&nbsp;);\n \n&nbsp;&nbsp;[DllImport(&nbsp;<span style=\"color:#a31515;\">&quot;user32.DLL&quot;</span>&nbsp;)]\n&nbsp;&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">extern</span>&nbsp;<span style=\"color:blue;\">int</span>&nbsp;GetWindowTextLength(&nbsp;HWND&nbsp;hWnd&nbsp;);\n \n&nbsp;&nbsp;[DllImport(&nbsp;<span style=\"color:#a31515;\">&quot;user32.DLL&quot;</span>&nbsp;)]\n&nbsp;&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">extern</span>&nbsp;<span style=\"color:blue;\">int</span>&nbsp;GetWindowText(&nbsp;HWND&nbsp;hWnd,\n&nbsp;&nbsp;&nbsp;&nbsp;StringBuilder&nbsp;lpString,&nbsp;<span style=\"color:blue;\">int</span>&nbsp;nMaxCount&nbsp;);\n \n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;Returns&nbsp;the&nbsp;main&nbsp;Window&nbsp;Handle&nbsp;for&nbsp;the&nbsp;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;Process&nbsp;Id&nbsp;(pid)&nbsp;passed&nbsp;in.</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;IF&nbsp;the&nbsp;Main&nbsp;Window&nbsp;is&nbsp;not&nbsp;found&nbsp;then&nbsp;a&nbsp;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;handle&nbsp;value&nbsp;of&nbsp;Zreo&nbsp;is&nbsp;returned,&nbsp;no&nbsp;handle.</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;/</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">param</span><span style=\"color:gray;\">&nbsp;name</span><span style=\"color:gray;\">=</span><span style=\"color:gray;\">&quot;</span>pid<span style=\"color:gray;\">&quot;</span><span style=\"color:gray;\">&gt;&lt;/</span><span style=\"color:gray;\">param</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">returns</span><span style=\"color:gray;\">&gt;&lt;/</span><span style=\"color:gray;\">returns</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:blue;\">public</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>&nbsp;GetMainWindow(&nbsp;<span style=\"color:blue;\">int</span>&nbsp;pid&nbsp;)\n&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;HWND&nbsp;shellWindow&nbsp;=&nbsp;GetShellWindow();\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">List</span>&lt;HWND&gt;&nbsp;windowsForPid&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;<span style=\"color:#2b91af;\">List</span>&lt;<span style=\"color:#2b91af;\">IntPtr</span>&gt;();\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">try</span>\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EnumWindows(\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;EnumWindowsProc&nbsp;Function,&nbsp;does&nbsp;the&nbsp;work&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;on&nbsp;each&nbsp;window.</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">delegate</span>&nbsp;(&nbsp;HWND&nbsp;hWnd,&nbsp;<span style=\"color:blue;\">int</span>&nbsp;lParam&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;hWnd&nbsp;==&nbsp;shellWindow&nbsp;)&nbsp;<span style=\"color:blue;\">return</span>&nbsp;<span style=\"color:blue;\">true</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;!IsWindowVisible(&nbsp;hWnd&nbsp;)&nbsp;)&nbsp;<span style=\"color:blue;\">return</span>&nbsp;<span style=\"color:blue;\">true</span>;\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">uint</span>&nbsp;windowPid&nbsp;=&nbsp;0;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetWindowThreadProcessId(&nbsp;hWnd,&nbsp;<span style=\"color:blue;\">out</span>&nbsp;windowPid&nbsp;);\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;if&nbsp;window&nbsp;is&nbsp;from&nbsp;Pid&nbsp;of&nbsp;interest,&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;see&nbsp;if&nbsp;it&#39;s&nbsp;the&nbsp;Main&nbsp;Window</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;windowPid&nbsp;==&nbsp;pid&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;By&nbsp;default&nbsp;Main&nbsp;Window&nbsp;has&nbsp;a&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Parent&nbsp;Window&nbsp;of&nbsp;Zero,&nbsp;no&nbsp;parent.</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HWND&nbsp;parentHwnd&nbsp;=&nbsp;GetParent(&nbsp;hWnd&nbsp;);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;parentHwnd&nbsp;==&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>.Zero&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;windowsForPid.Add(&nbsp;hWnd&nbsp;);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">return</span>&nbsp;<span style=\"color:blue;\">true</span>;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;lParam,&nbsp;nothing,&nbsp;null...</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;0&nbsp;);\n&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">catch</span>(&nbsp;<span style=\"color:#2b91af;\">Exception</span>&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;}\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">return</span>&nbsp;DetermineMainWindow(&nbsp;windowsForPid&nbsp;);\n&nbsp;&nbsp;}\n \n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;Finds&nbsp;Revit&#39;s&nbsp;Main&nbsp;Window&nbsp;from&nbsp;the&nbsp;list&nbsp;of&nbsp;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;window&nbsp;handles&nbsp;passed&nbsp;in.</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;If&nbsp;the&nbsp;Main&nbsp;Window&nbsp;for&nbsp;Revit&nbsp;is&nbsp;not&nbsp;found&nbsp;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;then&nbsp;a&nbsp;Null&nbsp;(IntPtr.Zero)&nbsp;handle&nbsp;is&nbsp;returnd.</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;/</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">param</span><span style=\"color:gray;\">&nbsp;name</span><span style=\"color:gray;\">=</span><span style=\"color:gray;\">&quot;</span>handles<span style=\"color:gray;\">&quot;</span><span style=\"color:gray;\">&gt;&lt;/</span><span style=\"color:gray;\">param</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">returns</span><span style=\"color:gray;\">&gt;&lt;/</span><span style=\"color:gray;\">returns</span><span style=\"color:gray;\">&gt;</span>\n&nbsp;&nbsp;<span style=\"color:blue;\">private</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>&nbsp;DetermineMainWindow(&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">List</span>&lt;HWND&gt;&nbsp;handles&nbsp;)\n&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Safty&nbsp;conditions,&nbsp;bail&nbsp;if&nbsp;not&nbsp;met.</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;handles&nbsp;==&nbsp;<span style=\"color:blue;\">null</span>&nbsp;||&nbsp;handles.Count&nbsp;&lt;=&nbsp;0&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">return</span>&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>.Zero;\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;default&nbsp;Null&nbsp;handel</span>\n&nbsp;&nbsp;&nbsp;&nbsp;HWND&nbsp;mainWindow&nbsp;=&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>.Zero;\n \n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;only&nbsp;one&nbsp;window&nbsp;so&nbsp;return&nbsp;it,&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;must&nbsp;be&nbsp;the&nbsp;Main&nbsp;Window??</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;handles.Count&nbsp;==&nbsp;1&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mainWindow&nbsp;=&nbsp;handles[0];\n&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;more&nbsp;than&nbsp;one&nbsp;window</span>\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">else</span>\n&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;more&nbsp;than&nbsp;one&nbsp;candidate&nbsp;for&nbsp;Main&nbsp;Window&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;so&nbsp;find&nbsp;the&nbsp;Main&nbsp;Window&nbsp;by&nbsp;its&nbsp;Title,&nbsp;it&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;will&nbsp;contain&nbsp;&quot;Autodesk&nbsp;Revit&quot;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">foreach</span>(&nbsp;<span style=\"color:blue;\">var</span>&nbsp;hWnd&nbsp;<span style=\"color:blue;\">in</span>&nbsp;handles&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">int</span>&nbsp;length&nbsp;=&nbsp;GetWindowTextLength(&nbsp;hWnd&nbsp;);\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;length&nbsp;==&nbsp;0&nbsp;)&nbsp;<span style=\"color:blue;\">continue</span>;\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StringBuilder&nbsp;builder&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;StringBuilder(&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;length&nbsp;);\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetWindowText(&nbsp;hWnd,&nbsp;builder,&nbsp;length&nbsp;+&nbsp;1&nbsp;);\n \n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Depending&nbsp;on&nbsp;the&nbsp;Title&nbsp;of&nbsp;the&nbsp;Main&nbsp;Window&nbsp;</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;to&nbsp;have&nbsp;&quot;Autodesk&nbsp;Revit&quot;&nbsp;in&nbsp;it.</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;builder.ToString().ToLower().Contains(&nbsp;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#a31515;\">&quot;autodesk&nbsp;revit&quot;</span>&nbsp;)&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mainWindow&nbsp;=&nbsp;hWnd;\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">break</span>;&nbsp;<span style=\"color:green;\">//&nbsp;found&nbsp;Main&nbsp;Window&nbsp;stop&nbsp;and&nbsp;return&nbsp;it.</span>\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;}\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">return</span>&nbsp;mainWindow;\n&nbsp;&nbsp;}\n&nbsp;&nbsp;<span style=\"color:blue;\">#endregion</span>\n}\n</pre>\n\n\n####<a name=\"6\"></a>Second Issue Context\n\nWith the main window found and working for Revit 2016 and 2017, all was good and a couple more WPF modeless applications were developed. Then came Revit 2018...\n\n####<a name=\"7\"></a>The Second Problem\n\nWhile porting our add-in(s) to Revit 2018, we noticed Revit lose focus from time to time. When our modeless (WinForms based) add-in window was closed, Revit was not left on top with focus; instead, the application that had focus <b>before</b> Revit was placed on top. This was a surprise, being something that Windows should handle. Notable was this new losing focus behavior was only seen in Revit 2018, and not in 2017 or 2016.\n\nAn example of the sequence would be:\n\n- Open Revit\n- Open Windows File Manager and ensure it is placed on top of Revit\n- Switch back to Revit\n- Open the add-in\n- Close the add-in\n\nFile Manager would now be placed on top, i.e., Revit lost its position in the application stack/show, and was replaced by File Manager.\n\nThe above was the case for the WinForms based add-ins, but WPF based add-ins needed additional steps:\n\n- Open Revit\n- Open Windows File Manager and ensure it is placed on top of Revit\n- Switch back to Revit\n- Open the add-in\n- Open a modal dialog from the modeless add-in\n- Close the modal dialog\n- Close the add-in\n\nFile Manager would then be placed on top, replacing Revit as the top application.\n\n####<a name=\"8\"></a>The Second Resolution\n\nThe resolution for the loss of focus ended up being somewhat simple.\n\nI registered for the `OnClosing` event in the add-in's main window. Within the `OnClosing` event handler, I set Revit to be on top with the User32.dll call `SetForegroundWindow`.\n\nBecause the owner/parent of the add-in window was set correctly for Revit, setting the add-in's owner (Revit) on closing to be in the foreground solved the focus problem.\n\nNOTE: See the section “Code for Second Resolution” below for the solution to this issue.\n\nTo Run the Sample Add-In:\n\n- Open Revit 2018\n- Open File Manager, ensure it is on top of Revit\n- Switch back Revit, bring Revit to the top\n- To see the solution\n- Pick the “Id8 Revit 2018 Focus Solution” command From the Add-Ins Panel > Extern Tools\n- Press the “Start Dialog” button\n- Close the new dialog\n- Close the Add-In dialog\n- Revit Stays on top\n- To see the Focus issue\n- Pick the “Id8 Revit 2018 Focus Solution” command From the Add-Ins Panel > Extern Tools\n- Uncheck the “Fix Focus Issue” checkbox\n- Press the “Start Dialog” button\n- Close the new dialog\n- Close the Add-In dialog\n- Revit is no longer on top, replaced by File Manager\n\n####<a name=\"9\"></a>Code Example for Second Resolution\n\n<pre class=\"code\">\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;User32&nbsp;calls&nbsp;used&nbsp;to&nbsp;set&nbsp;Revit&nbsp;focus</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;/</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n[DllImport(&nbsp;<span style=\"color:#a31515;\">&quot;USER32.DLL&quot;</span>&nbsp;)]\n<span style=\"color:blue;\">internal</span>&nbsp;<span style=\"color:blue;\">static</span>&nbsp;<span style=\"color:blue;\">extern</span>&nbsp;<span style=\"color:blue;\">bool</span>&nbsp;SetForegroundWindow(&nbsp;HWND&nbsp;hWnd&nbsp;);\n \n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;Use&nbsp;the&nbsp;OnClose&nbsp;event&nbsp;to&nbsp;ensure&nbsp;Revit&nbsp;is&nbsp;brought&nbsp;back&nbsp;into&nbsp;focus.</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;/</span><span style=\"color:gray;\">summary</span><span style=\"color:gray;\">&gt;</span>\n<span style=\"color:gray;\">///</span><span style=\"color:green;\">&nbsp;</span><span style=\"color:gray;\">&lt;</span><span style=\"color:gray;\">param</span><span style=\"color:gray;\">&nbsp;name</span><span style=\"color:gray;\">=</span><span style=\"color:gray;\">&quot;</span>e<span style=\"color:gray;\">&quot;</span><span style=\"color:gray;\">&gt;&lt;/</span><span style=\"color:gray;\">param</span><span style=\"color:gray;\">&gt;</span>\n<span style=\"color:blue;\">protected</span>&nbsp;<span style=\"color:blue;\">override</span>&nbsp;<span style=\"color:blue;\">void</span>&nbsp;OnClosing(&nbsp;CancelEventArgs&nbsp;e&nbsp;)\n{\n&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;do&nbsp;the&nbsp;base&nbsp;work&nbsp;first.</span>\n&nbsp;&nbsp;<span style=\"color:blue;\">base</span>.OnClosing(&nbsp;e&nbsp;);\n \n&nbsp;&nbsp;<span style=\"color:green;\">//&nbsp;Set&nbsp;Revit&nbsp;to&nbsp;the&nbsp;foreground</span>\n&nbsp;&nbsp;<span style=\"color:blue;\">try</span>\n&nbsp;&nbsp;{\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>&nbsp;ownerIntPtr&nbsp;=&nbsp;<span style=\"color:blue;\">new</span>&nbsp;WindowInteropHelper(&nbsp;<span style=\"color:blue;\">this</span>&nbsp;).Owner;\n&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color:blue;\">if</span>(&nbsp;ownerIntPtr&nbsp;!=&nbsp;<span style=\"color:#2b91af;\">IntPtr</span>.Zero&nbsp;)\n&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;User32.SetForegroundWindow(&nbsp;ownerIntPtr&nbsp;);\n&nbsp;&nbsp;}\n&nbsp;&nbsp;<span style=\"color:blue;\">catch</span>(&nbsp;<span style=\"color:#2b91af;\">Exception</span>&nbsp;)\n&nbsp;&nbsp;{&nbsp;}\n}\n</pre>\n\nVery many thanks to Hank for his persistent research and sharing this valuable solution.\n\n####<a name=\"10\"></a>Warning! Things Will Change in the Next Release\n\nI myself always used the `JtWindowHandle` class to retrieve the main Revit window handle in the past, and use that\nto [set up the parent window relationship for my modeless forms](http://thebuildingcoder.typepad.com/blog/2010/06/revit-parent-window.html) for\nsimple single modeless forms.\n\nI have been warned by the development team that this method will cease to work in the next major release of Revit, after Revit 2018:\n\nA developer followed the advice \nto [ensure a WPF add-in remains in foreground](http://thebuildingcoder.typepad.com/blog/2012/10/ensure-wpf-add-in-remains-in-foreground.html) in\nbuilding a new add-in. \n\nThis was written about 5 years ago.\n\nAs of the next major release of Revit, the method described there will no longer work.\n\nAn easy way to fix this will be provided. The Revit API will include new API calls providing an official way to get the application window handle:\n\n- Get the handle of the Revit main window.\n- Return the main window handle of the Revit application. This handle should be used when displaying modal dialogs and message windows to ensure that they are properly parented. This property replaces the *System.Diagnostics.Process.GetCurrentProcess()* `MainWindowHandle` property."
  }
]