[
  {
    "original_filename": "0345_manual_regeneration",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0345_manual_regeneration",
    "header_text": "Manual Regeneration Option Danger",
    "local_header_href": "#manual-regeneration-option-danger",
    "chunk_text": "<h3>Manual Regeneration Option Danger</h3><p>Here is a serious issue that several developers have already run into when migrating to the Revit 2011 API, including myself.\nIt sometimes causes pretty obscure errors which are hard to understand and very easy to resolve, once you understand the source.\nObviously it is best and most efficient to completely avoid running into the problem at all, which I hope this post will help you do.\n\n<p>The issue is the regeneration option, one of the required attributes that must be set on every external command in this version.\n\n<p>For instance, when\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/03/porting-the-building-coder-samples-to-revit-2011.html\">\nporting The Building Coder samples</a>\n to \n\nRevit 2011,\n I globally set the regeneration option to manual, e.g.\n\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Automatic )]\n[<span class=\"teal\">Regeneration</span>( <span class=\"teal\">RegenerationOption</span>.Manual )]\n<span class=\"blue\">class</span> <span class=\"teal\">CmdCollectorPerformance</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  . . .\n</pre>\n<p>This is a very risky choice to make, since the manual regeneration mode will cause different behaviour than in Revit 2010.\n\n<p>The less risky choice is to set it to automatic, since that will retain the same behaviour experienced in the Revit 2010 API.\nIf you use manual regeneration mode and your code makes any change to the Revit model and then queries it for data that has been affected by the changes, the returned data will be stale, i.e. out of date.\n\n<p>If in doubt, when migrating moderately complex code to the new version, the safer choice is to always use the automatic mode instead.\nOne very minor disadvantage of this is that this issues a warning during compilation:\n\n<ul>\n<li>warning CS0618: 'Autodesk.Revit.Attributes.RegenerationOption.Automatic' is obsolete: \n'Use of RegenerationOpton.Automatic is deprecated and will be removed in a future release. \nAutodesk recommends converting all Revit API code to use the RegenerationOption.Manual option.'\n</li></ul>\n<p>I chose the manual mode for my sample code for several reasons:\n\n<ul>\n<li>To avoid this compilation warning.\n<li>Knowing that almost all of the sample commands are very short and trivial in nature and do not modify the model and query it for data afterwards.\n<li>Knowing that this is not production code.\n</li></li></li></ul>\n<p>This choice did cause a problem in one of the Revit API introduction labs, Lab2_0_CreateLittleHouse, which adds several building elements to the model and in some cases modifies them afterwards.\nThe area which initially did not work at all and actually threw an exception during execution was the section setting the roof slope:\n\n<pre class=\"code\">\n<span class=\"teal\">FootPrintRoof</span> roof = createDoc.NewFootPrintRoof(\n  profile, levelTop, roofType, <span class=\"blue\">out</span> modelCurves );\n<span class=\"blue\">double</span> slopeAngle = 30 * <span class=\"teal\">LabConstants</span>.DegreesToRadians;\n<span class=\"blue\">foreach</span>( <span class=\"teal\">ModelCurve</span> curve <span class=\"blue\">in</span> modelCurves )\n{\n  roof.set_DefinesSlope( curve, <span class=\"blue\">true</span> );\n  roof.set_SlopeAngle( curve, slopeAngle );\n}\n</pre>\n<p>This code creates a new roof, which returns the automatically generated roof edge curves in the modelCurves array.\nIt then iterates over them to set the DefinesSlope and SlopeAngle properties on each.\nThis worked perfectly well in Revit 2010, and also in 2011 with automatic regeneration mode.\nWith the manual mode, however, it causes the following error:\n\n<ul>\n<li>Unable to access curves from the roof sketch.\n</li></ul>\n<p>The reason is that the model has been modified by the addition of the model curves, but these changes have not yet propagated far enough through the model for us to already access and modify their properties.\nThis can easily be resolved once you understand the problem, which simply consists in the addition of a call to doc.Regenerate:\n\n<pre class=\"code\">\n<span class=\"teal\">FootPrintRoof</span> roof = createDoc.NewFootPrintRoof(\n  profile, levelTop, roofType, <span class=\"blue\">out</span> modelCurves );\ndoc.Regenerate();\n<span class=\"blue\">double</span> slopeAngle = 30 * <span class=\"teal\">LabConstants</span>.DegreesToRadians;\n<span class=\"blue\">foreach</span>( <span class=\"teal\">ModelCurve</span> curve <span class=\"blue\">in</span> modelCurves )\n{\n  roof.set_DefinesSlope( curve, <span class=\"blue\">true</span> );\n  roof.set_SlopeAngle( curve, slopeAngle );\n}\n</pre>\n<p>I discussed another example of using \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/03/performance-profiling.html#manual_regen\">\nmanual regeneration mode</a> with\n\nMarcelo Quevedo to update the model after a call to SetLocationPoint on a column.\nIn that case, Marcelo again decided to add appropriate calls to doc.Regenerate to keep the model in synch.\n\n<p>In yet another recent case, Winston Yaw of\n\n<a href=\"http://www.risatech.com\">\nRISA Technologies</a> had\n\na problem accessing the analytical model curve of a newly created slanted column.\nAgain, the problem was the regeneration option being set to manual. \nOnce it was set to automatic, everything worked perfectly.\nAnother issue that Winston encountered that was also caused by the manual regeneration option was setting the vertical projection parameter for a new slab.\n\n<p>In summary, please be aware of the effect of the regeneration option on your code.\nIf in any doubt whatsoever, when migrating existing code to the Revit 2011 API, your safest bet will be to set it to automatic.\n</p></p></p></p></p></p></p></p></p></p></p></p></p>"
  }
]