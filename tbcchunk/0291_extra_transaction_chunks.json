[
  {
    "original_filename": "0291_extra_transaction",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0291_extra_transaction",
    "header_text": "Extra Transaction Required",
    "local_header_href": "#extra-transaction-required",
    "chunk_text": "<h3>Extra Transaction Required</h3><p>Here is another interesting issue to discuss in between the series of instalments of background information on the Revit API geometry library from Scott's Autodesk University presentation on \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/01/analyse-building-geometry.html\">\nanalysing building geometry</a>.\n\n<p>As we mentioned repeatedly in the past, Revit automatically opens a transaction when an external command is invoked, and closes or aborts it when the command terminates, depending on the command result returned by the Execute method.\nThis affects the \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2008/12/document-ismodified-property.html\">\ndocument IsModified property</a> and \n\nclarifies why you need to open you own transactions for certain \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/01/transactions.html\">\nevent handlers</a> and \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/12/modeless-dialogues-in-revit.html\">\nmodeless dialogues</a>,\n\nforcing you to take on some \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/01/transaction-responsibility.html\">\ntransaction responsibility</a> yourself.\n\nIt is therefore always easier and more robust to \n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2009/06/export-family-instance-to-gbxml.html#1\">\nuse a modal dialogue</a> instead of a modeless one, if that is possible.\n\n<p>Here is an example from a case handled by Joe Ye of a situation where we are forced to open our own transaction in spite of executing code within a normal modal external command context.\nThis is because in this specific situation, certain actions of our command depend on previous actions having completed, and this does apparently not always happen automatically.\nBy encapsulating the first step in its own transaction and closing that, the second step depending on it can execute correctly as well.\n\n<p><strong>Question:</strong> I have created a new I beam in my Revit model. \nI then use the Revit API to apply the following modifications to it:\n\n<ol>\n<li>Change the beam's \"Vertical Projection\" property to \"Center of Beam\".\n<li>Change the beam's \"Z Direction Justification\" property to \"Center\".\n<li>Create two rectangular openings to hold the beam using the beam's start and end points as center points and defining rectangles around them.\n</li></li></li></ol>\n<p>Of the two openings, the first is created in the wrong position, while the second one, at the end of the beam, is created correctly. \nIt seems as if the first opening is created before the \"Z Direction Justification\" is changed, and the second one afterwards.\n\n<p><strong>Answer:</strong> This issue has to do with the model update. \nThe changes to the Z direction justification and vertical projection properties modify the model.\n\nApparently, these changes have not yet been completely applied to the model before the creation of the openings is launched.\nThe complete changes are only guaranteed to be applied to the model after the external command has completely terminated and its automatic transaction has been closed.\n\n<p>In this case, it appears that the property modifications have not been applied when the first opening is created. \nThe creation of the first opening affects the model in a way as to apply the property modifications as well, and therefore the second opening can make use of the updated properties, whereas the first one could not.\nThis explains why the first opening ended up in the wrong position and the second was correct.\n\n<p>The solution for this is to add a transaction to encapsulate the process of changing the two parameter values. \nThis makes sure the beam is updated. \nAfter modifying the properties and closing the transaction, the two openings can be added successfully.\n\n<p>Here is a sample code snippet demonstrating this:\n\n<pre class=\"code\">\n<span class=\"blue\">using</span> <span class=\"teal\">RvtElement</span> = Autodesk.Revit.<span class=\"teal\">Element</span>;\n<span class=\"blue\">using</span> <span class=\"teal\">CreationDocument</span> = Autodesk.Revit.Creation.<span class=\"teal\">Document</span>;\n\n<span class=\"blue\">public</span> <span class=\"teal\">IExternalCommand</span>.<span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n    <span class=\"teal\">ElementSet</span> elements )\n{\n  <span class=\"teal\">Application</span> app = commandData.Application;\n  <span class=\"teal\">Document</span> doc = app.ActiveDocument;\n  <span class=\"teal\">View</span> view = commandData.View;\n \n  <span class=\"teal\">ElementSet</span> elemSet = view.Elements;\n \n  <span class=\"teal\">IEnumerator</span> elementEnumerator \n    = elemSet.ForwardIterator();\n \n  <span class=\"blue\">while</span>( elementEnumerator.MoveNext() )\n  {\n    <span class=\"teal\">FamilyInstance</span> fi = elementEnumerator.Current \n      <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n \n    <span class=\"blue\">if</span>( <span class=\"blue\">null</span> != fi )\n    {\n      <span class=\"teal\">CurveArray</span> curves = <span class=\"blue\">new</span> <span class=\"teal\">CurveArray</span>();\n \n      app.ActiveDocument.BeginTransaction();\n \n      <span class=\"green\">// set the Vertical Projection</span>\n \n      <span class=\"teal\">Parameter</span> p = fi.get_Parameter( \n        <span class=\"teal\">BuiltInParameter</span>.BEAM_V_JUSTIFICATION );\n \n      p.Set( 1 );\n \n      p = fi.get_Parameter( <span class=\"teal\">BuiltInParameter</span>\n        .STRUCTURAL_ANALYTICAL_PROJECT_MEMBER_PLANE );\n \n      <span class=\"blue\">if</span>( p != <span class=\"blue\">null</span> )\n      {\n        <span class=\"teal\">ElementId</span> elemId = p.AsElementId();\n \n        elemId.Value = -3;\n \n        p.Set( <span class=\"blue\">ref</span> elemId );\n      }\n \n      <span class=\"green\">// Vertical Projection modification ends here</span>\n \n      app.ActiveDocument.EndTransaction();\n \n      <span class=\"teal\">LocationCurve</span> lc = fi.Location <span class=\"blue\">as</span> <span class=\"teal\">LocationCurve</span>;\n \n      <span class=\"teal\">XYZ</span> pointOnPlane = lc.Curve.get_EndPoint( 0 );\n \n      <span class=\"teal\">XYZ</span> hostY = fi.FacingOrientation;\n      <span class=\"teal\">XYZ</span> hostX = fi.HandOrientation;\n      <span class=\"teal\">XYZ</span> hostZ = hostX.Cross( hostY );\n \n      curves = CreateRectangle( app, pointOnPlane, \n        hostX, hostZ, 0.5, 0.5 );\n \n      <span class=\"teal\">Opening</span> opening = doc.Create.NewOpening( fi, \n        curves, <span class=\"teal\">CreationDocument</span>.<span class=\"teal\">eRefFace</span>.CenterY );\n \n      pointOnPlane = lc.Curve.get_EndPoint( 1 );\n \n      curves = CreateRectangle( app, pointOnPlane, \n        hostX, hostZ, 0.5, 0.5 );\n \n      opening = doc.Create.NewOpening( fi, \n        curves, <span class=\"teal\">CreationDocument</span>.<span class=\"teal\">eRefFace</span>.CenterY );\n    }\n  }\n  <span class=\"blue\">return</span> <span class=\"teal\">IExternalCommand</span>.<span class=\"teal\">Result</span>.Succeeded;\n}\n</pre>\n<p>So the motto of this is that if you need to perform some model change immediately after some other model changing action, and the second change is closely related to the first, then it is safer to encapsulate the first change in a transaction to ensure that the second one correctly honours it.\n\n<p>Many thanks to Joe for handling this case!\n\n</p></p></p></p></p></p></p></p></p></p></p>"
  }
]