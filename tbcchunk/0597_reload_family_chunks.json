[
  {
    "original_filename": "0597_reload_family",
    "header_text": "Introduction",
    "local_header_href": "#introduction",
    "chunk_text": "<head>\n<link href=\"bc.css\" rel=\"stylesheet\" type=\"text/css\"/>\n</head>"
  },
  {
    "original_filename": "0597_reload_family",
    "header_text": "Reloading a Family",
    "local_header_href": "#reloading-a-family",
    "chunk_text": "<h3>Reloading a Family</h3><p>Here is an impressively complete list of pretty fundamental beginner's issues that you might potentially run into when reloading a family, starting from scratch, from a recent case handled by my colleague Joe Ye.\nOne of the interesting points that Joe ends up making is that in order to reload a family that has already been loaded into the document, you can use the LoadFamily overload taking an\n\n<a href=\"http://thebuildingcoder.typepad.com/blog/2010/02/ifamilyloadoptions-and-gemini.html\">\nIFamilyLoadOptions</a> argument.\n\nBefore and after getting to that stage, here are some other issues that you can potentially run into and need to resolve:\n\n<ol>\n<li><a href=\"#1\">Replacing the family type or symbol of a family instance with another type</a>.\n<li><a href=\"#2\">Setting up an appropriate transaction</a>.\n<li><a href=\"#3\">Reloading an already loaded family</a>.\n<li><a href=\"#4\">Creating a new family type</a>.\n</li></li></li></li></ol>\n<a name=\"1\"></a>\n<h4>1. Changing the Symbol of a Family Instance</h4>\n<p><strong>Question:</strong> How can I replace the family type or symbol of a family instance with some other type via the API?\n\n<p><strong>Answer:</strong> The type of a family instance can be changed by modifying its Symbol property. \nYou can simply assign a new FamilySymbol instance to FamilyInstance.Symbol property.\nHere is some pseudo code to illustrate this:\n\n<pre class=\"code\">\n  // the code to retrieve the new family symbol:\n\n  FamilySymbol newSymbol = ... ;\n\n  // the code to access the family instance:\n\n  FamilyInstance famInstance = ... ;\n\n  // change the family instance type:\n\n  famInstance.Symbol = symbol1;\n</pre>\n<p>By the way, the Revit SDK provides the Revit Developer Guide PDF file, which can guide you to the knowledge of programming on Revit and also provides some real sample code to achieve exactly what you need.\n\n\n\n<a name=\"2\"></a>\n<h4>2. Setting up an Appropriate Transaction</h4>\n<p><strong>Question:</strong> I followed your advice, but now I am facing an exception saying \"A sub-transaction can only be active inside an open Transaction\" in the following line:\n\n<pre class=\"code\">\n  // add a new type and edit its parameters \n  FamilyType newFamilyType \n    = familyManager.NewType(\"2X2\"); \n</pre>\n<p>I am trying to add a new type to the family in order to assign that as a replacement symbol to the family instance.\nWhat could be going wrong here?\n\n<p><strong>Answer:</strong> The reason might be that you have set up a manual transaction mode for your command. \nYou have to specify either manual or automatic transaction mode for you command.\nYou probably set up manual mode but omitted to explicitly start a transaction.\nYou can either change the mode to Automatic, or leave it as Manual and add the code to start and commit the transaction.\n\n<p>Here is an example of automatic transaction mode: \n\n<pre class=\"code\">\n[<span class=\"teal\">TransactionAttribute</span>( <span class=\"teal\">TransactionMode</span>.Automatic )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">RevitCommand</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> messages,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">UIApplication</span> app = commandData.Application;\n    <span class=\"teal\">Document</span> doc = app.ActiveUIDocument.Document;\n \n    EditFamilyTypes( doc, famInstance );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>Here is an example of retaining the manual transaction model: start your own transaction first, and then commit it after executing the code to change the model:\n\n<pre class=\"code\">\n[<span class=\"teal\">TransactionAttribute</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">RevitCommand</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute( \n    <span class=\"teal\">ExternalCommandData</span> commandData, \n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> messages, \n    <span class=\"teal\">ElementSet</span> elements )\n  {\n \n    <span class=\"teal\">UIApplication</span> app = commandData.Application;\n    <span class=\"teal\">Document</span> doc = app.ActiveUIDocument.Document;\n \n    <span class=\"teal\">Transaction</span> trans = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc, <span class=\"maroon\">\"ExComm\"</span> );\n    trans.Start();\n \n    EditFamilyTypes( doc, famInstance );\n \n    trans.Commit();\n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n} \n</pre>\n<a name=\"3\"></a>\n<h4>3. Reloading an Already Loaded Family</h4>\n<p><strong>Question:</strong> The transaction handling improved matters.\nNow the execution stops at the line\n\n\n<pre class=\"code\">\n  family = familyDoc.LoadFamily(doc); \n</pre>\n\nIt returns an error saying \"Family loading failed\".\n\n<p><strong>Answer:</strong> The error occurs because the family is already present in the current model. \nIf you use the Document.LoadFamily method overload taking a Document argument only to reload an existing family document, it will always fail.\nInstead, you should use the LoadFamily overload that accepts an argument implementing the IFamilyLoadOptions interface.\nHere is a simple implementation of such a class:\n\n<pre class=\"code\">\n<span class=\"blue\">class</span> <span class=\"teal\">FamilyOption</span> : <span class=\"teal\">IFamilyLoadOptions</span>\n{\n  <span class=\"blue\">public</span> <span class=\"blue\">bool</span> OnFamilyFound(\n    <span class=\"blue\">bool</span> familyInUse,\n    <span class=\"blue\">ref</span> <span class=\"blue\">bool</span> overwriteParameterValues )\n  {\n    overwriteParameterValues = <span class=\"blue\">true</span>;\n    <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">bool</span> OnSharedFamilyFound(\n    <span class=\"teal\">Family</span> sharedFamily,\n    <span class=\"blue\">bool</span> familyInUse,\n    <span class=\"blue\">ref</span> <span class=\"teal\">FamilySource</span> source,\n    <span class=\"blue\">ref</span> <span class=\"blue\">bool</span> overwriteParameterValues )\n  {\n    <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n  }\n}\n</pre>\n<p>With the IFamilyLoadOptions implementation in place, you can call the appropriate LoadFamily overload:\n\n<pre class=\"code\">\n  family = familyDoc.LoadFamily(\n    doc, new FamilyOption() );\n</pre>\n<!--\n\n<p>Using this complicated sample to show the usage of changing a family type is not necessary, so I also wrote a simple command that changes a selected family instance symbol/type. \nIt retrieves all available family symbols that can be used for the picked family instance, and assigns one of them to the family instance:\n\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n[<span class=\"teal\">Regeneration</span>( <span class=\"teal\">RegenerationOption</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Command1</span> : <span class=\"teal\">IExternalCommand</span>\n{\n&nbsp; <span class=\"blue\">public</span> <span class=\"teal\">UIApplication</span> app;\n&nbsp; <span class=\"blue\">public</span> <span class=\"teal\">Document</span> doc;\n&nbsp; <span class=\"blue\">public</span> <span class=\"teal\">UIDocument</span> uidoc;\n&nbsp;\n&nbsp; <span class=\"teal\">Result</span> <span class=\"teal\">IExternalCommand</span>.Execute(\n&nbsp; &nbsp; <span class=\"teal\">ExternalCommandData</span> commandData,\n&nbsp; &nbsp; <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n&nbsp; &nbsp; <span class=\"teal\">ElementSet</span> elements )\n&nbsp; {\n&nbsp; &nbsp; app = commandData.Application;\n&nbsp; &nbsp; doc = app.ActiveUIDocument.Document;\n&nbsp; &nbsp; uidoc = <span class=\"blue\">new</span> <span class=\"teal\">UIDocument</span>( doc );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">Transaction</span> trans = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc );\n&nbsp; &nbsp; trans.Start( <span class=\"maroon\">&quot;changeSymbol&quot;</span> );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">Selection</span> sel = uidoc.Selection;\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">Reference</span> ref1 = sel.PickObject(\n&nbsp; &nbsp; &nbsp; <span class=\"teal\">ObjectType</span>.Element,\n&nbsp; &nbsp; &nbsp; <span class=\"maroon\">&quot;Please pick a family instance&quot;</span> );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">FamilyInstance</span> famInstance = ref1.Element <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">FamilySymbol</span> famSymbol = famInstance.Symbol;\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">ICollection</span>&lt;<span class=\"teal\">ElementId</span>&gt; symbols = famSymbol.GetSimilarTypes();\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">FamilySymbol</span> famSymbolOther = <span class=\"blue\">null</span>;\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">foreach</span>( <span class=\"teal\">ElementId</span> id <span class=\"blue\">in</span> symbols )\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; <span class=\"blue\">if</span>( <span class=\"blue\">false</span> == id.Equals( famSymbol.Id ) )\n&nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; famSymbolOther = doc.get_Element( id ) <span class=\"blue\">as</span> <span class=\"teal\">FamilySymbol</span>;\n&nbsp; &nbsp; &nbsp; &nbsp; <span class=\"blue\">break</span>;\n&nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">if</span>( famSymbolOther != <span class=\"blue\">null</span> )\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; famInstance.Symbol = famSymbolOther;\n&nbsp; &nbsp; }\n&nbsp;\n&nbsp; &nbsp; trans.Commit();\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n&nbsp; }\n}\n</pre>\n\n-->\n<a name=\"4\"></a>\n<h4>4. Creating a New Family Type</h4>\n<p><strong>Question:</strong> The updated code works fine when I only select one object.\nIf I select more than one object, it gives me error in the following line:\n\n<pre class=\"code\">\n  newFamilyType = familyManager.NewType(\"xx\"); \n</pre>\n\nThe error says \"The type name xx is already in use\".\nI need to able to select and modify the type of more than one object, and assign all of them the new type \"xx\".\nHow can I achieve that, please?\n\n<p><strong>Answer:</strong> If you are trying to change the type of more than one family instance, the new type does not need to be created repeatedly. \nFor the second family instance, you can bypass the code creating a new type using an 'if' conditional statement.\n\n<p>For completeness sake, here is <a href=\"zip/ReloadFamily.zip\">ReloadFamily.zip</a> containing the complete Revit 2011 source code and Visual Studio solution of these various code snippets.\n\n<p>Many thanks to Joe for this exhaustive explanation.\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0597_reload_family",
    "header_text": "1. Changing the Symbol of a Family Instance",
    "local_header_href": "#1-changing-the-symbol-of-a-family-instance",
    "chunk_text": "<h4>1. Changing the Symbol of a Family Instance</h4><p><strong>Question:</strong> How can I replace the family type or symbol of a family instance with some other type via the API?\n\n<p><strong>Answer:</strong> The type of a family instance can be changed by modifying its Symbol property. \nYou can simply assign a new FamilySymbol instance to FamilyInstance.Symbol property.\nHere is some pseudo code to illustrate this:\n\n<pre class=\"code\">\n  // the code to retrieve the new family symbol:\n\n  FamilySymbol newSymbol = ... ;\n\n  // the code to access the family instance:\n\n  FamilyInstance famInstance = ... ;\n\n  // change the family instance type:\n\n  famInstance.Symbol = symbol1;\n</pre>\n<p>By the way, the Revit SDK provides the Revit Developer Guide PDF file, which can guide you to the knowledge of programming on Revit and also provides some real sample code to achieve exactly what you need.\n\n\n\n<a name=\"2\"></a>\n<h4>2. Setting up an Appropriate Transaction</h4>\n<p><strong>Question:</strong> I followed your advice, but now I am facing an exception saying \"A sub-transaction can only be active inside an open Transaction\" in the following line:\n\n<pre class=\"code\">\n  // add a new type and edit its parameters \n  FamilyType newFamilyType \n    = familyManager.NewType(\"2X2\"); \n</pre>\n<p>I am trying to add a new type to the family in order to assign that as a replacement symbol to the family instance.\nWhat could be going wrong here?\n\n<p><strong>Answer:</strong> The reason might be that you have set up a manual transaction mode for your command. \nYou have to specify either manual or automatic transaction mode for you command.\nYou probably set up manual mode but omitted to explicitly start a transaction.\nYou can either change the mode to Automatic, or leave it as Manual and add the code to start and commit the transaction.\n\n<p>Here is an example of automatic transaction mode: \n\n<pre class=\"code\">\n[<span class=\"teal\">TransactionAttribute</span>( <span class=\"teal\">TransactionMode</span>.Automatic )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">RevitCommand</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> messages,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">UIApplication</span> app = commandData.Application;\n    <span class=\"teal\">Document</span> doc = app.ActiveUIDocument.Document;\n \n    EditFamilyTypes( doc, famInstance );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>Here is an example of retaining the manual transaction model: start your own transaction first, and then commit it after executing the code to change the model:\n\n<pre class=\"code\">\n[<span class=\"teal\">TransactionAttribute</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">RevitCommand</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute( \n    <span class=\"teal\">ExternalCommandData</span> commandData, \n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> messages, \n    <span class=\"teal\">ElementSet</span> elements )\n  {\n \n    <span class=\"teal\">UIApplication</span> app = commandData.Application;\n    <span class=\"teal\">Document</span> doc = app.ActiveUIDocument.Document;\n \n    <span class=\"teal\">Transaction</span> trans = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc, <span class=\"maroon\">\"ExComm\"</span> );\n    trans.Start();\n \n    EditFamilyTypes( doc, famInstance );\n \n    trans.Commit();\n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n} \n</pre>\n<a name=\"3\"></a>\n<h4>3. Reloading an Already Loaded Family</h4>\n<p><strong>Question:</strong> The transaction handling improved matters.\nNow the execution stops at the line\n\n\n<pre class=\"code\">\n  family = familyDoc.LoadFamily(doc); \n</pre>\n\nIt returns an error saying \"Family loading failed\".\n\n<p><strong>Answer:</strong> The error occurs because the family is already present in the current model. \nIf you use the Document.LoadFamily method overload taking a Document argument only to reload an existing family document, it will always fail.\nInstead, you should use the LoadFamily overload that accepts an argument implementing the IFamilyLoadOptions interface.\nHere is a simple implementation of such a class:\n\n<pre class=\"code\">\n<span class=\"blue\">class</span> <span class=\"teal\">FamilyOption</span> : <span class=\"teal\">IFamilyLoadOptions</span>\n{\n  <span class=\"blue\">public</span> <span class=\"blue\">bool</span> OnFamilyFound(\n    <span class=\"blue\">bool</span> familyInUse,\n    <span class=\"blue\">ref</span> <span class=\"blue\">bool</span> overwriteParameterValues )\n  {\n    overwriteParameterValues = <span class=\"blue\">true</span>;\n    <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">bool</span> OnSharedFamilyFound(\n    <span class=\"teal\">Family</span> sharedFamily,\n    <span class=\"blue\">bool</span> familyInUse,\n    <span class=\"blue\">ref</span> <span class=\"teal\">FamilySource</span> source,\n    <span class=\"blue\">ref</span> <span class=\"blue\">bool</span> overwriteParameterValues )\n  {\n    <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n  }\n}\n</pre>\n<p>With the IFamilyLoadOptions implementation in place, you can call the appropriate LoadFamily overload:\n\n<pre class=\"code\">\n  family = familyDoc.LoadFamily(\n    doc, new FamilyOption() );\n</pre>\n<!--\n\n<p>Using this complicated sample to show the usage of changing a family type is not necessary, so I also wrote a simple command that changes a selected family instance symbol/type. \nIt retrieves all available family symbols that can be used for the picked family instance, and assigns one of them to the family instance:\n\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n[<span class=\"teal\">Regeneration</span>( <span class=\"teal\">RegenerationOption</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Command1</span> : <span class=\"teal\">IExternalCommand</span>\n{\n&nbsp; <span class=\"blue\">public</span> <span class=\"teal\">UIApplication</span> app;\n&nbsp; <span class=\"blue\">public</span> <span class=\"teal\">Document</span> doc;\n&nbsp; <span class=\"blue\">public</span> <span class=\"teal\">UIDocument</span> uidoc;\n&nbsp;\n&nbsp; <span class=\"teal\">Result</span> <span class=\"teal\">IExternalCommand</span>.Execute(\n&nbsp; &nbsp; <span class=\"teal\">ExternalCommandData</span> commandData,\n&nbsp; &nbsp; <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n&nbsp; &nbsp; <span class=\"teal\">ElementSet</span> elements )\n&nbsp; {\n&nbsp; &nbsp; app = commandData.Application;\n&nbsp; &nbsp; doc = app.ActiveUIDocument.Document;\n&nbsp; &nbsp; uidoc = <span class=\"blue\">new</span> <span class=\"teal\">UIDocument</span>( doc );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">Transaction</span> trans = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc );\n&nbsp; &nbsp; trans.Start( <span class=\"maroon\">&quot;changeSymbol&quot;</span> );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">Selection</span> sel = uidoc.Selection;\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">Reference</span> ref1 = sel.PickObject(\n&nbsp; &nbsp; &nbsp; <span class=\"teal\">ObjectType</span>.Element,\n&nbsp; &nbsp; &nbsp; <span class=\"maroon\">&quot;Please pick a family instance&quot;</span> );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">FamilyInstance</span> famInstance = ref1.Element <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">FamilySymbol</span> famSymbol = famInstance.Symbol;\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">ICollection</span>&lt;<span class=\"teal\">ElementId</span>&gt; symbols = famSymbol.GetSimilarTypes();\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">FamilySymbol</span> famSymbolOther = <span class=\"blue\">null</span>;\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">foreach</span>( <span class=\"teal\">ElementId</span> id <span class=\"blue\">in</span> symbols )\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; <span class=\"blue\">if</span>( <span class=\"blue\">false</span> == id.Equals( famSymbol.Id ) )\n&nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; famSymbolOther = doc.get_Element( id ) <span class=\"blue\">as</span> <span class=\"teal\">FamilySymbol</span>;\n&nbsp; &nbsp; &nbsp; &nbsp; <span class=\"blue\">break</span>;\n&nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">if</span>( famSymbolOther != <span class=\"blue\">null</span> )\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; famInstance.Symbol = famSymbolOther;\n&nbsp; &nbsp; }\n&nbsp;\n&nbsp; &nbsp; trans.Commit();\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n&nbsp; }\n}\n</pre>\n\n-->\n<a name=\"4\"></a>\n<h4>4. Creating a New Family Type</h4>\n<p><strong>Question:</strong> The updated code works fine when I only select one object.\nIf I select more than one object, it gives me error in the following line:\n\n<pre class=\"code\">\n  newFamilyType = familyManager.NewType(\"xx\"); \n</pre>\n\nThe error says \"The type name xx is already in use\".\nI need to able to select and modify the type of more than one object, and assign all of them the new type \"xx\".\nHow can I achieve that, please?\n\n<p><strong>Answer:</strong> If you are trying to change the type of more than one family instance, the new type does not need to be created repeatedly. \nFor the second family instance, you can bypass the code creating a new type using an 'if' conditional statement.\n\n<p>For completeness sake, here is <a href=\"zip/ReloadFamily.zip\">ReloadFamily.zip</a> containing the complete Revit 2011 source code and Visual Studio solution of these various code snippets.\n\n<p>Many thanks to Joe for this exhaustive explanation.\n</p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0597_reload_family",
    "header_text": "2. Setting up an Appropriate Transaction",
    "local_header_href": "#2-setting-up-an-appropriate-transaction",
    "chunk_text": "<h4>2. Setting up an Appropriate Transaction</h4><p><strong>Question:</strong> I followed your advice, but now I am facing an exception saying \"A sub-transaction can only be active inside an open Transaction\" in the following line:\n\n<pre class=\"code\">\n  // add a new type and edit its parameters \n  FamilyType newFamilyType \n    = familyManager.NewType(\"2X2\"); \n</pre>\n<p>I am trying to add a new type to the family in order to assign that as a replacement symbol to the family instance.\nWhat could be going wrong here?\n\n<p><strong>Answer:</strong> The reason might be that you have set up a manual transaction mode for your command. \nYou have to specify either manual or automatic transaction mode for you command.\nYou probably set up manual mode but omitted to explicitly start a transaction.\nYou can either change the mode to Automatic, or leave it as Manual and add the code to start and commit the transaction.\n\n<p>Here is an example of automatic transaction mode: \n\n<pre class=\"code\">\n[<span class=\"teal\">TransactionAttribute</span>( <span class=\"teal\">TransactionMode</span>.Automatic )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">RevitCommand</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute(\n    <span class=\"teal\">ExternalCommandData</span> commandData,\n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> messages,\n    <span class=\"teal\">ElementSet</span> elements )\n  {\n    <span class=\"teal\">UIApplication</span> app = commandData.Application;\n    <span class=\"teal\">Document</span> doc = app.ActiveUIDocument.Document;\n \n    EditFamilyTypes( doc, famInstance );\n \n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n}\n</pre>\n<p>Here is an example of retaining the manual transaction model: start your own transaction first, and then commit it after executing the code to change the model:\n\n<pre class=\"code\">\n[<span class=\"teal\">TransactionAttribute</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">RevitCommand</span> : <span class=\"teal\">IExternalCommand</span>\n{\n  <span class=\"blue\">public</span> <span class=\"teal\">Result</span> Execute( \n    <span class=\"teal\">ExternalCommandData</span> commandData, \n    <span class=\"blue\">ref</span> <span class=\"blue\">string</span> messages, \n    <span class=\"teal\">ElementSet</span> elements )\n  {\n \n    <span class=\"teal\">UIApplication</span> app = commandData.Application;\n    <span class=\"teal\">Document</span> doc = app.ActiveUIDocument.Document;\n \n    <span class=\"teal\">Transaction</span> trans = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc, <span class=\"maroon\">\"ExComm\"</span> );\n    trans.Start();\n \n    EditFamilyTypes( doc, famInstance );\n \n    trans.Commit();\n    <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n  }\n} \n</pre>\n<a name=\"3\"></a>\n<h4>3. Reloading an Already Loaded Family</h4>\n<p><strong>Question:</strong> The transaction handling improved matters.\nNow the execution stops at the line\n\n\n<pre class=\"code\">\n  family = familyDoc.LoadFamily(doc); \n</pre>\n\nIt returns an error saying \"Family loading failed\".\n\n<p><strong>Answer:</strong> The error occurs because the family is already present in the current model. \nIf you use the Document.LoadFamily method overload taking a Document argument only to reload an existing family document, it will always fail.\nInstead, you should use the LoadFamily overload that accepts an argument implementing the IFamilyLoadOptions interface.\nHere is a simple implementation of such a class:\n\n<pre class=\"code\">\n<span class=\"blue\">class</span> <span class=\"teal\">FamilyOption</span> : <span class=\"teal\">IFamilyLoadOptions</span>\n{\n  <span class=\"blue\">public</span> <span class=\"blue\">bool</span> OnFamilyFound(\n    <span class=\"blue\">bool</span> familyInUse,\n    <span class=\"blue\">ref</span> <span class=\"blue\">bool</span> overwriteParameterValues )\n  {\n    overwriteParameterValues = <span class=\"blue\">true</span>;\n    <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">bool</span> OnSharedFamilyFound(\n    <span class=\"teal\">Family</span> sharedFamily,\n    <span class=\"blue\">bool</span> familyInUse,\n    <span class=\"blue\">ref</span> <span class=\"teal\">FamilySource</span> source,\n    <span class=\"blue\">ref</span> <span class=\"blue\">bool</span> overwriteParameterValues )\n  {\n    <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n  }\n}\n</pre>\n<p>With the IFamilyLoadOptions implementation in place, you can call the appropriate LoadFamily overload:\n\n<pre class=\"code\">\n  family = familyDoc.LoadFamily(\n    doc, new FamilyOption() );\n</pre>\n<!--\n\n<p>Using this complicated sample to show the usage of changing a family type is not necessary, so I also wrote a simple command that changes a selected family instance symbol/type. \nIt retrieves all available family symbols that can be used for the picked family instance, and assigns one of them to the family instance:\n\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n[<span class=\"teal\">Regeneration</span>( <span class=\"teal\">RegenerationOption</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Command1</span> : <span class=\"teal\">IExternalCommand</span>\n{\n&nbsp; <span class=\"blue\">public</span> <span class=\"teal\">UIApplication</span> app;\n&nbsp; <span class=\"blue\">public</span> <span class=\"teal\">Document</span> doc;\n&nbsp; <span class=\"blue\">public</span> <span class=\"teal\">UIDocument</span> uidoc;\n&nbsp;\n&nbsp; <span class=\"teal\">Result</span> <span class=\"teal\">IExternalCommand</span>.Execute(\n&nbsp; &nbsp; <span class=\"teal\">ExternalCommandData</span> commandData,\n&nbsp; &nbsp; <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n&nbsp; &nbsp; <span class=\"teal\">ElementSet</span> elements )\n&nbsp; {\n&nbsp; &nbsp; app = commandData.Application;\n&nbsp; &nbsp; doc = app.ActiveUIDocument.Document;\n&nbsp; &nbsp; uidoc = <span class=\"blue\">new</span> <span class=\"teal\">UIDocument</span>( doc );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">Transaction</span> trans = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc );\n&nbsp; &nbsp; trans.Start( <span class=\"maroon\">&quot;changeSymbol&quot;</span> );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">Selection</span> sel = uidoc.Selection;\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">Reference</span> ref1 = sel.PickObject(\n&nbsp; &nbsp; &nbsp; <span class=\"teal\">ObjectType</span>.Element,\n&nbsp; &nbsp; &nbsp; <span class=\"maroon\">&quot;Please pick a family instance&quot;</span> );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">FamilyInstance</span> famInstance = ref1.Element <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">FamilySymbol</span> famSymbol = famInstance.Symbol;\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">ICollection</span>&lt;<span class=\"teal\">ElementId</span>&gt; symbols = famSymbol.GetSimilarTypes();\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">FamilySymbol</span> famSymbolOther = <span class=\"blue\">null</span>;\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">foreach</span>( <span class=\"teal\">ElementId</span> id <span class=\"blue\">in</span> symbols )\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; <span class=\"blue\">if</span>( <span class=\"blue\">false</span> == id.Equals( famSymbol.Id ) )\n&nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; famSymbolOther = doc.get_Element( id ) <span class=\"blue\">as</span> <span class=\"teal\">FamilySymbol</span>;\n&nbsp; &nbsp; &nbsp; &nbsp; <span class=\"blue\">break</span>;\n&nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">if</span>( famSymbolOther != <span class=\"blue\">null</span> )\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; famInstance.Symbol = famSymbolOther;\n&nbsp; &nbsp; }\n&nbsp;\n&nbsp; &nbsp; trans.Commit();\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n&nbsp; }\n}\n</pre>\n\n-->\n<a name=\"4\"></a>\n<h4>4. Creating a New Family Type</h4>\n<p><strong>Question:</strong> The updated code works fine when I only select one object.\nIf I select more than one object, it gives me error in the following line:\n\n<pre class=\"code\">\n  newFamilyType = familyManager.NewType(\"xx\"); \n</pre>\n\nThe error says \"The type name xx is already in use\".\nI need to able to select and modify the type of more than one object, and assign all of them the new type \"xx\".\nHow can I achieve that, please?\n\n<p><strong>Answer:</strong> If you are trying to change the type of more than one family instance, the new type does not need to be created repeatedly. \nFor the second family instance, you can bypass the code creating a new type using an 'if' conditional statement.\n\n<p>For completeness sake, here is <a href=\"zip/ReloadFamily.zip\">ReloadFamily.zip</a> containing the complete Revit 2011 source code and Visual Studio solution of these various code snippets.\n\n<p>Many thanks to Joe for this exhaustive explanation.\n</p></p></p></p></p></p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0597_reload_family",
    "header_text": "3. Reloading an Already Loaded Family",
    "local_header_href": "#3-reloading-an-already-loaded-family",
    "chunk_text": "<h4>3. Reloading an Already Loaded Family</h4><p><strong>Question:</strong> The transaction handling improved matters.\nNow the execution stops at the line\n\n\n<pre class=\"code\">\n  family = familyDoc.LoadFamily(doc); \n</pre>\n\nIt returns an error saying \"Family loading failed\".\n\n<p><strong>Answer:</strong> The error occurs because the family is already present in the current model. \nIf you use the Document.LoadFamily method overload taking a Document argument only to reload an existing family document, it will always fail.\nInstead, you should use the LoadFamily overload that accepts an argument implementing the IFamilyLoadOptions interface.\nHere is a simple implementation of such a class:\n\n<pre class=\"code\">\n<span class=\"blue\">class</span> <span class=\"teal\">FamilyOption</span> : <span class=\"teal\">IFamilyLoadOptions</span>\n{\n  <span class=\"blue\">public</span> <span class=\"blue\">bool</span> OnFamilyFound(\n    <span class=\"blue\">bool</span> familyInUse,\n    <span class=\"blue\">ref</span> <span class=\"blue\">bool</span> overwriteParameterValues )\n  {\n    overwriteParameterValues = <span class=\"blue\">true</span>;\n    <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n  }\n \n  <span class=\"blue\">public</span> <span class=\"blue\">bool</span> OnSharedFamilyFound(\n    <span class=\"teal\">Family</span> sharedFamily,\n    <span class=\"blue\">bool</span> familyInUse,\n    <span class=\"blue\">ref</span> <span class=\"teal\">FamilySource</span> source,\n    <span class=\"blue\">ref</span> <span class=\"blue\">bool</span> overwriteParameterValues )\n  {\n    <span class=\"blue\">return</span> <span class=\"blue\">true</span>;\n  }\n}\n</pre>\n<p>With the IFamilyLoadOptions implementation in place, you can call the appropriate LoadFamily overload:\n\n<pre class=\"code\">\n  family = familyDoc.LoadFamily(\n    doc, new FamilyOption() );\n</pre>\n<!--\n\n<p>Using this complicated sample to show the usage of changing a family type is not necessary, so I also wrote a simple command that changes a selected family instance symbol/type. \nIt retrieves all available family symbols that can be used for the picked family instance, and assigns one of them to the family instance:\n\n<pre class=\"code\">\n[<span class=\"teal\">Transaction</span>( <span class=\"teal\">TransactionMode</span>.Manual )]\n[<span class=\"teal\">Regeneration</span>( <span class=\"teal\">RegenerationOption</span>.Manual )]\n<span class=\"blue\">public</span> <span class=\"blue\">class</span> <span class=\"teal\">Command1</span> : <span class=\"teal\">IExternalCommand</span>\n{\n&nbsp; <span class=\"blue\">public</span> <span class=\"teal\">UIApplication</span> app;\n&nbsp; <span class=\"blue\">public</span> <span class=\"teal\">Document</span> doc;\n&nbsp; <span class=\"blue\">public</span> <span class=\"teal\">UIDocument</span> uidoc;\n&nbsp;\n&nbsp; <span class=\"teal\">Result</span> <span class=\"teal\">IExternalCommand</span>.Execute(\n&nbsp; &nbsp; <span class=\"teal\">ExternalCommandData</span> commandData,\n&nbsp; &nbsp; <span class=\"blue\">ref</span> <span class=\"blue\">string</span> message,\n&nbsp; &nbsp; <span class=\"teal\">ElementSet</span> elements )\n&nbsp; {\n&nbsp; &nbsp; app = commandData.Application;\n&nbsp; &nbsp; doc = app.ActiveUIDocument.Document;\n&nbsp; &nbsp; uidoc = <span class=\"blue\">new</span> <span class=\"teal\">UIDocument</span>( doc );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">Transaction</span> trans = <span class=\"blue\">new</span> <span class=\"teal\">Transaction</span>( doc );\n&nbsp; &nbsp; trans.Start( <span class=\"maroon\">&quot;changeSymbol&quot;</span> );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">Selection</span> sel = uidoc.Selection;\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">Reference</span> ref1 = sel.PickObject(\n&nbsp; &nbsp; &nbsp; <span class=\"teal\">ObjectType</span>.Element,\n&nbsp; &nbsp; &nbsp; <span class=\"maroon\">&quot;Please pick a family instance&quot;</span> );\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">FamilyInstance</span> famInstance = ref1.Element <span class=\"blue\">as</span> <span class=\"teal\">FamilyInstance</span>;\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">FamilySymbol</span> famSymbol = famInstance.Symbol;\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">ICollection</span>&lt;<span class=\"teal\">ElementId</span>&gt; symbols = famSymbol.GetSimilarTypes();\n&nbsp;\n&nbsp; &nbsp; <span class=\"teal\">FamilySymbol</span> famSymbolOther = <span class=\"blue\">null</span>;\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">foreach</span>( <span class=\"teal\">ElementId</span> id <span class=\"blue\">in</span> symbols )\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; <span class=\"blue\">if</span>( <span class=\"blue\">false</span> == id.Equals( famSymbol.Id ) )\n&nbsp; &nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; famSymbolOther = doc.get_Element( id ) <span class=\"blue\">as</span> <span class=\"teal\">FamilySymbol</span>;\n&nbsp; &nbsp; &nbsp; &nbsp; <span class=\"blue\">break</span>;\n&nbsp; &nbsp; &nbsp; }\n&nbsp; &nbsp; }\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">if</span>( famSymbolOther != <span class=\"blue\">null</span> )\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; famInstance.Symbol = famSymbolOther;\n&nbsp; &nbsp; }\n&nbsp;\n&nbsp; &nbsp; trans.Commit();\n&nbsp;\n&nbsp; &nbsp; <span class=\"blue\">return</span> <span class=\"teal\">Result</span>.Succeeded;\n&nbsp; }\n}\n</pre>\n\n-->\n<a name=\"4\"></a>\n<h4>4. Creating a New Family Type</h4>\n<p><strong>Question:</strong> The updated code works fine when I only select one object.\nIf I select more than one object, it gives me error in the following line:\n\n<pre class=\"code\">\n  newFamilyType = familyManager.NewType(\"xx\"); \n</pre>\n\nThe error says \"The type name xx is already in use\".\nI need to able to select and modify the type of more than one object, and assign all of them the new type \"xx\".\nHow can I achieve that, please?\n\n<p><strong>Answer:</strong> If you are trying to change the type of more than one family instance, the new type does not need to be created repeatedly. \nFor the second family instance, you can bypass the code creating a new type using an 'if' conditional statement.\n\n<p>For completeness sake, here is <a href=\"zip/ReloadFamily.zip\">ReloadFamily.zip</a> containing the complete Revit 2011 source code and Visual Studio solution of these various code snippets.\n\n<p>Many thanks to Joe for this exhaustive explanation.\n</p></p></p></p></p></p></p>"
  },
  {
    "original_filename": "0597_reload_family",
    "header_text": "4. Creating a New Family Type",
    "local_header_href": "#4-creating-a-new-family-type",
    "chunk_text": "<h4>4. Creating a New Family Type</h4><p><strong>Question:</strong> The updated code works fine when I only select one object.\nIf I select more than one object, it gives me error in the following line:\n\n<pre class=\"code\">\n  newFamilyType = familyManager.NewType(\"xx\"); \n</pre>\n\nThe error says \"The type name xx is already in use\".\nI need to able to select and modify the type of more than one object, and assign all of them the new type \"xx\".\nHow can I achieve that, please?\n\n<p><strong>Answer:</strong> If you are trying to change the type of more than one family instance, the new type does not need to be created repeatedly. \nFor the second family instance, you can bypass the code creating a new type using an 'if' conditional statement.\n\n<p>For completeness sake, here is <a href=\"zip/ReloadFamily.zip\">ReloadFamily.zip</a> containing the complete Revit 2011 source code and Visual Studio solution of these various code snippets.\n\n<p>Many thanks to Joe for this exhaustive explanation.\n</p></p></p></p>"
  }
]